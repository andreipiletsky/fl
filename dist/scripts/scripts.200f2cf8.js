"use strict";angular.module("ngLocale",[],["$provide",function(t){var n="one",i="few",l="many",o="other";t.value("$locale",{DATETIME_FORMATS:{AMPMS:["AM","PM"],DAY:["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"],ERANAMES:["до н. э.","н. э."],ERAS:["до н. э.","н. э."],MONTH:["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"],SHORTDAY:["вс","пн","вт","ср","чт","пт","сб"],SHORTMONTH:["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"],fullDate:"EEEE, d MMMM y 'г'.",longDate:"d MMMM y 'г'.",medium:"d MMM y 'г'. H:mm:ss",mediumDate:"d MMM y 'г'.",mediumTime:"H:mm:ss",short:"dd.MM.yy H:mm",shortDate:"dd.MM.yy",shortTime:"H:mm"},NUMBER_FORMATS:{CURRENCY_SYM:"руб.",DECIMAL_SEP:",",GROUP_SEP:" ",PATTERNS:[{gSize:3,lgSize:3,maxFrac:3,minFrac:0,minInt:1,negPre:"-",negSuf:"",posPre:"",posSuf:""},{gSize:3,lgSize:3,maxFrac:2,minFrac:2,minInt:1,negPre:"-",negSuf:" ¤",posPre:"",posSuf:" ¤"}]},id:"ru-ru",pluralCat:function(t,e){var a=0|t,r=function(t,e){var a,r,n=e;void 0===n&&(n=Math.min((a=t,-1==(r=(a+="").indexOf("."))?0:a.length-r-1),3));var i=Math.pow(10,n);return{v:n,f:(t*i|0)%i}}(t,e);return 0==r.v&&a%10==1&&a%100!=11?n:0==r.v&&2<=a%10&&a%10<=4&&(a%100<12||14<a%100)?i:0==r.v&&a%10==0||0==r.v&&5<=a%10&&a%10<=9||0==r.v&&11<=a%100&&a%100<=14?l:o}})}]),angular.module("ui.bootstrap",["ui.bootstrap.tpls","ui.bootstrap.tabs","ui.bootstrap.collapse","ui.bootstrap.typeahead","ui.bootstrap.position"]),angular.module("ui.bootstrap.tpls",["template/tabs/tab.html","template/tabs/tabset.html","template/typeahead/typeahead-match.html","template/typeahead/typeahead-popup.html"]),angular.module("ui.bootstrap.tabs",[]).controller("UibTabsetController",["$scope",function(t){var r,n=this,i=n.tabs=t.tabs=[];n.select=function(e){angular.forEach(i,function(t){t.active&&t!==e&&(t.active=!1,t.onDeselect(),e.selectCalled=!1)}),e.active=!0,e.selectCalled||(e.onSelect(),e.selectCalled=!0)},n.addTab=function(t){i.push(t),1===i.length&&!1!==t.active?t.active=!0:t.active?n.select(t):t.active=!1},n.removeTab=function(t){var e=i.indexOf(t);if(t.active&&1<i.length&&!r){var a=e==i.length-1?e-1:e+1;n.select(i[a])}i.splice(e,1)},t.$on("$destroy",function(){r=!0})}]).directive("uibTabset",function(){return{restrict:"EA",transclude:!0,replace:!0,scope:{type:"@"},controller:"UibTabsetController",templateUrl:"template/tabs/tabset.html",link:function(t,e,a){t.vertical=!!angular.isDefined(a.vertical)&&t.$parent.$eval(a.vertical),t.justified=!!angular.isDefined(a.justified)&&t.$parent.$eval(a.justified)}}}).directive("uibTab",["$parse",function(i){return{require:"^uibTabset",restrict:"EA",replace:!0,templateUrl:"template/tabs/tab.html",transclude:!0,scope:{active:"=?",heading:"@",onSelect:"&select",onDeselect:"&deselect"},controller:function(){},link:function(e,t,a,r,n){e.$watch("active",function(t){t&&r.select(e)}),e.disabled=!1,a.disable&&e.$parent.$watch(i(a.disable),function(t){e.disabled=!!t}),e.select=function(){e.disabled||(e.active=!0)},r.addTab(e),e.$on("$destroy",function(){r.removeTab(e)}),e.$transcludeFn=n}}}]).directive("uibTabHeadingTransclude",function(){return{restrict:"A",require:["?^uibTab","?^tab"],link:function(t,e){t.$watch("headingElement",function(t){t&&(e.html(""),e.append(t))})}}}).directive("uibTabContentTransclude",function(){return{restrict:"A",require:["?^uibTabset","?^tabset"],link:function(t,a,e){var r=t.$eval(e.uibTabContentTransclude);r.$transcludeFn(r.$parent,function(t){angular.forEach(t,function(t){var e;(e=t).tagName&&(e.hasAttribute("tab-heading")||e.hasAttribute("data-tab-heading")||e.hasAttribute("x-tab-heading")||e.hasAttribute("uib-tab-heading")||e.hasAttribute("data-uib-tab-heading")||e.hasAttribute("x-uib-tab-heading")||"tab-heading"===e.tagName.toLowerCase()||"data-tab-heading"===e.tagName.toLowerCase()||"x-tab-heading"===e.tagName.toLowerCase()||"uib-tab-heading"===e.tagName.toLowerCase()||"data-uib-tab-heading"===e.tagName.toLowerCase()||"x-uib-tab-heading"===e.tagName.toLowerCase())?r.headingElement=t:a.append(t)})})}}}),angular.module("ui.bootstrap.tabs").value("$tabsSuppressWarning",!1).controller("TabsetController",["$scope","$controller","$log","$tabsSuppressWarning",function(t,e,a,r){r||a.warn("TabsetController is now deprecated. Use UibTabsetController instead."),angular.extend(this,e("UibTabsetController",{$scope:t}))}]).directive("tabset",["$log","$tabsSuppressWarning",function(r,n){return{restrict:"EA",transclude:!0,replace:!0,scope:{type:"@"},controller:"TabsetController",templateUrl:"template/tabs/tabset.html",link:function(t,e,a){n||r.warn("tabset is now deprecated. Use uib-tabset instead."),t.vertical=!!angular.isDefined(a.vertical)&&t.$parent.$eval(a.vertical),t.justified=!!angular.isDefined(a.justified)&&t.$parent.$eval(a.justified)}}}]).directive("tab",["$parse","$log","$tabsSuppressWarning",function(i,l,o){return{require:"^tabset",restrict:"EA",replace:!0,templateUrl:"template/tabs/tab.html",transclude:!0,scope:{active:"=?",heading:"@",onSelect:"&select",onDeselect:"&deselect"},controller:function(){},link:function(e,t,a,r,n){o||l.warn("tab is now deprecated. Use uib-tab instead."),e.$watch("active",function(t){t&&r.select(e)}),e.disabled=!1,a.disable&&e.$parent.$watch(i(a.disable),function(t){e.disabled=!!t}),e.select=function(){e.disabled||(e.active=!0)},r.addTab(e),e.$on("$destroy",function(){r.removeTab(e)}),e.$transcludeFn=n}}}]).directive("tabHeadingTransclude",["$log","$tabsSuppressWarning",function(a,r){return{restrict:"A",require:"^tab",link:function(t,e){r||a.warn("tab-heading-transclude is now deprecated. Use uib-tab-heading-transclude instead."),t.$watch("headingElement",function(t){t&&(e.html(""),e.append(t))})}}}]).directive("tabContentTransclude",["$log","$tabsSuppressWarning",function(n,i){return{restrict:"A",require:"^tabset",link:function(t,a,e){i||n.warn("tab-content-transclude is now deprecated. Use uib-tab-content-transclude instead.");var r=t.$eval(e.tabContentTransclude);r.$transcludeFn(r.$parent,function(t){angular.forEach(t,function(t){var e;(e=t).tagName&&(e.hasAttribute("tab-heading")||e.hasAttribute("data-tab-heading")||e.hasAttribute("x-tab-heading")||"tab-heading"===e.tagName.toLowerCase()||"data-tab-heading"===e.tagName.toLowerCase()||"x-tab-heading"===e.tagName.toLowerCase())?r.headingElement=t:a.append(t)})})}}}]),angular.module("ui.bootstrap.collapse",[]).directive("uibCollapse",["$animate","$injector",function(i,t){var l=t.has("$animateCss")?t.get("$animateCss"):null;return{link:function(t,e,a){function r(){e.removeClass("collapsing").addClass("collapse").css({height:"auto"})}function n(){e.css({height:"0"}),e.removeClass("collapsing").addClass("collapse")}t.$watch(a.uibCollapse,function(t){t?function(){if(!e.hasClass("collapse")&&!e.hasClass("in"))return n();e.css({height:e[0].scrollHeight+"px"}).removeClass("collapse").addClass("collapsing").attr("aria-expanded",!1).attr("aria-hidden",!0),l?l(e,{removeClass:"in",to:{height:"0"}}).start().finally(n):i.removeClass(e,"in",{to:{height:"0"}}).then(n)}():(e.removeClass("collapse").addClass("collapsing").attr("aria-expanded",!0).attr("aria-hidden",!1),l?l(e,{addClass:"in",easing:"ease",to:{height:e[0].scrollHeight+"px"}}).start().finally(r):i.addClass(e,"in",{to:{height:e[0].scrollHeight+"px"}}).then(r))})}}}]),angular.module("ui.bootstrap.collapse").value("$collapseSuppressWarning",!1).directive("collapse",["$animate","$injector","$log","$collapseSuppressWarning",function(i,t,l,o){var s=t.has("$animateCss")?t.get("$animateCss"):null;return{link:function(t,e,a){function r(){e.removeClass("collapsing").addClass("collapse in").css({height:"auto"})}function n(){e.css({height:"0"}),e.removeClass("collapsing").addClass("collapse")}o||l.warn("collapse is now deprecated. Use uib-collapse instead."),t.$watch(a.collapse,function(t){t?function(){if(!e.hasClass("collapse")&&!e.hasClass("in"))return n();e.css({height:e[0].scrollHeight+"px"}).removeClass("collapse in").addClass("collapsing").attr("aria-expanded",!1).attr("aria-hidden",!0),s?s(e,{to:{height:"0"}}).start().done(n):i.animate(e,{},{height:"0"}).then(n)}():(e.removeClass("collapse").addClass("collapsing").attr("aria-expanded",!0).attr("aria-hidden",!1),s?s(e,{easing:"ease",to:{height:e[0].scrollHeight+"px"}}).start().done(r):i.animate(e,{},{height:e[0].scrollHeight+"px"}).then(r))})}}}]),angular.module("ui.bootstrap.typeahead",["ui.bootstrap.position"]).factory("uibTypeaheadParser",["$parse",function(a){var r=/^\s*([\s\S]+?)(?:\s+as\s+([\s\S]+?))?\s+for\s+(?:([\$\w][\$\w\d]*))\s+in\s+([\s\S]+?)$/;return{parse:function(t){var e=t.match(r);if(!e)throw new Error('Expected typeahead specification in form of "_modelValue_ (as _label_)? for _item_ in _collection_" but got "'+t+'".');return{itemName:e[3],source:a(e[4]),viewMapper:a(e[2]||e[1]),modelMapper:a(e[1])}}}}]).controller("UibTypeaheadController",["$scope","$element","$attrs","$compile","$parse","$q","$timeout","$document","$window","$rootScope","$uibPosition","uibTypeaheadParser",function(o,s,l,t,e,a,c,r,n,i,u,d){var m,f,p=[9,13,27,38,40],h=200,g=o.$eval(l.typeaheadMinLength);g||0===g||(g=1);var v,D,y=o.$eval(l.typeaheadWaitMs)||0,b=!1!==o.$eval(l.typeaheadEditable),C=e(l.typeaheadLoading).assign||angular.noop,w=e(l.typeaheadOnSelect),I=!!angular.isDefined(l.typeaheadSelectOnBlur)&&o.$eval(l.typeaheadSelectOnBlur),N=e(l.typeaheadNoResults).assign||angular.noop,_=l.typeaheadInputFormatter?e(l.typeaheadInputFormatter):void 0,Y=!!l.typeaheadAppendToBody&&o.$eval(l.typeaheadAppendToBody),M=l.typeaheadAppendToElementId||!1,A=!1!==o.$eval(l.typeaheadFocusFirst),S=!!l.typeaheadSelectOnExact&&o.$eval(l.typeaheadSelectOnExact),P=e(l.ngModel),O=e(l.ngModel+"($$$p)"),U=d.parse(l.uibTypeahead),T=o.$new(),j=o.$on("$destroy",function(){T.$destroy()});T.$on("$destroy",j);var $="typeahead-"+T.$id+"-"+Math.floor(1e4*Math.random());s.attr({"aria-autocomplete":"list","aria-expanded":!1,"aria-owns":$}),T.elementFocus=!1,angular.element(s).bind("focus",function(t){T.$apply(function(){var t=m.$viewValue;return v=!0,0===g||t&&t.length>=g?0<y?(R(),W(t)):V(t):(C(o,!1),R(),k()),b?t:t?void m.$setValidity("editable",!1):(m.$setValidity("editable",!0),null)})});var F=angular.element("<div uib-typeahead-popup></div>");F.attr({id:$,matches:"matches",active:"activeIdx",select:"select(activeIdx)","move-in-progress":"moveInProgress",query:"query",position:"position"}),angular.isDefined(l.typeaheadTemplateUrl)&&F.attr("template-url",l.typeaheadTemplateUrl),angular.isDefined(l.typeaheadPopupTemplateUrl)&&F.attr("popup-template-url",l.typeaheadPopupTemplateUrl);var k=function(){T.matches=[],T.activeIdx=-1,s.attr("aria-expanded",!1)},x=function(t){return $+"-option-"+t};T.$watch("activeIdx",function(t){t<0?s.removeAttr("aria-activedescendant"):s.attr("aria-activedescendant",x(t))});var E,L,V=function(i){var l={$viewValue:i||""};C(o,!0),N(o,!1),a.when(U.source(o,l)).then(function(t){var e,a,r=i===m.$viewValue;if(r&&v)if(t&&0<t.length){T.activeIdx=A?0:-1,N(o,!1);for(var n=T.matches.length=0;n<t.length;n++)l[U.itemName]=t[n],T.matches.push({id:x(n),label:U.viewMapper(T,l),model:t[n]});T.query=i,B(),s.attr("aria-expanded",!0),S&&1===T.matches.length&&(e=i,a=0,T.matches.length>a&&e&&e.toUpperCase()===T.matches[a].label.toUpperCase())&&T.select(0)}else k(),N(o,!0);r&&C(o,!1)},function(){k(),C(o,!1),N(o,!0)})};function q(){T.moveInProgress||(T.moveInProgress=!0,T.$digest()),E&&c.cancel(E),E=c(function(){T.matches.length&&B(),T.moveInProgress=!1},h)}function B(){T.position=Y?u.offset(s):u.position(s),T.position.top+=s.prop("offsetHeight")}Y&&(angular.element(n).bind("resize",q),r.find("body").bind("scroll",q)),T.moveInProgress=!1,T.query=void 0;var W=function(t){L=c(function(){V(t)},y)},R=function(){L&&c.cancel(L)};k(),T.select=function(t){var e,a,r,n,i={};D=!0,i[U.itemName]=a=T.matches[t].model,e=U.modelMapper(o,i),r=o,n=e,angular.isFunction(P(o))&&f&&f.$options&&f.$options.getterSetter?O(r,{$$$p:n}):P.assign(r,n),m.$setValidity("editable",!0),m.$setValidity("parse",!0),w(o,{$item:a,$model:e,$label:U.viewMapper(o,i)}),k(),!1!==T.$eval(l.typeaheadFocusOnSelect)&&c(function(){s[0].focus()},0,!1)},s.bind("keydown",function(t){if(0!==T.matches.length&&-1!==p.indexOf(t.which)){if(-1===T.activeIdx&&(9===t.which||13===t.which))return k(),void T.$digest();t.preventDefault(),40===t.which?(T.activeIdx=(T.activeIdx+1)%T.matches.length,T.$digest()):38===t.which?(T.activeIdx=(0<T.activeIdx?T.activeIdx:T.matches.length)-1,T.$digest()):13===t.which||9===t.which?T.$apply(function(){T.select(T.activeIdx)}):27===t.which&&(t.stopPropagation(),k(),T.$digest())}}),s.bind("blur",function(){I&&T.matches.length&&-1!==T.activeIdx&&!D&&(D=!0,T.$apply(function(){T.select(T.activeIdx)})),D=v=!1});var G=function(t){s[0]!==t.target&&3!==t.which&&0!==T.matches.length&&(k(),i.$$phase||T.$digest())};r.bind("click",G),o.$on("$destroy",function(){r.unbind("click",G),(Y||M)&&z.remove(),Y&&(angular.element(n).unbind("resize",q),r.find("body").unbind("scroll",q)),F.remove()});var z=t(F)(T);Y?r.find("body").append(z):!1!==M?angular.element(r[0].getElementById(M)).append(z):s.after(z),this.init=function(t,e){f=e,(m=t).$parsers.unshift(function(t){return v=!0,0===g||t&&t.length>=g?0<y?(R(),W(t)):V(t):(C(o,!1),R(),k()),b?t:t?void m.$setValidity("editable",!1):(m.$setValidity("editable",!0),null)}),m.$formatters.push(function(t){var e,a={};return b||m.$setValidity("editable",!0),_?(a.$model=t,_(o,a)):(a[U.itemName]=t,e=U.viewMapper(o,a),a[U.itemName]=void 0,e!==U.viewMapper(o,a)?e:t)})}}]).directive("uibTypeahead",function(){return{controller:"UibTypeaheadController",require:["ngModel","^?ngModelOptions","uibTypeahead"],link:function(t,e,a,r){r[2].init(r[0],r[1])}}}).directive("uibTypeaheadPopup",function(){return{scope:{elementFocus:"=",matches:"=",query:"=",active:"=",position:"&",moveInProgress:"=",select:"&"},replace:!0,templateUrl:function(t,e){return e.popupTemplateUrl||"template/typeahead/typeahead-popup.html"},link:function(e,t,a){e.templateUrl=a.templateUrl,e.isOpen=function(){return 0<e.matches.length},e.isActive=function(t){return e.active==t},e.selectActive=function(t){e.active=t},e.selectMatch=function(t){e.select({activeIdx:t})}}}}).directive("uibTypeaheadMatch",["$templateRequest","$compile","$parse",function(n,i,l){return{scope:{index:"=",match:"=",query:"="},link:function(e,a,t){var r=l(t.templateUrl)(e.$parent)||"template/typeahead/typeahead-match.html";n(r).then(function(t){i(t.trim())(e,function(t){a.replaceWith(t)})})}}}]).filter("uibTypeaheadHighlight",["$sce","$injector","$log",function(a,t,r){var n;return n=t.has("$sanitize"),function(t,e){return!n&&/<.*>/g.test(t)&&r.warn("Unsafe use of typeahead please use ngSanitize"),t=e?(""+t).replace(new RegExp(e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"),"gi"),"<strong>$&</strong>"):t,n||(t=a.trustAsHtml(t)),t}}]),angular.module("ui.bootstrap.typeahead").value("$typeaheadSuppressWarning",!1).service("typeaheadParser",["$parse","uibTypeaheadParser","$log","$typeaheadSuppressWarning",function(t,e,a,r){return r||a.warn("typeaheadParser is now deprecated. Use uibTypeaheadParser instead."),e}]).directive("typeahead",["$compile","$parse","$q","$timeout","$document","$window","$rootScope","$uibPosition","typeaheadParser","$log","$typeaheadSuppressWarning",function(k,x,E,L,V,q,B,W,R,G,z){var K=[9,13,27,38,40];return{require:["ngModel","^?ngModelOptions"],link:function(o,s,l,t){z||G.warn("typeahead is now deprecated. Use uib-typeahead instead.");var c=t[0],u=t[1],a=o.$eval(l.typeaheadMinLength);a||0===a||(a=1);var d,m,r=o.$eval(l.typeaheadWaitMs)||0,n=!1!==o.$eval(l.typeaheadEditable),f=x(l.typeaheadLoading).assign||angular.noop,p=x(l.typeaheadOnSelect),e=!!angular.isDefined(l.typeaheadSelectOnBlur)&&o.$eval(l.typeaheadSelectOnBlur),h=x(l.typeaheadNoResults).assign||angular.noop,i=l.typeaheadInputFormatter?x(l.typeaheadInputFormatter):void 0,g=!!l.typeaheadAppendToBody&&o.$eval(l.typeaheadAppendToBody),v=l.typeaheadAppendToElementId||!1,D=!1!==o.$eval(l.typeaheadFocusFirst),y=!!l.typeaheadSelectOnExact&&o.$eval(l.typeaheadSelectOnExact),b=x(l.ngModel),C=x(l.ngModel+"($$$p)"),w=R.parse(l.typeahead),I=o.$new(),N=o.$on("$destroy",function(){I.$destroy()});I.$on("$destroy",N);var _="typeahead-"+I.$id+"-"+Math.floor(1e4*Math.random());s.attr({"aria-autocomplete":"list","aria-expanded":!1,"aria-owns":_});var Y=angular.element("<div typeahead-popup></div>");Y.attr({id:_,matches:"matches",active:"activeIdx",select:"select(activeIdx)","move-in-progress":"moveInProgress",query:"query",position:"position"}),angular.isDefined(l.typeaheadTemplateUrl)&&Y.attr("template-url",l.typeaheadTemplateUrl),angular.isDefined(l.typeaheadPopupTemplateUrl)&&Y.attr("popup-template-url",l.typeaheadPopupTemplateUrl);var M=function(){I.matches=[],I.activeIdx=-1,s.attr("aria-expanded",!1)},A=function(t){return _+"-option-"+t};I.$watch("activeIdx",function(t){t<0?s.removeAttr("aria-activedescendant"):s.attr("aria-activedescendant",A(t))});var S,P,O=function(i){var l={$viewValue:i};f(o,!0),h(o,!1),E.when(w.source(o,l)).then(function(t){var e,a,r=i===c.$viewValue;if(r&&d)if(t&&0<t.length){I.activeIdx=D?0:-1,h(o,!1);for(var n=I.matches.length=0;n<t.length;n++)l[w.itemName]=t[n],I.matches.push({id:A(n),label:w.viewMapper(I,l),model:t[n]});I.query=i,T(),s.attr("aria-expanded",!0),y&&1===I.matches.length&&(e=i,a=0,I.matches.length>a&&e&&e.toUpperCase()===I.matches[a].label.toUpperCase())&&I.select(0)}else M(),h(o,!0);r&&f(o,!1)},function(){M(),f(o,!1),h(o,!0)})};function U(){I.moveInProgress||(I.moveInProgress=!0,I.$digest()),S&&L.cancel(S),S=L(function(){I.matches.length&&T(),I.moveInProgress=!1},200)}function T(){I.position=g?W.offset(s):W.position(s),I.position.top+=s.prop("offsetHeight")}g&&(angular.element(q).bind("resize",U),V.find("body").bind("scroll",U)),I.moveInProgress=!1,M(),I.query=void 0;var j=function(){P&&L.cancel(P)};c.$parsers.unshift(function(t){var e;return d=!0,0===a||t&&t.length>=a?0<r?(j(),e=t,P=L(function(){O(e)},r)):O(t):(f(o,!1),j(),M()),n?t:t?void c.$setValidity("editable",!1):(c.$setValidity("editable",!0),null)}),c.$formatters.push(function(t){var e,a={};return n||c.$setValidity("editable",!0),i?(a.$model=t,i(o,a)):(a[w.itemName]=t,e=w.viewMapper(o,a),a[w.itemName]=void 0,e!==w.viewMapper(o,a)?e:t)}),I.select=function(t){var e,a,r,n,i={};m=!0,i[w.itemName]=a=I.matches[t].model,e=w.modelMapper(o,i),r=o,n=e,angular.isFunction(b(o))&&u&&u.$options&&u.$options.getterSetter?C(r,{$$$p:n}):b.assign(r,n),c.$setValidity("editable",!0),c.$setValidity("parse",!0),p(o,{$item:a,$model:e,$label:w.viewMapper(o,i)}),M(),!1!==I.$eval(l.typeaheadFocusOnSelect)&&L(function(){s[0].focus()},0,!1)},s.bind("keydown",function(t){if(0!==I.matches.length&&-1!==K.indexOf(t.which)){if(-1===I.activeIdx&&(9===t.which||13===t.which))return M(),void I.$digest();t.preventDefault(),40===t.which?(I.activeIdx=(I.activeIdx+1)%I.matches.length,I.$digest()):38===t.which?(I.activeIdx=(0<I.activeIdx?I.activeIdx:I.matches.length)-1,I.$digest()):13===t.which||9===t.which?I.$apply(function(){I.select(I.activeIdx)}):27===t.which&&(t.stopPropagation(),M(),I.$digest())}}),s.bind("blur",function(){e&&I.matches.length&&-1!==I.activeIdx&&!m&&(m=!0,I.$apply(function(){I.select(I.activeIdx)})),m=d=!1});var $=function(t){s[0]!==t.target&&3!==t.which&&0!==I.matches.length&&(M(),B.$$phase||I.$digest())};V.bind("click",$),o.$on("$destroy",function(){V.unbind("click",$),(g||v)&&F.remove(),g&&(angular.element(q).unbind("resize",U),V.find("body").unbind("scroll",U)),Y.remove()});var F=k(Y)(I);g?V.find("body").append(F):!1!==v?angular.element(V[0].getElementById(v)).append(F):s.after(F)}}}]).directive("typeaheadPopup",["$typeaheadSuppressWarning","$log",function(r,n){return{scope:{matches:"=",query:"=",active:"=",position:"&",moveInProgress:"=",select:"&"},replace:!0,templateUrl:function(t,e){return e.popupTemplateUrl||"template/typeahead/typeahead-popup.html"},link:function(e,t,a){r||n.warn("typeahead-popup is now deprecated. Use uib-typeahead-popup instead."),e.templateUrl=a.templateUrl,e.isOpen=function(){return 0<e.matches.length},e.isActive=function(t){return e.active==t},e.selectActive=function(t){e.active=t},e.selectMatch=function(t){e.select({activeIdx:t})}}}}]).directive("typeaheadMatch",["$templateRequest","$compile","$parse","$typeaheadSuppressWarning","$log",function(n,i,l,o,s){return{restrict:"EA",scope:{index:"=",match:"=",query:"="},link:function(e,a,t){o||s.warn("typeahead-match is now deprecated. Use uib-typeahead-match instead.");var r=l(t.templateUrl)(e.$parent)||"template/typeahead/typeahead-match.html";n(r).then(function(t){i(t.trim())(e,function(t){a.replaceWith(t)})})}}}]).filter("typeaheadHighlight",["$sce","$injector","$log","$typeaheadSuppressWarning",function(a,t,r,n){var i;return i=t.has("$sanitize"),function(t,e){return n||r.warn("typeaheadHighlight is now deprecated. Use uibTypeaheadHighlight instead."),!i&&/<.*>/g.test(t)&&r.warn("Unsafe use of typeahead please use ngSanitize"),t=e?(""+t).replace(new RegExp(e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"),"gi"),"<strong>$&</strong>"):t,i||(t=a.trustAsHtml(t)),t}}]),angular.module("ui.bootstrap.position",[]).factory("$uibPosition",["$document","$window",function(i,r){function l(t){return"static"===(a="position",((e=t).currentStyle?e.currentStyle[a]:r.getComputedStyle?r.getComputedStyle(e)[a]:e.style[a])||"static");var e,a}return{position:function(t){var e=this.offset(t),a={top:0,left:0},r=function(t){for(var e=i[0],a=t.offsetParent||e;a&&a!==e&&l(a);)a=a.offsetParent;return a||e}(t[0]);r!=i[0]&&((a=this.offset(angular.element(r))).top+=r.clientTop-r.scrollTop,a.left+=r.clientLeft-r.scrollLeft);var n=t[0].getBoundingClientRect();return{width:n.width||t.prop("offsetWidth"),height:n.height||t.prop("offsetHeight"),top:e.top-a.top,left:e.left-a.left}},offset:function(t){var e=t[0].getBoundingClientRect();return{width:e.width||t.prop("offsetWidth"),height:e.height||t.prop("offsetHeight"),top:e.top+(r.pageYOffset||i[0].documentElement.scrollTop),left:e.left+(r.pageXOffset||i[0].documentElement.scrollLeft)}},positionElements:function(t,e,a,r){var n,i,l,o,s=a.split("-"),c=s[0],u=s[1]||"center";n=r?this.offset(t):this.position(t),i=e.prop("offsetWidth"),l=e.prop("offsetHeight");var d={center:function(){return n.left+n.width/2-i/2},left:function(){return n.left},right:function(){return n.left+n.width}},m={center:function(){return n.top+n.height/2-l/2},top:function(){return n.top},bottom:function(){return n.top+n.height}};switch(c){case"right":o={top:m[u](),left:d[c]()};break;case"left":o={top:m[u](),left:n.left-i};break;case"bottom":o={top:m[c](),left:d[u]()};break;default:o={top:n.top-l,left:d[u]()}}return o}}}]),angular.module("ui.bootstrap.position").value("$positionSuppressWarning",!1).service("$position",["$log","$positionSuppressWarning","$uibPosition",function(t,e,a){e||t.warn("$position is now deprecated. Use $uibPosition instead."),angular.extend(this,a)}]),angular.module("template/tabs/tab.html",[]).run(["$templateCache",function(t){t.put("template/tabs/tab.html",'<li ng-class="{active: active, disabled: disabled}">\n  <a href ng-click="select()" uib-tab-heading-transclude>{{heading}}</a>\n</li>\n')}]),angular.module("template/tabs/tabset.html",[]).run(["$templateCache",function(t){t.put("template/tabs/tabset.html",'<div>\n  <ul class="nav nav-{{type || \'tabs\'}}" ng-class="{\'nav-stacked\': vertical, \'nav-justified\': justified}" ng-transclude></ul>\n  <div class="tab-content">\n    <div class="tab-pane" \n         ng-repeat="tab in tabs" \n         ng-class="{active: tab.active}"\n         uib-tab-content-transclude="tab">\n    </div>\n  </div>\n</div>\n')}]),angular.module("template/typeahead/typeahead-match.html",[]).run(["$templateCache",function(t){t.put("template/typeahead/typeahead-match.html",'<a href tabindex="-1" ng-bind-html="match.label | uibTypeaheadHighlight:query"></a>\n')}]),angular.module("template/typeahead/typeahead-popup.html",[]).run(["$templateCache",function(t){t.put("template/typeahead/typeahead-popup.html",'<ul class="dropdown-menu" ng-show="isOpen() && !moveInProgress" ng-style="{top: position().top+\'px\', left: position().left+\'px\'}" style="display: block;" role="listbox" aria-hidden="{{!isOpen()}}">\n    <li ng-repeat="match in matches track by $index" ng-class="{active: isActive($index) }" ng-mouseenter="selectActive($index)" ng-click="selectMatch($index)" role="option" id="{{::match.id}}">\n        <div uib-typeahead-match index="$index" match="match" query="query" template-url="templateUrl"></div>\n    </li>\n</ul>\n')}]),function(v,D){var r=function(t,e,a){this.parentEl="body",this.element=v(t);var r="";e.hideFormInputs||(r='<div class="daterangepicker_start_input"><label for="daterangepicker_start"></label><input class="input-mini" type="text" name="daterangepicker_start" value="" disabled="disabled" /></div><div class="daterangepicker_end_input"><label for="daterangepicker_end"></label><input class="input-mini" type="text" name="daterangepicker_end" value="" disabled="disabled" /></div>');var n='<div class="daterangepicker dropdown-menu"><div class="calendar left"></div><div class="calendar right"></div><div class="ranges"><div class="range_inputs">'+r+'<button class="applyBtn" disabled="disabled"></button>&nbsp;<button class="cancelBtn"></button></div></div></div>';"object"==typeof e&&null!==e||(e={}),this.parentEl="object"==typeof e&&e.parentEl&&v(e.parentEl).length||v(this.parentEl),this.container=v(n).appendTo(this.parentEl),v.extend(e,t.data("options")),this.setOptions(e,a);var i=this.container;v.each(this.buttonClasses,function(t,e){i.find("button").addClass(e)}),this.container.find(".daterangepicker_start_input label").html(this.locale.fromLabel),this.container.find(".daterangepicker_end_input label").html(this.locale.toLabel),this.applyClass.length&&this.container.find(".applyBtn").addClass(this.applyClass),this.cancelClass.length&&this.container.find(".cancelBtn").addClass(this.cancelClass),this.container.find(".applyBtn").html(this.locale.applyLabel),this.container.find(".cancelBtn").html(this.locale.cancelLabel),this.container.find(".calendar").on("click.daterangepicker",".prev",v.proxy(this.clickPrev,this)).on("click.daterangepicker",".next",v.proxy(this.clickNext,this)).on("click.daterangepicker","td.available",v.proxy(this.clickDate,this)).on("mouseenter.daterangepicker","td.available",v.proxy(this.enterDate,this)).on("mouseleave.daterangepicker","td.available",v.proxy(this.updateFormInputs,this)).on("change.daterangepicker","select.yearselect",v.proxy(this.updateMonthYear,this)).on("change.daterangepicker","select.monthselect",v.proxy(this.updateMonthYear,this)).on("change.daterangepicker","select.hourselect,select.minuteselect,select.ampmselect",v.proxy(this.updateTime,this)),this.container.find(".ranges").on("click.daterangepicker","button.applyBtn",v.proxy(this.clickApply,this)).on("click.daterangepicker","button.cancelBtn",v.proxy(this.clickCancel,this)).on("click.daterangepicker",".daterangepicker_start_input,.daterangepicker_end_input",v.proxy(this.showCalendars,this)).on("click.daterangepicker","li",v.proxy(this.clickRange,this)).on("mouseenter.daterangepicker","li",v.proxy(this.enterRange,this)).on("mouseleave.daterangepicker","li",v.proxy(this.updateFormInputs,this)),this.element.is("input")?this.element.on({"click.daterangepicker":v.proxy(this.show,this),"focus.daterangepicker":v.proxy(this.show,this),"keyup.daterangepicker":v.proxy(this.updateFromControl,this)}):this.element.on("click.daterangepicker",v.proxy(this.toggle,this))};r.prototype={constructor:r,setOptions:function(t,e){if(this.minViewMode="day","string"==typeof t.minViewMode&&(this.minViewMode=t.minViewMode),this.startDate=D().startOf(this.minViewMode),this.endDate=D().endOf(this.minViewMode),this.minDate=!1,this.maxDate=!1,this.dateLimit=!1,this.showDropdowns=!1,this.showWeekNumbers=!1,this.hideFormInputs=!1,this.alwaysShowCalendars=!1,this.autoApplyClickedRange=!0,this.timePicker=!1,this.timePickerIncrement=30,this.timePicker12Hour=!0,this.singleDatePicker=!1,this.ranges={},this.opens="right",this.element.hasClass("pull-right")&&(this.opens="left"),this.buttonClasses=["btn","btn-small"],this.applyClass="btn-success",this.cancelClass="btn-default",this.format=this.viewModes[this.minViewMode].defaultFormat,this.separator=" - ",this.locale={applyLabel:"Apply",cancelLabel:"Cancel",fromLabel:"From",toLabel:"To",weekLabel:"W",customRangeLabel:"Custom Range",daysOfWeek:D()._locale._weekdaysMin.slice(),monthNames:D()._locale._monthsShort.slice(),firstDay:0},this.cb=function(){},"string"==typeof t.format&&(this.format=t.format),"string"==typeof t.separator&&(this.separator=t.separator),"string"==typeof t.startDate&&(this.startDate=D(t.startDate,this.format)),"string"==typeof t.endDate&&(this.endDate=D(t.endDate,this.format)),"string"==typeof t.minDate&&(this.minDate=D(t.minDate,this.format)),"string"==typeof t.maxDate&&(this.maxDate=D(t.maxDate,this.format)),"object"==typeof t.startDate&&(this.startDate=D(t.startDate)),"object"==typeof t.endDate&&(this.endDate=D(t.endDate)),"object"==typeof t.minDate&&(this.minDate=D(t.minDate)),"object"==typeof t.maxDate&&(this.maxDate=D(t.maxDate)),this.startDate=this.startDate.startOf(this.minViewMode),this.endDate=this.endDate.endOf(this.minViewMode),this.minDate&&(this.minDate=this.minDate.startOf(this.minViewMode)),this.maxDate&&(this.maxDate=this.maxDate.endOf(this.minViewMode)),"string"==typeof t.applyClass&&(this.applyClass=t.applyClass),"string"==typeof t.cancelClass&&(this.cancelClass=t.cancelClass),"object"==typeof t.dateLimit&&(this.dateLimit=t.dateLimit),"object"==typeof t.locale){if("object"==typeof t.locale.daysOfWeek&&(this.locale.daysOfWeek=t.locale.daysOfWeek.slice()),"object"==typeof t.locale.monthNames&&(this.locale.monthNames=t.locale.monthNames.slice()),"number"==typeof t.locale.firstDay){this.locale.firstDay=t.locale.firstDay;for(var a=t.locale.firstDay;0<a;)this.locale.daysOfWeek.push(this.locale.daysOfWeek.shift()),a--}"string"==typeof t.locale.applyLabel&&(this.locale.applyLabel=t.locale.applyLabel),"string"==typeof t.locale.cancelLabel&&(this.locale.cancelLabel=t.locale.cancelLabel),"string"==typeof t.locale.fromLabel&&(this.locale.fromLabel=t.locale.fromLabel),"string"==typeof t.locale.toLabel&&(this.locale.toLabel=t.locale.toLabel),"string"==typeof t.locale.weekLabel&&(this.locale.weekLabel=t.locale.weekLabel),"string"==typeof t.locale.customRangeLabel&&(this.locale.customRangeLabel=t.locale.customRangeLabel)}var r,n,i;if("string"==typeof t.opens&&(this.opens=t.opens),"boolean"==typeof t.showWeekNumbers&&(this.showWeekNumbers=t.showWeekNumbers),"boolean"==typeof t.hideFormInputs&&(this.hideFormInputs=t.hideFormInputs),"boolean"==typeof t.alwaysShowCalendars&&(this.alwaysShowCalendars=t.alwaysShowCalendars),"boolean"==typeof t.autoApplyClickedRange&&(this.autoApplyClickedRange=t.autoApplyClickedRange),"string"==typeof t.buttonClasses&&(this.buttonClasses=[t.buttonClasses]),"object"==typeof t.buttonClasses&&(this.buttonClasses=t.buttonClasses),"boolean"==typeof t.showDropdowns&&(this.showDropdowns=t.showDropdowns),"boolean"==typeof t.singleDatePicker&&(this.singleDatePicker=t.singleDatePicker),"boolean"==typeof t.timePicker&&(this.timePicker=t.timePicker),"number"==typeof t.timePickerIncrement&&(this.timePickerIncrement=t.timePickerIncrement),"boolean"==typeof t.timePicker12Hour&&(this.timePicker12Hour=t.timePicker12Hour),void 0===t.startDate&&void 0===t.endDate&&v(this.element).is("input[type=text]")){var l=v(this.element).val(),o=l.split(this.separator);r=n=null,2==o.length?(r=D(o[0],this.format),n=D(o[1],this.format)):this.singleDatePicker&&(r=D(l,this.format),n=D(l,this.format)),null!==r&&null!==n&&(this.startDate=r,this.endDate=n)}if("object"==typeof t.ranges){for(i in t.ranges)r=D(t.ranges[i][0]),n=D(t.ranges[i][1]),this.minDate&&r.isBefore(this.minDate)&&(r=D(this.minDate)),this.maxDate&&n.isAfter(this.maxDate)&&(n=D(this.maxDate)),this.minDate&&n.isBefore(this.minDate)||this.maxDate&&r.isAfter(this.maxDate)||(this.ranges[i]=[r,n]);var s="<ul>";for(i in this.ranges)s+="<li>"+i+"</li>";this.alwaysShowCalendars||(s+="<li>"+this.locale.customRangeLabel+"</li>"),s+="</ul>",this.container.find(".ranges ul").remove(),this.container.find(".ranges").prepend(s)}if("function"==typeof e&&(this.cb=e),this.timePicker||(this.startDate=this.startDate.startOf("day"),this.endDate=this.endDate.endOf("day")),this.singleDatePicker?(this.opens="right",this.container.find(".calendar.right").show(),this.container.find(".calendar.left").hide(),this.container.find(".ranges").hide(),this.container.find(".calendar.right").hasClass("single")||this.container.find(".calendar.right").addClass("single")):(this.container.find(".calendar.right").removeClass("single"),this.container.find(".ranges").show()),this.oldStartDate=this.startDate.clone(),this.oldEndDate=this.endDate.clone(),this.oldChosenLabel=this.chosenLabel,this.leftCalendar={month:D([this.startDate.year(),this.startDate.month(),1,this.startDate.hour(),this.startDate.minute()]),calendar:[]},this.rightCalendar={month:D([this.endDate.year(),this.endDate.month(),this.endDate.daysInMonth(),this.endDate.hour(),this.endDate.minute()]),calendar:[]},"right"==this.opens){var c=this.container.find(".calendar.left"),u=this.container.find(".calendar.right");c.removeClass("left").addClass("right"),u.removeClass("right").addClass("left")}void 0!==t.ranges||this.singleDatePicker||this.container.addClass("show-calendar"),this.container.addClass("opens"+this.opens),this.updateView(),this.updateCalendars(),this.alwaysShowCalendars&&this.showCalendars()},setStartDate:function(t){"string"==typeof t&&(this.startDate=D(t,this.format)),"object"==typeof t&&(this.startDate=D(t)),this.timePicker||(this.startDate=this.startDate.startOf(this.minViewMode)),this.oldStartDate=this.startDate.clone(),this.updateView(),this.updateCalendars()},setEndDate:function(t){"string"==typeof t&&(this.endDate=D(t,this.format)),"object"==typeof t&&(this.endDate=D(t)),this.timePicker||(this.endDate=this.endDate.endOf(this.minViewMode)),this.oldEndDate=this.endDate.clone(),this.updateView(),this.updateCalendars()},updateView:function(){this.leftCalendar.month.month(this.startDate.month()).year(this.startDate.year()),this.rightCalendar.month.month(this.endDate.month()).year(this.endDate.year()).date(this.endDate.daysInMonth()),this.updateFormInputs()},updateFormInputs:function(){this.hideFormInputs||(this.container.find("input[name=daterangepicker_start]").val(this.startDate.format(this.format)),this.container.find("input[name=daterangepicker_end]").val(this.endDate.format(this.format))),this.startDate.isSame(this.endDate)||this.startDate.isBefore(this.endDate)?this.container.find("button.applyBtn").removeAttr("disabled"):this.container.find("button.applyBtn").attr("disabled","disabled")},updateFromControl:function(){if(this.element.is("input")&&this.element.val().length){var t=this.element.val().split(this.separator),e=null,a=null;2===t.length&&(e=D(t[0],this.format),a=D(t[1],this.format)),(this.singleDatePicker||null===e||null===a)&&(a=e=D(this.element.val(),this.format)),a.isBefore(e)||(this.oldStartDate=this.startDate.clone(),this.oldEndDate=this.endDate.clone(),this.startDate=e,this.endDate=a,this.startDate.isSame(this.oldStartDate)&&this.endDate.isSame(this.oldEndDate)||this.notify(),this.updateCalendars())}},notify:function(){this.updateView(),this.cb(this.startDate,this.endDate,this.chosenLabel)},move:function(){var t={top:0,left:0};this.parentEl.is("body")||(t={top:this.parentEl.offset().top-this.parentEl.scrollTop(),left:this.parentEl.offset().left-this.parentEl.scrollLeft()}),"left"==this.opens?(this.container.css({top:this.element.offset().top+this.element.outerHeight()-t.top,right:v(window).width()-this.element.offset().left-this.element.outerWidth()-t.left,left:"auto"}),this.container.offset().left<0&&this.container.css({right:"auto",left:9})):(this.container.css({top:this.element.offset().top+this.element.outerHeight()-t.top,left:this.element.offset().left-t.left,right:"auto"}),this.container.offset().left+this.container.outerWidth()>v(window).width()&&this.container.css({left:"auto",right:0}))},toggle:function(t){this.element.hasClass("active")?this.hide():this.show()},show:function(t){this.element.addClass("active"),this.container.show(),this.move(),v(document).on("click.daterangepicker",v.proxy(this.outsideClick,this)),v(document).on("click.daterangepicker","[data-toggle=dropdown]",v.proxy(this.outsideClick,this)),this.element.trigger("show.daterangepicker",this)},outsideClick:function(t){var e=v(t.target);e.closest(this.element).length||e.closest(this.container).length||e.closest(".calendar-date").length||this.clickCancel()},hide:function(t){v(document).off("click.daterangepicker",this.outsideClick),this.element.removeClass("active"),this.container.hide(),this.notify(),this.oldStartDate=this.startDate.clone(),this.oldEndDate=this.endDate.clone(),this.element.trigger("hide.daterangepicker",this)},enterRange:function(t){var e=t.target.innerHTML;if(e==this.locale.customRangeLabel)this.updateView();else{var a=this.ranges[e];this.container.find("input[name=daterangepicker_start]").val(a[0].format(this.format)),this.container.find("input[name=daterangepicker_end]").val(a[1].format(this.format))}},showCalendars:function(){this.container.addClass("show-calendar"),this.move()},hideCalendars:function(){this.container.removeClass("show-calendar")},updateInputText:function(){this.element.is("input")&&!this.singleDatePicker?this.element.val(this.startDate.format(this.format)+this.separator+this.endDate.format(this.format)):this.element.is("input")&&this.element.val(this.startDate.format(this.format))},clickRange:function(t){var e=t.target.innerHTML;if((this.chosenLabel=e)==this.locale.customRangeLabel)this.showCalendars();else{var a=this.ranges[e];this.startDate=a[0],this.endDate=a[1],this.timePicker||(this.startDate.startOf("day"),this.endDate.endOf("day")),this.leftCalendar.month.month(this.startDate.month()).year(this.startDate.year()).hour(this.startDate.hour()).minute(this.startDate.minute()),this.rightCalendar.month.month(this.endDate.month()).year(this.endDate.year()).hour(this.endDate.hour()).minute(this.endDate.minute()),this.updateCalendars(),this.autoApplyClickedRange&&(this.alwaysShowCalendars||this.hideCalendars(),this.updateInputText(),this.hide(),this.element.trigger("apply.daterangepicker",this))}},clickPrev:function(t){var e=this.viewModes[this.minViewMode].next;v(t.target).parents(".calendar").hasClass("left")?this.leftCalendar.month.subtract(e,1):(this.rightCalendar.month.subtract(e,1),this.rightCalendar.month.date(this.rightCalendar.month.daysInMonth())),this.updateCalendars()},clickNext:function(t){var e=this.viewModes[this.minViewMode].next;v(t.target).parents(".calendar").hasClass("left")?this.leftCalendar.month.add(e,1):(this.rightCalendar.month.add(e,1),this.rightCalendar.month.date(this.rightCalendar.month.daysInMonth())),this.updateCalendars()},enterDate:function(t){var e=v(t.target).attr("data-title"),a=e.substr(1,1),r=e.substr(3,1);v(t.target).parents(".calendar").hasClass("left")?this.container.find("input[name=daterangepicker_start]").val(this.leftCalendar.calendar[a][r].format(this.format)):this.container.find("input[name=daterangepicker_end]").val(this.rightCalendar.calendar[a][r].format(this.format))},clickDate:function(t){var e,a,r=v(t.target).attr("data-title"),n=r.substr(1,1),i=r.substr(3,1),l=v(t.target).parents(".calendar");if(l.hasClass("left")){if(e=this.leftCalendar.calendar[n][i],a=this.endDate,"object"==typeof this.dateLimit){var o=D(e).add(this.dateLimit).startOf("day");a=a.max(o)}}else if(e=this.startDate,a=this.rightCalendar.calendar[n][i],"object"==typeof this.dateLimit){var s=D(a).subtract(this.dateLimit).startOf("day");e=e.min(s)}this.singleDatePicker&&l.hasClass("left")?a=e.clone():this.singleDatePicker&&l.hasClass("right")&&(e=a.clone()),l.find("td").removeClass("active"),v(t.target).addClass("active"),this.setDates(e,a),this.updateFormInputs(),this.leftCalendar.month=this.startDate.clone().startOf("month"),this.rightCalendar.month=this.endDate.clone().endOf("month"),this.updateCalendars(),this.timePicker||a.endOf("day"),this.singleDatePicker&&this.clickApply()},setDates:function(t,e){var a=this.viewModes[this.minViewMode].duration;if(t.isSame(e)||t.isBefore(e))this.endDate=e;else if(t.isAfter(e)){var r;"month"==this.minViewMode?(r=this.endDate.month()-this.startDate.month(),r+=12*(this.endDate.year()-this.startDate.year())):r=this.endDate.diff(this.startDate,a),this.endDate=D(t).add(a,r).endOf(this.minViewMode)}this.startDate=t,this.minDate&&(this.startDate=this.startDate.min(this.minDate)),this.maxDate&&(this.endDate=this.endDate.max(this.maxDate)),this.chosenLabel=this.locale.customRangeLabel},clickApply:function(t){this.updateInputText(),this.hide(),this.element.trigger("apply.daterangepicker",this)},clickCancel:function(t){this.startDate=this.oldStartDate,this.endDate=this.oldEndDate,this.chosenLabel=this.oldChosenLabel,this.updateView(),this.updateCalendars(),this.hide(),this.element.trigger("cancel.daterangepicker",this)},updateMonthYear:function(t){var e=v(t.target).closest(".calendar").hasClass("left")?"left":"right",a=this.container.find(".calendar."+e),r=parseInt(a.find(".monthselect").val(),10),n=a.find(".yearselect").val();this[e+"Calendar"].month.month(r).year(n),this.updateCalendars()},updateTime:function(t){var e=v(t.target).closest(".calendar").hasClass("left"),a=e?"left":"right",r=this.container.find(".calendar."+a),n=parseInt(r.find(".hourselect").val(),10),i=parseInt(r.find(".minuteselect").val(),10);if(this.timePicker12Hour){var l=r.find(".ampmselect").val();"PM"===l&&n<12&&(n+=12),"AM"===l&&12===n&&(n=0)}if(e){var o=this.startDate.clone();o.hour(n),o.minute(i),this.startDate=o,this.leftCalendar.month.hour(n).minute(i)}else{var s=this.endDate.clone();s.hour(n),s.minute(i),this.endDate=s,this.rightCalendar.month.hour(n).minute(i)}this.updateCalendars()},updateCalendars:function(){this.leftCalendar.calendar=this.buildCalendar(this.leftCalendar.month.month(),this.leftCalendar.month.year(),this.leftCalendar.month.hour(),this.leftCalendar.month.minute(),"left"),this.rightCalendar.calendar=this.buildCalendar(this.rightCalendar.month.month(),this.rightCalendar.month.year(),this.rightCalendar.month.hour(),this.rightCalendar.month.minute(),"right"),this.container.find(".calendar.left").empty().html(this.renderCalendar(this.leftCalendar.calendar,this.startDate,this.minDate,this.endDate)),this.container.find(".calendar.right").empty().html(this.renderCalendar(this.rightCalendar.calendar,this.endDate,this.startDate,this.maxDate)),this.container.find(".ranges li").removeClass("active");var t=!0,e=0;for(var a in this.ranges)this.timePicker?this.startDate.isSame(this.ranges[a][0])&&this.endDate.isSame(this.ranges[a][1])&&(t=!1,this.chosenLabel=this.container.find(".ranges li:eq("+e+")").addClass("active").html()):this.startDate.format("YYYY-MM-DD")==this.ranges[a][0].format("YYYY-MM-DD")&&this.endDate.format("YYYY-MM-DD")==this.ranges[a][1].format("YYYY-MM-DD")&&(t=!1,this.chosenLabel=this.container.find(".ranges li:eq("+e+")").addClass("active").html()),e++;!this.alwaysShowCalendars&&t&&(this.chosenLabel=this.container.find(".ranges li:last").addClass("active").html())},buildCalendar:function(t,e,a,r,n){var i,l=[];if("month"==this.minViewMode){var o;for(i=D([e,0,1]),"right"==n&&(i=i.endOf("month")),s=0;s<3;s++)for(l[s]=[],o=0;o<4;o++)l[s][o]=i.clone(),i=i.add("month",1),"right"==n&&(i=i.endOf("month"))}else{var s,c=D([e,t,1]),u=D(c).subtract("month",1).month(),d=D(c).subtract("month",1).year(),m=D([d,u]).daysInMonth(),f=c.day();for(l=[],s=0;s<6;s++)l[s]=[];var p,h,g=m-f+this.locale.firstDay+1;for(m<g&&(g-=7),f==this.locale.firstDay&&(g=m-6),i=D([d,u,g,12,r]),h=p=s=0;s<42;s++,p++,i=D(i).add("hour",24))0<s&&p%7==0&&(p=0,h++),l[h][p]=i.clone().hour(a),i.hour(12)}return l},renderDropdowns:function(t,e,a){var r="";if(this.viewModes[this.minViewMode].ordinal<6){var n=t.month();r='<select class="monthselect">';for(var i=0;i<12;i++)(t.isAfter(e,"year")||i>=e.month())&&(t.isBefore(a,"year")||i<=a.month())&&(r+="<option value='"+i+"'"+(i===n?" selected='selected'":"")+">"+this.locale.monthNames[i]+"</option>");r+="</select>"}for(var l=t.year(),o=a&&a.year()||l+5,s='<select class="yearselect">',c=e&&e.year()||l-50;c<=o;c++)s+='<option value="'+c+'"'+(c===l?' selected="selected"':"")+">"+c+"</option>";return r+(s+="</select>")},renderCalendar:function(t,e,a,r){var n='<div class="calendar-date">';n+='<table class="table-condensed">',n+="<thead>",n+="<tr>",this.showWeekNumbers&&(n+="<th></th>");var i=t[1][1];!a||a.isBefore(i,"month")?n+='<th class="prev available"><i class="fa fa-arrow-left icon-arrow-left glyphicon glyphicon-arrow-left"></i></th>':n+="<th></th>";var l,o="";if(this.showDropdowns)o=this.renderDropdowns(i,a,r);else{var s=this.viewModes[this.minViewMode].monthYearFormat;o+=i.format(s)}n+='<th colspan="'+this.viewModes[this.minViewMode].monthYearColSpan+'" class="month">'+o+"</th>",!r||r.isAfter(i,"month")?n+='<th class="next available"><i class="fa fa-arrow-right icon-arrow-right glyphicon glyphicon-arrow-right"></i></th>':n+="<th></th>",n+="</tr>","days"==this.minViewMode&&(n+="<tr>",this.showWeekNumbers&&(n+='<th class="week">'+this.locale.weekLabel+"</th>"),v.each(this.locale.daysOfWeek,function(t,e){n+="<th>"+e+"</th>"}),n+="</tr>"),n+="</thead>",n+="<tbody>";for(var c=0;c<t.length;c++){n+="<tr>",this.showWeekNumbers&&this.viewModes[this.minViewMode].ordinal<6&&(n+='<td class="week">'+t[c][0].week()+"</td>");for(var u=0;u<t[c].length;u++){var d="available ";this.viewModes[this.minViewMode].ordinal<6&&(d+=t[c][u].month()==t[1][1].month()?"":"off"),a&&t[c][u].isBefore(a)||r&&t[c][u].isAfter(r)?d=" off disabled ":t[c][u].format("YYYY-MM-DD")==e.format("YYYY-MM-DD")?(d+=" active ",t[c][u].format("YYYY-MM-DD")==this.startDate.format("YYYY-MM-DD")&&(d+=" start-date "),t[c][u].format("YYYY-MM-DD")==this.endDate.format("YYYY-MM-DD")&&(d+=" end-date ")):t[c][u]>=this.startDate&&t[c][u]<=this.endDate&&(d+=" in-range ",t[c][u].isSame(this.startDate)&&(d+=" start-date "),t[c][u].isSame(this.endDate)&&(d+=" end-date ")),d+=" "+this.minViewMode;var m="r"+c+"c"+u;n+='<td class="'+d.replace(/\s+/g," ").replace(/^\s?(.*?)\s?$/,"$1")+'" data-title="'+m+'">'+t[c][u].format(this.viewModes[this.minViewMode].cellFormat)+"</td>"}n+="</tr>"}if(n+="</tbody>",n+="</table>",n+="</div>",this.timePicker){n+='<div class="calendar-time">',n+='<select class="hourselect">';var f=0,p=23,h=e.hour();for(this.timePicker12Hour&&(f=1,(p=12)<=h&&(h-=12),0===h&&(h=12)),l=f;l<=p;l++)n+=l==h?'<option value="'+l+'" selected="selected">'+l+"</option>":'<option value="'+l+'">'+l+"</option>";for(n+="</select> : ",n+='<select class="minuteselect">',l=0;l<60;l+=this.timePickerIncrement){var g=l;g<10&&(g="0"+g),l==e.minute()?n+='<option value="'+l+'" selected="selected">'+g+"</option>":n+='<option value="'+l+'">'+g+"</option>"}n+="</select> ",this.timePicker12Hour&&(n+='<select class="ampmselect">',12<=e.hour()?n+='<option value="AM">AM</option><option value="PM" selected="selected">PM</option>':n+='<option value="AM" selected="selected">AM</option><option value="PM">PM</option>',n+="</select>"),n+="</div>"}return n},remove:function(){this.container.remove(),this.element.off(".daterangepicker"),this.element.removeData("daterangepicker")},viewModes:{day:{ordinal:4,next:"month",prev:"hour",get:"date",duration:"days",monthYearFormat:"MMM YYYY",monthYearColSpan:5,defaultFormat:"MM/DD/YYYY",cellFormat:"D"},month:{ordinal:6,next:"year",prev:"day",get:"month",duration:"months",monthYearFormat:"YYYY",monthYearColSpan:2,defaultFormat:"MMM, YYYY",cellFormat:"MMM"}}},v.fn.daterangepicker=function(e,a){return this.each(function(){var t=v(this);t.data("daterangepicker")&&t.data("daterangepicker").remove(),t.data("daterangepicker",new r(t,e,a))}),this}}(window.jQuery,window.moment);var smbApp=angular.module("smbApp",["ngAnimate","ngResource","ngRoute","ngSanitize","ngTouch","toaster","LocalStorageModule","mgcrea.ngStrap","smart-table","angular-bootstrap-select","ng.shims.placeholder","ui.bootstrap","treeControl","highcharts-ng","ngFileUpload","pdfjsViewer","ngNumeraljs","daterangepicker","vs-repeat","dx"]).config(["$provide","$httpProvider","$routeProvider","$sceProvider","$datepickerProvider","localStorageServiceProvider","pdfjsViewerConfigProvider",function(t,e,a,r,n,i,l){t.factory("WithCredInterceptor",["$q",function(e){return{request:function(t){return t.withCredentials=!0,t},requestError:function(t){return canRecover(t)?responseOrNewPromise:e.reject(t)},response:function(t){return t},responseError:function(t){return canRecover(t)?responseOrNewPromise:e.reject(t)}}}]),e.interceptors.push("WithCredInterceptor"),r.enabled(!1),angular.extend(n.defaults,{dateFormat:"dd.MM.yyyy",modelDateFormat:"yyyy-MM-dd",startWeek:1,dateType:"string",autoclose:!0}),Highcharts.setOptions({lang:{drillUpText:"Назад к {series.name}"}}),i.setPrefix("smbApp"),moment.locale("ru"),numeral.language("ru"),Globalize.locale("ru"),l.setWorkerSrc("pdf-viewer/pdf.worker.js"),l.setCmapDir("pdf-viewer/cmaps"),l.setImageDir("images"),DevExpress.localization.locale("ru"),Date.prototype.toISODate||(Date.prototype.toISODate=function(){return this.getFullYear()+"-"+("0"+(this.getMonth()+1)).slice(-2)+"-"+("0"+this.getDate()).slice(-2)}),a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/signIn",{templateUrl:"views/signin.html",controller:"SigninCtrl"}).when("/physicalData",{templateUrl:"views/physicaldata.html",controller:"PhysicalDataCtrl"}).when("/economicalData",{templateUrl:"views/economicaldata.html",controller:"EconomicalDataCtrl"}).when("/costDay",{templateUrl:"views/costday.html",controller:"CostDayCtrl"}).when("/ratingDo",{templateUrl:"views/ratingDo.html",controller:"RatingDoCtrl"}).when("/contracts",{templateUrl:"views/contracts.html",controller:"ContractsCtrl"}).when("/psd",{templateUrl:"views/psddocuments.html",controller:"PsdDocumentsCtrl"}).when("/permitdocuments",{templateUrl:"views/permitdocuments.html",controller:"PermitDocumentsCtrl"}).when("/documents",{redirectTo:"/stub"}).when("/brigadeMovements",{redirectTo:"/stub"}).when("/productionPlan",{templateUrl:"views/productionplan.html",controller:"ProductionPlanCtrl",reloadOnSearch:!1}).when("/acceptancePlan",{templateUrl:"views/acceptanceplan.html",controller:"AcceptancePlanCtrl"}).when("/pvChart",{templateUrl:"views/pvchart.html",controller:"PvchartCtrl"}).when("/reload",{templateUrl:"views/reload.html",controller:"ReloadCtrl"}).when("/reports",{templateUrl:"views/reports.html",controller:"ReportsCtrl"}).when("/regulatorydocuments",{templateUrl:"views/regulatorydocuments.html",controller:"RegulatoryDocumentsCtrl"}).when("/stub",{templateUrl:"views/stub.html",controller:"StubCtrl"}).when("/style",{templateUrl:"views/style.html",controller:"StyleCtrl"}).when("/company/:companyUID",{templateUrl:"views/company.html",controller:"CompanyCtrl"}).when("/field/:companyUID/:fieldUID",{templateUrl:"views/field.html",controller:"FieldCtrl"}).when("/cluster/:companyUID/:fieldUID/:clusterUID",{templateUrl:"views/cluster.html",controller:"ClusterCtrl"}).when("/well/:companyUID/:fieldUID/:clusterUID/:wellUID",{templateUrl:"views/well.html",controller:"WellCtrl"}).when("/well/:companyUID/:fieldUID/:wellUID",{templateUrl:"views/well.html",controller:"WellCtrl"}).when("/contractor/:contractorUID/card",{templateUrl:"views/contractor.html",controller:"ContractorCtrl"}).when("/companiesChart/:attributeName",{templateUrl:"views/companies-chart.html",controller:"CompaniesChartCtrl"}).when("/fieldsChart/:attributeName/:companyUID",{templateUrl:"views/fields-chart.html",controller:"FieldsChartCtrl"}).when("/fieldChart/:attributeName/:companyUID/:fieldUID",{templateUrl:"views/field-chart.html",controller:"FieldChartCtrl"}).when("/wellsChart/:attributeName/:companyUID/:fieldUID",{templateUrl:"views/wells-chart.html",controller:"WellsChartCtrl"}).when("/clustersChart/:attributeName/:companyUID/:fieldUID",{templateUrl:"views/clusters-chart.html",controller:"ClustersChartCtrl"}).when("/companiesFinChart/:attributeName",{templateUrl:"views/companies-fin-chart.html",controller:"CompaniesFinChartCtrl"}).when("/fieldsFinChart/:attributeName/:companyUID",{templateUrl:"views/fields-fin-chart.html",controller:"FieldsFinChartCtrl"}).when("/fieldFinChart/:attributeName/:companyUID/:fieldUID",{templateUrl:"views/field-fin-chart.html",controller:"FieldFinChartCtrl"}).when("/wellsFinChart/:attributeName/:companyUID/:fieldUID",{templateUrl:"views/wells-fin-chart.html",controller:"WellsFinChartCtrl"}).when("/help",{templateUrl:"views/help.html",controller:"HelpCtrl"}).when("/test",{templateUrl:"views/test.html",controller:"TestCtrl"}).when("/testChart",{templateUrl:"views/test-chart.html",controller:"TestChartCtrl"}).when("/accessDenied",{templateUrl:"views/access-denied.html",controller:"AccessDeniedCtrl"}).when("/dashboardMailing",{templateUrl:"views/dashboard-mailing.html",controller:"DashboardMailingCtrl"}).when("/integrationManaging",{templateUrl:"views/integration-managing.html",controller:"IntegrationManagingCtrl"}).when("/chooseSettings",{templateUrl:"views/choose-settings.html",controller:"ChooseSettingsCtrl"}).when("/clear",{template:"",controller:"ClearCtrl"}).otherwise({redirectTo:"/"})}]);smbApp.run(["$templateCache","$http","$rootScope","$location","$q","localStorageService","logger","msg","authData","schedule","appStatus","dataManager","appSettings","referenceData","contractsDocumentsData","psdDocumentsData","permitDocumentsData","companiesData","companyData","structureData","companiesAttributesData","mapData","mapPointsData","refData","fieldsAttributesData","contractorsData","apiData","config","assemblyVersionService",function(t,e,r,n,i,a,l,o,s,c,u,d,m,f,p,h,g,v,D,y,b,C,w,I,N,_,Y,M,A){a.remove("permitDocuments"),a.remove("psdDocuments"),a.remove("companiesData"),a.remove("companyData"),a.remove("contracts"),a.remove("refData"),a.remove("referenceData"),a.remove("structureData"),a.remove("mapPointsData"),r.$on("$routeChangeSuccess",function(t,e,a){r.user&&l.routeChange(a&&a.scope?a.scope.page:"",n.path())}),r.isSpecificPage=function(){return-1!==["/signIn","/accessDenied"].indexOf(n.path())},M.getData().then(function(t){i.all([s.getData(),A.getAssemblyVersion()]).then(function(t){var e=t[0],a=t[1];r.assemblyVersion=a,l.login(),e&&e.Roles&&e.Roles.length||n.path("/accessDenied"),r.user=e,c.addUpdate(u),d.addDataResource(m),d.addDataResource(f),d.addDataResource(y),d.addDataResource(v),d.addDataResource(D),d.addDataResource(C),d.addDataResource(w),d.addDataResource(I),c.addUpdate(d),c.start(),i.all([v.getData(),_.getData()]).then(function(t){r.appLoaded=!0,Y.getWhatsNew().promise.then(function(t){t.data&&o.updateApp("note","Версия ПО была обновлена.","<span>Просмотреть список изменений.</span>",0,function(){window.open(M.getApiUrl()+"whats_new/content","_blank").focus()})})}),r.iframeUrl=M.getIframeUrl()+"?nohdr=true"},function(){r.appLoaded=!0,n.path("/accessDenied")})},function(t){r.appLoaded=!1})}]),angular.module("smbApp").controller("MainCtrl",["$scope","$location","$timeout","$q","mapPointsData","mapData","companiesData","authData",function(e,t,a,r,n,i,o,s){e.bErrorAuth=!1,e.bErrorCanView=!1,e.authData?e.authData.CanViewMap?(e.data={loaded:!1},e.getMap=function(t){var l=r.defer();return r.all([n.getData(),o.getData(),i.getData(),o.getActiveWellsCount()]).then(function(t){var e=t[2].data,a=_.cloneDeep(t[0]),r=o.getCompaniesActiveWellsCount();_.forEach(a,function(t){t.location.longitude=t.location.longitude-160});var n=_.map(a,function(t){var e=s.getRawData().AllowedDzo||[];return{id:t.id,name:o.getCompanyName(t.id),location:t.location,activeWellCount:r[t.id],labelDirection:t.labelDirection,barWidth:t.barWidth,disabled:-1===e.indexOf(t.id)}});n=_.filter(n,function(t){return null!==t.name}),console.log("companies for map"),console.log(n);var i={name:"Газпром Нефть",activeWellCount:t[3]};l.resolve([{type:"path",objects:topojson.feature(e,e.objects.russia).features},{type:"company",objects:n},{type:"company-info",objects:[i]}])}),e.data.loaded=!0,l.promise}):e.bErrorCanView=!0:e.bErrorAuth=!0}]),angular.module("smbApp").directive("smbMenu",function(){return{templateUrl:"views/directives/menu.html",restrict:"E",controller:["$scope","$element","$location","$q","authData","companiesData","contractorsData",function(n,t,e,a,r,i,l){n.page=e.path(),n.$on("$routeChangeSuccess",function(){n.page=e.path()}),n.authData=null,r.getData().then(function(t){n.authData=t}),n.searchDisabled=function(){return!(n.authData&&n.authData.CanSearch)},n.pageActive=function(t,e){switch(t){case"map":return"/"===e||_.find(["/company/","/field/","/well/"],function(t){return-1!==e.indexOf(t)});case"documents":return _.find(["/contracts","/psd","/permitdocuments","/regulatorydocuments"],function(t){return-1!==e.indexOf(t)});case"plans":return-1!==_.indexOf(["/productionPlan"],e);case"physicalData":return _.find(["/physicalData","/companiesChart/","/fieldsChart/","/fieldChart/","/wellsChart/"],function(t){return-1!==e.indexOf(t)});case"economicalData":return _.find(["/economicalData","/companiesFinChart/","/fieldsFinChart/","/fieldFinChart/","/wellsFinChart/"],function(t){return-1!==e.indexOf(t)});case"costDay":return _.find(["/costDay"],function(t){return-1!==e.indexOf(t)});case"ratingDo":return _.find(["/ratingDo"],function(t){return-1!==e.indexOf(t)});case"help":return-1!==_.indexOf(["/help"],e);case"reports":return-1!==_.indexOf(["/reports"],e);default:return!1}},n.pageDisabled=function(t){switch(t){case"map":return!(n.authData&&n.authData.CanViewMap);case"physicalData":return!(n.authData&&n.authData.CanViewPhysData);case"economicalData":return!(n.authData&&n.authData.CanViewFinData);case"costDay":return!(n.authData&&n.authData.CanViewFinPivot);case"ratingDo":return!(n.authData&&n.authData.CanViewDzoRating);case"documents":return!(n.authData&&(n.authData.CanViewAgreements||n.authData.CanViewPsd||n.authData.CanViewRd||n.authData.CanViewNmd));case"plans":return!(n.authData&&n.authData.CanViewPlanData);case"reports":return!(n.authData&&n.authData.CanViewReports);case"settings":return!(n.authData&&n.authData.CanViewSettings);case"help":return!(n.authData&&n.authData.CanViewHelp);default:return!1}},n.movePage=function(t){switch(t){case"/documents":return n.authData&&n.authData.CanViewAgreements?void e.path("/contracts"):n.authData&&n.authData.CanViewPsd?void e.path("/psd"):n.authData&&n.authData.CanViewRd?void e.path("/permitdocuments"):void e.path("/regulatorydocuments");case"/settings":return void e.path("/chooseSettings");default:e.path(t)}},n.searchItemFormat="{{name}}",a.all([i.getData(),l.getData()]).then(function(t){var e=i.getCompaniesNames();_.forEach(e,function(t){t.path="/company/"+t.UID,t.name="ДО: "+t.name});var a=[];console.log(t[1]),_.forEach(t[1],function(e){_.forEach(e.Lines,function(t){a.push({path:"/contractor/"+e.Id+"/card?lineId="+t.Id,name:"Подрядчик: "+e.Name+" ("+t.Name+")"})})});var r=i.getCompaniesObjects();r=_.map(r,function(t){return{path:"/well/"+t.companyUID+"/"+t.fieldUID+"/"+t.wellUID,name:"Скважина: "+t.fieldName+", "+("none"!==t.clusterUID?t.clusterName+", ":"")+t.wellName}})||[],n.searchObjects=_.sortBy(_.union(e,a,r),"name")}),n.selectSearch=function(t){console.log(t),t&&t.path&&e.url(t.path)}}]}}),angular.module("smbApp").controller("SigninCtrl",["$scope","msg","txt","$http","$location","$timeout","smbData",function(e,a,r,t,n,i,l){e.data={},e.error={},e.signIn=function(){var t=e.data;if(t.email||(e.error.wrongEmail=!0,a.pop("error",r.EmptyEmail,r.InputYourEmail)),t.password||(e.error.wrongPassword=!0,a.pop("error",r.EmptyPassword,r.InputYourPassword)),!t.email||!t.password)return!1;"demo"===t.email.toLowerCase()&&"demo"===t.password.toLowerCase()?($(".animated-logo-box").addClass("perspectiveUp"),$(".blue-cloth-left,.blue-cloth-right").fadeOut(700),$(".container").fadeOut(700,function(){e.$apply(function(){n.path("/")})})):a.pop("error",r.WrongEmail,r.EmailNotRegistered)},i(function(){$(".animated-shadow-box").toggleClass("animated-shadow"),$(".animated-logo-box").toggleClass("animated-logo"),$(".animated-logo-txt-box").toggleClass("animated-logo-txt")},400),l.getStructure()}]),angular.module("smbApp").service("msg",["toaster",function(i){var l=!1;return{pop:function(t,e,a,r,n){i.pop(t,e,a,r,"trustedHtml",n)},updateApp:function(t,e,a,r,n){l||i.pop(t,e,a,r,"trustedHtml",n),l=!0}}}]),angular.module("smbApp").constant("txt",{EmptyEmail:"Поле логин не заполнено",InputYourEmail:"Пожалуйста, введите логин",EmptyPassword:"Пароль не введён",InputYourPassword:"Пожалуйста, введите пароль",WrongEmail:"Проверьте поле логин",EmailNotRegistered:"Такой пользователь не зарегистрирован",WrongPassword:"Неправильный пароль",CheckWrongPassword:"Пожалуйста, введите правильный пароль"}),angular.module("smbApp").controller("HeadCtrl",["$scope",function(t){}]),angular.module("smbApp").controller("PhysicalDataCtrl",["$scope","$location","$q","$timeout","PhysicalData","chartSeriesColors","appSettings","utils","refData","physChartsData","apiData","xlsx","saveFile","authData",function(u,t,r,e,a,n,i,d,l,o,s,c,m,f){if(u.authData&&u.authData.CanViewPhysData){var p;u.$on("$destroy",function(){l.removeUpdateDataCallback(v),g()}),u.planFactChatsColors=n.planFactChatsColors,u.factChatsColor=n.factChatsColor,u.onlyFactChatsColor=[u.factChatsColor[1]],u.filter={wellState:1,timeKey:"month",timeCount:0,drillType:0,viewMode:0,showValues:!0},u.data={error:null,loaded:!1,chartsLoaded:!1,chartsData:null,params:[],physCharts:[]},(p=i.getSettings("app"))&&angular.extend(u.filter,p),u.$watch("filter",function(){g()},!0),v(),u.$watch("filter.wellState",function(t,e){t!==e&&D()}),u.$watch("filter.timeKey",function(t,e){t!==e&&D()}),u.$watch("filter.timeCount",function(t,e){t!==e&&D()}),u.$watch("filter.drillType",function(t,e){t!==e&&D()});var h=null;u.splittedParam=function(t){var e=_.find(u.data.physCharts,{Id:t});return e&&e.Parameters&&1<e.Parameters.length},u.getExcel=function(){var t=["eb","zbs","prb"],e=["undefined","drilling","drilled","builded","active"],a=_.filter(u.data.physCharts,function(t){return-1!==t.DrillTypes.indexOf(u.filter.drillType)});a=_.filter(a,function(t){return-1!==t.WellStates.indexOf(u.filter.wellState)});_.sortBy(a,"Order");var r=[];_.forEach(a,function(t){_.forEach(t.Parameters,function(t){r.push(t.Id)})});var n,i,l="parameter="+r.join("&parameter="),o=null;switch(u.filter.timeKey){case"month":o="Month",n=moment().startOf("month").subtract(2-u.filter.timeCount,"months"),i=moment().startOf("month").subtract(-1-u.filter.timeCount,"months").subtract(1,"day"),n.format("YYYY-MM-DD")<"2013-01-01"&&(n=moment("2013-01-01"));break;case"quarter":o="Quarter",n=moment().startOf("quarter").subtract(2-u.filter.timeCount,"quarters"),i=moment().startOf("quarter").subtract(-1-u.filter.timeCount,"quarters").subtract(1,"day"),n.format("YYYY-MM-DD")<"2013-01-01"&&(n=moment("2013-01-01"));break;case"year":o="Year",n=moment().startOf("year").subtract(2-u.filter.timeCount,"years"),i=moment().startOf("year").subtract(-1-u.filter.timeCount,"years").subtract(1,"day"),n.format("YYYY-MM-DD")<"2013-01-01"&&(n=moment("2013-01-01"))}if(n=n.format("YYYY-MM-DD"),i=i.format("YYYY-MM-DD"),4===u.filter.wellState)var s="/crsreport/api/physreport/0/"+t[u.filter.drillType]+"/"+e[u.filter.wellState]+"/2006-06-12/2100-01-01?periodBy="+o+"&"+l;else s="/crsreport/api/physreport/0/"+t[u.filter.drillType]+"/"+e[u.filter.wellState]+"/"+n+"/"+i+"?periodBy="+o+"&"+l;window.open(s,"_blank").focus()}}else t.path("/main");function g(){var t={drillType:u.filter.drillType,wellState:u.filter.wellState,timeKey:u.filter.timeKey,showValues:u.filter.showValues,timeCount:u.filter.timeCount};i.setSettings("app",t)}function v(){r.all([o.getData()]).then(function(t){e(function(){u.data.physCharts=t[0],D(),u.data.loaded=!0},400)})}function D(){u.data.chartsLoaded=!1,u.data.error=null,u.data.chartsData={},u.data.params=[],h&&h.reject("cancel");var e=_.filter(u.data.physCharts,function(t){return-1!==t.DrillTypes.indexOf(u.filter.drillType)});e=_.filter(e,function(t){return-1!==t.WellStates.indexOf(u.filter.wellState)});_.sortBy(e,"Order");var a=[];_.forEach(e,function(t){_.forEach(t.Parameters,function(t){a.push(t.Id)})}),h=s.getMainCompanyData(u.filter.drillType,u.filter.timeKey,u.filter.timeCount,u.filter.wellState,a),r.all([h.promise]).then(function(t){var c=t[0].data;u.data.params=_.pluck(e,"Id"),_.forEach(u.data.params,function(t){var e=_.find(u.data.physCharts,{Id:t});if(u.splittedParam(t)){var a=_.find(c,{Parameter:t+"Nns"}),r=_.find(c,{Parameter:t+"Gs"}),n=a&&a.Objects,i=a&&r.Objects,l={uom:e&&e.Uom,displayName:e&&e.Name,format:(a||r).Format,yAxisTitle:" ",subXAxisTitles:["ННС","ГС"],values:[]},o=_.unique(_.union(n,i),function(t){return""+t.Year+t.Quarter+d.pad(t.Month,2)});o=_.sortBy(o,function(t){return""+t.Year+t.Quarter+d.pad(t.Month,2)}),_.forEach(o,function(t){var e=_.find(n,{Year:t.Year,Quarter:t.Quarter,Month:t.Month}),a=_.find(i,{Year:t.Year,Quarter:t.Quarter,Month:t.Month});l.values.push({title:d.getObjectTimeTitle(e||a),points:"year"===u.filter.timeKey?[{values:e?[{val:e.Value}]:[null]},{values:a?[{val:a.Value}]:[null]}]:[{values:e?[{val:e.PrevValue},{val:e.Value}]:[null,null]},{values:a?[{val:a.PrevValue},{val:a.Value}]:[null,null]}]})}),u.data.chartsData[t]=l}else{var s=_.find(c,{Parameter:t});l={uom:e&&e.Uom,displayName:e&&e.Name,format:s&&s.Format,yAxisTitle:" ",values:[]};s.Objects=_.sortBy(s&&s.Objects,function(t){return""+t.Year+t.Quarter+d.pad(t.Month,2)}),_.forEach(s&&s.Objects,function(t){l.values.push({title:d.getObjectTimeTitle(t),points:"year"===u.filter.timeKey?[{values:[{val:t.Value}]}]:[{values:[{val:t.PrevValue},{val:t.Value}]}]})}),u.data.chartsData[t]=l}}),console.log(u.data.chartsData),u.data.chartsLoaded=!0,u.data.error=null},function(t){"cancel"!==t&&(u.data.chartsLoaded=!0,u.data.error=t)})}}]),angular.module("smbApp").controller("EconomicalDataCtrl",["$scope","$location","$q","$timeout","apiData","chartSeriesColors","appSettings","utils","xlsx","saveFile","authData","config",function(p,t,e,a,r,n,i,h,l,o,s,c){if(p.authData&&p.authData.CanViewFinData){var u;p.$on("$destroy",function(){f()}),p.planFactChatsColors=n.planFactChatsColors,p.factChatsColor=n.factChatsColor,p.onlyFactChatsColor=[p.factChatsColor[1]],p.filter={wellState:1,timeKey:"month",timeCount:0,drillType:0,viewMode:0,showValues:!0},p.data={error:null,loaded:!1,chartsLoaded:!1,chartsData:null,params:[],finCharts:[]},(u=i.getSettings("app"))&&angular.extend(p.filter,u),p.$watch("filter",function(){f()},!0),e.all([r.getFinCharts().promise]).then(function(t){a(function(){g(),p.data.finCharts=t[0].data,p.data.loaded=!0},400)}),p.$watch("filter.wellState",function(t,e){t!==e&&g()}),p.$watch("filter.timeKey",function(t,e){t!==e&&g()}),p.$watch("filter.timeCount",function(t,e){t!==e&&g()}),p.$watch("filter.drillType",function(t,e){t!==e&&g()}),p.getAttributeFullName=function(e){var t=_.find(p.data.finCharts,function(t){return t.Parameters[0].Id.replace("Gs","").replace("Nns","")===e});return t?t.Name:e},p.getAttributeMUnit=function(e){var t=_.find(p.data.finCharts,function(t){return t.Parameters[0].Id.replace("Gs","").replace("Nns","")===e});return t?t.Parameters[0].Uom:e};var d=null,m=null;p.getParamLink=function(t){return s.singleCompany()?"#/fieldsFinChart/"+t+"/"+s.getCompanyUID():"#/companiesFinChart/"+t},p.getExcel=function(){var t=["eb","zbs","prb"],e=["undefined","drilling","drilled","builded","active"],a=[];_.forEach(p.data.params,function(t){a.push("Nns"+t),a.push("Gs"+t)}),a="parameter="+a.join("&parameter=");var r,n,i=null;switch(p.filter.timeKey){case"month":i="Month",r=moment().startOf("month").subtract(2-p.filter.timeCount,"months"),n=moment().startOf("month").subtract(-1-p.filter.timeCount,"months").subtract(1,"day"),r.format("YYYY-MM-DD")<"2013-01-01"&&(r=moment("2013-01-01"));break;case"quarter":i="Quarter",r=moment().startOf("quarter").subtract(2-p.filter.timeCount,"quarters"),n=moment().startOf("quarter").subtract(-1-p.filter.timeCount,"quarters").subtract(1,"day"),r.format("YYYY-MM-DD")<"2013-01-01"&&(r=moment("2013-01-01"));break;case"year":i="Year",r=moment().startOf("year").subtract(2-p.filter.timeCount,"years"),n=moment().startOf("year").subtract(-1-p.filter.timeCount,"years").subtract(1,"day"),r.format("YYYY-MM-DD")<"2013-01-01"&&(r=moment("2013-01-01"))}if(r=r.format("YYYY-MM-DD"),n=n.format("YYYY-MM-DD"),4===p.filter.wellState)var l=c.getApiUrl()+"finreport/0/"+t[p.filter.drillType]+"/"+e[p.filter.wellState]+"/2006-06-12/2100-01-01?targetObject=Gpn&periodBy="+i+"&"+a;else l=c.getApiUrl()+"finreport/0/"+t[p.filter.drillType]+"/"+e[p.filter.wellState]+"/"+r+"/"+n+"?targetObject=Gpn&periodBy="+i+"&"+a;console.log(l),window.open(l,"_blank").focus()},p.openSettings=function(){window.open("/CrsReport/Default.aspx?singleModuleName=CostCategory","_blank").focus()}}else t.path("/main");function f(){var t={drillType:p.filter.drillType,wellState:p.filter.wellState,timeKey:p.filter.timeKey,viewMode:p.filter.viewMode,showValues:p.filter.showValues,timeCount:p.filter.timeCount};i.setSettings("app",t)}function g(){p.data.chartsLoaded=!1,p.data.error=null,p.data.chartsData={},p.data.params=[],d&&d.reject("cancel"),m&&m.reject("cancel"),(d=r.getFinParamList()).promise.then(function(t){return t.data}).then(function(t){var e=_.pluck(t,"Id");return(m=r.getMainCompanyFinData(p.filter.drillType,p.filter.timeKey,p.filter.timeCount,p.filter.wellState,e)).promise}).then(function(t){return t.data}).then(function(m){var f=_.pluck(m,"Parameter");f=_.map(f,function(t){return t.replace("Gs","").replace("Nns","")}),f=_.unique(f),p.data.params=f,_.forEach(f,function(t){var e=_.find(m,{Parameter:"Nns"+t}),a=_.find(m,{Parameter:"Gs"+t}),r=e.Objects,n=a.Objects,i={format:(e||a).Format,yAxisTitle:" ",subXAxisTitles:["ННС","ГС"],values:[]},l=_.unique(_.union(r,n),function(t){return""+t.Year+t.Quarter+h.pad(t.Month,2)});l=_.sortBy(l,function(t){return""+t.Year+t.Quarter+h.pad(t.Month,2)}),"704AF9E4-E562-421A-BF02-BA28DF8BC0A1"===t?_.forEach(l,function(o){var s=[],c=[],u=[],d=[];_.forEach(f,function(t){if("704AF9E4-E562-421A-BF02-BA28DF8BC0A1"!==t){var e=_.find(m,{Parameter:"Nns"+t}),a=_.find(m,{Parameter:"Gs"+t}),r=e.Objects,n=a.Objects,i=_.find(r,{Year:o.Year,Quarter:o.Quarter,Month:o.Month}),l=_.find(n,{Year:o.Year,Quarter:o.Quarter,Month:o.Month});i&&i.Value?s.push({val:i.Value,label:p.getAttributeFullName(t)}):s.push({val:0}),i&&i.PrevValue?u.push({val:i.PrevValue,label:p.getAttributeFullName(t)}):u.push({val:0}),l&&l.Value?c.push({val:l.Value,label:p.getAttributeFullName(t)}):c.push({val:0}),l&&l.PrevValue?d.push({val:l.PrevValue,label:p.getAttributeFullName(t)}):d.push({val:0})}});var t=_.find(r,{Year:o.Year,Quarter:o.Quarter,Month:o.Month}),e=_.find(n,{Year:o.Year,Quarter:o.Quarter,Month:o.Month});i.values.push({title:h.getObjectTimeTitle(t||e),points:"year"===p.filter.timeKey?[{values:[{val:s,color:t&&t.Color}]},{values:[{val:c,color:e&&e.Color}]}]:[{values:[{val:u,color:t&&t.PrevColor},{val:s,color:t&&t.Color}]},{values:[{val:d,color:e&&e.PrevColor},{val:c,color:e&&e.Color}]}]})}):_.forEach(l,function(t){var e=_.find(r,{Year:t.Year,Quarter:t.Quarter,Month:t.Month}),a=_.find(n,{Year:t.Year,Quarter:t.Quarter,Month:t.Month});i.values.push({title:h.getObjectTimeTitle(e||a),points:"year"===p.filter.timeKey?[{values:e?[{val:e.Value,color:e.Color}]:[null]},{values:a?[{val:a.Value,color:a.Color}]:[null]}]:[{values:e?[{val:e.PrevValue,color:e.PrevColor},{val:e.Value,color:e.Color}]:[null,null]},{values:a?[{val:a.PrevValue,color:a.PrevColor},{val:a.Value,color:a.Color}]:[null,null]}]})}),p.data.chartsData[t]=i}),p.data.chartsLoaded=!0,p.data.error=null}).catch(function(t){"cancel"!==t&&(p.data.chartsLoaded=!0,p.data.error=t)})}}]),angular.module("smbApp").controller("CostDayCtrl",["$scope","$location","$q","$timeout","apiData","chartSeriesColors","appSettings","utils","xlsx","saveFile","authData",function(l,t,a,e,r,n,i,o,s,c,u){if(l.authData&&l.authData.CanViewFinPivot){var d;l.$on("$destroy",function(){f()}),l.ChangeRowsColumns=function(){if(l.data.loaded){var t=l.pivotGridDataSource.fields();console.log("ChangeRowsColumns"),console.log(t);for(var e=[],a=0;a<t.length;a++){var r=t[a];console.log(r),"column"==r.area?r.area="row":"row"==r.area&&(r.area="column"),e.push(r)}var n=$("#costdayGrid"),i=($("#costdayChart"),n.dxPivotGrid("instance"));if($("#costdayChart").dxChart("instance")&&i)l.pivotGridDataSource=new DevExpress.data.PivotGridDataSource({fields:e,store:l.data.serverData.data}),g(),$("#costdayFieldChooser").dxPivotGridFieldChooser("instance").repaint()}},l.planFactChatsColors=n.planFactChatsColors,l.factChatsColor=n.factChatsColor,l.onlyFactChatsColor=[l.factChatsColor[1]],l.filter={wellState:1,timeKey:"month",timeCount:0,drillType:0,viewMode:0,showValues:!0},l.data={error:null,loaded:!1,chartsLoaded:!1,serverData:{fields:[],data:[]}},(d=i.getSettings("app"))&&angular.extend(l.filter,d),l.$watch("filter",function(){f()},!0),l.accordionOptions={items:[{title:"График",visible:!0,template:"chartAcc"},{title:"Таблица",visible:!0,template:"tableAcc"}],itemTemplate:"customer",collapsible:!0,multiple:!0},l.bShowChart=!0,l.bShowTable=!0,l.ChangeChartVisible=function(){l.bShowChart=!l.bShowChart,p()},l.ChangeTableVisible=function(){l.bShowTable=!l.bShowTable,p()},l.pivotGridDataSource=new DevExpress.data.PivotGridDataSource({fields:l.data.serverData.fields,store:l.data.serverData.data}),D(),v(),h();var m=null;l.$watch("filter.wellState",function(t,e){t!==e&&h()}),l.$watch("filter.timeKey",function(t,e){t!==e&&h()}),l.$watch("filter.timeCount",function(t,e){t!==e&&h()}),l.$watch("filter.drillType",function(t,e){t!==e&&h()})}else t.path("/main");function f(){var t={drillType:l.filter.drillType,wellState:l.filter.wellState,timeKey:l.filter.timeKey,viewMode:l.filter.viewMode,showValues:l.filter.showValues,timeCount:l.filter.timeCount};i.setSettings("app",t)}function p(){l.bShowChart&&setTimeout(function(){$("#costdayChart").dxChart("instance").render()},300)}function h(){m&&m.reject("cancel"),l.data.loaded=!1,l.data.chartsLoaded=!1;var e=m=a.defer();a.all([r.getCostDay(l.filter.drillType,l.filter.timeKey,l.filter.wellState,l.filter.timeCount).promise]).then(function(t){console.log(t[0].data),e.resolve(t)},function(t){e.reject(t)}),e.promise.then(function(t){var e=t[0].data.fields;e.push({area:"data",caption:"НПВ, %",format:"#,##0.0#",summaryType:"custom",displayFolder:"КПЭ",calculateCustomSummary:function(t){"start"===t.summaryProcess&&(t.balanceDuration=0,t.npvDuration=0),"calculate"===t.summaryProcess&&(t.balanceDuration+=t.value.balanceDuration,t.npvDuration+=t.value.npvDuration),"finalize"===t.summaryProcess&&(t.totalValue=0<t.balanceDuration?t.npvDuration/t.balanceDuration*100:0)}}),e.push({area:"data",caption:"Скорость бурения, сут/1000м",format:"#,##0.0#",summaryType:"custom",displayFolder:"КПЭ",calculateCustomSummary:function(t){if("start"===t.summaryProcess&&(t.balanceDuration=0,t.penetration=0),"calculate"===t.summaryProcess&&(t.balanceDuration+=t.value.balanceDuration,t.penetration+=t.value.penetration),"finalize"===t.summaryProcess&&0<t.penetration){var e=t.penetration/1e3;t.totalValue=t.balanceDuration/e}}}),e.push({area:"data",caption:"Коэфиициент аварийности, ав/1000м",format:"#,##0.0#",summaryType:"custom",displayFolder:"КПЭ",calculateCustomSummary:function(t){if("start"===t.summaryProcess&&(t.incidentCount=0,t.penetration=0),"calculate"===t.summaryProcess&&(t.incidentCount+=t.value.incidentCount,t.penetration+=t.value.penetration),"finalize"===t.summaryProcess)if(0<t.penetration){var e=t.penetration/1e3;t.totalValue=t.incidentCount/e}else t.totalValue=0}}),e.push({area:"data",caption:"Коэфиициент аварийности, ч/1000м",format:"#,##0.0#",summaryType:"custom",displayFolder:"КПЭ",calculateCustomSummary:function(t){if("start"===t.summaryProcess&&(t.incidentDuration=0,t.penetration=0),"calculate"===t.summaryProcess&&(t.incidentDuration+=t.value.incidentDuration,t.penetration+=t.value.penetration),"finalize"===t.summaryProcess)if(0<t.penetration){var e=t.penetration/1e3;t.totalValue=24*t.incidentDuration/e}else t.totalValue=0}}),l.data.serverData.fields=t[0].data.fields;for(var a=0;a<t[0].data.fields.length;a++)"number"==t[0].data.fields[a].dataType&&(t[0].data.fields[a].format="#,###.##");l.data.serverData.data=t[0].data.data,l.pivotGridDataSource=new DevExpress.data.PivotGridDataSource({fields:l.data.serverData.fields,store:l.data.serverData.data}),g(),setTimeout(p(),1e3)},function(t){"cancel"!==t&&(l.data.chartsLoaded=!0,l.data.error=t)})}function g(){l.data.error=null,D(),v();var t=$("#costdayGrid").dxPivotGrid("instance"),e=$("#costdayChart").dxChart("instance");e&&t&&(t.option(l.pivotGridOptions),t.bindChart(e),l.fieldChooserOptions={dataSource:l.pivotGridDataSource,texts:{allFields:"Все поля",columnFields:"Столбцы",dataFields:"Данные",rowFields:"Строки",filterFields:"Фильтр"},layout:1,width:400,height:800},$("#costdayFieldChooser").dxPivotGridFieldChooser("instance").option(l.fieldChooserOptions));l.data.loaded=!0,l.data.chartsLoaded=!0}function v(){l.chartOptions={commonSeriesSettings:{type:"bar"},legend:{verticalAlignment:"bottom",horizontalAlignment:"center",itemTextPosition:"right",visible:"true"},tooltip:{enabled:!0,customizeTooltip:function(t){var e=t.originalValue,a="number"==typeof e?Math.round(100*e)/100:e;return{html:t.seriesName+"<div class='currency'>"+a+"</div>"}}},onInitialized:function(t){}}}function D(){l.pivotGridOptions={allowSorting:!0,allowSortingBySummary:!0,allowFiltering:!0,showBorders:!0,showColumnGrandTotals:!1,showScrollbar:!0,showRowGrandTotals:!1,showRowTotals:!1,showColumnTotals:!1,height:480,fieldChooser:{enabled:!1},onInitialized:function(t){},dataSource:l.pivotGridDataSource}}}]),angular.module("smbApp").controller("DashboardMailingCtrl",["$scope","$location","apiData",function(n,t,r){function a(t){!function(t){for(var e=0;e<t.length;e++)t[e].times="",t[e].frequency=1}(n.data.tableData),t.data&&_.forEach(t.data,function(e){var a,t,r=_.find(n.data.tableData,function(t){return t.id===e.Report});r.times=(a=e.Times,t=a.replace(/\s/g,"").split(";"),_.forEach(t,function(t){if(t){var e=moment.utc(t,"HH:mm").local().format("HH:mm");a=a.replace(t,e)}}),a),r.frequency=e.Frequency}),n.data.isNodeSelected=!0}n.authData&&n.authData.CanViewSettings?(n.data={loaded:!1,error:!1,profiles:[],selectedItem:null,tableData:[{id:1,reportName:"Рейтинг ДО по бурению",frequency:1},{id:2,reportName:"КПЭ по бурению",frequency:1}]},n.onItemSelectionChanged=function(t){if(t.itemData.parentId){var e=t.itemData.id.replace(t.itemData.parentId+"_","");r.getMailingSettingsById(1,e).then(a).finally(function(){n.data.selectedItem={id:e,source:1}})}else r.getMailingSettingsById(2,t.itemData.id).then(a).finally(function(){n.data.selectedItem={id:t.itemData.id,source:2}})},n.onSettingsUpdated=function(t){var e=n.data.selectedItem,a=_.map(n.data.tableData,function(t){return{Report:t.id,Times:(a=t.times,e=a.replace(/\s/g,"").split(";"),_.forEach(e,function(t){if(t){var e=moment(t,"HH:mm").utc().format("HH:mm");a=a.replace(t,e)}}),a),Frequency:t.frequency};var a,e});r.createUserMailingSettings(e.source,e.id,a)},n.treeViewOptions={dataSource:n.data.profiles,bindingOptions:{dataSource:{dataPath:"data.profiles"}},onItemClick:n.onItemSelectionChanged,searchMode:"contains",searchEnabled:!0},n.dataGridOptions={keyExpr:"id",columnAutoWidth:!0,bindingOptions:{dataSource:{deep:!0,dataPath:"data.tableData"}},onToolbarPreparing:function(t){var e=t.toolbarOptions.items;_.forEach(e,function(t){"saveButton"!=t.name&&"revertButton"!=t.name||(t.visible=!1)})},paging:{enabled:!1},editing:{mode:"row",allowUpdating:!0},columns:[{dataField:"reportName",caption:"Название отчета",allowEditing:!1,width:"20%"},{dataField:"frequency",caption:"Частота рассылки",width:"20%",lookup:{dataSource:[{ID:1,Name:"Ежедневно"},{ID:2,Name:"Еженедельно"},{ID:3,Name:"Ежемесячно"}],displayExpr:"Name",valueExpr:"ID"}},{dataField:"times",caption:"Время рассылки",width:"40%",validationRules:[{type:"pattern",pattern:/^(((?:([01]|)\d|2[0-3]):[0-5]\d( |)(;|)( |)){1,}$)/,message:"Укажите часы отправки. Пример: 8:00;12:00"}]}],onRowUpdated:n.onSettingsUpdated},r.getProfiles().then(function(t){n.data.profiles=_.map(t.data,function(t){return function e(t,a){var r=t.Id;return a&&(r=a+"_"+r),{id:r,parentId:a,text:t.Name,items:_.map(t.Users,function(t){return e(t,r)})||null}}(t,null)})}).finally(function(){n.data.loaded=!0})):t.path("/main")}]),angular.module("smbApp").controller("IntegrationManagingCtrl",["$scope","$location","$modal","apiData","msg","config",function(n,t,e,a,r,i){function l(){n.data.loaded=!1,a.getIntegrationLogs().catch(function(){r.pop("error","Ошибка запроса","Не удалось загрузить сообщения",0)}).then(function(t){if(t.data){n.data.integrationLogs=t.data;for(var e=0;e<t.data.length;e++){n.data.integrationLogs[e].position=e+1;var a=new Date(n.data.integrationLogs[e].StartDate),r=new Date(Date.UTC(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds()));n.data.integrationLogs[e].StartDate=r.toLocaleString()}}}).finally(function(){n.data.loaded=!0})}n.authData&&n.authData.CanViewSettings?(n.data={loaded:!1,error:!1,integrationLogs:null,integrations:[{id:"628FD428-DCAB-4676-8D41-0A1750BD9BE8",name:"Веб-служба интеграции САПФИР"},{id:"46AF79BC-0DEF-4056-9353-6AEF48B4C18C",name:"Эра-ремонты"},{id:"4FCAC4D9-76C4-4743-882C-46D85BC6CDFB",name:"СМБ"}]},n.downloadErrorLog=function(t){window.open(i.getApiUrl()+"integration/logs/"+t,"_blank").focus()},n.refreshLogs=function(){l()},n.openIntegrations=function(){n.integrationsModal=e({scope:n,template:"views/modals/integration-selector.html",show:!1,animation:"am-fade-and-slide-top"}),n.integrationsModal.$promise.then(n.integrationsModal.show)},n.runIntegration=function(t){a.runIntegration(t).catch(function(){r.pop("error","Ошибка запроса","Вызов интеграции завершился с ошибкой",0)}).then(l),n.integrationsModal.$promise.then(n.integrationsModal.hide)},n.dataGridOptions={columnAutoWidth:!0,showBorders:!0,filterRow:{visible:!0},columnMinWidth:70,paging:{pageSize:20},pager:{showPageSizeSelector:!0,allowedPageSizes:[5,10,20,50,0],showInfo:!0},bindingOptions:{dataSource:{deep:!0,dataPath:"data.integrationLogs"}},columns:[{dataField:"position",caption:"#",alignment:"left"},{dataField:"StartDate",caption:"Дата начала"},{dataField:"Duration",caption:"Длительность (с)",alignment:"left",dataType:"number"},{dataField:"Status",caption:"Статус",cellTemplate:"statusTemplate"},{dataField:"UpdatedRows",caption:"Записей обновлено",alignment:"left",dataType:"number"},{dataField:"Message",caption:"Сообщение"},{dataField:"ServiceName",caption:"Имя интегрируемой системы"}]},l()):t.path("/main")}]),angular.module("smbApp").controller("RatingDoCtrl",["$scope","$location","$q","$timeout","apiData","chartSeriesColors","appSettings","companiesData","utils","xlsx","saveFile","authData",function(h,t,l,e,o,a,r,n,i,s,c,u){if(h.authData&&h.authData.CanViewDzoRating){h.$on("$destroy",function(){f()}),h.data={error:null,loaded:!1,firstLoaded:!1,chartsLoaded:!1,companies:[],serverData:{AllowedParams:[],Data:[]},newDoYearData:[],selectedDoYear:null,dataSource:[],dataSourceMarks:[],newAllData:[],dzoMarks:[]},h.bCellIsSelected=!1,h.selectedCell=null,h.planFactChatsColors=a.planFactChatsColors,h.factChatsColor=a.factChatsColor,h.onlyFactChatsColor=[h.factChatsColor[1]],h.canSave=!1,h.filter={timeKeyYear:"year",timeCountYear:0,timeKeyMarks:"year",timeCountMarks:0,year:(new Date).getFullYear(),_viewMode:1,companyUID:null,companyName:null},Object.defineProperty(h.filter,"viewMode",{get:function(){return this._viewMode},set:function(t){this._viewMode=t,h.data.loaded&&0==t&&S(!0)}}),h.chartOptions=[],h.gridOptions=null,h.gridMarksOptions=null,h.charts=[],h.monthNames=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"],h.monthFullNames=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],h.marks=[{MarkName:"Итоговое место в рейтинге",MarkId:"FinalPlace",ParentId:null},{MarkName:"Итоговый балл",MarkId:"FinalPoints",ParentId:null},{MarkName:"LTIF {month2} {year} г.",MarkId:"Ltif",ParentId:null},{MarkName:"Балл за LTIF",MarkId:"LtifPoints",ParentId:"Ltif"},{MarkName:"Прирост добычи от ввода новых скважин ({year}/ БП {year})",MarkId:"Grow",ParentId:null},{MarkName:"Балл за изменение прироста добычи",MarkId:"GrowPoints",ParentId:"Grow"},{MarkName:"Изменение показателя руб./тонну ({year}г/ БП {year}г),%",MarkId:"PriceDelta",ParentId:null},{MarkName:"Балл за изменение показателя руб./тонну",MarkId:"PriceDeltaPoints",ParentId:"PriceDelta"},{MarkName:"Изменение показателя сут./1000 м ({year}г/{yearBefore}г),%",MarkId:"DepthDelta",ParentId:null},{MarkName:"Балл за изменение показателя сут./1000м",MarkId:"DepthDeltaPoints",ParentId:"DepthDelta"},{MarkName:"Количество реализованный идей "+String.fromCharCode(13)+"{month2} {year}, идей/100 чел.",MarkId:"IdeaCnt",ParentId:null},{MarkName:"Балл за количество реализованный идей/чел.",MarkId:"IdeaCntPoints",ParentId:"IdeaCnt"},{MarkName:"Количество смертельных несчастных случаев "+String.fromCharCode(13)+"{month2} {year}",MarkId:"DeathCnt",ParentId:null}],h.marksTitleConst="Рейтинг ДО по бурению за {month2} {year} г.",h.marksTitle="Рейтинг ДО по бурению";var d,y={Name:"LostTime",Caption:"Потерянное время",ParamId:"30D389F8-1445-4965-8ACA-FBA9D8FF9017".toLowerCase()},b={Name:"WorkedTime",Caption:"Суммарное отработанное время",ParamId:"147711E5-2969-4244-996A-157A67518214".toLowerCase()},C={Name:"FatalAccident",Caption:"Смертельных случаев",ParamId:"E377B2A9-1A0A-441B-AE38-821182EC35FB".toLowerCase()},w={Name:"IncreaseProductionNewWells",Caption:"Прирост добычи от ввода новых скважин",ParamId:"7DA4FA3F-A86B-4383-A351-DBA09B978F8A".toLowerCase()},I={Name:"IncreaseProductionNewWellsBP",Caption:"Прирост добычи от ввода новых скважин БП",ParamId:"A903D22F-9A66-46B3-9D86-0777F40E6D7D".toLowerCase()},N={Name:"IncreaseRate",Caption:"Прирост руб/тонну",ParamId:"09E2A374-10A9-423D-9BB6-B1412C241EB6".toLowerCase()},Y={Name:"IncreaseRateBP",Caption:"Прирост руб/тонну БП",ParamId:"7821D898-02E7-4AB3-AC4D-6B4BB5EEA384".toLowerCase()},M={Name:"DrillSpeed",Caption:"Скорость бурения",ParamId:"ACC93388-7356-4960-8FA1-6040DE6B5CD0".toLowerCase()},A={Name:"ImplementedIdeas",Caption:"Реализовано идей",ParamId:"826DE463-D101-4AFA-B8B7-3C638BDFB1A8".toLowerCase()};(d=r.getSettings("app"))&&(angular.extend(h.filter,d),h.filter.timeKeyYear="year"),U(),O(),j(),S();var m=null;h.$watch("filter",function(){f()},!0),h.$watch("filter.timeCountYear",function(t,e){t!==e&&S()}),h.$watch("filter.companyUID",function(t,e){t!==e&&S()}),h.$watch("filter.timeKeyMarks",function(t,e){t!==e&&P()}),h.$watch("filter.timeCountMarks",function(t,e){t!==e&&P()}),h.getCompanyName=function(){var t=_.find(h.data.companies,{UID:h.filter.companyUID});return t?t.name:""},h.Save=function(){console.log("Save");var e=k(!0),a=m=l.defer();l.all([o.saveRatingDo(e).promise]).then(function(t){a.resolve(t)},function(t){a.reject(t)}),h.canSave=!1,a.promise.then(function(t){console.log("сохранено"),_.forEach(h.data.newDoYearData,function(t){t.bIsChanged=!1}),h.data.serverData.Data=e,h.data.newAllData=e,h.undo=JSON.stringify(h.data)})},h.Undo=function(){console.log("undo");var t=JSON.parse(h.undo);h.data=t,S(!(h.canSave=!1))},h.LoadCellData=function(){console.log("LoadCellData");var t=h.selectedCell;if(null!=t){var r=t.data,n=t.column.dataField,i=n.substr(1),e=h.monthFullNames[i-1];if(confirm('Загрузить данные для параметра "'+r.ParamName+'" за месяц '+e+", "+h.filter.year+"г., "+h.filter.companyName+"? ")){var a=m=l.defer();l.all([o.loadRatingDoMonthData(h.filter.companyUID,h.filter.year,i,r.ParamId).promise]).then(function(t){a.resolve(t)},function(t){a.reject(t)}),a.promise.then(function(t){if(t[0].data&&t[0].data[0]&&t[0].data[0].MonthValues&&t[0].data[0].MonthValues.length){var e=_.find(t[0].data[0].MonthValues,function(t){return t.Month==i});if(e){var a=e.Value;r[n]=a,g(r),F()}}})}}},h.openRatingDoMarks=function(){console.log("openRatingDoMarks"),h.filter.viewMode=2,h.data.newAllData=k(!0),P()}}else t.path("/main");function f(){var t={timeKeyMarks:h.filter.timeKeyMarks,timeCountYear:h.filter.timeCountYear,timeCountMarks:h.filter.timeCountMarks,viewMode:h.filter.viewMode,companyUID:h.filter.companyUID};r.setSettings("app",t)}function p(){console.log("raiting do - begin loadData. "),m&&m.reject("cancel"),h.data.loaded=!1,h.data.chartsLoaded=!1;var e=m=l.defer();l.all([o.getRatindDo().promise,n.getData()]).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise.then(function(t){return h.data.companies=n.getCompaniesNames(),null!=h.data.companies&&h.data.companies.length?(h.data.serverData=t[0].data,null!=h.data.serverData&&null!=h.data.serverData.AllowedParams&&h.data.serverData.AllowedParams.length?(h.data.newAllData=h.data.serverData.Data,null==h.filter.companyUID&&(h.filter.companyUID=h.data.companies[0].UID),v(),D(),function(){U();var t=$("#ratingGrid").dxDataGrid("instance");t&&t.option(h.gridOptions)}(),function(){if(h.charts=[],O(),!h.data.dataSource||!h.data.dataSource.length)return;_.forEach(h.data.dataSource,function(t,e){var a=$("#ratingChart"+e).dxChart("instance");a&&a.option(h.chartOptions[e])})}(),function(){j();var t=$("#ratingMarksGrid").dxDataGrid("instance");t&&t.option(h.gridMarksOptions)}(),setTimeout(function(){_.forEach(h.data.dataSource,function(t,e){var a=$("#ratingChart"+e).dxChart("instance");a&&a.render({force:!0})})},100),h.undo=JSON.stringify(h.data),h.data.loaded=!0,void(h.data.chartsLoaded=!0)):(h.data.dataSource=[],void(h.data.error="Не загружены данные с сервера."))):(h.data.companies=[],void(h.data.error="Не загружены ДО."))},function(t){"cancel"!==t&&(h.data.chartsLoaded=!0,h.data.error=t)})}function g(t){for(var e=0,a=1;a<=12;a++){var r=t["m"+a];e+=r||0}t.Sum=e}function v(){console.log("UpdateDataSource"),h.data.dataSource=[],null!=h.data.serverData&&null!=h.data.serverData.AllowedParams&&h.data.serverData.AllowedParams.length&&null!=h.data.companies&&h.data.companies.length||(h.data.error="Ошибка инициализации источника данных.");var t=h.data.serverData.AllowedParams,s=(new Date).getFullYear()+h.filter.timeCountYear;h.filter.year=s;var c=h.filter.companyUID.toLowerCase();h.filter.companyName=h.getCompanyName();var e=_.find(h.data.newDoYearData,{DoId:c,Year:s});if(null==e){var u=[];_.forEach(t,function(t){for(var e=_.find(h.data.serverData.Data,{DzoId:c,ParamId:t.ParamId,Year:s}),a=e?e.MonthValues:[],r={ParamId:t.ParamId,ParamName:t.ParamName,ParamUomName:t.ParamName+", "+t.UomName,IsInteger:t.ParamId===C.ParamId||t.ParamId===A.ParamId,GroupName:t.GroupName,GroupNum:t.GroupNum,UomId:t.UomId,Num:t.Num},n=0,i=[],l=1;l<=12;l++){var o=_.find(a,{Month:l});r["m"+l]=o?o.Value:null,n+=o?o.Value:0,i.push({MonthName:h.monthNames[l-1],MonthValue:null!=o&&null!=o.Value?o.Value:0})}r.Sum=n,r.ChartDataSource=i,u.push(r)}),e={DoId:c,Year:s,TableData:u,bIsChanged:!1},h.data.newDoYearData.push(e)}h.data.selectedDoYear=e,h.data.dataSource=e.TableData,console.log("$scope:"),console.log(h)}function D(){console.log("updateDataSourceMarks"),h.data.dataSourceMarks=[];var t,e,a=h.filter.timeCountMarks,r=h.filter.timeKeyMarks;switch(r){case"month":"Month",t=moment().startOf("month").subtract(-a,"months"),e=moment().startOf("month").subtract(-1-a,"months").subtract(1,"day");break;case"quarter":"Quarter",t=moment().startOf("quarter").subtract(-a,"quarters"),e=moment().startOf("quarter").subtract(-1-a,"quarters").subtract(1,"day");break;case"year":"Year",t=moment().startOf("year").subtract(-a,"years"),e=moment().startOf("year").subtract(-1-a,"years").subtract(1,"day")}var g=t.get("year"),i=e.get("month"),d="";switch(r){case"month":case"quarter":d=h.monthFullNames[0].toLowerCase()+"-"+h.monthFullNames[i].toLowerCase()}h.marksTitle=h.marksTitleConst.replace("{year}",g).replace("{month2}",d);var v=[];_.forEach(h.data.newAllData,function(t){if(t.Year==g||t.Year==g-1&&t.ParamId==M.ParamId){var e=0,a=0;if(t.MonthValues)for(var r=0;r<t.MonthValues.length;r++)1<=t.MonthValues[r].Month&&t.MonthValues[r].Month<=i+1&&(e+=null==t.MonthValues[r].Value?0:t.MonthValues[r].Value,t.ParamId==C.ParamId&&null!=t.MonthValues[r].Value&&0<t.MonthValues[r].Value&&a++);var n={DzoId:t.DzoId,Year:t.Year,ParamId:t.ParamId,IntervalValue:e,UomId:t.UomId,DepthMonthCnt:a};v.push(n)}});var D=[];_.forEach(h.data.companies,function(t){var e=t.UID.toLowerCase(),a=_.filter(v,function(t){return t.DzoId==e&&t.Year==g}),r=_.find(a,function(t){return t.ParamId==C.ParamId}),n=null==r?0:r.DepthMonthCnt,i=x(_.filter(a,function(t){return t.ParamId==C.ParamId})),l=x(_.filter(a,function(t){return t.ParamId==A.ParamId}));l/=100;var o=x(_.filter(a,function(t){return t.ParamId==y.ParamId})),s=x(_.filter(a,function(t){return t.ParamId==b.ParamId})),c=x(_.filter(a,function(t){return t.ParamId==w.ParamId})),u=x(_.filter(a,function(t){return t.ParamId==I.ParamId})),d=x(_.filter(a,function(t){return t.ParamId==N.ParamId})),m=x(_.filter(a,function(t){return t.ParamId==Y.ParamId})),f=x(_.filter(a,function(t){return t.ParamId==M.ParamId})),p=x(_.filter(v,function(t){return t.ParamId==M.ParamId&&t.DzoId==e&&t.Year==g-1})),h=0;null!=n&&0<n&&(h=-20*n),D.push({DzoId:e,dzo:t,Ltif:0<s?1e6*(o+i)/s:0,Grow:0<u?c/u:0,PriceDelta:0<m?d/m*100:0,DepthDelta:0<p?f/p*100:0,IdeaCnt:l,DeathCnt:i,DepthMonthCnt:n,FinalPoints:h,FinalPlace:0})});var m=function(t,e){return t.MarkValue>e.MarkValue?1:t.MarkValue<e.MarkValue?-1:0},f=function(t,e){return t.MarkValue<e.MarkValue?1:t.MarkValue>e.MarkValue?-1:0},p=[];_.forEach(h.marks,function(e){var t=e.MarkName;t=t.replace("{year}",g).replace("{year}",g).replace("{yearBefore}",g-1).replace("{month2}",d);var a={MarkId:e.MarkId,MarkName:t,DzoMarkValues:null};if(p.push(a),null==e.ParamId&&"FinalPlace"!=e.MarkId&&"FinalPoints"!=e.MarkId){var r=D.map(function(t){return{MarkValue:t[e.MarkId],Dzo:t,Place:0,Points:0,IsInSameGroup:!1,NumInSameGroup:0,SameGroupNum:0,SameGroupLength:1}});"IdeaCnt"==e.MarkId||"Grow"==e.MarkId?r.sort(f):r.sort(m);for(var n=[],i=null,l=null,o=0;o<r.length;o++){var s=r[o],c=o+1;switch(s.Place=c,e.MarkId){case"Ltif":1<=c&&c<=4?s.Points=5*(5-c):c>=r.length-1&&c<=r.length?s.Points=5*(r.length-2-c):s.Points=0;break;case"IdeaCnt":1<=c&&c<=5?s.Points=1*(6-c):c==r.length?s.Points=-1:s.Points=0;break;default:1<=c&&c<=5?s.Points=5*(6-c):c==r.length?s.Points=-5:s.Points=0}i==s.MarkValue&&(s.IsInSameGroup=!0,r[o-1].IsInSameGroup?(l.DzoMarksValues.push(s),l.SumPoints=l.SumPoints+s.Points):(r[o-1].IsInSameGroup=!0,l={DzoMarksValues:[s,r[o-1]],SumPoints:s.Points+r[o-1].Points},n.push(l))),i=s.MarkValue}_.forEach(n,function(t){var e=t.SumPoints/t.DzoMarksValues.length;_.forEach(t.DzoMarksValues,function(t){t.Points=e})});for(var u=0;u<r.length;u++)r[u].Dzo[e.MarkId+"Points"]=r[u].Points;a.DzoMarkValues=r}});var n=_.filter(h.marks,function(t){return null!=t.ParentId});_.forEach(n,function(e){_.forEach(D,function(t){t.FinalPoints+=t[e.MarkId]})});D.sort(function(t,e){return t.FinalPoints<e.FinalPoints?1:t.FinalPoints>e.FinalPoints?-1:t.DzoId>e.DzoId?1:t.DzoId<e.DzoId?-1:0});var l=0;_.forEach(D,function(e){e.FinalPlace=l+1,_.forEach(p,function(t){t["c"+l]=e[t.MarkId]}),l++}),h.data.dzoMarks=D,h.data.dataSourceMarks=p,T(),console.log("dataSourceMarks:"),console.log(p)}function S(t){console.log("updateData"),h.data.firstLoaded?(h.data.loaded=!1,h.data.chartsLoaded=!1,h.data.error=null,v(),1==t&&(console.log("updateChartDataSources"),_.forEach(h.data.dataSource,function(t){for(var e=[],a=1;a<=12;a++)e.push({MonthName:h.monthNames[a-1],MonthValue:t["m"+a]?t["m"+a]:0});t.ChartDataSource=e})),D(),function(){if(console.log("updateGridChartMarksData"),h.charts=[],!h.data.dataSource||!h.data.dataSource.length)return;var t=$("#ratingGrid").dxDataGrid("instance");t&&(t.dataSource=h.data.dataSource);_.forEach(h.data.dataSource,function(t,e){var a=$("#ratingChart"+e).dxChart("instance");a&&(a.dataSource=t.ChartDataSource,a.refresh())});var e=$("#ratingMarksGrid").dxDataGrid("instance");e&&(e.columns=h.data.gridMarksColumns,e.dataSource=h.data.dataSourceMarks)}(),h.data.loaded=!0,h.data.chartsLoaded=!0):(p(),h.data.firstLoaded=!0)}function P(){S()}function O(){console.log("createChartOptions"),h.chartOptions=[],h.data.dataSource&&_.forEach(h.data.dataSource,function(t,e){var a=t.ParamUomName,r={title:{text:a,font:{color:"#0070BA",family:"Helvetica Neue, Helvetica, Arial, sans-serif",size:18}},commonSeriesSettings:{type:"bar",label:{visible:!0,backgroundColor:"transparent",font:{color:"#000"},format:"#,##0.#"}},series:{argumentField:"MonthName",valueField:"MonthValue",name:a,color:"#7CACDB"},dataSource:t.ChartDataSource,legend:{visible:!1},size:{height:280},onInitialized:function(t){},bindingOptions:{dataSource:"data.dataSource["+e+"].ChartDataSource"},tooltip:{enabled:!0,customizeTooltip:function(t){var e=(Math.round(10*t.originalValue)/10).toLocaleString();return{html:t.seriesName+"<div class='currency'>"+e+"</div>"}}}};h.chartOptions.push(r)})}function U(){console.log("createGridOptions");var r=[{dataField:"Num",caption:"Номер",sortOrder:"asc",allowEditing:!1,visible:!1,width:100},{dataField:"ParamUomName",caption:"Показатель",allowSorting:!1,width:300,allowEditing:!1}];_.forEach(h.monthFullNames,function(t,e){var a=e+1;r.push({dataField:"m"+a,allowSorting:!1,caption:t,dataType:"number",format:"#,###.##",cellTemplate:function(t,e){var a="";if(null==e.value)a='<div style="text-align:center;"> - </div>';else if(0==e.value)a='<div style="text-align:center;">0</div>';else{a='<div style="text-align:center;"> '+(Math.round(100*e.value)/100).toLocaleString()+" </div>"}t.append(a)},editCellTemplate:"numberBoxEditorTemplate"})}),r.push({dataField:"Sum",caption:"Итого",allowEditing:!1,allowSorting:!1,format:"#,##0.##"}),r.push({dataField:"GroupNum",caption:"Группа",groupIndex:0,allowEditing:!1,allowSorting:!1,cellTemplate:function(t,e){var a=e.GroupName;t.append("<span>"+a+"</span")},groupCellTemplate:function(t,e){var a=e.data.items[0].GroupName;t.append("<span>"+a+"</span")}}),h.initNumberBoxEditor=function(e){var t=e.data,a={format:t.IsInteger?"#,##0":"#,##0.##",value:e.value,showClearButton:!0,onValueChanged:function(t){e.setValue(t.value)}};return t.IsInteger&&(a.min=0),a},h.gridOptions={allowFiltering:!0,showBorders:!0,showRowLines:!0,keyExpr:"ParamId",wordWrapEnabled:!0,allowColumnResizing:!0,keyboardNavigation:{enterKeyAction:"moveFocus",enterKeyDirection:"column",editOnKeyPress:!0},columns:r,fieldChooser:{enabled:!1},onFocusedCellChanged:function(t){h.selectedCell=t,h.bCellIsSelected=!0},onRowUpdated:function(t){null!=t&&null!=t.data&&(g(t.data),F())},onEditingStart:function(t){h.selectedCell=t,h.bCellIsSelected=!0},onCellClick:function(t){h.selectedCell=t,h.bCellIsSelected=!0},onEditorPreparing:function(t){},onSelectionChanged:function(t){},onInitialized:function(t){},bindingOptions:{dataSource:"data.dataSource"},dataSource:h.data.dataSource,editing:{mode:"cell",allowUpdating:null!=h.authData&&h.authData.CanEditDzoRating,allowDeleting:!1,allowAdding:!1}}}function T(){console.log("updateGridMarksColumns");var a=[{dataField:"MarkName",caption:"Критерий",width:500,allowSorting:!1}],n=h.data.companies.length;_.forEach(h.data.dzoMarks,function(t,e){a.push({dataField:"c"+e,caption:t.dzo.name,allowSorting:!1,dataType:"number",alignment:"center",cssClass:"d_Bold",format:"#,##0.##",headerCellTemplate:function(t,e){if(!e.column.groupIndex){var a="",r=1- -e.column.dataField.substr(1);1==r?a="d_best":2<=r&&r<=3?a="d_good":4<=r&&r<=n-2?a="d_norm":n-1<=r&&(a="d_bad"),$("<div>").html(e.column.caption).appendTo(t),$(t).closest("td").addClass(a)}}})}),h.data.gridMarksColumns=a}function j(){console.log("createGridMarksOptions"),T();var n=h.data.companies.length;h.gridMarksOptions={showBorders:!0,showRowLines:!0,keyExpr:"MarkId",wordWrapEnabled:!0,allowColumnResizing:!0,columns:h.data.gridMarksColumns,fieldChooser:{enabled:!1},onCellPrepared:function(t){if(null!=t.row&&null!=t.row.data&&"FinalPlace"==t.row.data.MarkId){var e="",a=1- -t.column.dataField.substr(1);1==a?e="d_best":2<=a&&a<=3?e="d_good":4<=a&&a<=n-2?e="d_norm":n-1<=a&&(e="d_bad");var r=$(t.cellElement).closest("td");null!=r&&r.addClass(e)}},onRowPrepared:function(t){if(null!=t&&null!=t.data){var e=t.data;switch(0<=e.MarkId.indexOf("Points")&&$(t.rowElement).addClass("d_Points"),e.MarkId){case"FinalPlace":case"FinalPoints":case"Grow":case"GrowPoints":case"DepthDelta":case"DepthDeltaPoints":case"DeathCnt":$(t.rowElement).addClass("d_GrayRow")}}},onInitialized:function(t){},bindingOptions:{dataSource:"data.dataSourceMarks",columns:"data.gridMarksColumns"},dataSource:h.data.dataSourceMarks}}function F(){h.data.selectedDoYear.bIsChanged||(h.data.selectedDoYear.bIsChanged=!0),h.canSave||(h.canSave=!0)}function k(t){var l=[];if(_.forEach(h.data.newDoYearData,function(i){i.bIsChanged&&_.forEach(i.TableData,function(t){for(var e=[],a=1;a<=12;a++){var r=t["m"+a];e.push({Month:a,Value:r})}var n={DzoId:i.DoId,Year:i.Year,ParamId:t.ParamId,MonthValues:e,UomId:t.UomId};l.push(n)})}),t){var e=_.filter(h.data.serverData.Data,function(e){return!(null!=_.find(l,function(t){return t.DzoId==e.DzoId&&t.Year==e.Year&&t.ParamId==e.ParamId&&t.UomId==e.UomId}))});Array.prototype.push.apply(l,e)}return l}function x(t){var e=0;return _.forEach(t,function(t){e+=null==t.IntervalValue?0:t.IntervalValue}),e}}]),angular.module("smbApp").controller("DocumentsCtrl",["$scope",function(t){t.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("smbApp").controller("BrigademovementsCtrl",["$scope",function(t){t.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("smbApp").controller("BusinessplanCtrl",["$scope",function(t){t.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("smbApp").directive("blueCloth",function(){return{restrict:"EAC",priority:2,link:function(t,s){!function(){var t,e;t=s.css("height"),e=s.css("width");var a=angular.element('<canvas width="'+e+'" height="'+t+'"></canvas>')[0];s.append(a);var d,m,i,l,f,p,h,g,v,D,r=a,y=r.getContext("2d"),b=r.width,o=r.height,C=2*Math.PI;function n(){var t,e,a,r,n,i,l,o,s,c;for(e=0;e<g;e++)for(v++,t=0;t<d;t++){(a=f[t]).param+=a.changeSpeed,1<=a.param&&(a.param=0,a.pointList1=a.pointList2,a.pointList2=w(p)),s=.5-.5*Math.cos(Math.PI*a.param),y.strokeStyle=a.color,y.lineWidth=D,y.beginPath(),n=a.pointList1.first,i=a.pointList2.first,a.phase+=2e-4;var u=a.phase;for(r=a.minRad+(n.y+s*(i.y-n.y))*(a.maxRad-a.minRad),a.centerX+=.5,a.centerY+=.04,c=40*Math.sin(a.globalPhase+v/1e3*C),a.centerX>b+m&&(clearInterval(h),h=null),y.setTransform(.75,0,0,1,a.centerX,a.centerY+c),l=.75*r*Math.cos(u),o=r*Math.sin(u),y.lineTo(l,o);null!==n.next&&void 0!==n.next;)n=n.next,i=i.next,u=C*(n.x+s*(i.x-n.x))+a.phase,l=.75*(r=a.minRad+(n.y+s*(i.y-n.y))*(a.maxRad-a.minRad))*Math.cos(u),o=r*Math.sin(u),y.lineTo(l,o);y.closePath(),y.stroke()}}function w(t){var e,a,r,n,i,l={first:{x:0,y:1}},o=1,s=1;l.first.next={x:1,y:1};for(var c=0;c<t;c++)for(e=l.first;null!==e.next&&void 0!==e.next;){r=(a=e.next).x-e.x,n=.5*(e.x+a.x),i=.5*(e.y+a.y);var u={x:n,y:i+=r*(2*Math.random()-1)};i<o?o=i:s<i&&(s=i),u.next=a,e.next=u,e=a}if(s!==o){var d=1/(s-o);for(e=l.first;null!=e;)e.y=d*(e.y-o),e=e.next}else for(e=l.first;null!=e;)e.y=1,e=e.next;return l}d=1,i=m=120,p=10,g=8,D=1.1,v=l=0,y.setTransform(1,0,0,1,0,0),y.clearRect(0,0,b,o),function(){var t,e,a,r;for(f=[],t=0;t<d;t++){e=i+Math.random()*(m-i),a=l*e,(r=y.createRadialGradient(0,0,a,0,0,e)).addColorStop(1,"rgba(0,170,200,0.2)"),r.addColorStop(0,"rgba(0,20,170,0.2)");var n={centerX:-e,centerY:o/2-50,maxRad:e,minRad:a,color:r,param:0,changeSpeed:1/350,phase:Math.random()*C,globalPhase:Math.random()*C};f.push(n),n.pointList1=w(p),n.pointList2=w(p)}}(),h&&clearInterval(h),h=setInterval(n,20)}()}}}),angular.module("smbApp").directive("rotatedHeight",function(){return{restrict:"A",priority:0,link:function(t,e){e.css("width",$(window).height());var a=e.position().top;e.css("top",-a),"0px"===e.css("left")&&e.css("left",a),"0px"===e.css("right")&&e.css("right",a)}}}),angular.module("smbApp").directive("d3Map",["$timeout","$location","D3ChartSizer",function(m,f,r){return{restrict:"E",scope:{mapWidth:"@",mapHeight:"@",widthScale:"@",heightScale:"@",leftOffset:"@",topOffset:"@",rightOffset:"@",bottomOffset:"@",scale:"@",height:"@",getMap:"&",pointClass:"@",activeClass:"@",areaClass:"@",zoomEmptyAreas:"@",zoomXscale:"@",zoomYscale:"@",circleRadius:"@",textFontSize:"@",textClass:"@",textFont:"@",divClass:"@"},compile:function(t,e){var a;return(a=e).widthScale=a.widthScale||"1.4",a.heightScale=a.heightScale||"1.5",a.leftOffset=a.leftOffset||"0",a.topOffset=a.topOffset||"0",a.rightOffset=a.rightOffset||"0",a.bottomOffset=a.bottomOffset||"0",a.scale=a.scale||"0.14",a.zoomXscale=a.zoomXscale||"1.8",a.zoomYscale=a.zoomYscale||"2.1",a.circleRadius=a.circleRadius||"2",void 0===a.zoomEmptyAreas&&(a.zoomEmptyAreas="false"),a.textFontSize=a.textFontSize||"8px",a.textFont=a.textFont||"sans-serif",{post:function(u,n){var i=new r,d=u.scale;if(!u.getMap||!angular.isFunction(u.getMap))return console.error("map getter not binded"),!1;function a(){var l,o,s,t,e,a,r;function c(t){if(angular.isArray(t))return angular.forEach(t,function(t){t.objects&&c(t)}),!0;var e;if(!angular.isArray(t)&&angular.isArray(t.objects)&&(e=t.type,t=t.objects,!angular.isArray(t)))return console.error("d3-map: Expected array of objects or array of array of objects.",t),!1;var a=l.append("g");switch(e){case"company-info":var r=a.selectAll("g.map-company-info").data(t).enter().append("g").attr("class","map-company-info").attr("transform","translate("+u.width/2+",10)scale("+d*u.width/600+")").on("click",function(t){m(function(){f.path("/company/all")},0),window.location.href="#/company/all?ie="+Date.now()});r.append("path").attr("class","map-company-info-bar").attr("d",function(t){return"M-150,0","L150,0","L130,20","L150,40","L-150,40","L-130,20","L-150,0","Z","M-150,0L150,0L130,20L150,40L-150,40L-130,20L-150,0Z"}),r.append("text").attr("font-size",u.textFontSize).attr("class","point-counter map-point-over point-bar-title").attr("transform","translate(0,"+(20+parseFloat(parseInt(u.textFontSize)/3))+")").text(function(t){return t.name}),r.append("circle").attr("r",30).attr("transform","translate(0,64)").attr("class","map-point map-company-info-point"),r.append("text").attr("font-size",1.2*u.textFontSize).attr("class","point-counter map-point-over").attr("transform","translate(0,"+(64+parseFloat(1.2*parseInt(u.textFontSize)/3))+")").text(function(t){return t.activeWellCount});break;case"company":var n=a.selectAll("g.map-company").data(t).enter().append("g").attr("class",function(t){return t.disabled?"map-company disabled":"map-company"}).attr("transform",function(t){return"translate("+o([t.location.longitude,t.location.latitude])+") scale("+d*u.width/600+")"}).on("click",function(t){m(function(){f.path("/company/"+t.id)},0),window.location.href="#/company/"+t.id+"?ie="+Date.now()});n.append("circle").attr("r",function(t){return t.r||u.circleRadius}).attr("class","map-point"),n.append("text").attr("font-size",u.textFontSize).attr("class","point-counter map-point-over").attr("transform","translate(0,"+parseFloat(parseInt(u.textFontSize)/3)+")").text(function(t){return t.activeWellCount}),n.append("path").attr("class","map-company-bar").attr("d",function(t){var e=u.circleRadius/2,a=2*u.circleRadius,r=t.barWidth,n=1;"left"===t.labelDirection&&(n=-1,e=-e,r=-r);var i=[{x:e,y:-a/2},{x:e+r,y:-a/2},{x:e+r-n*(.375*a),y:a/2},{x:e,y:a/2}];return 0<n?(t="M"+i[0].x+","+i[0].y,t+="L"+i[1].x+","+i[1].y,t+="L"+i[2].x+","+i[2].y,t+="L"+i[3].x+","+i[3].y,t+="A"+a/2.4+","+a/2+" 0 0,0 "+i[0].x+","+i[0].y):(t="M"+i[0].x+","+i[0].y,t+="L"+i[1].x+","+i[1].y,t+="L"+i[2].x+","+i[2].y,t+="L"+i[3].x+","+i[3].y,t+="A"+a/2.4+","+a/2+" 0 1,1 "+i[0].x+","+i[0].y),t+="Z"}),n.append("text").attr("font-size",u.textFontSize).attr("class","point-bar-title").attr("transform","translate(0,"+parseFloat(parseInt(u.textFontSize)/3)+")").attr("x",function(t){return"left"===t.labelDirection?-40:40}).attr("text-anchor",function(t){return"left"===t.labelDirection?"end":"start"}).text(function(t){return t.name});break;default:var i=u.areaClass;a.selectAll("path").data(t).enter().append("path").attr("class",i).attr("d",s)}}d3.select(angular.element(n)[0]).selectAll("svg").remove(),t=d3.select(angular.element(n)[0]).append("svg"),l=t.append("g"),i.setSizes(u,n.parent()),!u.widthScale&&u.mapWidth&&(u.widthScale=u.width/u.mapWidth),!u.heightScale&&u.mapHeight&&(u.heightScale=u.height/u.mapHeight),u.scale=d*u.width,e=u.width,a=u.height,o=d3.geo.mercator().scale(u.scale).center([-55,65]).translate([e/2,a/2]),t.attr("preserveAspectRatio","xMidYMid").attr("viewBox",Math.round(u.leftOffset/100*e)+" "+Math.round(u.topOffset/100*a)+" "+Math.round(e*(1-u.rightOffset/100))+" "+Math.round(a*(1-u.bottomOffset/100))).attr("width",e).attr("height",a),s=d3.geo.path().projection(o),r?(l.selectAll("g").remove(),c(r)):u.getMap().then(function(t){if(!t)return console.error("map objects empty"),!1;r=t,l.selectAll("g").remove(),c(r)})}console.log(u.getMap),a(),$(window).resize(function(){var t=$(window).height(),e=$(window).width();m(function(){$(window).height()===t&&$(window).width()===e&&(u.height=!1,u.width=!1,i.setSizes(u,n.parent()),a())},200)})}}}}}]),angular.module("smbApp").directive("d3Donut",["$timeout",function(a){function u(t,e,a,r,n,i,l,o,s,c,u,d,m){var f=Math.min(a,r),p=(n=f*(n/100))*Math.abs(Math.sin(90*(1-i)*(Math.PI/180))),h=(f-p)/2,g=h,v=h*i,D=a/2,y=h;(function(t,e,a,r,n,i,l){var u={textClass:t,innerSliceClass:e,topSliceClass:a,outerSliceClass:r,onClick:n,onMouseOver:i,onMouseOut:l};function d(t,e,a,r){if(t.endAngle-t.startAngle==0)return"M 0 0";var n=e*Math.cos(t.startAngle),i=a*Math.sin(t.startAngle),l=e*Math.cos(t.endAngle),o=a*Math.sin(t.endAngle),s=[];return s.push("M",n,i,"A",e,a,"0",t.endAngle-t.startAngle>Math.PI?1:0,"1",l,o,"L",r*l,r*o),s.push("A",r*e,r*a,"0",t.endAngle-t.startAngle>Math.PI?1:0,"0",r*n,r*i,"z"),s.join(" ")}function m(t,e,a,r){var n=t.startAngle>Math.PI?Math.PI:t.startAngle,i=t.endAngle>Math.PI?Math.PI:t.endAngle,l=e*Math.cos(n),o=a*Math.sin(n),s=e*Math.cos(i),c=a*Math.sin(i),u=[];return u.push("M",l,r+o,"A",e,a,"0 0 1",s,r+c,"L",s,c,"A",e,a,"0 0 0",l,o,"z"),u.join(" ")}function f(t,e,a,r,n){var i=t.startAngle<Math.PI?Math.PI:t.startAngle,l=t.endAngle<Math.PI?Math.PI:t.endAngle,o=n*e*Math.cos(i),s=n*a*Math.sin(i),c=n*e*Math.cos(l),u=n*a*Math.sin(l),d=[];return d.push("M",o,s,"A",n*e,n*a,"0 0 1",c,u,"L",c,r+u,"A",n*e,n*a,"0 0 0",o,r+s,"z"),d.join(" ")}function p(t){return.2<t.endAngle-t.startAngle?Math.round(1e3*(t.endAngle-t.startAngle)/(2*Math.PI))/10+"%":""}return u.transition=function(t,e,a,r,n,i){var l=d3.layout.pie().sort(null).value(function(t){return t.value})(e);t.selectAll("."+u.innerSliceClass).data(l).transition().duration(750).attrTween("d",function(t){var e=d3.interpolate(this._current,t);return this._current=e(0),function(t){return f(e(t),a+.5,r+.5,n,i)}}),t.selectAll("."+u.topSliceClass).data(l).transition().duration(750).attrTween("d",function(t){var e=d3.interpolate(this._current,t);return this._current=e(0),function(t){return d(e(t),a,r,i)}}),t.selectAll("."+u.outerSliceClass).data(l).transition().duration(750).attrTween("d",function(t){var e=d3.interpolate(this._current,t);return this._current=e(0),function(t){return m(e(t),a-.5,r-.5,n)}}),t.selectAll("."+u.textClass).data(l).transition().duration(750).attrTween("x",function(t){var e=d3.interpolate(this._current,t);return this._current=e(0),function(t){return.6*a*Math.cos(.5*(e(t).startAngle+e(t).endAngle))}}).attrTween("y",function(t){var e=d3.interpolate(this._current,t);return this._current=e(0),function(t){return.6*a*Math.sin(.5*(e(t).startAngle+e(t).endAngle))}}).text(p)},u.draw=function(t,e,a,r,n,i,l,o){var s=d3.layout.pie().sort(null).value(function(t){return t.value})(e),c=t.append("g").attr("transform","translate("+a+","+r+")");c.selectAll("."+u.innerSliceClass).data(s).enter().append("path").attr("class",u.innerSliceClass).style("fill",function(t){return d3.hsl(t.data.color).darker(.7)}).attr("d",function(t){return f(t,n+.5,i+.5,l,o)}).each(function(t){this._current=t}),c.selectAll("."+u.topSliceClass).data(s).enter().append("path").attr("class",u.topSliceClass).style("fill",function(t){return t.data.color}).style("stroke",function(t){return t.data.color}).attr("d",function(t){return d(t,n,i,o)}).on("click",u.onClick).on("mouseover",u.onMouseOver).on("mouseOut",u.onMouseOut).each(function(t){this._current=t}),c.selectAll("."+u.outerSliceClass).data(s).enter().append("path").attr("class",u.outerSliceClass).style("fill",function(t){return d3.hsl(t.data.color).darker(.7)}).attr("d",function(t){return m(t,n-.5,i-.5,l)}).each(function(t){this._current=t}),c.selectAll("."+u.textClass).data(s).enter().append("text").attr("class",u.textClass).attr("transform",function(t){return"translate("+.65*n*Math.cos(.5*(t.startAngle+t.endAngle))+","+.65*i*Math.sin(.5*(t.startAngle+t.endAngle))+")"}).each(function(t){d3.select(this).append("tspan").attr("x","0").attr("dy","0").text(p),d3.select(this).append("tspan").attr("x","0").attr("dy","1em").text(t.data.label)})},u})(l,o,s,c,u,d,m).draw(t,e,D,y,g,v,p,.4)}return{restrict:"AE",scope:{ngModel:"=",textClass:"@",innerSliceClass:"@",topSliceClass:"@",outerSliceClass:"@",depth:"@",angle:"@",onClick:"&",onMouseOver:"&",onMouseOut:"&"},compile:function(t,e){return e.innerSliceClass=e.innerSliceClass||"innerSlice",e.topSliceClass=e.topSliceClass||"topSlice",e.outerSliceClass=e.outerSliceClass||"outerSlice",e.depth=parseFloat(e.depth)||10,e.angle=parseFloat(e.angle)||.87,{post:function(r,n){var i,l,o,s=d3.select(angular.element(n)[0]).append("svg"),c=s.append("g");function e(t){s.select("g").remove();var e=$(n.parent()).width(),a=$(n.parent()).height();s.attr("width",e).attr("height",a),c=s.append("g"),t&&u(c,t,e,a,r.depth,r.angle,r.textClass,r.innerSliceClass,r.topSliceClass,r.outerSliceClass,i,l,o)}r.onClick&&(i=function(t){r.$apply(function(){r.onClick(t)})}),r.onMouseOver&&(l=function(t){r.$apply(function(){r.onMouseOver(t)})}),r.onMouseOut&&(o=function(t){r.$apply(function(){r.onMouseOut(t)})}),r.$watch("ngModel",function(t){a(function(){e(t)},400)},!0),r.resizeWatching||(r.resizeWatching=!0,$(window).resize(function(){a(function(){e(r.ngModel)},400)}))}}}}}]),angular.module("smbApp").controller("PvchartCtrl",["$scope","$location","$q","$timeout","pvChartData","chartSeriesColors","appSettings",function(e,t,a,r,n,i,l){var o;e.$on("$destroy",function(){var t;t={filterMode:e.filter.filterMode,timeKey:e.filter.timeKey,filterType:e.filter.filterType},l.setSettings("app",t)}),e.firstColors=[i.tupleColors[1]],e.secondColors=[i.tupleColors[0]],e.data={loaded:!1},n.setSourceDataKeys([0,1]),e.filter={filterMode:0,timeKey:"month",filterType:0},(o=l.getSettings("app"))&&angular.extend(e.filter,o),void 0!==t.search().mode&&(1===parseInt(t.search().mode)||"zbs"===t.search().mode?e.filterMode=1:e.filterMode=0),n.setPeriodKeys(["year","quarter","month"]),a.all([n.getPV(),n.getSubPV()]).then(function(t){e.data.loaded=!0,r(function(){_.forEach(t,function(t){_.forEach(t,function(t){_.forEach(t,function(t){t.values=_.sortBy(t.values,function(t){return-t.points[0].values[0]})})})}),e.pv=t[0],e.subPv=t[1]},0)}),e.getPeriodLabel=function(){switch(e.filter.timeKey){case"month":return"Январь-Март 2015 г.";case"quarter":return"1-3 кв. 2015 г.";case"year":return"2013-2015 г.";default:return""}}}]),angular.module("smbApp").service("IEHacks",["$location","$timeout",function(t,e){var a="#3bda52";function r(){if(-1<navigator.userAgent.indexOf("Trident/6.0"))return 10;if(-1<navigator.userAgent.indexOf("Trident/7.0"))return 11;var t,e=-1;return"Microsoft Internet Explorer"===navigator.appName?(t=navigator.userAgent,null!==new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(t)?e=parseFloat(RegExp.$1):null!==new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})").exec(t)&&(e=parseFloat(RegExp.$1))):"Netscape"===navigator.appName&&(t=navigator.userAgent,null!==new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(t)&&(e=parseFloat(RegExp.$1))),e}var n=!1,i=function(){n=!0,d3.selectAll(".active-map-point").classed("map-point",!1).attr("fill",a).transition().attr("fill","#65b2fa").duration(1e3).transition().attr("fill",a).duration(1e3),e(i,2e3)},l={pageBeforeRedirect:"",nightMode:function(){11===r()&&(l.pageBeforeRedirect=t.path(),t.path("/reload"))},setPointsAnimation:function(){0<r()&&(n||i())},getIEVersion:r};return l}]),angular.module("smbApp").controller("ReloadCtrl",["$location","IEHacks",function(t,e){e.pageBeforeRedirect?t.path(e.pageBeforeRedirect):t.path("/")}]),angular.module("smbApp").service("smbData",["$q","$http","localStorageService",function(n,i,l){var a,o=null,s=160,r=null;function t(e,a){var r=n.defer();return o||(o=l.get("structure.json")),!o||e?i.get("maps/structure_new.json").success(function(t){l.set("structure.json",t),o=t,a?r.resolve(o):r.resolve(c(o,e))}).error(function(t){r.reject(t)}):a?r.resolve(o):r.resolve(c(o)),r.promise}function c(t,e){if(!t)return!1;if(a&&!e)return a;var l={localities:[],clusters:[],activeWellsCountsByAreas:{}};return angular.forEach(t,function(i){l.activeWellsCountsByAreas[i.id]=0,i.locality&&i.locality.length&&angular.forEach(i.locality,function(r){if(r.cluster&&r.cluster.length){var n=!1;angular.forEach(r.cluster,function(t){var e=!1;if(t.well&&0<t.well.length){var a=_.where(t.well,{act:1}).length;l.activeWellsCountsByAreas[i.id]+=a,0<a&&(e=!0)}t.lat&&t.lon&&(l.clusters.push({name:r.n+" "+t.n,id:"cluster"+t.id,isActive:e,location:{longitude:t.lon-s,latitude:t.lat}}),n||(l.localities.push({name:r.n,id:"locality"+r.id,company:i.n,isActive:e,location:{longitude:t.lon-s,latitude:t.lat}}),n=!0))})}})}),a=l}return{getRusPointsClusters:function(){var e=n.defer();return t().then(function(t){e.resolve(t.clusters)},function(t){e.reject(t)}),e.promise},getRusPointsLocalities:function(){var e=n.defer();return t().then(function(t){e.resolve(t.localities)},function(t){e.reject(t)}),e.promise},getRusAreaPoints:function(){return e=n.defer(),!r||t?i.get("maps/areaPoints.json").success(function(t){r=t,angular.forEach(r,function(t){t.location.longitude=t.location.longitude-s}),e.resolve(r)}).error(function(t){e.reject(t)}):e.resolve(r),e.promise;var t,e},getActiveWellsCountsByAreas:function(){var e=n.defer();return t().then(function(t){e.resolve(t.activeWellsCountsByAreas)},function(t){e.reject(t)}),e.promise},getStructure:function(){var e=n.defer();return t(!1,!0).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},getCompaniesOnly:function(t){var e=[];return angular.forEach(t,function(t){e.push({name:t.n,id:t.id,shortName:t.shortName})}),e},getCompanyName:function(t){var e=[];return angular.forEach(o,function(t){e.push({name:t.n,id:t.id,shortName:t.shortName})}),_.result(_.findWhere(e,{id:t}),"name")},getCompanyShortName:function(t){var e=[];return angular.forEach(o,function(t){e.push({name:t.n,id:t.id,shortName:t.shortName})}),_.result(_.findWhere(e,{id:t}),"shortName")},getLocalitiesOnly:function(t){var a=[];return angular.forEach(t,function(e){e.locality&&e.locality.length&&angular.forEach(e.locality,function(t){a.push({name:t.n,id:t.id,companyId:e.id})})}),a}}}]),angular.module("smbApp").directive("groupedBarChart",["$timeout","$location","numeraljsFilter","utils","D3ChartSizer",function(l,t,G,e,a){var o=new a;return{restrict:"AE",scope:{ngModel:"=",tipClass:"@",titleTipClass:"@",barColors:"=",splitPairs:"@",trendLines:"@",trPointRadius:"@",tpClass:"@",tlClass:"@",labelFormatter:"&",axisOffsetX:"@",axisOffsetY:"@",redrawParam:"=",tiltXAxisText:"=",showValues:"=",showMarkers:"=",reverseMarkers:"=",showAverageLines:"="},compile:function(t,e){var a;return e.tipClass&&$("."+e.tipClass).remove(),(a=e).width=a.width||"100%",a.trPointRadius=a.trPointRadius||"3",a.tlClass=a.tlClass||"trend-line",a.tpClass=a.tpClass||"trend-point",a.splitPairs=a.splitPairs||"true","false"===a.splitPairs&&(a.splitPairs=null),{post:function(a,t){var e=d3.select(angular.element(t)[0]).append("svg"),r=d3.tip().attr("class",a.tipClass).offset([-7,0]).html(function(t){console.log(a.ngModel&&a.ngModel.format);var e="";return e=t.value.label?t.value.label+": "+G(t.value.val,a.ngModel&&a.ngModel.format||"0.0[0000]"):G(t.value.val,a.ngModel&&a.ngModel.format||"0.0[0000]"),'<span class="'+a.titleTipClass+'">'+e+"</span>"});e.call(r);var n=d3.tip().attr("class",a.tipClass).offset([-7,0]).html(function(t){return"<span>"+t+"</span>"});function i(){r.hide(),n.hide(),a.height=!1,a.width=!1,o.setSizes(a,t.parent()),function(t,e,r,n,a,i,l,o,s,c,u,d,m,f,p,h,g,v,D,y){if(t.selectAll("g").remove(),n&&n.values){var b={top:g?45:20,right:1,bottom:0,left:0,yAxisOffset:0,yAxisWidth:0,xAxisOffset:0};n.yAxisTitle&&(b.yAxisOffset=parseInt(p)||20,b.yAxisWidth=10);var C=_.pluck(n.values,"title");if(C&&(b.xAxisOffset=parseInt(f)||20,h&&(b.xAxisOffset+=100)),a=parseInt(a)-b.left-b.right-b.yAxisOffset-b.yAxisWidth,i=i-b.top-b.bottom-b.xAxisOffset,!(a<=0||i<=0)&&n&&n.values){var w=_.pluck(n.averageLines||[],"value"),I=_.pluck(n.values,"points"),N=_.flatten(_.flatten(I),!0,"values");N=_.map(N,function(t){if(t&&t.val&&_.isArray(t.val)){var e=0;return _.forEach(t.val,function(t){e+=t.val}),e}return t&&t.val||0});var Y=d3.scale.linear().range([i,0]).domain([0,d3.max(_.union(N,w))]),M=n.values.length,A=.1,S=.1,P=a*(1-A)/(2*S-A+M);if(250<P){var O=(a-250*M)/(a+250);S=A=O,P=250}P<30&&(a=30*(2*(S=A=.1)-A+M)/(1-A),P=30);var U=t.attr("width",a+b.left+b.right+b.yAxisOffset+b.yAxisWidth).attr("height",i+b.top+b.bottom+b.xAxisOffset).append("g").attr("transform","translate("+parseInt(b.left+b.yAxisOffset+b.yAxisWidth)+","+parseInt(b.top)+")"),T=d3.scale.ordinal().rangeBands([0,a],A,S);T.domain(_.map(n.values,function(t,e){return t.title+Array(e+1).join(" ")}));var j=T.rangeBand()/(1-A),$=T.rangeBand();if(C){var F=d3.svg.axis().tickPadding(5).scale(T).orient("bottom"),k=t.append("g").attr("class","x axis").attr("transform","translate("+parseInt(b.yAxisOffset+b.yAxisWidth)+","+parseInt(i+b.top+2)+")").call(F);k.selectAll("g.tick").data(n.values).on("click",function(t){t.link&&(_.isFunction(t.link)?t.link():window.location.href="#"+t.link)});var x=function(t){for(var e=d3.select(this),a=e.node().getComputedTextLength(),r=e.text();a>e.attr("width")&&0<r.length;)r=r.slice(0,-1),e.text(r+"..."),a=e.node().getComputedTextLength()};h?k.selectAll("g.tick text").attr("transform","rotate(-90)").attr("dy","-0.71em").attr("style","text-anchor: end;").attr("x","-8px").attr("width","100").each(x):k.selectAll("g.tick text").attr("width",P).each(x),n.subXAxisTitles&&(k.selectAll("g.tick text").attr("dy","1em"),angular.forEach(n.subXAxisTitles,function(t,e){var a=e*P/n.subXAxisTitles.length+P/n.subXAxisTitles.length/2-P/2;k.selectAll("g.tick").append("text").attr("class","sub-label").attr("y",3).attr("dy",".91em").attr("x",a).attr("style","text-anchor: middle;").text(t).attr("width",P/n.subXAxisTitles.length).each(x).on("mouseover",function(){r.show(t)}).on("mouseout",r.hide)}))}if(n.yAxisTitle){var E=d3.svg.axis().scale(Y).orient("left").ticks(5,"");t.append("g").attr("class","y axis").attr("transform","translate("+parseInt(b.yAxisOffset)+","+b.top+")").call(E).append("text").attr("class","y-axis-title").attr("y",5).attr("dy","-1.1em").style("text-anchor","end").text(n.yAxisTitle)}t.selectAll(".axis path, .axis line").attr("fill","none").attr("stroke","#000");var L=U.selectAll("g").data(n.values).enter().append("g").attr("transform",function(t,e){return"translate("+(j*S+j*e)+",0)"}).on("click",function(t){t.link&&(_.isFunction(t.link)?t.link():window.location.href="#"+t.link)}).selectAll("g").data(function(e){return _.map(e.points,function(t){return{point:t,pointsCount:e.points.length}})}).enter().append("g").attr("transform",function(t,e){return"translate("+e*$/t.pointsCount+",0)"});if(L.selectAll("g").data(function(r){var n=[];return angular.forEach(r.point.values,function(t,e){var a={value:t,parent:r,valuesCount:r.point.values.length};angular.isArray(r.labels)&&(a.label=r.labels[e]),n.push(a)}),n}).enter().append("g").attr("transform",function(t,e){var a=R(t);return"translate("+(.1*a+e*a)+",0)"}).selectAll("g").data(function(a,r){var n=R(a);if(a.value&&a.value.val&&_.isArray(a.value.val)){var i=0;return _.map(a.value.val,function(t){var e={color:l[r%a.valuesCount],startY:i,value:t,barWidth:n-.1*n};return i+=t.val,e})}return[{color:l[r%a.valuesCount],startY:0,value:a.value,barWidth:n-.1*n}]}).enter().append("rect").style("fill",function(t,e){return t.color}).style("opacity",function(t,e){return 1-.05*e}).style("stroke-width",1).style("stroke","white").attr("width",function(t){return t.barWidth}).attr("y",function(t){return Y((t.value?t.value.val:0)+t.startY)}).attr("height",function(t){return i-Y(t.value?t.value.val:0)}).on("mouseover",e.show).on("mousedown",e.hide).on("mouseout",e.hide),g){var V=L.selectAll("text.value").data(function(r){var n=[];return angular.forEach(r.point.values,function(t,e){var a={value:t,parent:r,valuesCount:r.point.values.length};angular.isArray(r.labels)&&(a.label=r.labels[e]),n.push(a)}),n}).enter().append("g").attr("transform",function(t,e){var a;if(t.value&&t.value.val&&_.isArray(t.value.val)){var r=0;_.forEach(t.value.val,function(t){r+=t?t.val:0}),a=Y(r)-2}else a=Y(t.value?t.value.val:0)-2;var n=R(t);return"translate("+(.1*n+e*n+(n-.1*n)/2)+","+a+")"}).append("text").attr("font-size","10").text(function(t){if(t.value&&t.value.val&&_.isArray(t.value.val)){var e=0;return _.forEach(t.value.val,function(t){e+=t?t.val:0}),G(e,n.format||"0.0[0000]")}return G(t.value&&t.value.val||0,n.format||"0.0[0000]")}),q=!1;V.each(function(t){var e=d3.select(this).node().getComputedTextLength(),a=R(t);q=q||a-.1*a<e}),q?V.attr("dx","10").attr("dy","4").attr("style","text-anchor: start").attr("transform","rotate(-90)"):V.attr("dy","-10").attr("style","text-anchor: middle")}if(v){var B=1;_.forEach(n.values,function(t){B=_.max([B,t.points.length])}),L.selectAll("text.marker").data(function(r){var n=[];return angular.forEach(r.point.values,function(t,e){var a={value:t,parent:r,valuesCount:r.point.values.length};angular.isArray(r.labels)&&(a.label=r.labels[e]),n.push(a)}),n}).enter().append("text").attr("transform",function(t,e){var a;if(t.value&&t.value.val&&_.isArray(t.value.val)){var r=0;_.forEach(t.value.val,function(t){r+=t?t.val:0}),a=Y(r)-2}else a=Y(t.value?t.value.val:0)-2;var n=R(t);return"translate("+(.1*n+e*n+(n-.1*n)/2)+","+a+")"}).attr("fill",function(t,e,a){return t&&t.value&&t.value.color?t.value.color:""}).attr("style","text-anchor: middle").text(function(t,e,a){var r=a%B,n=e,i=n+r*t.valuesCount;if(_.isArray(t.value)){_.forEach(t.value,function(t){t&&t.val?t.val:0})}else t.value&&t.value.val&&t.value.val;return v[r][n]&&t&&t.value&&t.value.color?["▲","■","◆","●"][i]:""})}if(n.averageLines&&y){var W=["#cf812e","#4f80cf","#cf0d0b","#46cf22","#C57611","#3b05cf"];U.selectAll("line").data(n.averageLines).enter().append("line").attr("y1",function(t){return Y(t.value)}).attr("y2",function(t){return Y(t.value)}).attr("x1","0").attr("x2",a).attr("stroke-width",2).attr("stroke",function(t,e){return y[e]?W[e]:"none"})}return}}function R(t){return $/t.parent.pointsCount/(.2+t.valuesCount-.1)}}(e,r,n,a.ngModel,a.width,a.height,a.barColors,a.labelFormatter,a.splitPairs,a.trendLines,a.trPointRadius,a.tlClass,a.tpClass,a.axisOffsetX,a.axisOffsetY,a.tiltXAxisText,a.showValues,a.showMarkers,a.reverseMarkers,a.showAverageLines)}e.call(n),t.on("$destroy",function(){console.log("tip:"),console.log(r),console.log("subAxisTip:"),console.log(n),r&&"function"==typeof r.remove&&r.remove(),n&&"function"==typeof n.remove&&n.remove()}),i(),a.$watch("tiltXAxisText",function(t,e){t!==e&&i()}),a.$watch("showValues",function(t,e){t!==e&&i()}),a.$watch("showMarkers",function(t,e){t!==e&&i()},!0),a.$watch("showAverageLines",function(t,e){t!==e&&i()},!0),a.$watch("ngModel",function(t,e){t?l(function(){i()},400):i()}),a.$watch("redrawParam",function(t,e){t!==e&&l(function(){i()},400)},!0),a.resizeWatching||(a.resizeWatching=!0,$(window).resize(function(){l(function(){i()},400)}))}}}}}]),angular.module("smbApp").service("PhysicalData",["SmbDataParser",function(t){var e=new t("maps/physicalDash_old.json");function a(t){return!!t&&[{label:"ПВ",color:"#3691EF",value:t[0].data[0].pv},{label:"НПВ",color:"#EF4836",value:t[0].data[0].npv}]}var r={getNPV:function(){return e.getData("npv",a)},getDrillSpeed:function(){return e.getData("drillSpeed",e.getPfQuadParser(1))},getBrigadesCount:function(){return e.getData("brigadesCount",e.getPfTupleParser(2))},getBrigadesDevelopmentCount:function(){return e.getData("brigadesDCount",e.getPfTupleParser(3))},getLaunchedWellsCount:function(){return e.getData("LaunchedWellsCount",e.getPfTupleParser(4))},getFinishedBuildingWellsCount:function(){return e.getData("FinishedBuildingWellsCount",e.getPfTupleParser(5))},getFinishedDrillingWellsCount:function(){return e.getData("FinishedDrillingWellsCount",e.getPfTupleParser(6))},getTimeOfWellsBuilding:function(){return e.getData("TimeOfWellsBuilding",e.getPfQuadParser(10))},getTimeOfWellsDrilling:function(){return e.getData("TimeOfWellsDrilling",e.getPfQuadParser(8))},getTimeOfWellsDevelopment:function(){return e.getData("TimeOfWellsDevelopment",e.getPfQuadParser(9))},getAccidentsCoeff:function(){return e.getData("AccidentsCoeff",e.getYearsComparisonParser(7))},getAccidentsRateCoeff:function(){return e.getData("AccidentsRateCoeff",e.getYearsComparisonParser(11))}};return angular.extend(r,e),r}]),angular.module("smbApp").constant("chartSeriesColors",{planFactChatsColors:["#909090","#357EC7"],factChatsColor:["#909090","#357EC7"],quadColors:["#909090","#357EC7","#909090","#357EC7"],tupleColors:["#909090","#357EC7"],chartColors:["#3578BB","#7AADD4","#88C2E8","#9DD9FF"],plansChartsColors:["#3578BB","#7AADD4"]}),angular.module("smbApp").controller("ChooseSettingsCtrl",["$scope","$location","config",function(t,e,a){t.authData&&t.authData.CanViewSettings?(t.toDashboardMailing=function(){e.path("/dashboardMailing")},t.toIntegrationsManaging=function(){e.path("/integrationManaging")},t.toSystemSettings=function(){window.open(a.getAdminUrl(),"_blank").focus()}):e.path("/main")}]),angular.module("smbApp").service("EconomicalData",["SmbDataParser",function(t){var e=new t("maps/economicalDash.json"),a={getPI:function(){return e.getData("PI",e.getPfTupleParser(0))},getCostOfDev:function(){return e.getData("costOfDev",e.getPfQuadParser(1))},getInvPlanExec:function(){return e.getData("invPlanExec",e.getPfTupleParser(2))},getCostOfBuilding:function(){return e.getData("costOfBuilding",e.getPfQuadParser(3))},getCostOfDrilling:function(){return e.getData("costOfDrilling",e.getPfQuadParser(4))}};return angular.extend(a,e),a}]),angular.module("smbApp").service("CostDay",["SmbDataParser",function(t){}]),angular.module("smbApp").service("RatingDo",["SmbDataParser",function(t){}]),angular.module("smbApp").service("SmbDataParser",["$q","$http",function(c,u){return function(t){var n,i=null,l={},e=[0],o=[];function s(a,r,n){l[n]||(l[n]={}),angular.forEach(e,function(e){o.length?angular.forEach(o,function(t){l[n][e]||(l[n][e]={}),l[n][e][t]=a(r[e][t].data)}):l[n][e]=a(r[e].data)})}this.getPfQuadParser=function(e){return function(t){if(!t)return!1;var a=[];return angular.forEach(t[e].data,function(t){var e={title:t.period,points:[]};angular.forEach(t.data,function(t){e.points.push({labels:[t.type+" - план",t.type+" - факт"],values:[t.plan,t.fact]})}),a.push(e)}),{values:a,subXAxisTitles:["ННС","ГС"],yAxisTitle:t[e].typeOfData}}},this.getPfTupleParser=function(e){return function(t){if(!t)return!1;var a=[];return angular.forEach(t[e].data,function(t){var e={title:t.period,points:[{labels:["План","Факт"],values:[t.plan,t.fact]}]};a.push(e)}),{values:a,yAxisTitle:t[e].typeOfData}}},this.getYearsComparisonParser=function(e){return function(t){if(!t)return!1;var a=[],r=(new Date).getFullYear(),n=r-1;return angular.forEach(t[e].data,function(t){var e={title:t.period,points:[{labels:[n,r],values:[t.LastYear,t.thisYear]}]};a.push(e)}),{values:a,yAxisTitle:t[e].typeOfData}}},this.getSinglePairsParser=function(a){return function(t){if(!t)return!1;var e=[];return angular.forEach(t[a].data,function(t){e.push({title:t.label,points:[{labels:[t.label],values:[t.value]}]})}),{values:e,yAxisTitle:t[a].typeOfData}}},this.getData=function(e,a){var r=c.defer();return i?(s(a,i,e),r.resolve(l[e])):function(){if(n)return n;var e=c.defer();return n=e.promise,u.get(t).success(function(t){i=t,e.resolve(i),n=null}).error(function(t){e.reject(t),n=null}),e.promise}().then(function(t){s(a,t,e),r.resolve(l[e])},function(t){r.reject(t)}),r.promise},this.setSourceDataKeys=function(t){if(void 0===t||!angular.isArray(t))return console.error("wrong source data keys type (should be array)",t,typeof t),!1;e=t},this.setPeriodKeys=function(t){if(void 0===t||!angular.isArray(t))return console.error("wrong source data keys type (should be array)",t,typeof t),!1;o=t},this.readDataSlice=function(t,n,i,l){function r(t,e,a){var r={};r.values=t.values.slice(0,l),r.yAxisTitle=t.yAxisTitle,r.subXAxisTitles=t.subXAxisTitles,n[i]||(n[i]={}),a?(n[i][e]||(n[i][e]={}),n[i][e][a]=r):n[i][e]=r}l=l||3,angular.forEach(t,function(t,a){o.length?angular.forEach(t,function(t,e){r(t,a,e)}):r(t,a)})}}}]),angular.module("smbApp").directive("d3Multiline",["$timeout","D3ChartSizer","ColorIterator",function(i,t,l){var o=new t;return{restrict:"AE",scope:{ngModel:"=",tipClass:"@",tipHeight:"@",titleTipClass:"@",lineColors:"=",pointRadius:"@",pointClass:"@",labelFormatter:"&",axisOffsetX:"@",axisOffsetY:"@",lineWidth:"@",interpolation:"@"},compile:function(t,e){var a;return(a=e).pointRadius=a.pointRadius||"3",a.lineWidth=a.lineWidth||"1.5px;",a.tipHeight=a.tipHeight||"10",a.interpolation=a.interpolation||"basis",{post:function(t,e){var a=new l;t.lineColors&&a.setColors(t.lineColors);var r=d3.select(angular.element(e)[0]).append("svg");function n(){t.height=!1,t.width=!1,o.setSizes(t,e.parent()),function(t,a,r,e,n){t.selectAll("g").remove();var i=a.ngModel;if(i&&i.values){var l={top:15,right:1,bottom:0,left:0,yAxisOffset:0,yAxisWidth:0,xAxisOffset:0};i.yAxisTitle&&(l.yAxisOffset=parseInt(n)||20,l.yAxisWidth=10);var o=_.pluck(i.values,"title");o&&(l.xAxisOffset=parseInt(e)||20);var s=a.width,c=a.height,u=t.attr("width",s).attr("height",c).append("g").attr("transform","translate("+parseInt(l.left+l.yAxisOffset+l.yAxisWidth)+","+parseInt(l.top)+")");if(s=parseInt(s)-l.left-l.right-l.yAxisOffset-l.yAxisWidth,c=c-l.top-l.bottom-l.xAxisOffset,!(s<=0||c<=0)&&i&&i.values){var d=_.pluck(i.values,"points"),m=_.flatten(_.flatten(d),"values"),f=d3.scale.linear().range([c,0]).domain([0,d3.max(m)]),p=d3.tip().attr("class",a.tipClass).offset([-10,0]).html(function(t){var e;return angular.isFunction(a.labelFormatter)&&(e=a.labelFormatter(t)),void 0===e&&(e=t.label?t.label+": "+t.value:t.value),void 0===e&&(e=t),'<span class="'+a.titleTipClass+'">'+e+"</span>"});t.call(p);var h=d3.scale.ordinal().rangeRoundBands([0,s],.1),g=d3.scale.ordinal();if(h.domain(_.map(i.values,function(t){return t.title})),g.domain(d).rangeRoundBands([0,h.rangeBand()]),o){var v=d3.svg.axis().scale(h).orient("bottom");t.append("g").attr("class","x axis").attr("transform","translate("+parseInt(l.yAxisOffset+l.yAxisWidth)+","+parseInt(c+l.top+2)+")").call(v)}if(i.yAxisTitle){var D=d3.svg.axis().scale(f).orient("left").ticks(5,"");t.append("g").attr("class","y axis").attr("transform","translate("+parseInt(l.yAxisOffset)+","+l.top+")").call(D).append("text").attr("class","y-axis-title").attr("y",5).attr("dy","-1em").style("text-anchor","end").text(i.yAxisTitle)}var y=s/d.length,b=[];angular.forEach(d,function(a){angular.forEach(a[0].values,function(t,e){b[e]||(b[e]=[]),b[e].push({x:b[e].length*y+y/2,y:f(t),label:a[0].labels[e],value:t})})}),r.reset(),angular.forEach(b,function(t){var e=d3.svg.line().interpolate(a.interpolation).x(function(t){return t.x}).y(function(t){return t.y});u.append("path").datum(t).attr("stroke-width",a.lineWidth).attr("fill","none").attr("stroke",r.getColor()).attr("d",e),u.selectAll("d-d-circle").data(t).enter().append("circle").attr("r",a.pointRadius).attr("class",a.pointClass).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).on("mouseover",p.show).on("mousedown",p.hide).on("mouseout",p.hide)})}}}(r,t,a,t.axisOffsetX,t.axisOffsetY)}t.$watch("ngModel",function(){void 0!==t.ngModel&&n()},!0),t.resizeWatching||(t.resizeWatching=!0,$(window).resize(function(){i(function(){n()},200)}))}}}}}]),angular.module("smbApp").service("D3ChartSizer",function(){return function(){this.setSizes=function(t,e){t.height||(t.height=parseInt(e.css("height"))),"auto"===t.height&&(t.height="100%"),"string"==typeof t.height&&0<t.height.indexOf("%")?t.height=e.css("height")*(parseInt(t.height)/100):t.height=parseInt(t.height),parseInt(e.css("top"))&&(t.height=t.height-parseInt(e.css("top"))-5),t.width||(t.width=parseInt(e.css("width"))),"auto"===t.width&&(t.width="100%"),"string"==typeof t.width&&0<t.width.indexOf("%")?t.width=e.css("width")*(parseInt(t.width)/100):t.width=parseInt(t.width)}}}),angular.module("smbApp").service("ColorIterator",function(){return function(){this.colors=[],this.i=0,this.setColors=function(t){this.colors=t},this.getColor=function(){var t=this.colors[this.i];return this.i++,this.i>=this.colors.length&&(this.i=0),t},this.reset=function(){this.i=0}}}),angular.module("smbApp").directive("randomItemsShow",function(){return{restrict:"A",link:function(t,e,a){var r=a.randomItemsShow;if(!r)return!1;r+=':not([random-show-animated="scope"])';var n=parseInt(a.randomShowSpeed)||300,i=$(r);i.attr("random-show-animated","scope"),i.css("opacity","0");var l=_.range(0,i.length);l=_.shuffle(l);var o=function(){var t=l.pop();if(null==t)return!1;$(i[t]).fadeTo(n,1,o)};a.$observe("ready",function(t){t&&(l=_.range(0,i.length),l=_.shuffle(l),o())},!0)}}}),angular.module("smbApp").directive("smbAreaPointTooltip",function(){return{templateUrl:"views/directives/areaPointTooltip.html",restrict:"AE"}}),angular.module("smbApp").service("Subsidiary",["smbData","$q",function(t,e){var n={getCompany:function(a){var r=e.defer();return t.getStructure().then(function(t){var e=_.find(t,{id:a});r.resolve(e)},function(t){r.reject(t)}),r.promise},getActiveWellsList:function(t,e){if(t.__activeWellsList&&!e)return t.__activeWellsList;var r=[],n=["Бурение","Спуск","Подъем","Цементирование"];return t.locality&&t.locality.length&&angular.forEach(t.locality,function(a){a.cluster&&a.cluster.length&&angular.forEach(a.cluster,function(e){e.well&&0<e.well.length&&angular.forEach(e.well,function(t){1===t.act&&(t.stage=n[Math.floor(Math.random()*n.length)],t.gti=Math.round(Math.random()),t.telemetria=Math.round(Math.random()),r.push({well:t,cluster:e,locality:a}))})})}),t.__activeWellsList=r},getActiveLocalitiesList:function(t,e){if(t.__activeLocalitiesList&&!e)return t.__activeLocalitiesList;var a=[],r=n.getActiveWellsList(t,e);return angular.forEach(r,function(t){a.push(t.locality)}),a=_.unique(a),t.__activeLocalitiesList=a}};return n}]),angular.module("smbApp").directive("smbFadeOut",function(){return{restrict:"A",scope:!0,link:function(t,e){e.addClass("smb-fadeOut");var a=t.$watch("ready",function(t){t&&(e.addClass("smb-ready"),a())},!0)}}}),angular.module("smbApp").directive("heightToNextSibling",function(){return{restrict:"A",link:function(t,e,a){var r,n,i,l=e.next(a.heightToNextSibling);function o(){n=e.position(),i=l.position(),r=!l||!i||i.top<=n.top?$(window).height():i.top,n.top>$(window).height()&&(n.top=n.top-$(window).height(),i&&(r-=$(window).height())),e.css("height",r-n.top)}o(),t.resizeWatching||(t.resizeWatching=!0,$(window).resize(o)),t.$on("$routeChangeSuccess",o)}}}),angular.module("smbApp").controller("StubCtrl",["$scope",function(t){t.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("smbApp").service("pvChartData",["SmbDataParser",function(t){var e=new t("maps/npv.json"),a={getPV:function(){return e.getData("pv",e.getSinglePairsParser("npv"))},getSubPV:function(){return e.getData("pvSubs",e.getSinglePairsParser("subs"))}};return angular.extend(a,e),a}]),angular.module("smbApp").directive("smbTripleDataSwitch",function(){return{templateUrl:"views/directives/tripleDataSwitch.html",restrict:"E",scope:{filterMode:"=ngModel"},link:function(e){e.switchSourceKey=function(t){e.filterMode=t}}}}),angular.module("smbApp").directive("smbTriplePeriodSwitch",function(){return{templateUrl:"views/directives/triplePeriodSwitch.html",restrict:"E",scope:{timeKey:"=ngModel",hideYear:"=",hideQuarter:"=",hideMonth:"="},link:function(e){e.setTimeKey=function(t){e.timeKey=t}}}}),angular.module("smbApp").directive("smbTripleSaveGroup",function(){return{templateUrl:"views/directives/tripleSaveGroup.html",restrict:"E",scope:{filterMode:"=ngModel"},link:function(e){e.switchSourceKey=function(t){void 0!==e.filterMode&&(e.filterMode=t)}}}}),angular.module("smbApp").controller("StyleCtrl",["$scope",function(t){t.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("smbApp").controller("FieldCtrl",["$scope","$routeParams","$location","$q","$timeout","$filter","appSettings","companiesData","utils","refData","physChartsData","activeObjectsStatuses","apiData","selectWell","xlsx","saveFile","config",function(i,r,e,n,a,l,o,s,c,u,t,d,m,f,p,h,g){if(i.authData&&i.authData.CanViewMap){var v;i.$on("$destroy",function(){d.removeUpdate(i.updateActiveObjectsStatuses),d.stop(),y()}),i.filter={drillType:0,timeKey:"month",timeCount:0,wellState:1,deckEconomicalIsOpen:!0,deckPhysicalIsOpen:!0,showActiveObjects:!0,showObjects:!0,hierarchyMode:!0},i.data={activeObjectsStatuses:[],activeObjects:[],objects:[],companies:[],company:null,fields:[],field:null,clusters:[],loaded:!1,widgetsLoaded:!1,error:null,physWidgetsData:null,finWidgetsData:null,physParams:[],finParams:[],physCharts:[]},(v=o.getSettings("company"))&&(_.extend(i.filter,v),(v=o.getSettings("app"))&&_.extend(i.filter,v)),i.$watch("filter",function(){y()},!0),i.data.loaded=!1,i.data.error=null,n.all([s.getData(),u.getData(),t.getData()]).then(function(t){a(function(){i.data.activeObjects=s.getCompaniesActiveObjects(r.companyUID,r.fieldUID),i.data.objects=s.getCompaniesObjects(r.companyUID,r.fieldUID),i.data.companies=s.getCompaniesNames(),i.data.companies.unshift({name:"Газпром нефть",shortName:"Газпром нефть",UID:"all"}),i.data.company=_.find(i.data.companies,{UID:r.companyUID}),i.data.fields=s.getCompanyFieldsNames(r.companyUID),i.data.field=_.find(i.data.fields,{UID:r.fieldUID}),i.data.clusters=s.getCompanyClustersNames(r.companyUID,r.fieldUID),i.data.activeClusters=_.map(i.data.activeObjects,function(t){return{UID:t.clusterUID,name:t.clusterName}}),i.data.activeClusters=_.uniq(i.data.activeClusters,"UID"),i.data.wells=s.getCompanyWellsNames(r.companyUID,r.fieldUID),i.data.physCharts=t[2],i.data.loaded=!0,b()},500)}),i.getObjectCount=function(t,e){var a=e?i.data.activeObjects:i.data.objects;return _.filter(a,{clusterUID:t,drillType:i.filter.drillType+""}).length},i.$watch("filter.wellState",function(t,e){t!==e&&b()}),i.$watch("filter.timeKey",function(t,e){t!==e&&b()}),i.$watch("filter.drillType",function(t,e){t!==e&&b()}),i.$watch("filter.timeCount",function(t,e){t!==e&&b()});var D=null;i.getObjectName=function(t){return"none"!==t.clusterName?t.fieldName+" - "+t.clusterName+" - "+t.wellName+" - "+i.getDrillTypeName(t.drillType):t.fieldName+" - "+t.wellName+" - "+i.getDrillTypeName(t.drillType)},i.getActiveObjects=function(){return _.filter(i.data.activeObjects,{drillType:i.filter.drillType+""})},i.getObjects=function(){return _.filter(i.data.objects,{drillType:i.filter.drillType+""})},i.selectWell=function(){f(i.data.objects,i.data.activeObjects).then(function(t){e.path("/well/"+r.companyUID+"/"+r.fieldUID+"/"+t)})},i.selectField=function(t){e.path("/field/"+r.companyUID+"/"+t.UID)},i.selectCluster=function(t){e.path("/cluster/"+r.companyUID+"/"+r.fieldUID+"/"+t.UID)},i.selectCompany=function(t){e.path("/company/"+t.UID)},i.getDrillTypeName=u.getDrillTypeName,i.updateActiveObjectsStatuses=function(t){i.data.activeObjectsStatuses=t},i.getObjectGti=function(t){var e=_.find(i.data.activeObjectsStatuses,{objUID:t.wellUID});return!!e&&e.gti},i.getObjectMwd=function(t){var e=_.find(i.data.activeObjectsStatuses,{objUID:t.wellUID});return!!e&&e.mwd},i.getObjectActivity=function(t){var e=_.find(i.data.activeObjectsStatuses,{objUID:t.wellUID});return e&&"0"!==e.activity?u.getActivityName(e.activity):"-"},d.start(),d.addUpdate(i.updateActiveObjectsStatuses),i.emptyPhysData=function(){var e=!0;return _.forEach(i.data.physParams,function(t){i.data.physWidgetsData&&i.data.physWidgetsData[t]&&(e=!1)}),e},i.emptyFinData=function(){var e=!0;return _.forEach(i.data.finParams,function(t){i.data.finWidgetsData&&i.data.finWidgetsData[t]&&(e=!1)}),e},i.openExternalChart=function(){var t="/wsreport/default.aspx?nohdr=true";switch(t=t+"&l="+r.fieldUID,i.filter.drillType){case 0:t+="&drillType=eb";break;case 1:t+="&drillType=zbs";break;case 2:t+="&drillType=prb"}switch(i.filter.wellState){case 0:t+="&wState=undefined";break;case 1:t+="&wState=drilling";break;case 2:case 3:t+="&wState=drilled"}window.open(t,"_blank").focus()},i.getExcel=function(){var t=[],r={sheetName:"Физика",tableDescription:"Физика: "+c.getDrillTypeName(i.filter.drillType)+" "+c.getPeriodLabel(i.filter.timeKey,i.filter.timeCount)+" "+c.getWellStateName(i.filter.wellState),headers:["Показатель","Значение","Разница"],rows:[],merges:[]};_.forEach(i.data.physParams,function(t){if(i.data.physWidgetsData[t]){var e=i.data.physWidgetsData[t],a=[];a.push(e.displayName+" "+e.uom),a.push({value:l("round")(e.value,e.roundTo),type:"n"}),a.push({value:l("round")(e.delta,e.roundTo),type:"n"}),r.rows.push(a)}}),t.push(r),r={sheetName:"Экономика",tableDescription:"Экономика: "+c.getDrillTypeName(i.filter.drillType)+" "+c.getPeriodLabel(i.filter.timeKey,i.filter.timeCount)+" "+c.getWellStateName(i.filter.wellState),headers:["Показатель","Значение","Разница"],rows:[],merges:[]},_.forEach(i.data.finParams,function(t){if(i.data.finWidgetsData[t]){var e=i.data.finWidgetsData[t],a=[];a.push(e.displayName+" "+e.uom),a.push({value:l("round")(e.value,e.roundTo),type:"n"}),a.push({value:l("round")(e.delta,e.roundTo),type:"n"}),r.rows.push(a)}}),t.push(r),r={sheetName:"Активные объекты",tableDescription:"Активные объекты: "+c.getDrillTypeName(i.filter.drillType),headers:["Объект","ГТИ","Тел-я","Этап работ","Цель бурения"],rows:[],merges:[]},_.forEach(i.getActiveObjects(),function(t){var e=[];switch(e.push(i.getObjectName(t)),i.getObjectGti(t)){case"0":e.push("-");break;case"1":e.push("+");break;default:e.push("")}switch(i.getObjectMwd(t)){case"0":e.push("-");break;case"1":e.push("+");break;default:e.push("")}e.push(i.getObjectActivity(t)),e.push(i.getDrillTypeName(t.drillType)),r.rows.push(e)}),t.push(r);var e=p.writeXlsx(t);h.saveFile(e,"xlsx","Компания "+i.data.company.name+" месторождение "+i.data.field.name+" "+c.getDrillTypeName(i.filter.drillType)+" "+c.getPeriodLabel(i.filter.timeKey,i.filter.timeCount)+" "+c.getWellStateName(i.filter.wellState)).promise.then(function(t){window.open(g.getApiUrl()+"document/content?id="+t.data,"_blank").focus(),console.log(t)})}}else e.path("/main");function y(){var t={deckEconomicalIsOpen:i.filter.deckEconomicalIsOpen,deckPhysicalIsOpen:i.filter.deckEconomicalIsOpen};o.setSettings("company",t),t={drillType:i.filter.drillType,timeKey:i.filter.timeKey,wellState:i.filter.wellState,timeCount:i.filter.timeCount,showObjects:i.filter.showObjects},o.setSettings("app",t)}function b(){i.data.widgetsLoaded=!1,i.data.error=null,i.data.physWidgetsData={},i.data.finWidgetsData={},D&&D.reject("cancel");var t=_.filter(i.data.physCharts,function(t){return-1!==t.DrillTypes.indexOf(i.filter.drillType)});t=_.filter(t,function(t){return-1!==t.WellStates.indexOf(i.filter.wellState)});_.sortBy(t,"Order");var e=[];_.forEach(t,function(t){e.push(t.Id)});var a=D=n.defer();n.all([m.getFieldWidgetsData(r.fieldUID,i.filter.drillType,i.filter.timeKey,i.filter.timeCount,i.filter.wellState,e).promise,m.getFieldWidgetsFinData(r.fieldUID,i.filter.drillType,i.filter.timeKey,i.filter.timeCount,i.filter.wellState).promise]).then(function(t){a.resolve(t)},function(t){a.reject(t)}),a.promise.then(function(t){var r=t[0].data;i.data.physParams=_.pluck(r,"Parameter"),i.data.physParams=_.compact(i.data.physParams),i.data.physParams=_.map(i.data.physParams,function(t){return t.replace("Gs","").replace("Nns","")}),i.data.physParams=_.unique(i.data.physParams),_.forEach(i.data.physParams,function(t){var e=_.find(r,{Parameter:t});if(e){var a={displayName:e.DisplayName,uom:e.Uom,value:e.TrendValue,delta:e.TrendDeltaValue,deltaPc:e.TrendDeltaPc,color:e.Color,roundTo:e.RoundTo};i.data.physWidgetsData[t]=a}});var n=t[1].data;i.data.finParams=_.pluck(n,"Parameter"),i.data.finParams=_.compact(i.data.finParams),i.data.finParams=_.map(i.data.finParams,function(t){return t.replace("Gs","").replace("Nns","")}),i.data.finParams=_.unique(i.data.finParams),_.forEach(i.data.finParams,function(t){var e=_.find(n,{Parameter:t});if(e){var a={displayName:e.DisplayName,uom:e.Uom,value:e.TrendValue,delta:e.TrendDeltaValue,deltaPc:e.TrendDeltaPc,color:e.Color,roundTo:e.RoundTo};i.data.finWidgetsData[t]=a}}),i.data.widgetsLoaded=!0,i.data.error=null},function(t){"cancel"!==t&&(i.data.widgetsLoaded=!0,i.data.error=t)})}}]),angular.module("smbApp").controller("TestCtrl",["$scope","$http","xlsx",function(t,e,a){var r=a.writeXlsx([{sheetName:"Разрешительная документация",tableDescription:"Описание",headers:["Заголовок 1, загловок 2"],rows:[],merges:[]}]);e.post("api.php/test/1",{data:r}).then(function(t){window.open(t.data,"_blank").focus()}),console.log(r)}]),angular.module("smbApp").directive("towerSpinner",function(){return{template:'<div class="spinner-container"> <div class="spinner"> <div class="small-dot 1"></div> <div class="small-dot 2"></div> <div class="small-dot 3"></div> <div class="small-dot 4"></div> </div> <div class="main-dot"> <img src="../../images/tower-ico.png"> </div> <p class="spinner-title blink">Загрузка</p> </div>',restrict:"E"}}),angular.module("smbApp").directive("centeredFaSpinner",function(){return{templateUrl:"views/directives/spinner.html",restrict:"E",link:function(t,e){e.css("height","100%"),e.css("display","block")}}}),angular.module("smbApp").directive("smbWidget",function(){return{templateUrl:"views/directives/widget.html",restrict:"E",scope:{ngModel:"=",hideDifference:"=",hidePlan:"="},link:function(e){e.widgetData={},e.isGoodVal=function(){return e.widgetData&&0<e.widgetData.delta&&!e.inverse||e.widgetData&&e.widgetData.delta<0&&e.inverse},e.isBadVal=function(){return e.widgetData&&e.widgetData.delta<0&&!e.inverse||e.widgetData&&0<e.widgetData.delta&&e.inverse},e.invalidDifference=function(){return!e.widgetData||!_.isNumber(e.widgetData.delta)||-9999999==e.widgetData.delta},e.invalidDifferencePercent=function(){return!e.widgetData||!_.isNumber(e.widgetData.deltaPc)||-9999999==e.widgetData.deltaPc},e.invalidValuePlan=function(){return!e.widgetData||!_.isNumber(e.widgetData.valuePlan)},e.$watch("ngModel",function(t){e.widgetData=t},!0)}}}),angular.module("smbApp").service("WidgetDataLoader",function(){return function(){var e,a,i={setFilterMode:function(t){e=t},setTimeKey:function(t){a=t},getDataByKeys:function(t){return void 0!==a?void 0!==e?t[e][a]:t[a]:void 0!==e?t[e]:t},getQuadDataWidgetModel:function(t){var e=i.getDataByKeys(t);if(!e.values||!e.values.length)return{total:0,difference:0};var a=e.values[e.values.length-1].points,r={total:parseFloat(a[0].values[1])+parseFloat(a[1].values[1])};if(1<e.values.length){var n=e.values[e.values.length-2].points;r.difference=r.total-parseFloat(n[0].values[1])-parseFloat(n[1].values[1])}return r},getTupleDataWidgetModel:function(t){var e=i.getDataByKeys(t);if(!e.values||!e.values.length)return{total:0,difference:0};var a=e.values[e.values.length-1].points,r={total:parseFloat(a[0].values[1])};if(1<e.values.length){var n=e.values[e.values.length-2].points;r.difference=r.total-parseFloat(n[0].values[1])}return r},getNPVDataWidgetModel:function(t){var e=i.getDataByKeys(t),a=e[1].value>e[0].value?-1:1;return{total:e[1].value,difference:a*e[1].value}},loadWidgetFromQuad:function(t,e,a){t.then(function(t){e[a]=i.getQuadDataWidgetModel(t)})},loadWidgetFromTuple:function(t,e,a){t.then(function(t){e[a]=i.getTupleDataWidgetModel(t)})}};return i}}),angular.module("smbApp").directive("selectFromFound",["$interpolate","$timeout","$filter","$document","$sce",function(t,i,l,c,u){return{templateUrl:"views/directives/selectFromFound.html",restrict:"AE",scope:{objects:"=",search:"=",maxResults:"@",onSelect:"&",itemClass:"@",itemFormat:"=",itemSelectedClass:"@"},link:function(a,r){function e(){a.selectedIndex=0,a.showList=!1}c.on("mousedown",function(){i(function(){e()})}),e(),a.maxResults=parseInt(a.maxResults),a.maxResults||(a.maxResults=30),a.data={maxResults:a.maxResults},a.setObject=function(t){a.object=t,angular.isFunction(a.onSelect)&&a.onSelect({object:t}),a.search="",e()};var n=t(a.itemFormat);function o(t){return t.split(/[!,.»№;%:?*()\-+=`~\"\s<>]/i).map(function(t){return t.trim().toUpperCase()})}function s(e,t){return _.find(t,function(t){return-1<t.indexOf(e)})}a.getItemString=function(t){return n(t)},a.$watch("search",function(t){t?(a.selectedIndex=0,a.showList=!0):e()},!0),a.keyDown=function(t){40===t.keyCode&&a.selectNext(),38===t.keyCode&&a.selectPrev(),27===t.keyCode&&e(),13===t.keyCode&&function(){if(!a.search)return;var t=l("filter")(a.objects,{name:a.search});if(t.length<1)return;a.selectedIndex||(a.selectedIndex=0),a.setObject(t[a.selectedIndex]),a.search=""}()},a.selectNext=function(){if(!a.search)return!1;var t,e=l("filter")(a.objects,{name:a.search});if(e.length<1)return!1;t=a.data.maxResults?Math.min(a.data.maxResults,e.length):e.length,void 0===a.selectedIndex?a.selectedIndex=0:(a.selectedIndex++,a.selectedIndex>=t&&(a.selectedIndex=0)),i(function(){var t=r.find(".smb-active-search-item"),e=r.find(".dropdown-menu");console.log(t.position()),t&&t.position().top+t.height()>e.height()&&e.scrollTop(e.scrollTop()+t.position().top+t.height()-e.height()),t&&t.position().top<0&&e.scrollTop(e.scrollTop()+t.position().top)})},a.selectPrev=function(){if(!a.search)return!1;var t=l("filter")(a.objects,{name:a.search});if(t.length<1)return!1;var e=Math.min(a.data.maxResults,t.length);(a.selectedIndex<=0||void 0===a.selectedIndex)&&(a.selectedIndex=e),a.selectedIndex--,i(function(){var t=r.find(".smb-active-search-item"),e=r.find(".dropdown-menu");console.log(t.position()),t&&t.position().top+t.height()>e.height()&&e.scrollTop(e.scrollTop()+t.position().top+t.height()-e.height()),t&&t.position().top<0&&e.scrollTop(e.scrollTop()+t.position().top)})},a.objectComparator=function(t,e){if(!t||!e)return!1;if(angular.equals(t,e))return!0;for(var a=o(t),r=o(e),n=0,i=0;i<r.length;i++){var l=s(r[i],a);l&&(n++,a=_.filter(a,function(t){return t!==l}))}return n===r.length},a.highlight=function(t,e){if(!e)return u.trustAsHtml(t);var a=o(e);if(a.length){t="<div>"+t+"</div>";for(var r=0;r<a.length;r++)t=t.replace(new RegExp(a[r],"gi"),'<span class="highlightedText">$&</span>')}return u.trustAsHtml(t)}}}}]),angular.module("smbApp").directive("fullHeightWithout",["$timeout",function(n){return{restrict:"A",link:function(t,a,r){function e(){var e=0;if(r.fullHeightWithout)if(_.isNaN(parseInt(r.fullHeightWithout))){var t=$(r.fullHeightWithout);t.length&&angular.forEach(t,function(t){e+=$(t).height()})}else e+=parseInt(r.fullHeightWithout);a.height($(window).height()-e)}e(),a.__resizeWatching||$(window).resize(e),t.$on("$routeChangeSuccess",e),n(e,500)}}}]),angular.module("smbApp").directive("smbDocumentsMenu",["$location","authData",function(a,t){return{templateUrl:"views/directives/documentsMenu.html",restrict:"AE",link:function(e){e.page=a.path(),e.authData=null,t.getData().then(function(t){e.authData=t}),e.pageDisabled=function(t){switch(t){case"contracts":return!(e.authData&&e.authData.CanViewAgreements);case"psd":return!(e.authData&&e.authData.CanViewPsd);case"permitdocuments":return!(e.authData&&e.authData.CanViewRd);case"regulatorydocuments":return!(e.authData&&e.authData.CanViewNmd);default:return!1}},e.movePage=function(t){a.path(t)}}}}]),angular.module("smbApp").controller("ContractsCtrl",["$scope","$q","$location","$modal","$timeout","xlsx","companiesData","appSettings","apiData","saveFile","config","$filter",function(o,t,e,a,r,n,i,l,s,c,u,d){if(o.authData&&o.authData.CanViewAgreements){o.$on("$destroy",function(){p()}),o.tableCols=[{name:"Номер внешний",id:"externalID"},{name:"ДО",id:"branchName"},{name:"Контрагент",id:"contractorName"},{name:"Код услуги",id:"serviceCode"},{name:"Тип сервиса",id:"serviceName"},{name:"Дата заключения договора",id:"signatureDate"},{name:"Начало действия",id:"startDate"},{name:"Конец действия",id:"finalDate"},{name:"Стоимость, без НДС",id:"price"},{name:"Стоимость, с НДС",id:"priceVAT"},{name:"НДС",id:"vat"},{name:"Стоимость в SAP",id:"sapSum"},{name:"Доп соглашения",id:"linkedDocs"}],o.searchCols=[{name:"По всем полям",id:"",show:!0},{name:"Номер внешний",id:"externalID",show:!0},{name:"Контрагент",id:"contractorName",show:!0},{name:"Код услуги",id:"serviceCode",show:!0},{name:"Тип сервиса",id:"serviceName",show:!0}],o.filter={search:"",viewMode:!0,companyId:"",serviceTypeId:"",searchCol:"",contractStatusId:"",showedCols:1<o.user.AllowedDzo.length?["branchName","externalID","contractorName","startDate","finalDate","price","linkedDocs"]:["externalID","contractorName","startDate","finalDate","price","linkedDocs"],contractYear:"",itemsPerPage:12,itemsPerPageSelect:12,tableOdataQuery:"?$skip=0&$top=12",tableState:null},o.data={companies:[],companiesFilter:[],serviceTypes:[],contractStatuses:[{id:"",name:"Все"},{id:1,name:"Действующие"},{id:2,name:"Завершенные"}],contractYears:[],loaded:!1,tableLoaded:!1,error:null,items:[],itemsSkip:0,enableTable:!1},function(){var t=l.getSettings("contracts");if(t){var e=_.pluck(o.tableCols,"id");t.showedCols=_.intersection(e,t.showedCols),angular.extend(o.filter,t)}}(),o.$watch("filter",function(){p()},!0),o.getSearchList=function(){return o.filter.searchCol?o.filter.searchCol:_.compact(_.pluck(o.searchCols,"id")).join("+")},o.$watch("filter.itemsPerPageSelect",function(t){t&&(o.filter.itemsPerPage=t)}),o.$watch("filter.showedCols",function(e){_.forEach(o.searchCols,function(t){t.show=-1!==e.indexOf(t.id)||!t.id}),o.filter.searchCol&&-1===e.indexOf(o.filter.searchCol)&&(o.filter.searchCol="")}),o.showCol=function(t){return-1!==o.filter.showedCols.indexOf(t)},o.colName=function(t){var e=_.find(o.tableCols,{id:t});return e?e.name:""};var m=null;o.data.tableLoaded=!1,o.updateTableData=function(e){if(e&&o.filter.tableState&&e.pagination&&o.filter.tableState.pagination&&_.isEqual(o.filter.tableState.pagination,e.pagination)&&(e.pagination.start=0),e=e||o.filter.tableState,o.filter.itemsPerPage&&o.data.enableTable){o.filter.tableState=_.cloneDeep(e),o.data.tableLoaded=!1,o.data.error=!1,m&&m.reject("cancel");var a=e.pagination.start||0;o.data.itemsSkip=a;var r=o.filter.itemsPerPage||10,n=null;e.sort.predicate&&(n=e.sort.reverse?e.sort.predicate+" desc":e.sort.predicate);var i=[];if(e.year&&i.push("year(startDate) le "+e.year+" and year(finalDate) ge "+e.year),e.branchUID&&i.push("contains(branchUID, '"+e.branchUID+"')"),e.serviceType&&i.push("contains(serviceCode, '"+e.serviceType+"')"),o.filter.search){var t=o.getSearchList().split("+");t="("+(t=_.map(t,function(t){return"contains(tolower("+t+"), '"+o.filter.search.toLowerCase()+"')"})).join(" or ")+")",i.push(t)}if(e.status){var l=moment().toISOString();1===e.status?i.push("startDate lt "+l+" and "+l+" lt finalDate"):i.push("finalDate lt "+l)}i=i&&i.length?i.join(" and "):null,o.data.items=[],o.filter.tableOdataQuery="$skip="+a+"&$top="+r+(n?"&$orderby="+n:"")+(i?"&$filter="+encodeURIComponent(i):""),(m=s.getContractsCount(i)).promise.then(function(t){e.pagination.numberOfPages=Math.ceil(t/o.filter.itemsPerPage),m=s.getContractsData(a,r,n,i),o.data.tableLoaded=!0,m.promise.then(function(t){o.data.items=t.data.value},function(t){"cancel"!==t&&(o.data.tableLoaded=!0,o.data.error=t)})},function(t){"cancel"!==t&&(o.data.tableLoaded=!0,o.data.error=t)})}else o.filter.tableState=e},t.all([i.getData(),s.getContractsYears().promise,s.getContractsServices().promise]).then(function(t){o.data.companiesFilter=i.getCompaniesNames(),o.data.companiesFilter.unshift({name:"Все",fullName:"Все",UID:""}),o.data.contractYears=_.map(t[1].data.sort(),function(t){return{id:t,name:t+""}}),o.data.contractYears.unshift({id:"",name:"Все"});var e=_.map(t[2].data,function(t){return{id:t.serviceCode,name:t.serviceName}});(e=_.sortBy(e,function(t){return"10200"<=t.id&&t.id<"10300"?"000"+t.id.slice(3):"10300"<=t.id&&t.id<"10400"?"001"+t.id.slice(3):"10400"<=t.id&&t.id<"10500"?"002"+t.id.slice(3):t.id})).unshift({name:"Все",id:""}),o.data.serviceTypes=e,r(function(){o.data.enableTable=!0,o.updateTableData(o.filter.tableState)},500),o.data.loaded=!0}),o.openLink=function(t){if(t){var e=window.open(t,"_blank");e&&e.focus()}},o.checkFields=function(e){var a=!1;return _.forEach(o.tableCols,function(t){a=a||!e[t.id]}),!a};var f=a({scope:o,template:"views/modals/show-contract.html",show:!1,animation:"am-fade-and-scale"});o.showContractModal=function(t){o.selectedContract=t,f.$promise.then(f.show)},o.getExcel=function(){window.open(u.getApiUrl()+"agreement/report?"+o.filter.tableOdataQuery,"_blank").focus()}}else e.path("/main");function p(){var t=_.clone(o.filter);l.setSettings("contracts",t)}}]),angular.module("smbApp").filter("join",function(){return function(t,a,e){if(!Array.isArray(t))return t;_.map(t,function(t){return t[e]});var r=angular.isUndefined(e)?t:_.map(t,function(t){return t[e]});return _.reduce(r,function(t,e){return t+a+e})}}),angular.module("smbApp").controller("PsdDocumentsCtrl",["$scope","$q","$location","$modal","$timeout","companiesData","refData","appSettings","apiData","xlsx","saveFile","addPsdDocumentModal","showPsdDocumentModal","editPsdDocumentModal","accept","msg","config",function(l,t,e,a,r,n,i,o,s,c,u,d,m,f,p,h,g){if(l.authData&&l.authData.CanViewPsd){var v,D,y,b,C,w;l.$on("$destroy",function(){N()}),l.tableCols=[{name:"ДО",id:"branchName"},{name:"Месторождение",id:"localityName"},{name:"Тип профиля",id:"profileType"},{name:"Тип проекта",id:"documentType"},{name:"Наименование проекта",id:"documentName"},{name:"Номер проекта",id:"projectNumber"},{name:"Цель бурения",id:"drillTypeEnum"},{name:"Назначение скважины",id:"categoryTypeEnum"},{name:"Глубина бурения по стволу",id:"MeasuredDepthActual"},{name:"Глубина по вертикали",id:"VerticalDepthActual"},{name:"Отход по вертикали",id:"OffsetActual"},{name:"Диаметр ЭК",id:"CasingDiameterActual"},{name:"Глубина спуска ЭК",id:"CasingShoeDepthActual"},{name:"Целевык пласты",id:"GeoHorizonNames"},{name:"Дата документа ГГЭ",id:"inspectionFileDate"},{name:"Скачать всё",id:"inspectionFile"},{name:"Дата разработки",id:"developmentDate"},{name:"Дата загрузки",id:"UploadDate"},{name:"Инициатор загрузки",id:"UploaderUserName"},{name:"Документы",id:"files"}],l.searchCols=[{name:"По всем полям",id:"",show:!0},{name:"Месторождение",id:"localityName",show:!0},{name:"Тип профиля скважин",id:"profileType",show:!0},{name:"Инициатор загрузки",id:"UploaderUserName",show:!0},{name:"Наименование проекта",id:"documentName",show:!0},{name:"Номер проекта",id:"projectNumber",show:!0}],l.filter={search:"",viewMode:!0,companyId:"",documentType:"",searchCol:"",showedCols:_.pluck(l.tableCols,"id"),psdDocumentYear:"",itemsPerPage:12,itemsPerPageSelect:12,tableOdataQuery:"?$skip=0&$top=12",tableState:null},l.data={companies:[],companiesFilter:[],psdDocumentTypes:[],psdDocumentTypesFilter:[],psdDocumentYears:[],planWells:[],loaded:!1,tableLoaded:!1,error:null,items:[],itemsSkip:0,enableTable:!1},(w=o.getSettings("psdDocuments"))&&(angular.extend(l.filter,w),angular.isArray(l.filter.showedCols)||(l.filter=[]),v=l.filter.showedCols,D=_.map(l.tableCols,function(t){return t.id}),b=v,C=D,y=_.filter(b,function(t){return-1<C.indexOf(t)}),l.filter.showedCols=y),l.$watch("filter",function(){N()},!0),l.getSearchList=function(){return l.filter.searchCol?l.filter.searchCol:_.compact(_.pluck(l.searchCols,"id")).join("+")},l.$watch("filter.itemsPerPageSelect",function(t){t&&(l.filter.itemsPerPage=t)}),l.$watch("filter.showedCols",function(e){_.forEach(l.searchCols,function(t){t.show=-1!==e.indexOf(t.id)||!t.id}),l.filter.searchCol&&-1===e.indexOf(l.filter.searchCol)&&(l.filter.searchCol="")}),l.showCol=function(t){return-1!==l.filter.showedCols.indexOf(t)},l.colName=function(t){var e=_.find(l.tableCols,{id:t});return e?e.name:""};var I=null;l.data.tableLoaded=!1,l.updateTableData=function(e){if(e&&l.filter.tableState&&e.pagination&&l.filter.tableState.pagination&&_.isEqual(l.filter.tableState.pagination,e.pagination)&&(e.pagination.start=0),e=e||l.filter.tableState,l.filter.itemsPerPage&&l.data.enableTable){l.filter.tableState=_.cloneDeep(e),l.data.tableLoaded=!1,l.data.error=!1,I&&I.reject("cancel");var a=e.pagination.start||0;l.data.itemsSkip=a;var r=l.filter.itemsPerPage||10,n=null;e.sort.predicate&&(n=e.sort.reverse?e.sort.predicate+" desc":e.sort.predicate);var i=[];if(e.year&&i.push("year(developmentDate) le "+e.year+" and year(developmentDate) ge "+e.year),e.branchId&&i.push("contains(branchId, '"+e.branchId+"')"),e.documentType&&"Все"!==e.documentType&&i.push("contains(documentType, '"+e.documentType+"')"),l.filter.search){var t=l.getSearchList().split("+");t="("+(t=_.map(t,function(t){return"contains(tolower("+t+"), '"+l.filter.search.toLowerCase()+"')"})).join(" or ")+")",i.push(t)}i=i&&i.length?i.join(" and "):null,l.filter.tableOdataQuery="$skip="+a+"&$top="+r+(n?"&$orderby="+n:"")+(i?"&$filter="+encodeURIComponent(i):""),(I=s.getPsdDocumentsCount(i)).promise.then(function(t){e.pagination.numberOfPages=Math.ceil(t/l.filter.itemsPerPage),(I=s.getPsdDocumentsData(a,r,n,i)).promise.then(function(t){l.data.tableLoaded=!0,l.data.items=t.data.value},function(t){"cancel"!==t&&(l.data.tableLoaded=!0,l.data.error=t,l.data.items=[])})},function(t){"cancel"!==t&&(l.data.tableLoaded=!0,l.data.error=t,l.data.items=[])})}else l.filter.tableState=e},t.all([n.getData(),s.getPsdDocumentsYears().promise,s.getPsdDocumentTypes().promise,i.getData(),s.getDrillPlanWells().promise,s.getPsdDiameters().promise]).then(function(t){l.data.companiesFilter=n.getCompaniesNames(),l.data.companiesFilter.unshift({name:"Все",fullName:"Все",UID:""}),l.data.psdDocumentTypesFilter=_.map(t[2].data.sort(),function(t){return{id:t,name:t+""}}),l.data.psdDocumentTypesFilter.unshift({id:"",name:"Все"}),l.data.psdDocumentYears=_.map(t[1].data.sort(),function(t){return{id:t,name:t+""}}),l.data.psdDocumentYears.unshift({id:"",name:"Все"}),l.data.planWells=t[4].data||[],l.data.psdDiameters=t[5].data||[],r(function(){l.data.enableTable=!0,l.updateTableData(l.filter.tableState)},500),l.data.loaded=!0}),l.openDocument=function(t){window.open(g.getApiUrl()+"document/"+t.objUID+"/content","_blank").focus()},l.deletePsdDocument=function(t){p("Вы действительно хотите удалить документ?").then(function(){s.deleteDocument(t.objUID).promise.then(function(){l.updateTableData()})})},l.showPsdDocumentModal=function(t){l.user.CanEditPsd?f(t,l.data.psdDocumentTypesFilter.slice(1),l.data.psdDiameters).then(function(){l.updateTableData()},function(t){h.pop("error","Ошибка запроса","Не удалось обновить документ.",0)}):m(t)},l.addPsdDocument=function(){d(l.data.psdDocumentTypesFilter.slice(1),l.data.psdDiameters).then(function(){l.updateTableData()},function(t){h.pop("error","Ошибка запроса","Не удалось добавить документ.",0)})},l.getExcel=function(){window.open(g.getApiUrl()+"psd/report?"+l.filter.tableOdataQuery,"_blank").focus()}}else e.path("/main");function N(){var t=_.clone(l.filter);o.setSettings("psdDocuments",t)}}]),angular.module("smbApp").controller("PermitDocumentsCtrl",["$rootScope","$scope","$q","$location","$modal","$timeout","companiesData","refData","appSettings","apiData","xlsx","saveFile","addPsdDocumentModal","editPsdDocumentModal","addPermitDocumentModal","editPermitDocumentProjectNumberModal","editPermitDocumentOFDateModal","accept","msg","config",function(t,s,e,a,r,n,i,l,o,c,u,d,m,f,p,h,g,v,D,y){if(s.authData&&s.authData.CanViewRd){var b;s.$on("$destroy",function(){w()}),s.tableCols=[{name:"ДО",id:"DzoName"},{name:"Месторождение",id:"LocalityName"},{name:"Куст",id:"ClusterName"},{name:"№ скважины",id:"WellName"},{name:"Цель бурения",id:"DrillType"},{name:"Тип скважины",id:"Dn7WellType"},{name:"Начало бурения",id:"DrillBegin"},{name:"Окончание бурения",id:"DrillEnd"},{name:"Дата ввода",id:"ExploitationDate"},{name:"Дата ввода в ОФ",id:"DataVvodaVOsnovnyeFondy"},{name:"Номер проекта",id:"ProjectNumber"},{name:"Потрачено",id:"Ammount"},{name:"Потрачено по справкам-начислениям",id:"UnconfirmedDocumentsAmmount"},{name:"Сумма ввода в ОФ",id:"EnteredSumInOF"},{name:"Валюта",id:"UnitOfMeasure"},{name:"Дата оприходования",id:"PostingDate"},{name:"Стоимость прихода",id:"PostingAmount"},{name:"Инвентарный номер",id:"InventoryNumber"},{name:"КС-11",id:"Ks11Id"},{name:"КС-14",id:"Ks14Id"},{name:"КС-23",id:"Ks23Id"},{name:"Акт горного надзора",id:"ActGornyNadzorId"},{name:"Гос. экспертиза",id:"GlavGosExpertizaId"},{name:"Экол. экспертиза",id:"EkoExpertizaId"},{name:"Пром. экспертиза",id:"PromExpertizaId"},{name:"Наличие всех документов",id:"HasAllWellDocs"},{name:"Документы",id:"files"}],s.tableDateCols=[{name:"Начало бурения",id:"DrillBegin"},{name:"Окончание бурения",id:"DrillEnd"},{name:"Дата ввода",id:"ExploitationDate"},{name:"Дата ввода в ОФ",id:"DataVvodaVOsnovnyeFondy"},{name:"Дата оприходования",id:"PostingDate"}],s.searchCols=[{name:"По всем полям",id:"",show:!0},{name:"ДО",id:"DzoName",show:!0},{name:"Месторождение",id:"LocalityName",show:!0},{name:"Куст",id:"ClusterName",show:!0},{name:"№ скважины",id:"WellName",show:!0},{name:"Цель бурения",id:"DrillType",show:!0},{name:"Тип скважины",id:"Dn7WellType",show:!0},{name:"Номер проекта",id:"ProjectNumber",show:!0}],s.filter={search:"",viewMode:!0,companyId:"",fieldId:"",documentType:"",searchCol:"",showedCols:_.pluck(s.tableCols,"id"),itemsPerPage:12,itemsPerPageSelect:12,tableOdataQuery:"?$skip=0&$top=12",tableState:null,dateColId:"DrillBegin",startDate:"",endDate:""},s.data={companies:[],companiesFilter:[],fieldsFilter:[],permitDocumentTypes:[],permitDocumentTypesFilter:[],psdDocumentTypes:[],loaded:!1,tableLoaded:!1,error:null,items:[],itemsSkip:0,enableTable:!1},(b=o.getSettings("permitDocuments"))&&angular.extend(s.filter,b),s.$watch("filter",function(){w()},!0),s.getSearchList=function(){return s.filter.searchCol?s.filter.searchCol:_.compact(_.pluck(s.searchCols,"id")).join("+")},s.$watch("filter.itemsPerPageSelect",function(t){t&&(s.filter.itemsPerPage=t)}),s.$watch("filter.showedCols",function(e){_.forEach(s.searchCols,function(t){t.show=-1!==e.indexOf(t.id)||!t.id}),s.filter.searchCol&&-1===e.indexOf(s.filter.searchCol)&&(s.filter.searchCol="")}),s.showCol=function(t){return-1!==s.filter.showedCols.indexOf(t)},s.colName=function(t){var e=_.find(s.tableCols,{id:t});return e?e.name:""};var C=null;s.data.tableLoaded=!1,s.updateTableData=function(e){if(e&&s.filter.tableState&&e.pagination&&s.filter.tableState.pagination&&_.isEqual(s.filter.tableState.pagination,e.pagination)&&(e.pagination.start=0),e=e||s.filter.tableState,s.filter.itemsPerPage&&s.data.enableTable){s.filter.tableState=_.cloneDeep(e),s.data.tableLoaded=!1,s.data.error=!1,C&&C.reject("cancel");var t=e.pagination.start||0;s.data.itemsSkip=t;var a=s.filter.itemsPerPage||10,r=null;e.sort.predicate&&(r=e.sort.reverse?e.sort.predicate+" desc":e.sort.predicate);var n,i=[];if(e.DzoId&&i.push("contains(tolower(DzoId), '"+e.DzoId.toLowerCase()+"')"),e.LocalityId&&i.push("contains(tolower(LocalityId), '"+e.LocalityId.toLowerCase()+"')"),e.documentType)"noOne"===e.documentType&&(n=(n=_.map(s.data.permitDocumentTypes,function(t){return t.id+" eq null "})).join(" and ")),"any"===e.documentType&&(n="("+(n=_.map(s.data.permitDocumentTypes,function(t){return t.id+" ne null "})).join(" or ")+")"),"noOne"!==e.documentType&&"any"!==e.documentType&&(n=e.documentType+" ne null"),i.push(n);if(s.filter.dateColId&&s.filter.startDate&&i.push(s.filter.dateColId+" ge "+s.filter.startDate+"T00:00:00Z "),s.filter.dateColId&&s.filter.endDate&&i.push(s.filter.dateColId+" lt "+moment(s.filter.endDate,"YYYY-MM-DD").add(1,"days").format("YYYY-MM-DD")+"T00:00:00Z"),s.filter.search){var l=s.getSearchList().split("+");l="("+(l=_.map(l,function(t){return"contains(tolower("+t+"), '"+s.filter.search.toLowerCase()+"')"})).join(" or ")+")",i.push(l)}var o="$skip="+t+"&$top="+a+(r?"&$orderby="+r:"")+((i=i&&i.length?i.join(" and "):null)?"&$filter="+encodeURIComponent(i):"");s.data.tableLoaded=!1,s.data.error=!1,C&&C.reject("cancel"),s.filter.tableOdataQuery=o,C=c.getPermitDocumentsData(t,a,r,i).promise.then(function(t){e.pagination.numberOfPages=Math.ceil(t.totalCount/s.filter.itemsPerPage),s.data.tableLoaded=!0,s.data.items=t.items,C=null},function(t){"cancel"!==t&&(s.data.tableLoaded=!0,s.data.error=t,s.data.items=[])})}else s.filter.tableState=e},e.all([i.getData(),c.getPermitDocumentTypes().promise,c.getPsdDocumentTypes().promise,l.getData()]).then(function(t){s.data.companiesFilter=i.getCompaniesNames(),s.data.companiesFilter.unshift({name:"Все",UID:""}),s.data.fieldsFilter=i.getCompanyFieldsNames(),s.data.fieldsFilter.unshift({name:"Все",UID:""}),s.data.permitDocumentTypes=_.map(t[1].data.sort(),function(t){return{id:t.MemberName,name:t.Value}}),s.data.permitDocumentTypesFilter=_.clone(s.data.permitDocumentTypes),s.data.permitDocumentTypesFilter.unshift({id:"any",name:"Любой"}),s.data.permitDocumentTypesFilter.unshift({id:"noOne",name:"Ни одного"}),s.data.permitDocumentTypesFilter.unshift({id:"",name:"Все"}),s.data.psdDocumentTypes=_.map(t[2].data.sort(),function(t){return{id:t,name:t+""}}),n(function(){s.data.enableTable=!0,s.updateTableData(s.filter.tableState)},500),s.data.loaded=!0}),s.$watch("filter.companyId",function(t,e){t!==e&&(s.data.fieldsFilter=i.getCompanyFieldsNames(s.filter.companyId),s.data.fieldsFilter.unshift({name:"Все",UID:""}),s.filter.fieldId="")}),s.openDocument=function(t){window.open(y.getApiUrl()+"document/"+t+"/content","_blank").focus()},s.deleteDocument=function(t){v("Вы действительно хотите удалить документ?").then(function(){c.deleteDocument(t).promise.then(function(){s.updateTableData()})})},s.addPermitDocument=function(t,e){var a=(a=_.find(s.data.permitDocumentTypes,{id:e}))&&a.name;p(t,a,s.data.permitDocumentTypes).then(function(){s.updateTableData()},function(){D.pop("error","Ошибка запроса","Не удалось добавить документ",0)})},s.changeProjectNumber=function(t){h(t).then(function(){s.updateTableData()},function(){D.pop("error","Ошибка запроса","Не удалось обновить номер проекта",0)})},s.changeOFDate=function(t){g(t).then(function(){s.updateTableData()},function(){D.pop("error","Ошибка запроса","Не удалось обновить дату ввода в ОФ",0)})},s.editPsdDocument=function(t){t.PsdId?c.getPsdDocument(t.PsdId).promise.then(function(t){var e=t.data;f(e,s.data.psdDocumentTypes).then(function(){s.updateTableData()},function(){D.pop("error","Ошибка запроса","Не удалось обновить документ",0)})},function(){D.pop("error","Ошибка запроса","Не удалось получить ПСД документ",0)}):m(s.data.psdDocumentTypes).then(function(){s.updateTableData()},function(){D.pop("error","Ошибка запроса","Не удалось обновить документ",0)})},s.getExcel=function(){window.open(y.getApiUrl()+"rd/report?"+s.filter.tableOdataQuery,"_blank").focus()}}else a.path("/main");function w(){var t=_.clone(s.filter);console.log(t),o.setSettings("permitDocuments",t)}}]),angular.module("smbApp").service("appStatus",["$http","buildDate","msg",function(t,e,a){var r=null,n=!1;return{getStatus:function(){return r},update:function(){n||(n=!0,t.get("maps/buildStatus.json").success(function(t){r=t,n=!1,e.buildDate!==r.buildDate&&(console.log("buildDate.buildDate !== status.buildDate. buildDate.buildDate="+e.buildDate+", status.buildDate="+r.buildDate),a.updateApp("error","Приложение устарело.","Приложение устарело, необходимо обновить.",0,function(){location.reload()}))}).error(function(t){n=!1}))}}}]),angular.module("smbApp").service("schedule",["$interval",function(t){var a=[],e=null;function r(){angular.forEach(a,function(t){t.update()})}return{start:function(){r(),e=t(r,6e5)},stop:function(){e&&t.cancel(e)},addUpdate:function(t){a.push(t)},removeUpdate:function(t){var e=a.indexOf(t);-1<e&&a.splice(e,1)}}}]),angular.module("smbApp").constant("buildDate",{buildDate:"Tue Mar 16 2021 02:41:09 GMT+0700 (GMT+07:00)"}),angular.module("smbApp").directive("smbTripleTypeSwitch",function(){return{templateUrl:"views/directives/tripleTypeSwitch.html",restrict:"E",scope:{filterType:"=ngModel"},link:function(e){e.switchTypeKey=function(t){e.filterType=t}}}}),angular.module("smbApp").directive("smbPlansMenu",["$location",function(e){return{templateUrl:"views/directives/plansMenu.html",restrict:"AE",link:function(t){t.page=e.path()}}}]),angular.module("smbApp").controller("ProductionPlanCtrl",["$scope","$location","$q","$timeout","$modal","chartSeriesColors","appSettings","companiesData","apiData","xlsx","saveFile",function(g,t,r,e,a,n,i,l,o,s,c){if(g.authData&&g.authData.CanViewPlanData){g.$on("$destroy",function(){}),g.filter={showValues:!0,tableMode:!0,timeKey:"month",viewMode:!0,companyUID:null,year:null,planYear:null,drillType:null,planTypeName:null,planStatusName:null,plansUIDs:[],growingData:!1,growingChartsData:!1},g.data={loaded:!1,plansLoaded:!0,error:null,fullPlans:{},plansSrc:[],companies:[],years:[],planYears:[],drillTypes:[],planTypeNames:[],planStatusNames:[],plans:[],selectedPlans:[],tableData:null,chartsData:null,filteredPlansSrc:null,filteredPlans:null,avaliablePlanStatuses:[]},g.getPlanCompanyName=function(t){var e=_.filter(g.data.companies,t?{UID:t}:null);return null!==e&&0<e.length?e[0].name:null},r.all([l.getData(),o.getPlans().promise]).then(function(t){g.data.plansSrc=t[1].data,g.data.filteredPlansSrc=_.cloneDeep(g.data.plansSrc),g.data.filteredPlans=_.cloneDeep(g.data.filteredPlansSrc),m(),g.user&&g.user.AllowedDzo&&1<g.user.AllowedDzo.length?g.data.avaliablePlanStatuses=[{id:0,name:"Черновик"},{id:1,name:"Опубликован в ДО"},{id:2,name:"Согласован в КЦ"},{id:3,name:"На доработку"}]:g.data.avaliablePlanStatuses=[{id:0,name:"Черновик"},{id:1,name:"Опубликован в ДО"}],g.data.loaded=!0}),g.getAvaliablePlanStatusName=function(t){var e=_.find([{id:0,name:"Черновик"},{id:1,name:"Опубликован в ДО"},{id:2,name:"Согласован в КЦ"},{id:3,name:"На доработку"}],{id:t});return e&&e.name||t},g.$watch("filter.companyUID",function(t,e){t!==e&&(f(),m())}),g.$watch("filter.year",function(t,e){t!==e&&(f(),m())}),g.$watch("filter.drillType",function(t,e){t!==e&&(f(),m())}),g.$watch("filter.planTypeName",function(t,e){t!==e&&(f(),m())}),g.$watch("filter.planStatusName",function(t,e){t!==e&&(f(),m())}),g.$watch("filter.plansUIDs",function(t,e){t!==e&&function(){if(g.filter.plansUIDs&&g.filter.plansUIDs.length){g.data.selectedPlans=[],g.data.plansLoaded=!1,g.data.error=null,g.filter.planYear=null,g.data.planYears=[],u&&u.reject("cancel");var e=[];_.forEach(g.filter.plansUIDs,function(t){e.push(o.getPlan(t).promise)});var a=u=r.defer();r.all(e).then(function(t){a.resolve(t)},function(t){a.reject(t)}),a.promise.then(function(t){if(g.data.selectedPlans=_.map(t,function(t){return t.data}),g.data.selectedPlans&&1===g.data.selectedPlans.length){var e,a=g.data.selectedPlans[0];switch(g.filter.timeKey){case"month":e=a&&a.ParsByMonth;break;case"quarter":e=a&&a.ParsByQuarter;break;default:e=a&&a.ParsByMonth}e=(e=e&&e[0])&&e.Values;var r=_.pluck(e,"Year");(r=_.uniq(r)).sort(),g.data.planYears=_.map(r,function(t){return{id:t,name:t+""}}),g.filter.planYear=r&&r[0]}else g.filter.planYear=void 0;g.data.plansLoaded=!0},function(t){"cancel"!==t&&(g.data.plansLoaded=!0,g.data.error=t)})}else u&&u.reject("cancel"),g.data.plansLoaded=!0,g.data.error=null,g.data.selectedPlans=null,h(),p()}()},!0),g.$watch("filter.timeKey",function(t,e){t!==e&&(h(),p())}),g.$watch("filter.planYear",function(t,e){h(),p()});var u=null;g.plansChartsColors=n.plansChartsColors,g.planSelected=function(t){return t&&-1!==g.filter.plansUIDs.indexOf(t)},g.selectPlan=function(t){if(!t)return!1;-1===g.filter.plansUIDs.indexOf(t)?g.filter.plansUIDs.push(t):g.filter.plansUIDs.splice(g.filter.plansUIDs.indexOf(t),1)};var d=a({scope:g,template:"views/modals/acceptance.html",show:!1});g.acceptanceModal=function(){d.$promise.then(d.show)},g.getPeriodLabel=function(){if(!g.filter.timeKey)return"";var t="";switch(t=g.data.selectedPlans&&1===g.data.selectedPlans.length?g.data.selectedPlans[0].PlanYear:t,t=g.filter.year?g.filter.year:t,g.filter.timeKey){case"month":return"Янв-Дек "+(t?t+" г.":"");case"quarter":return"1-4 кв. "+(t?t+" г.":"");case"year":return t?t+" г.":"";default:return""}},g.openDrillProject=function(){window.open("/DrillProject.Client/DrillProject.Main.application","_blank").focus()},g.changePlanStatus=function(t,e){console.log(arguments),o.changePlanStatus(t,e)},g.getExcel=function(){var t=_.map(g.filter.plansUIDs,function(t){return"planId="+t});t=t.join("&"),console.log(g.data.selectedPlans),window.open("/crsreport/api/ru-RU/plan/report?"+t,"_blank").focus()}}else t.path("/main");function m(){var t;t=g.data.plansSrc,t=_.filter(t,g.filter.year?{PlanYear:g.filter.year}:null),t=_.filter(t,g.filter.drillType||0===g.filter.drillType?{PlanDrillType:g.filter.drillType}:null),t=_.filter(t,g.filter.planTypeName?{PlanTypeName:g.filter.planTypeName}:null),t=_.filter(t,g.filter.planStatusName?{PlanStatusName:g.filter.planStatusName}:null);var e=_.pluck(t,"PlanDzoId")||[];e=_.uniq(e),g.data.companies=_.map(e,function(t){return{UID:t,name:l.getCompanyName(t)}}),g.data.companies.unshift({name:"Все",UID:null}),t=g.data.plansSrc,t=_.filter(g.data.plansSrc,g.filter.companyUID?{PlanDzoId:g.filter.companyUID}:null),t=_.filter(t,g.filter.drillType||0===g.filter.drillType?{PlanDrillType:g.filter.drillType}:null),t=_.filter(t,g.filter.planTypeName?{PlanTypeName:g.filter.planTypeName}:null),t=_.filter(t,g.filter.planStatusName?{PlanStatusName:g.filter.planStatusName}:null);var a=_.pluck(g.data.filteredPlans,"PlanYear");a=_.uniq(a),a=_.sortBy(a),g.data.years=_.map(a,function(t){return{id:t,name:t+""}}),g.data.years.unshift({name:"Все",id:null}),t=g.data.plansSrc,t=_.filter(g.data.plansSrc,g.filter.companyUID?{PlanDzoId:g.filter.companyUID}:null),t=_.filter(t,g.filter.year?{PlanYear:g.filter.year}:null),t=_.filter(t,g.filter.planTypeName?{PlanTypeName:g.filter.planTypeName}:null),t=_.filter(t,g.filter.planStatusName?{PlanStatusName:g.filter.planStatusName}:null);var r=_.pluck(t,"PlanDrillType");r=_.uniq(r),g.data.drillTypes=_.map(r,function(t){return{id:t,name:["ЭБ","ЗБС","ПРБ"][t]}}),g.data.drillTypes.unshift({name:"Все",id:null}),t=g.data.plansSrc,t=_.filter(g.data.plansSrc,g.filter.companyUID?{PlanDzoId:g.filter.companyUID}:null),t=_.filter(t,g.filter.year?{PlanYear:g.filter.year}:null),t=_.filter(t,g.filter.drillType||0===g.filter.drillType?{PlanDrillType:g.filter.drillType}:null),t=_.filter(t,g.filter.planStatusName?{PlanStatusName:g.filter.planStatusName}:null);var n=_.pluck(t,"PlanTypeName");n=_.uniq(n),g.data.planTypeNames=_.map(n,function(t){return{id:t,name:t+""}}),g.data.planTypeNames.unshift({name:"Все",id:null}),t=g.data.plansSrc,t=_.filter(g.data.plansSrc,g.filter.companyUID?{PlanDzoId:g.filter.companyUID}:null),t=_.filter(t,g.filter.year?{PlanYear:g.filter.year}:null),t=_.filter(t,g.filter.drillType||0===g.filter.drillType?{PlanDrillType:g.filter.drillType}:null),t=_.filter(t,g.filter.planTypeName?{PlanTypeName:g.filter.planTypeName}:null);var i=_.pluck(t,"PlanStatusName");i=_.uniq(i),g.data.planStatusNames=_.map(i,function(t){return{id:t,name:t+""}}),g.data.planStatusNames.unshift({name:"Все",id:null})}function f(){var t=_.filter(g.data.plansSrc,g.filter.companyUID?{PlanDzoId:g.filter.companyUID}:null);t=_.filter(t,g.filter.year?{PlanYear:g.filter.year}:null),t=_.filter(t,g.filter.drillType||0===g.filter.drillType?{PlanDrillType:g.filter.drillType}:null),t=_.filter(t,g.filter.planTypeName?{PlanTypeName:g.filter.planTypeName}:null),t=_.filter(t,g.filter.planStatusName?{PlanStatusName:g.filter.planStatusName}:null),g.data.filteredPlansSrc=_.cloneDeep(t),g.data.filteredPlans=_.cloneDeep(g.data.filteredPlansSrc),g.filter.plansUIDs=_.intersection(g.filter.plansUIDs,_.pluck(g.data.filteredPlans,"PlanId"))}function p(){var n=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"];if(g.data.chartsData={},g.data.selectedPlans&&g.data.selectedPlans.length){var t=g.data.selectedPlans[0],e=[];_.forEach(t.ParsByMonth,function(t){e.push({displayName:t.DisplayName,uom:t.Uom})}),e=_.uniq(e,"displayName"),g.data.chartsData.params=e,g.data.chartsData.data={},_.forEach(e,function(t){var h=t.displayName,e=[];switch(g.filter.timeKey){case"month":e=_.range(1,13);break;case"quarter":e=_.range(1,5);break;default:e=_.range(1,2)}var a=[],r=[];_.forEach(e,function(m){var t="";switch(g.filter.timeKey){case"month":t=n[m-1];break;case"quarter":t=m+"-й квартал";break;default:t=m+" г."}var f=[],p=[];_.forEach(g.data.selectedPlans,function(t){var e,a,r,n,i,l,o,s,c,u,d=t.PlanYear;switch(d=g.filter.year?g.filter.year:d,d=g.filter.planYear?g.filter.planYear:d,g.filter.timeKey){case"month":e=(e=_.find(t.ParsByMonth,{DisplayName:h}))?e.Values:[],e=_.filter(e,{Year:d}),a=_.filter(e,{WellType:1}),r=_.filter(e,{WellType:0}),n=_.find(a,{Month:m}),i=_.find(r,{Month:m}),l=(l=_.find(t.ParsByMonth,{DisplayName:h}))?l.AggregatedValues:[],l=_.filter(l,{Year:d}),o=_.filter(l,{WellType:1}),s=_.filter(l,{WellType:0}),c=_.find(o,{Month:m}),u=_.find(s,{Month:m});break;case"quarter":e=(e=_.find(t.ParsByQuarter,{DisplayName:h}))?e.Values:[],e=_.filter(e,{Year:d}),a=_.filter(e,{WellType:1}),r=_.filter(e,{WellType:0}),n=_.find(a,{Quarter:m}),i=_.find(r,{Quarter:m}),l=(l=_.find(t.ParsByQuarter,{DisplayName:h}))?l.AggregatedValues:[],l=_.filter(l,{Year:d}),o=_.filter(l,{WellType:1}),s=_.filter(l,{WellType:0}),c=_.find(o,{Quarter:m}),u=_.find(s,{Quarter:m});break;default:e=(e=_.find(t.ParsByYear,{DisplayName:h}))?e.Values:[],e=_.filter(e,{Year:d}),a=_.filter(e,{WellType:1}),r=_.filter(e,{WellType:0}),n=_.find(a,{Year:m}),i=_.find(r,{Year:m}),l=(l=_.find(t.ParsByYear,{DisplayName:h}))?l.AggregatedValues:[],l=_.filter(l,{Year:d}),o=_.filter(l,{WellType:1}),s=_.filter(l,{WellType:0}),c=_.find(o,{Year:m}),u=_.find(s,{Year:m})}n=n?n.Value:0,i=i?i.Value:0,c=c?c.Value:0,u=u?u.Value:0,f.push({values:[{val:i},{val:n}]}),p.push({values:[{val:u},{val:c}]})}),a.push({title:t,points:f}),r.push({title:t,points:p})}),g.data.chartsData.data[h]={normal:{values:a,yAxisTitle:" ",subXAxisTitles:1<g.data.selectedPlans.length?_.pluck(g.data.selectedPlans,"PlanName"):null},growing:{values:r,yAxisTitle:" ",subXAxisTitles:1<g.data.selectedPlans.length?_.pluck(g.data.selectedPlans,"PlanName"):null}}})}}function h(){if(g.data.tableData={},g.data.selectedPlans&&g.data.selectedPlans.length){switch(g.filter.timeKey){case"month":g.data.tableData.timeHeaders=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"];break;case"quarter":g.data.tableData.timeHeaders=["1-ый квартал","2-ой квартал","3-ий квартал","4-ый квартал"];break;default:g.data.tableData.timeHeaders=[]}g.data.tableData.headers=[];for(var t=0;t<g.data.tableData.timeHeaders.length+1;t++)for(var e=0;e<g.data.selectedPlans.length;e++)g.data.tableData.headers.push(g.data.selectedPlans[e].DzoShortName+", "+g.data.selectedPlans[e].PlanDrillTypeName+", "+g.data.selectedPlans[e].PlanTypeName+", "+g.data.selectedPlans[e].PlanYear);var a=[],u={month:"ParsByMonth",quarter:"ParsByQuarter",year:"ParsByYear"}[g.filter.timeKey];_.forEach(g.data.selectedPlans,function(t){_.forEach(t[u],function(t){a.push({displayName:t.DisplayName,uom:t.Uom})})}),a=_.uniq(a,"displayName"),g.data.tableData.params=a,g.data.tableData.data={},_.forEach(a,function(t){var c=t.displayName;g.data.tableData.data[c]={nns:[],gs:[],aggr_nns:[],aggr_gs:[]},_.forEach(g.data.tableData.timeHeaders,function(t,s){_.forEach(g.data.selectedPlans,function(t){var e=t.PlanYear;e=g.filter.year?g.filter.year:e,e=g.filter.planYear?g.filter.planYear:e;var a=_.find(t[u],{DisplayName:c}),r=a?a.AggregatedValues:[];a=a?a.Values:[],a=_.filter(a,{Year:e}),r=_.filter(r,{Year:e}),r="month"===g.filter.timeKey?(a=_.filter(a,{Month:s+1}),_.filter(r,{Month:s+1})):(a=_.filter(a,{Quarter:s+1}),_.filter(r,{Quarter:s+1}));var n=_.filter(a,{WellType:1}),i=_.filter(a,{WellType:0}),l=_.filter(r,{WellType:1}),o=_.filter(r,{WellType:0});g.data.tableData.data[c].nns.push(n&&n.length?n[0].Value:"-"),g.data.tableData.data[c].gs.push(i&&i.length?i[0].Value:"-"),g.data.tableData.data[c].aggr_nns.push(l&&l.length?l[0].Value:"-"),g.data.tableData.data[c].aggr_gs.push(o&&o.length?o[0].Value:"-")})}),_.forEach(g.data.selectedPlans,function(t){var e=t.PlanYear;e=g.filter.year?g.filter.year:e,e=g.filter.planYear?g.filter.planYear:e;var a=_.find(t.ParsByYear,{DisplayName:c}),r=a?a.AggregatedValues:[];a=a?a.Values:[],a=_.filter(a,{Year:e}),r=_.filter(r,{Year:e});var n=_.filter(a,{WellType:1}),i=_.filter(a,{WellType:0}),l=_.filter(r,{WellType:1}),o=_.filter(r,{WellType:0});g.data.tableData.data[c].nns.push(n&&n.length?n[0].Value:"-"),g.data.tableData.data[c].gs.push(i&&i.length?i[0].Value:"-"),g.data.tableData.data[c].aggr_nns.push(l&&l.length?l[0].Value:"-"),g.data.tableData.data[c].aggr_gs.push(o&&o.length?o[0].Value:"-")})})}}}]),angular.module("smbApp").controller("ReportsCtrl",["$rootScope","$location","$scope","$timeout","$q","$modal","apiData","companyData","companiesData","reports",function(f,t,g,p,e,v,a,r,D,y){g.authData&&g.authData.CanViewReports?(g.data={loaded:!1,companyUID:"",reports:[]},e.all([D.getData(),r.getData(),a.getReports().promise]).then(function(t){g.data.companies=D.getCompaniesNames(),g.data.companyUID=t[1][0].data_id,g.data.loaded=!0,g.data.reports=t[2],console.log(g.data)}),g.getReportModal=function(t,e,a,r,n,i,l,o,s){var c=0,u="dd.MM.yyyy",d="today";switch(e){case"Day":c=0,u="dd.MM.yyyy",d="today";break;case"Month":c=1,u="MM.yyyy",d=r?moment().toDate():moment().subtract(1,"months").toDate();break;case"Year":c=2,u="yyyy",d="today"}var h=f.$new(!0);h.getReport=function(e){if(e.reportID){var t,a;if(e.rangeSpan)switch(e.minView){case 0:t=moment(e.dateRange.startDate).startOf("day").format("YYYY-MM-DDTHH:mm:ss"),a=moment(e.dateRange.endDate).endOf("day").format("YYYY-MM-DDTHH:mm:ss");break;case 1:t=moment(e.dateRange.startDate).startOf("month").format("YYYY-MM-DDTHH:mm:ss"),a=moment(e.dateRange.endDate).endOf("month").format("YYYY-MM-DDTHH:mm:ss");break;default:t=moment(e.dateRange.startDate).startOf("month").format("YYYY-MM-DDTHH:mm:ss"),a=moment(e.dateRange.endDate).endOf("month").format("YYYY-MM-DDTHH:mm:ss")}else switch(e.minView){case 0:t=moment(e.date,"YYYY-MM-DD").startOf("day").format("YYYY-MM-DDTHH:mm:ss"),a=moment(e.date,"YYYY-MM-DD").endOf("day").format("YYYY-MM-DDTHH:mm:ss");break;case 1:t=moment(e.date,"YYYY-MM-DD").startOf("month").format("YYYY-MM-DDTHH:mm:ss"),a=moment(e.date,"YYYY-MM-DD").endOf("month").format("YYYY-MM-DDTHH:mm:ss");break;case 2:t=moment(e.date,"YYYY-MM-DD").startOf("year").format("YYYY-MM-DDTHH:mm:ss"),a=moment(e.date,"YYYY-MM-DD").endOf("year").format("YYYY-MM-DDTHH:mm:ss");break;default:t=moment(e.date,"YYYY-MM-DD").startOf("month").format("YYYY-MM-DDTHH:mm:ss"),a=moment(e.date,"YYYY-MM-DD").endOf("month").format("YYYY-MM-DDTHH:mm:ss")}var r="50b277dd-d2f8-45a9-8165-7b19e3016731",n="10830B99-F298-4C99-AD7D-9D4EA6FE2D93",i="234E7F1A-DFF2-4D6A-9EB4-2BF9D610CCFA"===e.reportID.toUpperCase()||"5E66D281-131E-4BD5-980B-3F62D21A698F"===e.reportID.toUpperCase(),l=null,o=[];e.wells&&e.wells.length&&!l&&(l="FA3FED01-3CA5-417C-B7C3-8FBDE57B40B7",o=_.pluck(e.wells,"UID")),e.clusters&&e.clusters.length&&!l&&(l="563A4864-5EE3-4BAB-98BA-000667A90761",o=_.pluck(e.clusters,"UID"));var s=e.fields&&e.fields.length;if(!s||l||i||(l=r,o=_.pluck(e.fields,"UID")),!(e.companies&&e.companies.length)||l||s||(l=n,o="company"===e.companies[0]?[g.data.companyUID]:"all"===e.companies[0]?(o=_.pluck(h.data.companies,"UID"),_.filter(o,function(t){return"89C7F1D8-0444-4461-9376-5B5185CCB6CE"!==t})):e.companies),"91e44618-3301-42a3-96a1-43c45d578344"===e.reportID&&(l=n,o=[g.data.companyUID]),i&&!l){l=r;for(var c=_.filter(h.data.companies,function(t){return-1!==e.companies.indexOf(t.UID)}),u=0;u<c.length;u++){var d=c[u],m=_.filter(e.fields,{companyUID:d.UID});if(m.length)o=o.concat(_.pluck(m,"UID"));else{var f=_.filter(h.data.fields,{companyUID:d.UID});o=o.concat(_.pluck(f,"UID"))}}}var p={DateFrom:t,InclusiveDateTo:a,ObjectsType:l,Objects:o,ReportID:e.reportID};console.log(p),y.getReport(p,e.title).then(function(t){})}},h.data={companies:D.getCompaniesNames(),fields:[],clusters:[],wells:[]},console.log(h.data.companies),h.reportParameters={rangeSpan:a,maxDate:d,reportID:s,title:t,minView:c,dateFormat:u,selectCompanies:n,selectFields:i,selectClusters:l,selectWells:o,date:null,dateRange:null,dateRangeOpt:{minViewMode:"month",clearLabel:"Очистить",format:"DD.MM.YYYY",separator:" - ",singleDatePicker:!a,locale:{applyLabel:"Выбрать",cancelLabel:"Отмена",fromLabel:"От",toLabel:"До",format:"DD.MM.YYYY"}}},h.$watch("reportParameters.companies",function(t,e){var a=t;-1!==_.indexOf(a,"all")&&-1===_.indexOf(e,"all")&&(a=["all"]),-1!==_.indexOf(a,"company")&&-1===_.indexOf(e,"company")&&(a=["company"]),-1!==_.indexOf(a,"company")&&1<a.length&&a.splice(_.indexOf(a,"company"),1),-1!==_.indexOf(a,"all")&&1<a.length&&a.splice(_.indexOf(a,"all"),1),-1!==_.indexOf(a,"")&&(a=_.compact(a)),h.reportParameters.companies=a;var r=[];angular.forEach(h.reportParameters.companies,function(e){switch(e){case"all":case"company":break;default:var t=D.getCompanyFieldsNames(e);r=_.union(r,_.map(t,function(t){return{companyUID:e,companyName:D.getCompanyName(e),UID:t.UID,name:t.name}}))}}),h.data.fields=r,h.reportParameters.fields=null,p(function(){h.reportParameters.fields=[]})}),h.$watch("reportParameters.fields",function(t,e){var a=[];angular.forEach(h.reportParameters.fields,function(e){var t=D.getCompanyClustersNames(e.companyUID,e.UID);a=_.union(a,_.map(t,function(t){return{groupName:e.companyName+"->"+e.name,companyUID:e.companyUID,companyName:e.companyName,fieldUID:e.UID,fieldName:e.name,UID:t.UID,name:t.name}}))}),h.data.clusters=a,h.reportParameters.clusters=null,p(function(){h.reportParameters.clusters=[]})}),h.$watch("reportParameters.clusters",function(t,e){var a=[];angular.forEach(h.reportParameters.clusters,function(e){var t=D.getCompanyWellsNames(e.companyUID,e.fieldUID,e.UID);console.log(t),a=_.union(a,_.map(t,function(t){return{groupName:e.companyName+"->"+e.fieldName+"->"+e.name,companyUID:e.companyUID,companyName:e.companyName,localityUID:e.fieldUID,localityName:e.fieldName,clusterUID:e.UID,clusterName:e.name,UID:t.UID,name:t.name}}))}),h.data.wells=a,h.reportParameters.wells=null,p(function(){h.reportParameters.wells=[]})});var m=v({scope:h,template:"views/modals/get-report.html",show:!1,backdrop:"static"});m.$promise.then(m.show),p(function(){angular.extend(h.reportParameters,{companies:h.data.companies&&1===h.data.companies.length?[h.data.companies[0].UID]:null,fields:null,clusters:null,wells:null})})}):t.path("/main")}]),angular.module("smbApp").directive("smbDoubleViewSwitch",function(){return{templateUrl:"views/directives/doubleViewSwitch.html",restrict:"E",scope:{viewMode:"=ngModel",showChart:"=",showTable:"=",showPp:"=",showExcel:"=",showSettings:"=",showWidget:"=",showExternalChart:"=",showDailyCost:"=",showDrillProject:"=",showRatingDo:"=",showSitemap:"=",excelHandler:"&",settingsHandler:"&",externalChartHandler:"&",dailyCostHandler:"&",drillProjectHandler:"&",ratingDoHandler:"&"},link:function(e,t,a){e.setViewMode=function(t){e.viewMode=t}}}}),angular.module("smbApp").controller("CompareProductionPlansCtrl",["$scope","$q","smbData","productionPlansData",function(n,t,e,a){n.data={loaded:!1,monthList:["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"],quarterList:["1-ый квартал","2-ой квартал","3-ий квартал","4-ый квартал"],timeKey:"quarter",companies:[],years:[],versions:[]},n.planParameters={company:null,year:null,timesList:[],versions:[]},n.tableData={selectedVersions:[],timeHeaders:[],headers:[]},n.$parent.$watch("planParameters.object",function(t){t&&(n.planParameters.company=_.find(n.data.companies,{id:t.id}))}),n.$parent.$watch("planParameters.period",function(t){n.planParameters.year=t}),n.$parent.$watch("planParameters.version",function(e){var t=_.find(n.planParameters.versions,function(t){return e.ppUID===t.version.ppUID});t&&(t.selected=!0),n.fillTableData()}),t.all([e.getStructure(),a.getData()]).then(function(t){n.data.companies=e.getCompaniesOnly(t[0]),n.data.loaded=!0}),n.$watch("planParameters.company",function(t){n.data.years=t?a.getYears():[],n.planParameters.versions=null}),n.$watch("planParameters.year",function(t){n.data.versions=a.getPlans(t),n.planParameters.versions=null}),n.$watch("data.versions",function(t){n.planParameters.versions=_.map(t,function(t){return{name:t.name,selected:!1,version:t}})}),n.$watch("data.timeKey",function(){n.fillTableData()}),n.fillTableData=function(){var t=_.filter(n.planParameters.versions,"selected"),i=12;switch(n.tableData.selectedVersions=t,n.data.timeKey){case"month":n.tableData.timeHeaders=n.data.monthList,i=1;break;case"quarter":n.tableData.timeHeaders=n.data.quarterList,i=3;break;default:n.tableData.timeHeaders=[],i=12}for(var e=[],a=0;a<n.tableData.timeHeaders.length+1;a++)for(var r=0;r<t.length;r++)e.push(t[r].name);n.tableData.headers=e;var l=[];_.forEach(_.range(0,12,i),function(n){_.forEach(t,function(e){var a=_.keys(e.version.ppp[n]),r={};_.forEach(_.range(n,n+i),function(t){_.forEach(a,function(t){_.isUndefined(r[t])&&(r[t]=0),r[t]+=e.version.ppp[n][t]})}),l.push(r)}),a+=i}),12!==i&&_.forEach(t,function(t){var a=_.keys(t.version.ppp[0]),r={};_.forEach(t.version.ppp,function(e){_.forEach(a,function(t){_.isUndefined(r[t])&&(r[t]=0),r[t]+=e[t]})}),l.push(r)}),n.tableData.data=l},n.getSelectedVersions=function(){return _.filter(n.planParameters.versions,"selected")},n.getVersionsHeads=function(){for(var t=n.getSelectedVersions(),e=[],a=0;a<n.planParameters.timesList.length+1;a++)for(var r=0;r<t.length;r++)e.push(t[r].name);return e}}]),angular.module("smbApp").service("productionPlansData",["$q","$http",function(t,a){var c=["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"],u=["Я","Ф","М","А","М ","И","И ","А ","С","О","Н","Д"],d=null;return{getData:function(){return e=t.defer(),d?e.resolve(d):a.get("maps/PPPForOneDO.json").success(function(t){d=t,e.resolve(d||{})}).error(function(t){e.reject(t)}),e.promise;var e},getYears:function(){var e=[];return d&&angular.forEach(d.plansPerYear,function(t){e.push(t.year)}),e},getPlans:function(t){var e=[];if(d){var a=_.find(d.plansPerYear,{year:t});e=a&&a.plans||[]}return _.each(e,function(t){t.name||(t.name=t.vNum+" ("+t.vName+")")}),e},getChartData:function(t,e,r,n){n=n||!1;var i={values:[],yAxisTitle:" "},a=_.find(d&&d.plansPerYear,{year:t}),l=_.find(a&&a.plans,{ppUID:e});if(l){var o=0,s=0;_.forEach(l.ppp,function(t,e){var a=c[e];12===l.ppp.length&&(a=u[e]),o+=t[r+"Gs"],s+=t[r+"Nns"],i.values.push({title:a,points:[{labels:["ГС","ННС"],values:[[{val:n?o:t[r+"Gs"]},{val:1e3}],{val:n?s:t[r+"Nns"]}]}]})})}return i},getTableData:function(t,e,i){i=i||12;var a=[],r=_.find(d&&d.plansPerYear,{year:t});_.forEach(e,function(t){var e=_.find(r&&r.plans,{ppUID:t});e&&a.push(e)});var l=[];return _.forEach(_.range(0,12,i),function(n){_.forEach(a,function(e){var a=_.keys(e.ppp[n]),r={};_.forEach(_.range(n,n+i),function(t){_.forEach(a,function(t){_.isUndefined(r[t])&&(r[t]=0),r[t]+=e.ppp[n][t]})}),l.push(r)})}),12!==i&&_.forEach(a,function(t){var a=_.keys(t.ppp[0]),r={};_.forEach(t.ppp,function(e){_.forEach(a,function(t){_.isUndefined(r[t])&&(r[t]=0),r[t]+=e[t]})}),l.push(r)}),l}}}]),angular.module("smbApp").service("referenceData",["$q","BaseDataService",function(t,e){var a=new e("referenceData");return angular.extend({getServiceTypes:function(){var e=t.defer();return a.getData().then(function(t){e.resolve(t.serviceTypes)}),e.promise},getServiceName:function(t){var e=a.getRawData();return e&&_.result(_.findWhere(e.serviceTypes,{id:t}),"name")||t},getAcceptanceTypes:function(){var e=t.defer();return a.getData().then(function(t){e.resolve(t.acceptanceTypes)}),e.promise},getAcceptanceTypeName:function(t){var e=a.getRawData();return e&&_.result(_.findWhere(e.acceptanceTypes,{id:t}),"name")||t},getPsdDocumentTypes:function(){var e=t.defer();return a.getData().then(function(t){e.resolve(t.psdDocumentTypes)}),e.promise},getPsdDocumentTypeName:function(t){var e=a.getRawData();return e&&_.result(_.findWhere(e.psdDocumentTypes,{id:t}),"name")||t},getPermitDocumentTypes:function(){var e=t.defer();return a.getData().then(function(t){e.resolve(t.permitDocumentTypes)}),e.promise},getPermitDocumentTypeName:function(t){var e=a.getRawData();return e&&_.result(_.findWhere(e.permitDocumentTypes,{id:t}),"name")||t}},a)}]),angular.module("smbApp").service("dataManager",function(){var r=[];function a(){for(var t=_.sortBy(r,"priority"),e=0;e<t.length&&t[e].resource.loaded();e++)if(!t[e].resource.saved()&&!t[e].resource.save()){if(!t[e+1]||!t[e+1].resource.saved())break;for(var a=e+1;a<t.length;a++)t[a].resource.remove();if(!t[e].resource.save())break}}return{update:function(){_.forEach(r,function(t){t.resource.update()})},addDataResource:function(t,e){r.push({resource:t,priority:e||1}),t.addUpdateDataCallback(a)}}}),angular.module("smbApp").controller("AcceptancePlanCtrl",["$scope","$q","$modal","smbData","referenceData","productionPlansData",function(i,t,l,e,a,r){function n(){var r={};_.forEach(i.data.companies,function(a){r[a.id]={};var t=_.filter(i.data.acceptanceTypes,function(t){return!_.find(i.data.plans[a.id],{accept:t.id})});_.forEach(i.data.plans[a.id],function(e){r[a.id][e.ppUID]=_.map(t,function(t){return{text:t.name,click:'showAcceptModal("'+a.id+'","'+e.ppUID+'",'+t.id+")"}})})}),i.data.dropdowns=r}i.acceptanceParameters={year:null,plans:[],plansAcceptance:[]},i.data={loaded:!1,years:[],companies:[],acceptanceTypes:[],plans:{},dropdowns:{}},t.all([e.getStructure(),a.getAcceptanceTypes(),r.getData()]).then(function(t){i.data.loaded=!0,i.data.years=r.getYears(),i.acceptanceParameters.year=(new Date).getUTCFullYear()+"",i.data.companies=e.getCompaniesOnly(t[0]),i.data.acceptanceTypes=t[1]}),i.getAcceptanceTypeName=a.getAcceptanceTypeName,i.acceptedPlan=function(t){return!!t.accept},i.unAcceptedPlan=function(t){return!t.accept},i.$watch("acceptanceParameters.year",function(e){var a={};_.forEach(i.data.companies,function(t){a[t.id]=_.cloneDeep(r.getPlans(e))}),i.data.plans=a,n()}),i.showAcceptModal=function(t,e,a){var r=i.$new();r.companyId=t,r.ppUID=e,r.acceptanceTypeId=a;var n=l({scope:r,template:"views/modals/acceptacceptance.html",show:!1});n.$promise.then(n.show)},i.acceptPlan=function(t,e,a){var r=_.find(i.data.plans[t],{ppUID:e});r&&(r.accept=a),n()}}]),angular.module("smbApp").filter("ruble",function(){return function(t){if(t||0===t){t=parseFloat(t),t=Math.round(100*t)/100;for(var e=(t+="").split(".")[1],a=t.split(".")[0].split("").reverse().join(""),r="",n="",i=0;n=a.substring(0+3*i,3+3*i);)r+=n+" ",i++;return r=r.split("").reverse().join(""),e&&(r+="."+e),r}return""}}),angular.module("smbApp").filter("customCurrency",["rubleFilter",function(r){return function(t,e){if(!t&&0!==t)return"";var a=r(t);return e?a+" "+e:a}}]),angular.module("smbApp").filter("priceCurrencyPairs",["customCurrencyFilter",function(e){return function(t){return t.map(function(t){return e(t.Price,t.Currency)}).join(", ")}}]),angular.module("smbApp").service("appSettings",["$q","$http","localStorageService",function(t,e,a){var r="appSettings",n=a.get(r),i=[],l=!1;return _.isObject(n)?l=!0:n={},{loaded:function(){return!0},saved:function(){return l},save:function(){return l=a.set(r,n)},remove:function(t){delete n[t],l&&(l=a.set(r,n)),_.forEach(i,function(t){t(n)})},update:function(){},addUpdateDataCallback:function(t){i.push(t)},removeUpdateDataCallback:function(t){var e=i.indexOf(t);-1<e&&i.splice(e,1)},getData:function(){return n},getSettings:function(t){var e=n&&n[t];return e&&0===e.wellState&&(e.wellState=e.wellState||1),e},setSettings:function(t,e){n[t]=e,l&&(l=a.set(r,n)),_.forEach(i,function(t){t(n)})}}}]),angular.module("smbApp").service("BaseDataService",["$q","$http","localStorageService",function(n,i,l){return function(a){console.log(a);var r={data:null,dataDefer:n.defer(),updating:!1,updateDataCallbacks:[],saved:!1,update:function(e){e.updating=!0,i.get("maps/"+a+"Status.json").success(function(t){e.data&&t.dateOfLastModify===e.data.dateOfLastModify?e.updating=!1:i.get("maps/"+a+".json").success(function(t){e.data=t,console.log("BaseDataService return data"),console.log(e.data),_.forEach(e.updateDataCallbacks,function(t){t(e.data)}),e.dataDefer.resolve(e.data),e.dataDefer=n.defer(),e.dataDefer.resolve(e.data),e.saved&&(e.saved=l.set(a,e.data)),e.updating=!1}).error(function(t){e.updating=!1})}).error(function(t){e.updating=!1})}};r.data&&(r.saved=!0,r.dataDefer.resolve(r.data)),this.getPrivateData=function(){return r},this.setPrivateData=function(t){return r=t},this.loaded=function(){return!!r.data},this.saved=function(){return r.saved},this.save=function(){return r.saved},this.remove=function(){return r.saved=!l.remove(a),!r.saved},this.update=function(){r.updating||r.update(r)},this.addUpdateDataCallback=function(t){r.updateDataCallbacks.push(t)},this.removeUpdateDataCallback=function(t){var e=r.updateDataCallbacks.indexOf(t);-1<e&&r.updateDataCallbacks.splice(e,1)},this.getData=function(){return r.dataDefer.promise},this.getRawData=function(){return r.data}}}]),angular.module("smbApp").service("structureData",["$http","$q","localStorageService","BaseDataService","config",function(r,n,t,e,i){var l=[9,10],o=new e("structureData");return o.getPrivateData().update=function(e){e.updating=!0;var a=[];e.data||(_.forEach(l,function(t){a.push(r.get(i.getApiUrl()+"datatype_"+t,{cache:!0}))}),n.all(a).then(function(t){e.updating=!1,e.data=[],_.forEach(t,function(t){e.data=e.data.concat(t.data)}),e.dataDefer.resolve(e.data),e.dataDefer=n.defer(),e.dataDefer.resolve(e.data),e.saved&&o.save(),e.updating=!1,_.forEach(e.updateDataCallbacks,function(t){t(e.data)})},function(){e.updating=!1}))},angular.extend({getParsedData:function(){var e=n.defer();return o.getData().then(function(t){e.resolve(t)}),e.promise}},o)}]),angular.module("smbApp").controller("RegulatoryDocumentsCtrl",["$scope","$q","$location","apiData",function(e,t,a,r){e.authData&&e.authData.CanViewNmd?(e.data={loaded:!0,documents:[]},t.all([r.getRegulatoryDocuments().promise]).then(function(t){e.data.documents=t[0],console.log(e.data.documents),e.data.loaded=!0}),e.openDocument=function(t){window.open("/crsreport/api/document/nmd/"+t.Id+"/content","_blank").focus()}):a.path("/main")}]),angular.module("smbApp").service("BaseClusterDataService",["$http","$q","localStorageService","BaseDataService","config",function(n,i,t,l,o){return function(t,e){console.log(e),console.log(t);var r=new l(e),a=r.getPrivateData();return a.dataTypes=t,a.update=function(e){e.updating=!0;var a=[];e.data?(console.log("BaseClusterDataService return data"),console.log(e.data)):(_.forEach(e.dataTypes,function(t){a.push(n.get(o.getApiUrl()+"datatype_"+t,{cache:!0}))}),i.all(a).then(function(t){e.updating=!1,e.data=[],_.forEach(t,function(t){e.data=e.data.concat(t.data)}),_.forEach(e.updateDataCallbacks,function(t){t(e.data)}),e.dataDefer.resolve(e.data),e.dataDefer=i.defer(),e.dataDefer.resolve(e.data),e.saved&&r.save(),e.updating=!1},function(){e.updating=!1}))},r}}]),angular.module("smbApp").service("contractsDocumentsData",["$q","BaseClusterDataService",function(t,e){var a=new e([3],"contractsDocumentsData");return angular.extend({getContracts:function(){var e=t.defer();return a.getData().then(function(t){console.time&&console.time("getContracts");var a=[];_.forEach(t,function(e){var t=JSON.parse(e.json);_.forEach(t.contracts,function(t){t.companyId=e.rootUID}),a=a.concat(t.contracts)}),console.timeEnd&&console.timeEnd("getContracts"),e.resolve(a)}),e.promise}},a)}]),angular.module("smbApp").service("companiesData",["$q","authData","BaseClusterDataService","refData","$http","config",function(t,a,e,l,r,n){var i=new e([9],"companiesData");function s(){if(a.getRawData()){console.log("authData"),console.log(a.getRawData());var e=a.getRawData().AllowedDzo||[],t=i.getPrivateData().data;return t?(console.log("company data"),console.log(t),t=_.filter(t,function(t){return-1!==e.indexOf(t.data_id)}),console.log("filter company data"),console.log(t),t||[]):[]}return[]}function o(t){var e=moment();if(!t.drillBeginActual)return!1;var a,r=moment(t.drillBeginActual,"DD.MM.YYYY");return t.drillEndActual&&(a=moment(t.drillEndActual,"DD.MM.YYYY")),r.valueOf()<e.valueOf()&&!a||r.valueOf()<e.valueOf()&&a.valueOf()>e.valueOf()}var c=null;return angular.extend(i,{getActiveWellsCount:function(){var e=t.defer();return null===c?r.get(n.getApiUrl()+"active-wells-count").success(function(t){c=t,e.resolve(t)}).error(function(t){e.reject(t)}):e.resolve(c),e.promise},getParsedData:function(){var a=t.defer();return i.getData().then(function(t){var e=_.map(t,function(t){return _.clone(t)});a.resolve(e)}),a.promise},getCompaniesNames:function(){var t=s();console.log("getCompaniesNames"),console.log(t);var e=_.map(t,function(t){var e=t.json[0];return{UID:e.objUID,name:e.name,fullName:e.fullName}}),a=[];return _.forEach(e,function(t){void 0===_.find(a,{UID:t.UID})&&a.push(t)}),a||[]},getCompanyName:function(t){var e=i.getPrivateData().data,a=_.find(e,{data_id:t});return a?a.json[0].name:null},getCompanyFieldsNames:function(t){var r=[],e=s();return t&&(e=_.filter(e,{data_id:t})),_.forEach(e,function(t){var e=t.json[0],a=e.fields;_.forEach(a,function(t){r.push({companyUID:e.objUID,UID:t.objUID,name:t.name})})}),r},getCompanyFieldName:function(t,a){var r=null,e=s();return t&&(e=_.filter(e,{data_id:t})),_.forEach(e,function(t){var e=t.json[0].fields;_.forEach(e,function(t){t.objUID.toUpperCase()===a.toUpperCase()&&(r=t.name)})}),r||a},getCompanyClustersNames:function(t,e,a){var r=s(),n=_.find(r,{data_id:t});if(n){var i=n.json[0].fields,l=_.find(i,{objUID:e});if(l){var o=_.filter(l.clusters,function(t){return!a||_.find(t.wells,{profileType:a})});return _.map(o,function(t){return{UID:t.objUID,name:t.name}})||[]}return[]}return[]},getCompanyClusterName:function(t,a,r){var n=null,e=s(),i=_.filter(e,t?{data_id:t}:null);return _.forEach(i,function(t){var e=t.json[0].fields;e=_.filter(e,a?{objUID:a}:null),_.forEach(e,function(t){var e=_.find(t.clusters,{objUID:r});e&&(n=e.name)})}),n||r},getCompanyWellsNames:function(t,a,r,n){var i=[],e=s();return t&&(e=_.filter(e,{data_id:t})),_.forEach(e,function(t){var e=t.json[0].fields;a&&(e=_.filter(e,{objUID:a})),_.forEach(e,function(a){if(!r||"fieldOnly"===r){var t=_.filter(a.wells,n?{profileType:n}:null);_.forEach(t,function(t){i.push({UID:t.objUID,name:t.name,clusterName:null,fieldName:a.name})})}if("fieldOnly"!==r){var e=a.clusters;r&&(e=_.filter(e,{objUID:r})),_.forEach(e,function(e){var t=_.filter(e.wells,n?{profileType:n}:null);_.forEach(t,function(t){i.push({UID:t.objUID,name:t.name,clusterName:e.name,fieldName:a.name})})})}})}),i},getCompanyWellName:function(t,a,r,n){var i=null,e=s();return t&&(e=_.filter(e,{data_id:t})),_.forEach(e,function(t){var e=t.json[0].fields;a&&(e=_.filter(e,{objUID:a})),_.forEach(e,function(t){var e=_.find(t.wells,{objUID:n});e&&(i=e.name);var a=t.clusters;r&&(a=_.filter(a,{objUID:r})),_.forEach(a,function(t){var e=_.find(t.wells,{objUID:n});e&&(i=e.name)})})}),i},getCompaniesActiveWellsCount:function(){var t=s(),r={};return _.forEach(t,function(t){var e=0,a=t.json[0];_.forEach(a.fields,function(t){_.forEach(t.wells,function(t){o(t)&&e++}),_.forEach(t.clusters,function(t){_.forEach(t.wells,function(t){o(t)&&e++})})}),r[a.objUID]=e}),r},getCompaniesActiveObjects:function(t,a,n){var i=[],e=s();return t&&(e=_.filter(e,{data_id:t})),_.forEach(e,function(t){var r=t.json[0],e=r.fields;a&&(e=_.filter(e,{objUID:a})),_.forEach(e,function(a){_.forEach(a.wells,function(t){o(t)&&i.push({companyUID:r.objUID,companyName:r.name,fieldUID:a.objUID,fieldName:a.name,clusterUID:"none",clusterName:"none",wellUID:t.objUID,wellName:t.name,drillType:l.getDrillTypeID(t.drillType),drillEndActual:t.drillEndActual,drillBeginActual:t.drillBeginActual})});var t=a.clusters;n&&(t=_.filter(t,{objUID:n})),_.forEach(t,function(e){_.forEach(e.wells,function(t){o(t)&&i.push({companyUID:r.objUID,companyName:r.name,fieldUID:a.objUID,fieldName:a.name,clusterUID:e.objUID,clusterName:e.name,wellUID:t.objUID,wellName:t.name,drillType:l.getDrillTypeID(t.drillType),drillEndActual:t.drillEndActual,drillBeginActual:t.drillBeginActual})})})})}),i},getCompaniesObjects:function(t,a,n){var i=[],e=s();return t&&(e=_.filter(e,{data_id:t})),_.forEach(e,function(t){var r=t.json[0],e=r.fields;a&&(e=_.filter(e,{objUID:a})),_.forEach(e,function(a){_.forEach(a.wells,function(t){i.push({companyUID:r.objUID,companyName:r.name,fieldUID:a.objUID,fieldName:a.name,clusterUID:"none",clusterName:"none",wellUID:t.objUID,wellName:t.name,drillType:l.getDrillTypeID(t.drillType),drillEndActual:t.drillEndActual,drillBeginActual:t.drillBeginActual})});var t=a.clusters;n&&(t=_.filter(t,{objUID:n})),_.forEach(t,function(e){_.forEach(e.wells,function(t){i.push({companyUID:r.objUID,companyName:r.name,fieldUID:a.objUID,fieldName:a.name,clusterUID:e.objUID,clusterName:e.name,wellUID:t.objUID,wellName:t.name,drillType:l.getDrillTypeID(t.drillType),drillEndActual:t.drillEndActual,drillBeginActual:t.drillBeginActual})})})})}),i},getWellsData:function(e,a,r,n){var i=[],t=s();return e&&(t=_.filter(t,function(t){return-1!==e.indexOf(t.data_id)})),_.forEach(t,function(t){var e=t.json[0].fields;a&&(e=_.filter(e,function(t){return-1!==a.indexOf(t.objUID)})),_.forEach(e,function(t){var e=t.clusters;if(r&&(e=_.filter(e,function(t){return-1!==r.indexOf(t.objUID)})),_.forEach(e,function(t){var e=t.wells||[];n&&(e=_.filter(e,function(t){return-1!==n.indexOf(t.objUID)})),i=_.union(i,e)}),n){var a=t.wells||[];a=_.filter(a,function(t){return-1!==n.indexOf(t.objUID)})}i=_.union(i,a)})}),i}})}]),angular.module("smbApp").service("authData",["$q","$http","config",function(t,a,r){var n=null;return{getData:function(){var e=t.defer();return n?e.resolve(n):a.get(r.getApiUrl()+"user").success(function(t){n=t,e.resolve(t)}).error(function(t){e.reject(t)}),e.promise},getRawData:function(){return n},singleCompany:function(){return n&&1===n.AllowedDzo.length},getCompanyUID:function(){return n&&n.AllowedDzo&&n.AllowedDzo[0]},getCompaniesUID:function(){return n&&n.AllowedDzo}}}]),angular.module("smbApp").service("assemblyVersionService",["$http","config","$q",function(a,r,n){return{getAssemblyVersion:function(){var e=n.defer(),t=r.getApiUrl()+"version";return a.get(t).then(function(t){e.resolve(t.data)},function(t){e.reject(t)}),e.promise}}}]),angular.module("smbApp").controller("AccessDeniedCtrl",["$scope",function(t){}]),angular.module("smbApp").controller("ClearCtrl",["$scope","$window","localStorageService",function(t,e,a){a.clearAll(),e.location.href="/"}]),angular.module("smbApp").directive("syncHorizontalScrolls",function(){var r=0;return{restrict:"A",replace:!1,compile:function(t,e){var a;(a=t.find("."+e.syncHorizontalScrolls)).on("scroll",function(t){r=t.target.scrollLeft,_.forEach(a,function(t){angular.element(t).scrollLeft(r)})})}}}),angular.module("smbApp").directive("syncVerticalScrolls",function(){var r=0;return{restrict:"A",replace:!1,compile:function(t,e){var a;(a=t.find("."+e.syncVerticalScrolls)).on("scroll",function(t){r=t.target.scrollTop,_.forEach(a,function(t){angular.element(t).scrollTop(r)})})}}}),angular.module("smbApp").service("companiesAttributesData",["$http","$q","BaseClusterDataService","utils",function(t,e,a,b){var f=new a([1],"companiesAttributesData"),C={};function w(t){return _.flatten(arguments).join("+")}return f.addUpdateDataCallback(function(){C={}}),angular.extend({getParsedData:function(){var a=e.defer();return f.getData().then(function(t){var e=_.map(t,function(t){var e=_.clone(t);return e.json=JSON.parse(e.json),e});a.resolve(e)}),a.promise},getCompanyNonProductivePcChartData:function(t,e,a,r){if(!_.isUndefined(C[w("getCompanyNonProductivePcChartData",arguments)]))return C[w("getCompanyNonProductivePcChartData",arguments)];var n,i=f.getRawData(),l=_.filter(i,{data_id:t}),o=[];_.forEach(_.range(1,4),function(t){o=_.union(o,b.getIntervalData(l,r,t))});o=_.filter(o,{drillType:e+"",wellState:a+""});var s=b.aggregateDataSum(o,"nonProductiveDuration"),c=b.aggregateDataSum(o,"vmrDuration"),u=b.aggregateDataSum(o,"drillingDuration"),d=b.aggregateDataSum(o,"explorationDuration");if(_.isNumber(s.fact)&&_.isNumber(c.fact)&&_.isNumber(u.fact)&&_.isNumber(d.fact))var m=100*s.fact/(c.fact+u.fact+d.fact);return _.isNumber(m)&&(n=[{color:"#88C2E8",label:"НПВ",value:m},{color:"#3578BB",label:"ПВ",value:100-m}]),C[w("getCompanyNonProductivePcChartData",arguments)]=n},getCompanyChartData:function(t,p,h,g,v){if(!_.isUndefined(C[w("getCompanyChartData",arguments)]))return C[w("getCompanyChartData",arguments)];var e,a=f.getRawData(),D=_.filter(a,{data_id:t});switch((e=_.map(_.range(1,4),function(t){switch(v){case"incidentPer1000m":case"hoursPerIncident":var e=b.getIntervalData(D,g,t),a=_.find(e,{drillType:p+"",wellState:h+""}),r=t;if("year"===g){if(a&&a.fact[v]){var n=parseFloat(a.fact[v]);return{points:[{labels:["Факт"],values:[_.isNaN(n)?null:n]}],title:b.getIntervalName(g,t)}}return null}switch(g){case"month":r+=12;break;case"quarter":r+=4;break;case"year":r+=1}e=b.getIntervalData(D,g,r);var i=_.find(e,{drillType:p+"",wellState:h+""});if(a&&a.fact[v]||i&&i.fact[v]){n=a?parseFloat(a.fact[v]):null;var l=i?parseFloat(i.fact[v]):null;return{points:[{labels:["Факе предыдущий","Факт"],values:[_.isNaN(l)?null:l,_.isNaN(n)?null:n]}],title:b.getIntervalName(g,t)}}return null;case"explorationDuration":case"drillingDuration":case"drillingRate":e=b.getIntervalData(D,g,t,!0);var o=_.find(e,{drillType:p+"",wellState:h+"",profileType:"0"}),s=_.find(e,{drillType:p+"",wellState:h+"",profileType:"1"});if(o&&s&&(o.plans[0][v]||o.fact[v]||s.plans[0][v]||s.fact[v])){var c=o?parseFloat(o.plans[0][v]):null,u=o?parseFloat(o.fact[v]):null,d=s?parseFloat(s.plans[0][v]):null,m=s?parseFloat(s.fact[v]):null;return{points:[{labels:["ННС - план","ННС - факт"],values:[_.isNaN(c)?null:c,_.isNaN(u)?null:u]},{labels:["ГС - план","ГС - факт"],values:[_.isNaN(d)?null:d,_.isNaN(m)?null:m]}],title:b.getIntervalName(g,t)}}return null;case"drillingBrigades":case"explorationBrigades":e=b.getIntervalData(D,g,t);if((a=_.find(e,{drillType:p+"",wellState:h+""}))&&(a.plans[0][v]||a.fact[v])){var f=parseFloat(a.plans[0][v]);n=parseFloat(a.fact[v]);return{points:[{labels:["План","Факт"],values:[_.isNaN(f)?null:f,_.isNaN(n)?null:n]}],title:b.getIntervalName(g,t)}}return null}})).reverse(),e=_.compact(e),v){case"explorationDuration":case"drillingDuration":case"drillingRate":e=e.length?{values:e,yAxisTitle:" ",subXAxisTitles:["ННС","ГС"]}:null;break;case"incidentPer1000m":case"hoursPerIncident":case"drillingBrigades":case"explorationBrigades":e=e.length?{values:e,yAxisTitle:" "}:null}return C[w("getCompanyChartData",arguments)]=e},getCompaniesChartData:function(t,h,g,v,D){if(!_.isUndefined(C[w("getCompaniesChartData",arguments)]))return C[w("getCompaniesChartData",arguments)];var e,y=f.getRawData();switch(e=_.map(t,function(t){var e=_.filter(y,{data_id:t.UID});switch(D){case"incidentPer1000m":case"hoursPerIncident":case"nonProductivePc":var a=b.getIntervalData(e,v,1),r=_.find(a,{drillType:h+"",wellState:g+""}),n=1;switch(v){case"month":n+=12;break;case"quarter":n+=4;break;case"year":n+=1}a=b.getIntervalData(e,v,n);var i=_.find(a,{drillType:h+"",wellState:g+""});if(r&&r.fact[D]||i&&i.fact[D]){var l=r?parseFloat(r.fact[D]):null,o=i?parseFloat(i.fact[D]):null;return{points:[{labels:["Факе предыдущий","Факт"],values:[_.isNaN(o)?null:o,_.isNaN(l)?null:l]}],title:t.name,link:"/fieldsChart/"+D+"/"+t.UID}}return null;case"explorationDuration":case"drillingDuration":case"drillingRate":a=b.getIntervalData(e,v,1,!0);var s=_.find(a,{drillType:h+"",wellState:g+"",profileType:"0"}),c=_.find(a,{drillType:h+"",wellState:g+"",profileType:"1"});if(s&&c&&(s.plans[0][D]||s.fact[D]||c.plans[0][D]||c.fact[D])){var u=s?parseFloat(s.plans[0][D]):null,d=s?parseFloat(s.fact[D]):null,m=c?parseFloat(c.plans[0][D]):null,f=c?parseFloat(c.fact[D]):null;return{points:[{labels:["ННС - план","ННС - факт"],values:[_.isNaN(u)?null:u,_.isNaN(d)?null:d]},{labels:["ГС - план","ГС - факт"],values:[_.isNaN(m)?null:m,_.isNaN(f)?null:f]}],title:t.name,link:"/fieldsChart/"+D+"/"+t.UID}}return null;case"drillingBrigades":case"explorationBrigades":a=b.getIntervalData(e,v,1);if((r=_.find(a,{drillType:h+"",wellState:g+""}))&&(r.plans[0][D]||r.fact[D])){var p=parseFloat(r.plans[0][D]);l=parseFloat(r.fact[D]);return{points:[{labels:["План","Факт"],values:[_.isNaN(p)?null:p,_.isNaN(l)?null:l]}],title:t.name,link:"/fieldsChart/"+D+"/"+t.UID}}return null}}),e=_.compact(e),e=_.sortBy(e,function(t){return t.points[1]?-t.points[1].values[1]:-t.points[0].values[1]}),D){case"explorationDuration":case"drillingDuration":case"drillingRate":e=e.length?{values:e,yAxisTitle:" ",subXAxisTitles:["ННС","ГС"]}:null;break;case"nonProductivePc":case"incidentPer1000m":case"hoursPerIncident":case"drillingBrigades":case"explorationBrigades":e=e.length?{values:e,yAxisTitle:" "}:null}return C[w("getCompaniesChartData",arguments)]=e},getCompanyWidgetData:function(t,e,a,r,n){if(!_.isUndefined(C[w("getCompanyWidgetData",arguments)]))return C[w("getCompanyWidgetData",arguments)];var i,l,o=null,s=f.getRawData(),c=_.filter(s,{data_id:t}),u=b.getIntervalData(c,r,1),d=b.getIntervalData(c,r,2);return u=_.find(u,{drillType:e+"",wellState:a+""}),d=_.find(d,{drillType:e+"",wellState:a+""}),i=u?parseFloat(u.fact[n]):null,l=d?parseFloat(d.fact[n]):null,_.isNumber(i)&&(o={total:i,difference:_.isNumber(i)&&_.isNumber(l)?i-l:null}),C[w("getCompanyWidgetData",arguments)]=o}},f)}]),angular.module("smbApp").service("utils",function(){function e(t,e){for(var a=t+"";a.length<e;)a="0"+a;return a}return{getRange:function(t,e){e=e||0;var a=[];switch(t){case"month":var r=moment().startOf("month").subtract(3,"months").subtract(e,"year");_.forEach(_.range(0,3),function(){a.push({title:r.format("MMMM"),months:[{year:r.year()+"",month:r.month()+1+""}]}),r.add(1,"months")});break;case"quarter":var n=moment().startOf("quarter").subtract(3,"quarters").subtract(e,"year");_.forEach(_.range(0,3),function(){var t=[],e=n.clone();_.forEach(_.range(0,3),function(){t.push({year:e.year()+"",month:e.month()+1+""}),e.add(1,"months")}),a.push({title:n.quarter()+" квартал",months:t}),n.add(1,"quarters")});break;case"year":var i=moment().startOf("year").subtract(3,"years").subtract(e,"year");_.forEach(_.range(0,3),function(){var t=[],e=i.clone();_.forEach(_.range(0,12),function(){t.push({year:e.year()+"",month:e.month()+1+""}),e.add(1,"months")}),a.push({title:i.year(),months:t}),i.add(1,"years")})}return a},getIntervalData:function(t,e,a,r){var n=[];if(!t)return n;switch(e){case"month":var i=moment().startOf("month").subtract(a,"months");if(l=_.find(t,{year:i.year()+""}))(o=JSON.parse(l.json)).months&&(n=_.filter(o.months[r?"detail":"full"],{year:i.year()+"",month:i.month()+1+""}));break;case"quarter":i=moment().startOf("quarter").subtract(a,"quarter");if(l=_.find(t,{year:i.year()+""}))(o=JSON.parse(l.json)).quarts&&(n=_.filter(o.quarts[r?"detail":"full"],{year:i.year()+"",quart:i.quarter()+""}));break;case"year":var l,o;i=moment().startOf("year").subtract(a,"year");if(l=_.find(t,{year:i.year()+""}))(o=JSON.parse(l.json)).year&&(n=_.filter(o.year[r?"detail":"full"],{year:i.year()+""}))}return n},getIntervalName:function(t,e){switch(t){case"month":return moment().startOf("month").subtract(e,"months").format("MMMM");case"quarter":return moment().startOf("quarter").subtract(e,"quarter").format("Q квартал");case"year":return moment().startOf("year").subtract(e,"year").format("YYYY")}return intervalData},pad:e,sortChart:function(t,a){return t&&t.values&&(t.values=_.sortBy(t.values,function(t){var e;return e=t.points[1]?t.points[1].values[1]?-(t.points[1].values[1]&&t.points[1].values[1].val):-(t.points[1].values[0]&&t.points[1].values[0].val):t.points[0].values[1]?-(t.points[0].values[1]&&t.points[0].values[1].val):-(t.points[0].values[0]&&t.points[0].values[0].val),a&&e?-e:e})),t},sortObjectChart:function(e,t){return t?_.map(t,function(t){return _.find(e,{ObjId:t})}):e},getApiAttributeName:function(t){return{incidentPer1000m:"incident_per_1000m",hoursPerIncident:"hours_per_incident",nonProductivePc:"npv",explorationDuration:"explorationDuration",drillingDuration:"drillingDuration",drillingRate:"rop",drillingBrigades:"drillingBrigades",explorationBrigades:"explorationBrigades",buildingDuration:"buildingDuration",drilledWells:"drilledWells",buildedWells:"buildedWells",enteredWells:"enteredWells"}[t]||t},colors:function(){return["#7cb5ec","#90ed7d","#f7a35c","#8085e9","#f15c80","#e4d354","#2b908f","#f45b5b","#91e8e1"]},getNpvPieChartAttributeIndex:function(t){switch(t.toUpperCase()){case"971201FA-5B48-4B1B-9BF7-0BDD751E6603":return 1;case"C3298588-F69D-4F16-A9DE-7B9BD0B02EAF":return 2;case"31348656-AAB7-440A-96A5-060E035DBD55":return 3;case"8C776852-1955-463C-B711-51C21BF9338B":return 4;case"09990CEE-04BF-463C-B4A1-2F06E40E26EB":return 5;case"CFCC7CD6-A718-4303-AF57-EEB706885DD5":return 6;default:return 100}},getNpvPieChartAttributeColor:function(t){switch(t.toUpperCase()){case"971201FA-5B48-4B1B-9BF7-0BDD751E6603":return"#7cb5ec";case"C3298588-F69D-4F16-A9DE-7B9BD0B02EAF":return"#90ed7d";case"31348656-AAB7-440A-96A5-060E035DBD55":return"#f7a35c";case"8C776852-1955-463C-B711-51C21BF9338B":return"#8085e9";case"09990CEE-04BF-463C-B4A1-2F06E40E26EB":return"#f15c80";case"CFCC7CD6-A718-4303-AF57-EEB706885DD5":return"#e4d354";default:return"#2b908f"}},getDrillTypeName:function(t){switch(t){case 0:return"Эксплуатационные";case 1:return"ЗБС";case 2:return"ПРБ";default:return t}},getWellStateName:function(t){switch(t){case 1:return"Календ. период";case 2:return"Зак. бурением";case 3:return"Зак. стр-вом";default:return t}},getPeriodLabel:function(t,e){switch(t){case"month":return moment().startOf("month").subtract(-e,"months").format("MMMM YYYY г.");case"quarter":return moment().startOf("month").subtract(-e,"quarter").format("Q кв. YYYY г.");case"year":return moment().startOf("month").subtract(-e,"years").format("YYYY г.");default:return""}},getChartSheet:function(t,e,a,r){var n,i,l,o,s,c,u={sheetName:r,tableDescription:a,headers:[],rows:[],merges:[]};if(t)if(e){if(u.headers.push(""),u.headers.push(""),_.forEach(t.values,function(t){u.headers.push(t.title)}),s=t,c=!0,_.forEach(s.values,function(t){t.points[0]&&!_.isUndefined(t.points[0].values[1])&&(c=!1)}),c){var d=["ННС","факт"];_.forEach(t.values,function(t){var e=0;_.isArray(t.points[0].values[0])?_.forEach(t.points[0].values[0],function(t){e+=t.val}):e=t.points[0].values[0]&&t.points[0].values[0].val,d.push({value:e,type:"n"})}),u.rows.push(d)}else{d=["ННС","факт за пред. год"];_.forEach(t.values,function(t){var e=0;_.isArray(t.points[0].values[0])?_.forEach(t.points[0].values[0],function(t){e+=t.val}):e=t.points[0].values[0]&&t.points[0].values[0].val,d.push({value:e,type:"n"})}),u.rows.push(d),d=["ННС","факт"],_.forEach(t.values,function(t){var e=0;_.isArray(t.points[0].values[1])?_.forEach(t.points[0].values[1],function(t){e+=t.val}):e=t.points[0].values[1]&&t.points[0].values[1].val,d.push({value:e,type:"n"})}),u.rows.push(d),u.merges.push({s:{c:0,r:2},e:{c:0,r:3}})}if(l=t,o=!0,_.forEach(l.values,function(t){t.points[1]&&!_.isUndefined(t.points[1].values[1])&&(o=!1)}),o){d=["ГС","факт"];_.forEach(t.values,function(t){var e=0;_.isArray(t.points[1].values[0])?_.forEach(t.points[1].values[0],function(t){e+=t.val}):e=t.points[1].values[0]&&t.points[1].values[0].val,d.push({value:e,type:"n"})}),u.rows.push(d)}else{d=["ГС","факт за пред. год"];_.forEach(t.values,function(t){var e=0;_.isArray(t.points[1].values[0])?_.forEach(t.points[1].values[0],function(t){e+=t.val}):e=t.points[1].values[0]&&t.points[1].values[0].val,d.push({value:e,type:"n"})}),u.rows.push(d),d=["ГС","факт"],_.forEach(t.values,function(t){var e=0;_.isArray(t.points[1].values[1])?_.forEach(t.points[1].values[1],function(t){e+=t.val}):e=t.points[1].values[1]&&t.points[1].values[1].val,d.push({value:e,type:"n"})}),u.rows.push(d),u.merges.push({s:{c:0,r:4},e:{c:0,r:5}})}}else if(u.headers.push(""),_.forEach(t.values,function(t){u.headers.push(t.title)}),n=t,i=!0,_.forEach(n.values,function(t){t.points[0]&&!_.isUndefined(t.points[0].values[1])&&(i=!1)}),i){d=["факт"];_.forEach(t.values,function(t){var e=0;_.isArray(t.points[0].values[0])?_.forEach(t.points[0].values[0],function(t){e+=t.val}):e=t.points[0].values[0]&&t.points[0].values[0].val,d.push({value:e,type:"n"})}),u.rows.push(d)}else{d=["факт за пред. год"];_.forEach(t.values,function(t){var e=0;_.isArray(t.points[0].values[0])?_.forEach(t.points[0].values[0],function(t){e+=t.val}):e=t.points[0].values[0]&&t.points[0].values[0].val,d.push({value:e,type:"n"})}),u.rows.push(d);d=["факт"];_.forEach(t.values,function(t){var e=0;_.isArray(t.points[0].values[1])?_.forEach(t.points[0].values[1],function(t){e+=t.val}):e=t.points[0].values[1]&&t.points[0].values[1].val,d.push({value:e,type:"n"})}),u.rows.push(d)}return u},getObjectsSheet:function(n,t,e,a){var i={sheetName:a,tableDescription:e,headers:[],rows:[],merges:[]};if(n)if(t){i.headers.push(""),_.forEach(n.all,function(t,e){i.headers.push(t?t.DisplayName:""),i.headers.push(""),i.headers.push(""),i.headers.push(""),i.headers.push(""),i.headers.push(""),i.merges.push({s:{c:1+6*e,r:1},e:{c:6+6*e,r:1}})}),(l=[]).push(""),_.forEach(n.all,function(t,e){l.push("ННС"),l.push(""),i.merges.push({s:{c:1+6*e,r:2},e:{c:2+6*e,r:2}}),l.push("ГС"),l.push(""),i.merges.push({s:{c:3+6*e,r:2},e:{c:4+6*e,r:2}}),l.push("Всего"),l.push(""),i.merges.push({s:{c:5+6*e,r:2},e:{c:6+6*e,r:2}})}),i.rows.push(l),(l=[]).push(""),_.forEach(n.all,function(t,e){l.push("План"),l.push("Факт"),l.push("План"),l.push("Факт"),l.push("План"),l.push("Факт")}),i.rows.push(l);var r=n.all.length&&n.all[0].ComputedFrom;_.forEach(r,function(t,a){var r=[];r.push(t.Name+", "+t.Uom),_.forEach(n.all,function(t,e){r.push({value:n.nns[e]&&n.nns[e].ComputedFrom?n.nns[e].ComputedFrom[a].PlanValue:"",type:"n"}),r.push({value:n.nns[e]&&n.nns[e].ComputedFrom?n.nns[e].ComputedFrom[a].Value:"",type:"n"}),r.push({value:n.gs[e]&&n.gs[e].ComputedFrom?n.gs[e].ComputedFrom[a].PlanValue:"",type:"n"}),r.push({value:n.gs[e]&&n.gs[e].ComputedFrom?n.gs[e].ComputedFrom[a].Value:"",type:"n"}),r.push({value:n.all[e]&&n.all[e].ComputedFrom?n.all[e].ComputedFrom[a].PlanValue:"",type:"n"}),r.push({value:n.all[e]&&n.all[e].ComputedFrom?n.all[e].ComputedFrom[a].Value:"",type:"n"})}),i.rows.push(r)})}else{var l;i.headers.push(""),_.forEach(n,function(t,e){i.headers.push(t?t.DisplayName:""),i.headers.push(""),i.merges.push({s:{c:1+2*e,r:1},e:{c:2+2*e,r:1}})}),(l=[]).push(""),_.forEach(n,function(t,e){l.push("План"),l.push("Факт")}),i.rows.push(l);r=n.length&&n[0].ComputedFrom;_.forEach(r,function(t,e){var a=[];a.push(t.Name+", "+t.Uom),_.forEach(n,function(t){a.push({value:t&&t.ComputedFrom?t.ComputedFrom[e].PlanValue:"",type:"n"}),a.push({value:t&&t.ComputedFrom?t.ComputedFrom[e].Value:"",type:"n"})}),i.rows.push(a)})}return i},getObjectTimeTitle:function(t){return t.Month?moment().year()===t.Year?moment().month(t.Month-1).format("MMMM"):moment().month(t.Month-1).year(t.Year).format("MMMM YYYYг"):t.Quarter?moment().year()===t.Year?moment().quarter(t.Quarter).format("Q квартал"):moment().quarter(t.Quarter).year(t.Year).format("Q кв YYYYг"):moment().year(t.Year).format("YYYYг")},sortTimeObject:function(t){return _.sortBy(t,function(t){return""+t.Year+t.Quarter+e(t.Month,2)})},roundTo:function(t,e){return e=e||0===e?e:"3",+(Math.round(t+"e+"+e)+"e-"+e)}}}),angular.module("smbApp").directive("tableChart",["numeraljsFilter",function(r){return{templateUrl:"views/directives/tableChart.html",restrict:"EA",scope:{items:"=ngModel",splitted:"=splitted"},link:function(a,t,e){a.parseValue=function(t){var e=0;if(t&&_.isArray(t.val))_.forEach(t.val,function(t){e+=t.val});else{if(!_.isObject(t))return"-";e=t.val}return r(e,a.items&&a.items.format||"0.0[0000]")},a.noPlan=function(){var e=!0;return a.items&&_.forEach(a.items.values,function(t){_.isUndefined(t.points[0].values[1])||(e=!1)}),e},a.noPlanNns=function(){var e=!0;return a.items&&_.forEach(a.items.values,function(t){_.isUndefined(t.points[0].values[1])||(e=!1)}),e},a.noPlanGs=function(){var e=!0;return a.items&&_.forEach(a.items.values,function(t){_.isUndefined(t.points[1].values[1])||(e=!1)}),e}}}}]),angular.module("smbApp").service("mapPointsData",["$q","authData","BaseDataService",function(t,a,e){var r=new e("mapPointsData"),n=r.getData;return angular.extend(r,{getData:function(){var e=t.defer();return n().then(function(t){t=t.data,a.getRawData()?e.resolve(t||[]):e.resolve([])}),e.promise}})}]),angular.module("smbApp").controller("ClusterCtrl",["$scope","$routeParams","$location","$q","$timeout","$filter","appSettings","companiesData","fieldsAttributesData","utils","refData","activeObjectsStatuses","apiData","physChartsData","xlsx","saveFile","config",function(i,r,e,n,a,l,o,s,c,u,d,t,m,f,p,h,g){function v(){var t={deckEconomicalIsOpen:i.filter.deckEconomicalIsOpen,deckPhysicalIsOpen:i.filter.deckEconomicalIsOpen};o.setSettings("company",t),t={drillType:i.filter.drillType,timeKey:i.filter.timeKey,wellState:i.filter.wellState,timeCount:i.filter.timeCount,showObjects:i.filter.showObjects},o.setSettings("app",t)}var D;i.$on("$destroy",function(){s.removeUpdateDataCallback(C),c.removeUpdateDataCallback(C),d.removeUpdateDataCallback(C),t.stop(),v()}),i.filter={drillType:0,timeKey:"month",timeCount:0,wellState:1,deckEconomicalIsOpen:!0,deckPhysicalIsOpen:!0,showActiveObjects:!0,showObjects:!0},i.data={activeObjectsStatuses:[],activeObjects:[],objects:[],companies:[],company:null,fields:[],field:null,clusters:[],cluster:null,wells:[],well:null,loaded:!1,widgetsLoaded:!1,error:null,physWidgetsData:null,finWidgetsData:null,physParams:[],finParams:[],physCharts:[]},(D=o.getSettings("company"))&&(_.extend(i.filter,D),(D=o.getSettings("app"))&&_.extend(i.filter,D)),i.$watch("filter",function(){v()},!0),i.$watch("filter.wellState",function(t,e){t!==e&&b()}),i.$watch("filter.timeKey",function(t,e){t!==e&&b()}),i.$watch("filter.drillType",function(t,e){t!==e&&b()}),i.$watch("filter.timeCount",function(t,e){t!==e&&b()});var y=null;function b(){i.data.widgetsLoaded=!1,i.data.error=null,i.data.physWidgetsData={},i.data.finWidgetsData={},y&&y.reject("cancel");var t=_.filter(i.data.physCharts,function(t){return-1!==t.DrillTypes.indexOf(i.filter.drillType)});t=_.filter(t,function(t){return-1!==t.WellStates.indexOf(i.filter.wellState)});_.sortBy(t,"Order");var e=[];_.forEach(t,function(t){e.push(t.Id)});var a=y=n.defer();n.all([m.getClusterWidgetsData(r.clusterUID,i.filter.drillType,i.filter.timeKey,i.filter.timeCount,i.filter.wellState,e).promise,m.getClusterWidgetsFinData(r.clusterUID,i.filter.drillType,i.filter.timeKey,i.filter.timeCount,i.filter.wellState).promise]).then(function(t){a.resolve(t)},function(t){a.reject(t)}),a.promise.then(function(t){var r=t[0].data;i.data.physParams=_.pluck(r,"Parameter"),i.data.physParams=_.compact(i.data.physParams),i.data.physParams=_.map(i.data.physParams,function(t){return t.replace("Gs","").replace("Nns","")}),i.data.physParams=_.unique(i.data.physParams),_.forEach(i.data.physParams,function(t){var e=_.find(r,{Parameter:t});if(e){var a={displayName:e.DisplayName,uom:e.Uom,value:e.TrendValue,delta:e.TrendDeltaValue,deltaPc:e.TrendDeltaPc,color:e.Color,roundTo:e.RoundTo};i.data.physWidgetsData[t]=a}});var n=t[1].data;i.data.finParams=_.pluck(n,"Parameter"),i.data.finParams=_.compact(i.data.finParams),i.data.finParams=_.map(i.data.finParams,function(t){return t.replace("Gs","").replace("Nns","")}),i.data.finParams=_.unique(i.data.finParams),_.forEach(i.data.finParams,function(t){var e=_.find(n,{Parameter:t});if(e){var a={displayName:e.DisplayName,uom:e.Uom,value:e.TrendValue,delta:e.TrendDeltaValue,deltaPc:e.TrendDeltaPc,color:e.Color,roundTo:e.RoundTo};i.data.finWidgetsData[t]=a}}),i.data.widgetsLoaded=!0,i.data.error=null},function(t){"cancel"!==t&&(i.data.widgetsLoaded=!0,i.data.error=t)})}function C(){i.data.loaded=!1,i.data.error=null,n.all([s.getData(),f.getData()]).then(function(t){a(function(){i.data.activeObjects=s.getCompaniesActiveObjects(r.companyUID,r.fieldUID,r.clusterUID),i.data.objects=s.getCompaniesObjects(r.companyUID,r.fieldUID,r.clusterUID),i.data.companies=s.getCompaniesNames(),i.data.companies.unshift({name:"Газпром нефть",shortName:"Газпром нефть",UID:"all"}),i.data.company=_.find(i.data.companies,{UID:r.companyUID}),i.data.fields=s.getCompanyFieldsNames(r.companyUID),i.data.field=_.find(i.data.fields,{UID:r.fieldUID}),i.data.clusters=s.getCompanyClustersNames(r.companyUID,r.fieldUID),i.data.cluster=_.find(i.data.clusters,{UID:r.clusterUID}),i.data.wells=s.getCompanyWellsNames(r.companyUID,r.fieldUID,r.clusterUID),i.data.physCharts=t[1],i.data.loaded=!0,b()},500)})}i.emptyPhysData=function(){var e=!0;return _.forEach(i.data.physParams,function(t){i.data.physWidgetsData&&i.data.physWidgetsData[t]&&(e=!1)}),e},i.emptyFinData=function(){var e=!0;return _.forEach(i.data.finParams,function(t){i.data.finWidgetsData&&i.data.finWidgetsData[t]&&(e=!1)}),e},n.all([s.getData()]).then(function(t){C(),s.addUpdateDataCallback(C),c.addUpdateDataCallback(C),d.addUpdateDataCallback(C)}),i.getObjectName=function(t){return"none"!==t.clusterName?t.fieldName+" - "+t.clusterName+" - "+t.wellName+" - "+i.getDrillTypeName(t.drillType):t.fieldName+" - "+t.wellName+" - "+i.getDrillTypeName(t.drillType)},i.getActiveObjects=function(){return _.filter(i.data.activeObjects,{drillType:i.filter.drillType+""})},i.getObjects=function(){return _.filter(i.data.objects,{drillType:i.filter.drillType+""})},i.selectWell=function(t){e.path("/well/"+r.companyUID+"/"+r.fieldUID+"/"+r.clusterUID+"/"+t.UID)},i.selectCluster=function(t){e.path("/cluster/"+r.companyUID+"/"+r.fieldUID+"/"+t.UID)},i.selectField=function(t){e.path("/field/"+r.companyUID+"/"+t.UID)},i.selectCompany=function(t){e.path("/company/"+t.UID)},i.getDrillTypeName=d.getDrillTypeName,i.updateActiveObjectsStatuses=function(t){i.data.activeObjectsStatuses=t},i.getObjectGti=function(t){var e=_.find(i.data.activeObjectsStatuses,{objUID:t.wellUID});return!!e&&e.gti},i.getObjectMwd=function(t){var e=_.find(i.data.activeObjectsStatuses,{objUID:t.wellUID});return!!e&&e.mwd},i.getObjectActivity=function(t){var e=_.find(i.data.activeObjectsStatuses,{objUID:t.wellUID});return e?d.getActivityName(e.activity):"-"},t.start(),t.addUpdate(i.updateActiveObjectsStatuses),i.openExternalChart=function(){var t="/wsreport/default.aspx?nohdr=true";switch(t=t+"&wc="+r.clusterUID,i.filter.drillType){case 0:t+="&drillType=eb";break;case 1:t+="&drillType=zbs";break;case 2:t+="&drillType=prb"}switch(i.filter.wellState){case 0:t+="&wState=drilling";break;case 1:case 2:t+="&wState=drilled"}window.open(t,"_blank").focus()},i.getPeriodLabel=function(){switch(i.filter.timeKey){case"month":return moment().startOf("month").subtract(1,"months").format("MMMM YYYY г.");case"quarter":return moment().startOf("month").subtract(1,"quarter").format("Q кв. YYYY г.");case"year":return moment().startOf("month").subtract(1,"years").format("YYYY г.");default:return""}},i.getExcel=function(){var t=[],r={sheetName:"Физика",tableDescription:"Физика: "+u.getDrillTypeName(i.filter.drillType)+" "+u.getPeriodLabel(i.filter.timeKey,i.filter.timeCount)+" "+u.getWellStateName(i.filter.wellState),headers:["Показатель","Значение","Разница"],rows:[],merges:[]};_.forEach(i.data.physParams,function(t){if(i.data.physWidgetsData[t]){var e=i.data.physWidgetsData[t],a=[];a.push(e.displayName+" "+e.uom),a.push({value:l("round")(e.value,e.roundTo),type:"n"}),a.push({value:l("round")(e.delta,e.roundTo),type:"n"}),r.rows.push(a)}}),t.push(r),r={sheetName:"Экономика",tableDescription:"Экономика: "+u.getDrillTypeName(i.filter.drillType)+" "+u.getPeriodLabel(i.filter.timeKey,i.filter.timeCount)+" "+u.getWellStateName(i.filter.wellState),headers:["Показатель","Значение","Разница"],rows:[],merges:[]},_.forEach(i.data.finParams,function(t){if(i.data.finWidgetsData[t]){var e=i.data.finWidgetsData[t],a=[];a.push(e.displayName+" "+e.uom),a.push({value:l("round")(e.value,e.roundTo),type:"n"}),a.push({value:l("round")(e.delta,e.roundTo),type:"n"}),r.rows.push(a)}}),t.push(r),r={sheetName:"Активные объекты",tableDescription:"Активные объекты: "+u.getDrillTypeName(i.filter.drillType),headers:["Объект","ГТИ","Тел-я","Этап работ","Цель бурения"],rows:[],merges:[]},_.forEach(i.getActiveObjects(),function(t){var e=[];switch(e.push(i.getObjectName(t)),i.getObjectGti(t)){case"0":e.push("-");break;case"1":e.push("+");break;default:e.push("")}switch(i.getObjectMwd(t)){case"0":e.push("-");break;case"1":e.push("+");break;default:e.push("")}e.push(i.getObjectActivity(t)),e.push(i.getDrillTypeName(t.drillType)),r.rows.push(e)}),t.push(r);var e=p.writeXlsx(t);h.saveFile(e,"xlsx","Компания "+i.data.company.name+" месторождение "+i.data.field.name+" "+u.getDrillTypeName(i.filter.drillType)+" "+u.getPeriodLabel(i.filter.timeKey,i.filter.timeCount)+" "+u.getWellStateName(i.filter.wellState)).promise.then(function(t){window.open(g.getApiUrl()+"document/content?id="+t.data,"_blank").focus(),console.log(t)})}}]),angular.module("smbApp").controller("WellCtrl",["$scope","$location","$route","$routeParams","$q","$timeout","companiesData","utils","refData","apiData","selectWell","xlsx","saveFile","editSppIdModal","accept","config",function(D,e,a,r,t,l,n,c,i,o,s,u,d,m,f,p){function h(){if(D.data.benchItems){var t=_.filter(D.data.benchItems.benchItemsSrc,D.data.benchItems.filters.subSetName?{SubSetName:D.data.benchItems.filters.subSetName}:null);t=_.filter(t,D.data.benchItems.filters.contractId?{ContractId:D.data.benchItems.filters.contractId}:null),t=_.filter(t,D.data.benchItems.filters.contractorName?{ContractorName:D.data.benchItems.filters.contractorName}:null);var e=_.pluck(t,"SetName")||[];e=_.uniq(_.compact(e)).sort(),D.data.benchItems.sets=_.map(e,function(t){return{id:t,name:t+""}}),D.data.benchItems.sets.unshift({name:"Все",id:null}),t=_.filter(D.data.benchItems.benchItemsSrc,D.data.benchItems.filters.setName?{SetName:D.data.benchItems.filters.setName}:null),t=_.filter(t,D.data.benchItems.filters.contractId?{ContractId:D.data.benchItems.filters.contractId}:null),t=_.filter(t,D.data.benchItems.filters.contractorName?{ContractorName:D.data.benchItems.filters.contractorName}:null);var a=_.pluck(t,"SubSetName")||[];a=_.uniq(_.compact(a)).sort(),D.data.benchItems.subSets=_.map(a,function(t){return{id:t,name:t+""}}),D.data.benchItems.subSets.unshift({name:"Все",id:null}),t=_.filter(D.data.benchItems.benchItemsSrc,D.data.benchItems.filters.setName?{SetName:D.data.benchItems.filters.setName}:null),t=_.filter(t,D.data.benchItems.filters.subSetName?{SubSetName:D.data.benchItems.filters.subSetName}:null),t=_.filter(t,D.data.benchItems.filters.contractorName?{ContractorName:D.data.benchItems.filters.contractorName}:null),D.data.benchItems.totalAmmount=0,_.forEach(t,function(t){D.data.benchItems.totalAmmount+=t.Ammount}),t=_.filter(t,D.data.benchItems.filters.contractorName?{ContractorName:D.data.benchItems.filters.contractorName}:null);var r=_.pluck(t,"ContractId")||[];r=_.uniq(_.compact(r)).sort(),D.data.benchItems.contracts=_.map(r,function(t){return{id:t,name:t+""}}),D.data.benchItems.contracts.unshift({name:"Все",id:null}),t=_.filter(D.data.benchItems.benchItemsSrc,D.data.benchItems.filters.setName?{SetName:D.data.benchItems.filters.setName}:null),t=_.filter(t,D.data.benchItems.filters.subSetName?{SubSetName:D.data.benchItems.filters.subSetName}:null),t=_.filter(t,D.data.benchItems.filters.contractId?{ContractId:D.data.benchItems.filters.contractId}:null);var n=_.pluck(t,"ContractorName")||[];n=_.uniq(_.compact(n)).sort(),D.data.benchItems.contractors=_.map(n,function(t){return{id:t,name:t+""}}),D.data.benchItems.contractors.unshift({name:"Все",id:null})}}function g(t){D.data.npv&&D.data.npv.length&&(t=t||0,D.npvChartConfig=null,l(function(){D.npvChartConfig={options:{chart:{type:"pie",events:{redraw:function(t){t.target&&t.target.series&&t.target.series[0]&&function(t,e,a){if(console.log("sadfasdf",e,a),t){var r=D.data.npv;e&&(r=_.filter(r,function(t){return t["NpvLevel"+a]===e}));var n=_.groupBy(r,"Causer"),i=_.map(n,function(t,e){var a=0,r=0;return _.forEach(t,function(t){a+=t.Duration,r+=t.Pc}),{name:e,y:a,pcY:r}});l(function(){D.npvCausersChartConfig={options:{chart:{type:"pie"},title:{text:e||"Виновники НПВ"},plotOptions:{pie:{shadow:!1,center:["50%","50%"],borderColor:"#000000",showInLegend:!0}},tooltip:{headerFormat:'<span style="font-size:11px">{series.name}</span><br>',pointFormat:"<span>{point.name}</span>: <b>{point.pcY:.2f} %, {point.y:.2f} сут</b>"},colors:c.colors()},series:[{name:"Виновники НПВ",data:i,dataLabels:{formatter:function(){return D.filter.chartDrilldown?Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%":"<b>"+this.point.name+":</b> "+Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%"}}}]}})}else D.npvCausersChartConfig=null}(t.target.series[0].data,t.target.series[0].options.key,t.target.series[0].options.level)}}},title:{text:""},plotOptions:{pie:{shadow:!1,center:["50%","50%"],borderColor:"#000000"}},tooltip:{headerFormat:'<span style="font-size:11px">{series.name}</span><br>',pointFormat:"<span>{point.name}</span>: <b>{point.pcY:.2f} %, {point.y:.2f} сут</b>"}},series:[]};var t=D.data.npv,n=[],h=[],g=[],e=[],o=[],v=[];t=_.sortBy(t,function(t){return c.getNpvPieChartAttributeIndex(t.NpvLevel1Id)});var a=_.groupBy(t,"NpvLevel1"),s=[];if(_.forEach(a,function(t,e,a){var m=c.getNpvPieChartAttributeColor(t[0].NpvLevel1Id),i=0,l=0,f=0;t=_.sortBy(t,function(t){return t.NpvLevel2===e?0:1});var r=_.groupBy(t,"NpvLevel2"),p=[];_.forEach(r,function(t,e,a){var o=0,s=0,c=_.keys(a).length,u=0;t=_.sortBy(t,function(t){return t.NpvLevel2===e?0:1});var r=_.groupBy(t,"NpvLevel3"),d=[];_.forEach(r,function(t,e,a){var r=0,n=0;_.forEach(t,function(t){r+=t.Duration,n+=t.Pc}),o+=r,s+=n;var i=_.keys(a).length,l=.3*f/c+.9*u*.3/c/i;g.push({name:e,y:r,pcY:n,color:Highcharts.Color(m).brighten(l).get()}),d.push({name:e,y:r,pcY:n,color:Highcharts.Color(m).brighten(l).get()}),u++}),v.push({level:2,key:e,name:"Причина НПВ: "+e,id:"Уровень 3 "+e,data:d,dataLabels:{formatter:function(){return D.filter.chartDrilldown?Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%":"<b>"+this.point.name+":</b> "+Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%"}}}),i+=o,l+=s;var n=.3*f/c;h.push({name:e,y:o,pcY:s,color:Highcharts.Color(m).brighten(n).get()}),p.push({name:e,y:o,pcY:s,color:Highcharts.Color(m).brighten(n).get(),drilldown:"Уровень 3 "+e}),f++}),o.push({level:1,key:e,name:"Класс НПВ: "+e,id:"Уровень 2 "+e,data:p,dataLabels:{formatter:function(){return D.filter.chartDrilldown?Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%":"<b>"+this.point.name+":</b> "+Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%"}}}),n.push({name:e,y:i,pcY:l,color:m}),s.push({name:e,y:i,color:m,pcY:l,drilldown:"Уровень 2 "+e})}),e.push({level:0,key:null,name:"Тип НПВ",data:s,dataLabels:{formatter:function(){return D.filter.chartDrilldown?Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%":"<b>"+this.point.name+":</b> "+Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%"}}}),D.filter.chartDrilldown)D.npvChartConfig.options.plotOptions.pie.showInLegend=!0,D.npvChartConfig.options.drilldown={series:_.union(o,v)},D.npvChartConfig.series=e;else{if(D.npvChartConfig.series=[],D.filter.showNpvType){var r="30%";(!D.filter.showNpvClass&&D.filter.showNpvReason||D.filter.showNpvClass&&!D.filter.showNpvReason)&&(r="50%"),D.filter.showNpvClass||D.filter.showNpvReason||(r="75%"),D.npvChartConfig.series.push({level:1,key:null,name:"Тип НПВ",data:n,size:r,dataLabels:{formatter:function(){return D.filter.showNpvClass||D.filter.showNpvReason?this.point.name:"<b>"+this.point.name+":</b> "+Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%"},color:D.filter.showNpvClass||D.filter.showNpvReason?"white":null,distance:D.filter.showNpvClass||D.filter.showNpvReason?-50:30}})}if(D.filter.showNpvClass){r="65%";var i="30%";!D.filter.showNpvReason&&D.filter.showNpvType&&(i="50%",r="75%"),D.filter.showNpvReason&&!D.filter.showNpvType&&(i=null,r="50%"),D.filter.showNpvReason||D.filter.showNpvType||(i=null,r="75%"),D.npvChartConfig.series.push({name:"Класс НПВ",data:h,size:r,innerSize:i,dataLabels:{formatter:function(){return D.filter.showNpvReason?null:"<b>"+this.point.name+":</b> "+Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%"}}})}if(D.filter.showNpvReason){i="65%";(!D.filter.showNpvClass&&D.filter.showNpvType||D.filter.showNpvClass&&!D.filter.showNpvType)&&(i="50%"),D.filter.showNpvClass||D.filter.showNpvType||(i=null),D.npvChartConfig.series.push({name:"Причина НПВ",data:g,size:"75%",innerSize:i,dataLabels:{formatter:function(){return"<b>"+this.point.name+":</b> "+Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%"}}})}}},t))}D.authData&&D.authData.CanViewMap?(D.$on("$destroy",function(){}),D.data={iframeUrl:null,companies:[],company:null,objects:[],fields:[],field:null,wells:[],well:null,loaded:!1,error:null,widgetsData:null,benchItems:null,psdDocs:[],rdDocs:[],edsDocs:[],edsDocsSrc:[],npvDuration:0,npvPc:0,finCharts:[],finParams:[],physCharts:[],physParams:[]},p.getData().then(function(){D.data.iframeUrl=p.getIframeUrl()+"?nohdr=true&depth_day_only=true&w="+r.wellUID}),D.filter={chartDrilldown:!0,showNpvType:!0,showNpvClass:!0,showNpvReason:!0,npvChartSelected:!1,depthDaySelected:!1},D.data.loaded=!1,D.data.error=null,t.all([n.getData(),i.getData()]).then(function(t){D.data.companies=n.getCompaniesNames(),D.data.activeObjects=n.getCompaniesActiveObjects(r.companyUID,r.fieldUID),D.data.objects=n.getCompaniesObjects(r.companyUID,r.fieldUID),D.data.companies.unshift({name:"Газпром нефть",shortName:"Газпром нефть",UID:"all"}),D.data.company=_.find(D.data.companies,{UID:r.companyUID}),D.data.fields=n.getCompanyFieldsNames(r.companyUID),D.data.field=_.find(D.data.fields,{UID:r.fieldUID}),D.data.wells=n.getCompanyWellsNames(r.companyUID,r.fieldUID),D.data.well=_.find(D.data.wells,{UID:r.wellUID}),D.data.loaded=!1,D.data.error=null,D.data.widgetsData={},D.data.finWidgetsData={},o.getWellData(r.wellUID).then(function(t){var e=t.data.Parameters,a=t.data.FinParameters;function r(i,l,t){var o=["hours_per_incident","incident_per_1000m"];l[t]=_.unique(_.pluck(i,"Parameter"));var s=t+"Empty";l[s]=[],_.forEach(l[t],function(t){var e=_.find(i,{Parameter:t});if(e&&e.DisplayName){var a=e.TrendValue||-1<o.indexOf(t);if(a){var r={displayName:e.DisplayName,uom:e.Uom,value:e.TrendValue,valuePlan:e.PlanTrendValue,delta:e.TrendDeltaValue,deltaPc:e.TrendDeltaPc,roundTo:e.RoundTo};l.widgetsData[t]=r}else if(e.DisplayName){var n=e.DisplayName+", "+e.Uom;l[s].push(n)}}})}D.data.wellInfo=t.data,D.data.npv=t.data.Npv,D.data.psdDocsSrc=t.data.PsdDocs,D.data.psdDocs=_.cloneDeep(D.data.psdDocsSrc),D.data.rdDocsSrc=t.data.RdDocs,D.data.rdDocs=_.cloneDeep(D.data.rdDocsSrc),D.data.edsDocsSrc=t.data.EdsDocs,D.data.edsDocs=_.cloneDeep(D.data.edsDocsSrc),D.data.wellAgreementsSrc=t.data.WellAgreements,D.data.wellAgreements=_.cloneDeep(D.data.wellAgreementsSrc),D.data.benchItems={filters:{setName:null,subSetName:null,contractId:null,contractorName:null},benchItemsSrc:t.data.BenchItems,filteredBenchItemsSrc:_.cloneDeep(t.data.BenchItems),filteredBenchItems:_.cloneDeep(t.data.BenchItems),sets:[],subSets:[],contracts:[],contractors:[],totalAmmount:null},h(),D.data.npvDuration=t.data.NpvDuration,D.data.npvPc=t.data.NpvPc,D.data.npvDrillingDurationTotal=t.data.NpvDrillingDurationTotal,r(e,D.data,"physParams"),r(a,D.data,"finParams"),g(),D.data.loaded=!0,D.data.error=null},function(t){D.data.loaded=!0,D.data.error=t})}),D.$watch("data.benchItems.filters",function(){if(D.data.benchItems&&D.data.benchItems.benchItemsSrc){var t=_.cloneDeep(D.data.benchItems.benchItemsSrc);t=_.filter(t,D.data.benchItems.filters.setName?{SetName:D.data.benchItems.filters.setName}:null),t=_.filter(t,D.data.benchItems.filters.subSetName?{SubSetName:D.data.benchItems.filters.subSetName}:null),t=_.filter(t,D.data.benchItems.filters.contractId?{ContractId:D.data.benchItems.filters.contractId}:null),t=_.filter(t,D.data.benchItems.filters.contractorName?{ContractorName:D.data.benchItems.filters.contractorName}:null),D.data.benchItems.filteredBenchItemsSrc=t,D.data.benchItems.filteredBenchItems=_.cloneDeep(D.data.benchItems.filteredBenchItemsSrc)}h()},!0),D.$watch("filter.chartDrilldown",g),D.$watch("filter.showNpvType",g),D.$watch("filter.showNpvClass",g),D.$watch("filter.showNpvReason",g),D.updateNpvChartData=g,D.getContractorsNames=function(a,t){var r=[];return _.forEach(t.Contractors,function(t){var e='<a href="#/contractor/'+t.ObjId+"/card?lineId="+a+'">';e+=t.ShortName||t.Name,e+="</a>",r.push(e)}),r.join(", ")},D.selectedEdsDocumentsIds=[],D.edsDocumentSelected=function(t){return-1!==D.selectedEdsDocumentsIds.indexOf(t.DocId)},D.toggleSelectEdsDocument=function(t){-1===D.selectedEdsDocumentsIds.indexOf(t.DocId)?D.selectedEdsDocumentsIds.push(t.DocId):D.selectedEdsDocumentsIds.splice(D.selectedEdsDocumentsIds.indexOf(t.DocId),1)},D.downloadSelectedEdsDocuments=function(){var t=_.map(D.selectedEdsDocumentsIds,function(t){return"id="+t});window.open(p.getApiUrl()+"document/content?"+t.join("&"),"_blank").focus()},D.selectAllEds=function(){D.selectedEdsDocumentsIds=_.pluck(D.data.edsDocs,"DocId")},D.unSelectAllEds=function(){D.selectedEdsDocumentsIds=[]},D.selectedRdDocumentsIds=[],D.rdDocumentSelected=function(t){return-1!==D.selectedRdDocumentsIds.indexOf(t.DocId)},D.toggleSelectRdDocument=function(t){-1===D.selectedRdDocumentsIds.indexOf(t.DocId)?D.selectedRdDocumentsIds.push(t.DocId):D.selectedRdDocumentsIds.splice(D.selectedRdDocumentsIds.indexOf(t.DocId),1)},D.downloadSelectedRdDocuments=function(){var t=_.map(D.selectedRdDocumentsIds,function(t){return"id="+t});window.open(p.getApiUrl()+"document/content?"+t.join("&"),"_blank").focus()},D.selectAllRd=function(){D.selectedRdDocumentsIds=_.pluck(D.data.rdDocs,"DocId")},D.unSelectAllRd=function(){D.selectedRdDocumentsIds=[]},D.selectedPsdDocumentsIds=[],D.psdDocumentSelected=function(t){return-1!==D.selectedPsdDocumentsIds.indexOf(t.DocId)},D.toggleSelectPsdDocument=function(t){-1===D.selectedPsdDocumentsIds.indexOf(t.DocId)?D.selectedPsdDocumentsIds.push(t.DocId):D.selectedPsdDocumentsIds.splice(D.selectedPsdDocumentsIds.indexOf(t.DocId),1)},D.downloadSelectedPsdDocuments=function(){var t=_.map(D.selectedPsdDocumentsIds,function(t){return"id="+t});window.open(p.getApiUrl()+"document/content?"+t.join("&"),"_blank").focus()},D.selectAllPsd=function(){D.selectedPsdDocumentsIds=_.pluck(D.data.psdDocs,"DocId")},D.unSelectAllPsd=function(){D.selectedPsdDocumentsIds=[]},D.selectWell=function(){s(D.data.objects,D.data.activeObjects).then(function(t){e.path("/well/"+r.companyUID+"/"+r.fieldUID+"/"+t)})},D.selectField=function(t){e.path("/field/"+r.companyUID+"/"+t.UID)},D.selectCompany=function(t){e.path("/company/"+t.UID)},D.openDocument=function(t){window.open(p.getApiUrl()+"document/"+t.DocId+"/content","_blank").focus()},D.getAttributeFullName=i.getAttributeFullName,D.getAttributeMUnit=i.getAttributeMUnit,D.removeSppId=function(){f("Вы действительно хоите удалить СПП-Элемент?").then(function(){o.editWellSppId(r.wellUID,"").promise.then(function(){a.reload()})})},D.editSppId=function(){m(r.wellUID,D.data.wellInfo.SppId).then(function(t){a.reload()})},D.canEditSppId=function(){return D.user&&D.user.Roles&&(-1!==D.user.Roles.indexOf("CRS_FIN_WRITER")||-1!==D.user.Roles.indexOf("CRS_FIN_MANAGER"))},D.getExcel=function(){window.open(p.getApiUrl()+"well/"+r.wellUID+"/card/report","_blank").focus()},D.openLink=function(t){if(t){var e=window.open(t,"_blank");e&&e.focus()}},D.openDailyCost=function(){p.getData().then(function(){window.open(p.getIframeUrl()+"?singleModuleName=DailyCost&w="+r.wellUID,"_blank").focus()})},D.matchSapSmb=function(r){o.matchSapSmb(r.ContractorId).then(function(t){if(t.data.length)r.HasSapSmbRelation=!0,r.ContractorName=t.data[0];else{var e=window.open("","winPop","sample-options");if("about:blank"==e.location){var a=p.getAdminUrl();"/"===a.substr(a.length-1,1)&&(a=a.substr(0,a.length-1)),e.location.href=a+"/smbsap/"+r.ContractorId}e.focus()}},function(t){})}):e.path("/main")}]),angular.module("smbApp").controller("CompanyCtrl",["$scope","$routeParams","$location","$q","$timeout","$filter","utils","companiesData","refData","physChartsData","appSettings","activeObjectsStatuses","apiData","xlsx","saveFile",function(i,r,e,n,a,l,o,s,c,t,u,d,m,f,p){if(i.authData&&i.authData.CanViewMap){var h;i.$on("$destroy",function(){d.removeUpdate(i.updateActiveObjectsStatuses),d.stop(),D()}),i.filter={drillType:0,timeKey:"month",timeCount:0,wellState:1,deckEconomicalIsOpen:!0,deckPhysicalIsOpen:!0,showActiveObjects:!0,showObjects:!0,viewMode:!0,hierarchyMode:!0},i.data={activeObjectsStatuses:[],activeObjects:[],objects:[],companies:[],company:null,fields:[],activeFields:[],loaded:!1,widgetsLoaded:!1,error:null,physWidgetsData:null,finWidgetsData:null,physParams:[],finParams:[],physCharts:[]},(h=u.getSettings("company"))&&(_.extend(i.filter,h),(h=u.getSettings("app"))&&_.extend(i.filter,h)),i.$watch("filter",function(){D()},!0),i.data.loaded=!1,i.data.error=null,n.all([s.getData(),c.getData(),t.getData()]).then(function(t){a(function(){i.data.activeObjects=s.getCompaniesActiveObjects("all"===r.companyUID?null:r.companyUID),i.data.objects=s.getCompaniesObjects("all"===r.companyUID?null:r.companyUID),i.data.companies=s.getCompaniesNames(),i.data.companies.unshift({name:"Газпром нефть",shortName:"Газпром нефть",UID:"all"}),i.data.company=_.find(i.data.companies,{UID:r.companyUID}),i.data.fields=s.getCompanyFieldsNames("all"===r.companyUID?null:r.companyUID),i.data.physCharts=t[2],i.data.loaded=!0,y()},500)}),i.getFields=function(t){var e=t?i.data.activeObjects:i.data.objects;return _.filter(i.data.fields,function(t){return 0<_.filter(e,{fieldUID:t.UID,drillType:i.filter.drillType+""}).length})},i.getObjectCount=function(t,e){var a=e?i.data.activeObjects:i.data.objects;return _.filter(a,{fieldUID:t,drillType:i.filter.drillType+""}).length},i.getClustersCount=function(t,e){var a=e?i.data.activeObjects:i.data.objects;return g(a,t)};var g=function(t,e){var a=_.filter(t,{fieldUID:e,drillType:i.filter.drillType+""}),r=_.groupBy(a,"clusterName");return _.size(r)};i.$watch("filter.wellState",function(t,e){t!==e&&y()}),i.$watch("filter.timeKey",function(t,e){t!==e&&y()}),i.$watch("filter.timeCount",function(t,e){t!==e&&y()}),i.$watch("filter.drillType",function(t,e){t!==e&&y()});var v=null;i.getObjectName=function(t){return"none"!==t.clusterName?t.fieldName+" - "+t.clusterName+" - "+t.wellName+" - "+i.getDrillTypeName(t.drillType):t.fieldName+" - "+t.wellName+" - "+i.getDrillTypeName(t.drillType)},i.getActiveObjects=function(){return _.filter(i.data.activeObjects,{drillType:i.filter.drillType+""})},i.getObjects=function(){return _.filter(i.data.objects,{drillType:i.filter.drillType+""})},i.selectField=function(t){e.path("/field/"+t.companyUID+"/"+t.UID)},i.selectCompany=function(t){e.path("/company/"+t.UID)},i.getDrillTypeName=c.getDrillTypeName,i.updateActiveObjectsStatuses=function(t){i.data.activeObjectsStatuses=t},i.getObjectGti=function(t){var e=_.find(i.data.activeObjectsStatuses,{objUID:t.wellUID});return!!e&&e.gti},i.getObjectMwd=function(t){var e=_.find(i.data.activeObjectsStatuses,{objUID:t.wellUID});return!!e&&e.mwd},i.getObjectActivity=function(t){var e=_.find(i.data.activeObjectsStatuses,{objUID:t.wellUID});return e&&"0"!==e.activity?c.getActivityName(e.activity):"-"},d.start(),d.addUpdate(i.updateActiveObjectsStatuses),i.emptyPhysData=function(){var e=!0;return _.forEach(i.data.physParams,function(t){i.data.physWidgetsData&&i.data.physWidgetsData[t]&&(e=!1)}),e},i.emptyFinData=function(){var e=!0;return _.forEach(i.data.finParams,function(t){i.data.finWidgetsData&&i.data.finWidgetsData[t]&&(e=!1)}),e},i.openExternalChart=function(){var t="/wsreport/default.aspx?nohdr=true";switch("all"!==r.companyUID&&(t=t+"&c="+r.companyUID),i.filter.drillType){case 0:t+="&drillType=eb";break;case 1:t+="&drillType=zbs";break;case 2:t+="&drillType=prb"}switch(i.filter.wellState){case 0:t+="&wState=undefined";break;case 1:t+="&wState=drilling";break;case 2:case 3:t+="&wState=drilled"}window.open(t,"_blank").focus()},i.getExcel=function(){var t=[],r={sheetName:"Физика",tableDescription:"Физика: "+o.getDrillTypeName(i.filter.drillType)+" "+o.getPeriodLabel(i.filter.timeKey,i.filter.timeCount)+" "+o.getWellStateName(i.filter.wellState),headers:["Показатель","Значение","Разница"],rows:[],merges:[]};_.forEach(i.data.physParams,function(t){if(i.data.physWidgetsData[t]){var e=i.data.physWidgetsData[t],a=[];a.push(e.displayName+" "+e.uom),a.push({value:l("round")(e.value,e.roundTo),type:"n"}),a.push({value:l("round")(e.delta,e.roundTo),type:"n"}),r.rows.push(a)}}),t.push(r),r={sheetName:"Экономика",tableDescription:"Экономика: "+o.getDrillTypeName(i.filter.drillType)+" "+o.getPeriodLabel(i.filter.timeKey,i.filter.timeCount)+" "+o.getWellStateName(i.filter.wellState),headers:["Показатель","Значение","Разница"],rows:[],merges:[]},_.forEach(i.data.finParams,function(t){if(i.data.finWidgetsData[t]){var e=i.data.finWidgetsData[t],a=[];a.push(e.displayName+" "+e.uom),a.push({value:l("round")(e.value,e.roundTo),type:"n"}),a.push({value:l("round")(e.delta,e.roundTo),type:"n"}),r.rows.push(a)}}),t.push(r),r={sheetName:"Активные объекты",tableDescription:"Активные объекты: "+o.getDrillTypeName(i.filter.drillType),headers:["Объект","ГТИ","Тел-я","Этап работ","Цель бурения"],rows:[],merges:[]},_.forEach(i.getActiveObjects(),function(t){var e=[];switch(e.push(i.getObjectName(t)),i.getObjectGti(t)){case"0":e.push("-");break;case"1":e.push("+");break;default:e.push("")}switch(i.getObjectMwd(t)){case"0":e.push("-");break;case"1":e.push("+");break;default:e.push("")}e.push(i.getObjectActivity(t)),e.push(i.getDrillTypeName(t.drillType)),r.rows.push(e)}),t.push(r);var e=f.writeXlsx(t);p.saveFile(e,"xlsx","Компания "+i.data.company.name+" "+o.getDrillTypeName(i.filter.drillType)+" "+o.getPeriodLabel(i.filter.timeKey,i.filter.timeCount)+" "+o.getWellStateName(i.filter.wellState)).promise.then(function(t){console.log(t),window.open("/crsreport/api/document/content?id="+t.data,"_blank").focus(),console.log(t)})}}else e.path("/main");function D(){var t={deckEconomicalIsOpen:i.filter.deckEconomicalIsOpen,deckPhysicalIsOpen:i.filter.deckEconomicalIsOpen};u.setSettings("company",t),t={drillType:i.filter.drillType,timeKey:i.filter.timeKey,wellState:i.filter.wellState,timeCount:i.filter.timeCount,showObjects:i.filter.showObjects},u.setSettings("app",t)}function y(){i.data.widgetsLoaded=!1,i.data.error=null,i.data.physWidgetsData={},i.data.finWidgetsData={},v&&v.reject("cancel");var t=_.filter(i.data.physCharts,function(t){return-1!==t.DrillTypes.indexOf(i.filter.drillType)});t=_.filter(t,function(t){return-1!==t.WellStates.indexOf(i.filter.wellState)});_.sortBy(t,"Order");var e=[];_.forEach(t,function(t){e.push(t.Id)});var a=v=n.defer();n.all([m.getCompanyWidgetsData(r.companyUID,i.filter.drillType,i.filter.timeKey,i.filter.timeCount,i.filter.wellState,e).promise,m.getCompanyWidgetsFinData(r.companyUID,i.filter.drillType,i.filter.timeKey,i.filter.timeCount,i.filter.wellState).promise]).then(function(t){a.resolve(t)},function(t){a.reject(t)}),a.promise.then(function(t){var r=t[0].data;i.data.physParams=_.pluck(r,"Parameter"),i.data.physParams=_.compact(i.data.physParams),i.data.physParams=_.unique(i.data.physParams),_.forEach(i.data.physParams,function(t){var e=_.find(r,{Parameter:t});if(e){var a={displayName:e.DisplayName,uom:e.Uom,value:e.TrendValue,delta:e.TrendDeltaValue,deltaPc:e.TrendDeltaPc,color:e.Color,roundTo:e.RoundTo};i.data.physWidgetsData[t]=a}});var n=t[1].data;i.data.finParams=_.pluck(n,"Parameter"),i.data.finParams=_.compact(i.data.finParams),i.data.finParams=_.map(i.data.finParams,function(t){return t.replace("Gs","").replace("Nns","")}),i.data.finParams=_.unique(i.data.finParams),_.forEach(i.data.finParams,function(t){var e=_.find(n,{Parameter:t});if(e){var a={displayName:e.DisplayName,uom:e.Uom,value:e.TrendValue,delta:e.TrendDeltaValue,deltaPc:e.TrendDeltaPc,color:e.Color,roundTo:e.RoundTo};i.data.finWidgetsData[t]=a}}),i.data.widgetsLoaded=!0,i.data.error=null},function(t){"cancel"!==t&&(i.data.widgetsLoaded=!0,i.data.error=t)})}}]),angular.module("smbApp").service("refData",["$q","$http","localStorageService","BaseDataService","config",function(r,n,a,t,i){var l=new t("refData");return l.getPrivateData().update=function(e){e.data||(e.updating=!0,n.get(i.getApiUrl()+"ref_data").success(function(t){e.data=t,e.dataDefer.resolve(e.data),e.dataDefer=r.defer(),e.dataDefer.resolve(e.data),e.saved&&(e.saved=a.set("refData",e.data)),e.updating=!1,_.forEach(e.updateDataCallbacks,function(t){t(e.data)})}).error(function(t){e.updating=!1}))},angular.extend({getAttributeFullName:function(t){var e=l.getPrivateData();if(e.data){var a=_.find(e.data.attribute,{name:t});return a?a.fullName:t}return t},getAttributeMUnit:function(t){var e=l.getPrivateData();if(e.data){var a=_.find(e.data.attribute,{name:t});return a?a.mUnit:t}return t},getDocTypes:function(t){var e=l.getPrivateData();return e.data&&_.filter(e.data.doc_type,{module:t})||[]},getActivityName:function(t){var e=l.getPrivateData();if(e.data){var a=_.find(e.data.activity,{id:t});return a?a.value:t}return t},getRefHorizons:function(){var t=i.getApiUrl()+"ref-geo-horizon",e=r.defer();return n.get(t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e},getRefHorizonsByLocality:function(t){var e=i.getApiUrl()+"ref-geo-horizon/"+t,a=r.defer();return n.get(e).then(function(t){a.resolve(t)},function(t){a.reject(t)}),a},getDrillTypeName:function(t){switch(t+""){case"0":return"ЭБ";case"1":return"ЗБС";case"2":return"ПРБ";default:return t}},getDrillTypeID:function(t){switch(t){case"7dc8a38c-c70e-4858-9ff6-9fc21f9f38fc":return"0";case"0705c922-76b9-4c97-813a-ec088d0dc1e9":return"1";case"eb017477-a2d5-4e88-9acf-506eb0c4c311":return"2";default:return t}},getDn7NnsFilters:function(){return[{id:null,name:"Все"},{id:"NaklonnoNapravlennye",name:"наклонно направленные"},{id:"NaklonnoNapravlennyeYura",name:"наклонно направленные Юра"},{id:"NaklonnoNapravlennyeBazhen",name:"наклонно направленные Бажен"},{id:"NaklonnoNapravlennyePaleozoj",name:"наклонно направленные Палеозой"},{id:"NaklonnoNapravlennyeCGrp",name:"наклонно направленные c ГРП"},{id:"NaklonnoNapravlennyeCGrpYura",name:"наклонно направленные c ГРП Юра"},{id:"NaklonnoNapravlennyeCGrpBazhen",name:"наклонно направленные c ГРП Бажен"},{id:"NaklonnoNapravlennyeCGrpPaleozoj",name:"наклонно направленные c ГРП Палеозой"},{id:"Vodozabornye",name:"водозаборные"}]},getDn7GsFilters:function(){return[{id:null,name:"Все"},{id:"GorizontalnyePilotnye",name:"горизонтальные пилотные"},{id:"GorizontalnyeBezpilotnye",name:"горизонтальные безпилотные"},{id:"GorizontalnyePilotnyeYura",name:"горизонтальные пилотные Юра"},{id:"GorizontalnyeBezpilotnyeYura",name:"горизонтальные безпилотные Юра"},{id:"GorizontalnyePilotnyeBazhen",name:"горизонтальные пилотные Бажен"},{id:"GorizontalnyeBezpilotnyeBazhen",name:"горизонтальные безпилотные Бажен"},{id:"GorizontalnyePilotnyePaleozoj",name:"горизонтальные пилотные Палеозой"},{id:"GorizontalnyeBezpilotnyePaleozoj",name:"горизонтальные безпилотные Палеозой"},{id:"MnogozabojnyePilotnye",name:"многозабойные пилотные"},{id:"MnogozabojnyeBezpilotnye",name:"многозабойные безпилотные"},{id:"MgrpPilotnaya",name:"МГРП пилотная"},{id:"MgrpBezpilotnaya",name:"МГРП безпилотная"},{id:"MgrpPilotnayaYura",name:"МГРП пилотная Юра"},{id:"MgrpBezpilotnayaYura",name:"МГРП безпилотная Юра"},{id:"MgrpPilotnayaBazhen",name:"МГРП пилотная Бажен"},{id:"MgrpBezpilotnayaBazhen",name:"МГРП безпилотная Бажен"},{id:"MgrpPilotnayaPaleozoj",name:"МГРП пилотная Палеозой"},{id:"MgrpBezpilotnayaPaleozoj",name:"МГРП безпилотная Палеозой"}]}},l)}]),angular.module("smbApp").service("fieldsAttributesData",["$http","$q","BaseClusterDataService","utils",function(t,e,a,w){var I=new a([2],"fieldsAttributesData"),N={};function Y(t){return _.flatten(arguments).join("+")}return I.addUpdateDataCallback(function(){N={}}),angular.extend({getParsedData:function(){var a=e.defer();return I.getData().then(function(t){var e=_.map(t,function(t){var e=_.clone(t);return e.json=JSON.parse(e.json),e});a.resolve(e)}),a.promise},getFieldNonProductivePcWidgetData:function(t,e,a,r){if(!_.isUndefined(N[Y("getFieldNonProductivePcWidgetData",arguments)]))return N[Y("getFieldNonProductivePcWidgetData",arguments)];var n=null,i=w.getRange(r),l=I.getRawData(),o=_.map(l,function(t){var e=JSON.parse(t.json);return e.year=t.year,e});t&&(o=_.filter(o,{objUID:t}));var s=i[2].months,c=i[1].months,u=w.aggregateChartDataSum(s,o,1,e,a,"nonProductiveDuration"),d=w.aggregateChartDataSum(s,o,1,e,a,"vmrDuration"),m=w.aggregateChartDataSum(s,o,1,e,a,"drillingDuration"),f=w.aggregateChartDataSum(s,o,1,e,a,"explorationDuration");if(_.isNumber(u.fact)&&_.isNumber(d.fact)&&_.isNumber(m.fact)&&_.isNumber(f.fact)){var p=100*u.fact/(d.fact+m.fact+f.fact),h=w.aggregateChartDataSum(c,o,1,e,a,"nonProductiveDuration"),g=w.aggregateChartDataSum(c,o,1,e,a,"vmrDuration"),v=w.aggregateChartDataSum(c,o,1,e,a,"drillingDuration"),D=w.aggregateChartDataSum(c,o,1,e,a,"explorationDuration"),y=null;_.isNumber(h.fact)&&_.isNumber(g.fact)&&_.isNumber(v.fact)&&_.isNumber(D.fact)&&(y=100*h.fact/(g.fact+v.fact+D.fact)),_.isNaN(p)||(n={total:p,difference:!_.isNull(y)&&p-y?p-y:null})}return N[Y("getFieldNonProductivePcWidgetData",arguments)]=n},getFieldIncidentPer1000mWidgetData:function(t,e,a,r){if(!_.isUndefined(N[Y("getFieldIncidentPer1000mWidgetData",arguments)]))return N[Y("getFieldIncidentPer1000mWidgetData",arguments)];var n=null,i=w.getRange(r),l=I.getRawData(),o=_.map(l,function(t){var e=JSON.parse(t.json);return e.year=t.year,e});t&&(o=_.filter(o,{objUID:t}));var s=i[2].months,c=i[1].months,u=w.aggregateChartDataSum(s,o,1,e,a,"incidentCount"),d=w.aggregateChartDataSum(s,o,1,e,a,"penetration");if(_.isNumber(u.fact)&&_.isNumber(d.fact)){var m=u.fact/(d.fact/1e3),f=w.aggregateChartDataSum(c,o,1,e,a,"incidentCount"),p=w.aggregateChartDataSum(c,o,1,e,a,"penetration"),h=null;_.isNumber(f.fact)&&_.isNumber(p.fact)&&(h=f.fact/(p.fact/1e3)),_.isNaN(m)||(n={total:m,difference:!_.isNull(h)&&m-h?m-h:null})}return N[Y("getFieldIncidentPer1000mWidgetData",arguments)]=n},getDrillingRateWidgetData:function(t,e,a,r){if(!_.isUndefined(N[Y("getDrillingRateWidgetData",arguments)]))return N[Y("getDrillingRateWidgetData",arguments)];var n=null,i=w.getRange(r),l=I.getRawData(),o=_.map(l,function(t){var e=JSON.parse(t.json);return e.year=t.year,e});t&&(o=_.filter(o,{objUID:t}));var s=i[2].months,c=i[1].months,u=w.aggregateChartDataSum(s,o,1,e,a,"drillingDuration"),d=w.aggregateChartDataSum(s,o,1,e,a,"penetration");if(_.isNumber(u.fact)&&_.isNumber(d.fact)){var m=d.fact/u.fact,f=w.aggregateChartDataSum(c,o,1,e,a,"drillingDuration"),p=w.aggregateChartDataSum(c,o,1,e,a,"penetration"),h=null;_.isNumber(f.fact)&&_.isNumber(p.fact)&&(h=p.fact/f.fact),_.isNaN(m)||(n={total:m,difference:!_.isNull(h)&&m-h?m-h:null})}return N[Y("getDrillingRateWidgetData",arguments)]=n},getFieldWidgetData:function(t,e,a,r,n,i){if(!_.isUndefined(N[Y("getFieldWidgetData",arguments)]))return N[Y("getFieldWidgetData",arguments)];var l=null,o=w.getRange(r),s=I.getRawData(),c=_.map(s,function(t){var e=JSON.parse(t.json);return e.year=t.year,e});t&&(c=_.filter(c,{objUID:t}));var u=o[2].months,d=o[1].months,m=i(u,c,1,e,a,n),f=i(d,c,1,e,a,n);return _.isNumber(m.fact)&&(l={total:m.fact,difference:_.isNull(m.fact)||_.isNull(f.fact)?null:m.fact-f.fact}),N[Y("getFieldWidgetData",arguments)]=l},getClusterNonProductivePcWidgetData:function(t,e,a,r,n){if(!_.isUndefined(N[Y("getClusterNonProductivePcWidgetData",arguments)]))return N[Y("getClusterNonProductivePcWidgetData",arguments)];var i=null,l=w.getRange(n),o=I.getRawData(),s=_.map(o,function(t){var e=JSON.parse(t.json);return e.year=t.year,e});t&&(s=_.filter(s,{objUID:t}));var c=[];_.forEach(s,function(e){c=c.concat(_.map(e.clusters,function(t){return t.year=e.year,t}))}),e&&(c=_.filter(c,{objUID:e}));var u=l[2].months,d=l[1].months,m=w.aggregateChartDataSum(u,c,1,a,r,"nonProductiveDuration"),f=w.aggregateChartDataSum(u,c,1,a,r,"vmrDuration"),p=w.aggregateChartDataSum(u,c,1,a,r,"drillingDuration"),h=w.aggregateChartDataSum(u,c,1,a,r,"explorationDuration");if(_.isNumber(m.fact)&&_.isNumber(f.fact)&&_.isNumber(p.fact)&&_.isNumber(h.fact)){var g=100*m.fact/(f.fact+p.fact+h.fact),v=w.aggregateChartDataSum(d,c,1,a,r,"nonProductiveDuration"),D=w.aggregateChartDataSum(d,c,1,a,r,"vmrDuration"),y=w.aggregateChartDataSum(d,c,1,a,r,"drillingDuration"),b=w.aggregateChartDataSum(d,c,1,a,r,"explorationDuration"),C=null;_.isNumber(v.fact)&&_.isNumber(D.fact)&&_.isNumber(y.fact)&&_.isNumber(b.fact)&&(C=100*v.fact/(D.fact+y.fact+b.fact)),_.isNaN(g)||(i={total:g,difference:!_.isNull(C)&&g-C?g-C:null})}return N[Y("getClusterNonProductivePcWidgetData",arguments)]=i},getClusterIncidentPer1000mWidgetData:function(t,e,a,r,n){if(!_.isUndefined(N[Y("getClusterIncidentPer1000mWidgetData",arguments)]))return N[Y("getClusterIncidentPer1000mWidgetData",arguments)];var i=null,l=w.getRange(n),o=I.getRawData(),s=_.map(o,function(t){var e=JSON.parse(t.json);return e.year=t.year,e});t&&(s=_.filter(s,{objUID:t}));var c=[];_.forEach(s,function(e){c=c.concat(_.map(e.clusters,function(t){return t.year=e.year,t}))}),e&&(c=_.filter(c,{objUID:e}));var u=l[2].months,d=l[1].months,m=w.aggregateChartDataSum(u,c,1,a,r,"incidentCount"),f=w.aggregateChartDataSum(u,c,1,a,r,"penetration");if(_.isNumber(m.fact)&&_.isNumber(f.fact)){var p=m.fact/(f.fact/1e3),h=w.aggregateChartDataSum(d,c,1,a,r,"incidentCount"),g=w.aggregateChartDataSum(d,c,1,a,r,"penetration"),v=null;_.isNumber(h.fact)&&_.isNumber(g.fact)&&(v=h.fact/(g.fact/1e3)),_.isNaN(p)||(i={total:p,difference:!_.isNull(v)&&p-v?p-v:null})}return N[Y("getClusterIncidentPer1000mWidgetData",arguments)]=i},getClusterDrillingRateWidgetData:function(t,e,a,r,n){if(!_.isUndefined(N[Y("getClusterDrillingRateWidgetData",arguments)]))return N[Y("getClusterDrillingRateWidgetData",arguments)];var i=null,l=w.getRange(n),o=I.getRawData(),s=_.map(o,function(t){var e=JSON.parse(t.json);return e.year=t.year,e});t&&(s=_.filter(s,{objUID:t}));var c=[];_.forEach(s,function(e){c=c.concat(_.map(e.clusters,function(t){return t.year=e.year,t}))}),e&&(c=_.filter(c,{objUID:e}));var u=l[2].months,d=l[1].months,m=w.aggregateChartDataSum(u,c,1,a,r,"drillingDuration"),f=w.aggregateChartDataSum(u,c,1,a,r,"penetration");if(_.isNumber(m.fact)&&_.isNumber(f.fact)){var p=f.fact/m.fact,h=w.aggregateChartDataSum(d,c,1,a,r,"drillingDuration"),g=w.aggregateChartDataSum(d,c,1,a,r,"penetration"),v=null;_.isNumber(h.fact)&&_.isNumber(g.fact)&&(v=g.fact/h.fact),_.isNaN(p)||(i={total:p,difference:!_.isNull(v)&&p-v?p-v:null})}return N[Y("getClusterDrillingRateWidgetData",arguments)]=i},getClusterWidgetData:function(t,e,a,r,n,i,l){if(!_.isUndefined(N[Y("getClusterWidgetData",arguments)]))return N[Y("getClusterWidgetData",arguments)];var o=null,s=w.getRange(n),c=I.getRawData(),u=_.map(c,function(t){var e=JSON.parse(t.json);return e.year=t.year,e});t&&(u=_.filter(u,{objUID:t}));var d=[];_.forEach(u,function(e){d=d.concat(_.map(e.clusters,function(t){return t.year=e.year,t}))}),e&&(d=_.filter(d,{objUID:e}));var m=s[2].months,f=s[1].months,p=l(m,d,1,a,r,i),h=l(f,d,1,a,r,i);return _.isNumber(p.fact)&&(o={total:p.fact,difference:_.isNull(p.fact)||_.isNull(h.fact)?null:p.fact-h.fact}),N[Y("getClusterWidgetData",arguments)]=o},getWellNonProductivePcWidgetData:function(t,e,a){if(!_.isUndefined(N[Y("getWellNonProductivePcWidgetData",arguments)]))return N[Y("getWellNonProductivePcWidgetData",arguments)];var r=null,n=I.getRawData(),i=_.map(n,function(t){var e=JSON.parse(t.json);return e.year=t.year,e});t&&(i=_.filter(i,{objUID:t}));var l=[];_.forEach(i,function(e){l=l.concat(_.map(e.clusters,function(t){return t.year=e.year,t}))}),e&&(l=_.filter(l,{objUID:e}));var o=[];_.forEach(l,function(e){o=o.concat(_.map(e.wells,function(t){return t.year=e.year,t}))}),a&&(o=_.filter(o,{objUID:a}));var s=w.aggregateChartDataSum(null,o,1,null,null,"nonProductiveDuration"),c=w.aggregateChartDataSum(null,o,1,null,null,"vmrDuration"),u=w.aggregateChartDataSum(null,o,1,null,null,"drillingDuration"),d=w.aggregateChartDataSum(null,o,1,null,null,"explorationDuration");if(_.isNumber(s.fact)&&_.isNumber(c.fact)&&_.isNumber(u.fact)&&_.isNumber(d.fact)){var m=100*s.fact/(c.fact+u.fact+d.fact);_.isNaN(m)||(r={total:m,difference:null})}return N[Y("getWellNonProductivePcWidgetData",arguments)]=r},getWellIncidentPer1000mWidgetData:function(t,e,a){if(!_.isUndefined(N[Y("getWellIncidentPer1000mWidgetData",arguments)]))return N[Y("getWellIncidentPer1000mWidgetData",arguments)];var r=null,n=I.getRawData(),i=_.map(n,function(t){var e=JSON.parse(t.json);return e.year=t.year,e});t&&(i=_.filter(i,{objUID:t}));var l=[];_.forEach(i,function(e){l=l.concat(_.map(e.clusters,function(t){return t.year=e.year,t}))}),e&&(l=_.filter(l,{objUID:e}));var o=[];_.forEach(l,function(e){o=o.concat(_.map(e.wells,function(t){return t.year=e.year,t}))}),a&&(o=_.filter(o,{objUID:a}));var s=w.aggregateChartDataSum(null,o,1,null,null,"incidentCount"),c=w.aggregateChartDataSum(null,o,1,null,null,"penetration");if(_.isNumber(s.fact)&&_.isNumber(c.fact)){var u=s.fact/(c.fact/1e3);_.isNaN(u)||(r={total:u,difference:null})}return N[Y("getWellIncidentPer1000mWidgetData",arguments)]=r},getWellDrillingRateWidgetData:function(t,e,a){if(!_.isUndefined(N[Y("getWellDrillingRateWidgetData",arguments)]))return N[Y("getWellDrillingRateWidgetData",arguments)];var r=null,n=I.getRawData(),i=_.map(n,function(t){var e=JSON.parse(t.json);return e.year=t.year,e});t&&(i=_.filter(i,{objUID:t}));var l=[];_.forEach(i,function(e){l=l.concat(_.map(e.clusters,function(t){return t.year=e.year,t}))}),e&&(l=_.filter(l,{objUID:e}));var o=[];_.forEach(l,function(e){o=o.concat(_.map(e.wells,function(t){return t.year=e.year,t}))}),a&&(o=_.filter(o,{objUID:a}));var s=w.aggregateChartDataSum(null,o,1,null,null,"drillingDuration"),c=w.aggregateChartDataSum(null,o,1,null,null,"penetration");if(_.isNumber(s.fact)&&_.isNumber(c.fact)){var u=c.fact/s.fact;_.isNaN(u)||(r={total:u,difference:null})}return N[Y("getWellDrillingRateWidgetData",arguments)]=r},getWellWidgetData:function(t,e,a,r,n){if(!_.isUndefined(N[Y("getWellWidgetData",arguments)]))return N[Y("getWellWidgetData",arguments)];var i=null,l=I.getRawData(),o=_.map(l,function(t){var e=JSON.parse(t.json);return e.year=t.year,e});t&&(o=_.filter(o,{objUID:t}));var s=[];_.forEach(o,function(e){s=s.concat(_.map(e.clusters,function(t){return t.year=e.year,t}))}),e&&(s=_.filter(s,{objUID:e}));var c=[];_.forEach(s,function(e){c=c.concat(_.map(e.wells,function(t){return t.year=e.year,t}))}),a&&(c=_.filter(c,{objUID:a}));var u=n(null,c,1,null,null,r);return _.isNumber(u.fact)&&(i={total:u.fact,difference:null}),N[Y("getWellWidgetData",arguments)]=i},getFieldsChartData:function(t,r,n,e,i,l,o){if(!_.isUndefined(N[Y("getFieldsChartData",arguments)]))return N[Y("getFieldsChartData",arguments)];var a,s=w.getRange(e),c=I.getRawData(),u=_.map(c,function(t){var e=JSON.parse(t.json);return e.year=t.year,e}),d=_.flatten(_.pluck(s,"months"));return a=_.map(t,function(t){var e=_.filter(u,{objUID:t.UID}),a=o(d,e,1,r,n,i);return l?_.isNull(a.planNNS)&&_.isNull(a.factNNS)&&_.isNull(a.planGS)&&_.isNull(a.factGS)?null:{points:[{labels:["ННС - план","ННС - факт"],values:[a.planNNS,a.factNNS]},{labels:["ГС - план","ГС - факт"],values:[a.planGS,a.factGS]}],title:t.name}:_.isNull(a.plan)&&_.isNull(a.fact)?null:{points:[{labels:["План","Факт"],values:[a.plan,a.fact]}],title:t.name}}),a=_.compact(a),a=_.sortBy(a,function(t){return t.points[1]?-t.points[1].values[1]:-t.points[0].values[1]}),N[Y("getFieldsChartData",arguments)]=a},getClustersChartData:function(t,e,r,n,a,i,l,o){if(!_.isUndefined(N[Y("getClustersChartData",arguments)]))return N[Y("getClustersChartData",arguments)];var s,c=w.getRange(a),u=I.getRawData(),d=_.map(u,function(t){var e=JSON.parse(t.json);return e.year=t.year,e});t&&(d=_.filter(d,{objUID:t}));var m=[];_.forEach(d,function(e){m=m.concat(_.map(e.clusters,function(t){return t.year=e.year,t}))});var f=_.flatten(_.pluck(c,"months"));return s=_.map(e,function(t){var e=_.filter(m,{objUID:t.UID}),a=o(f,e,1,r,n,i);return l?_.isNull(a.planNNS)&&_.isNull(a.factNNS)&&_.isNull(a.planGS)&&_.isNull(a.factGS)?null:{points:[{labels:["ННС - план","ННС - факт"],values:[a.planNNS,a.factNNS]},{labels:["ГС - план","ГС - факт"],values:[a.planGS,a.factGS]}],title:t.name}:_.isNull(a.plan)&&_.isNull(a.fact)?null:{points:[{labels:["План","Факт"],values:[a.plan,a.fact]}],title:t.name}}),s=_.compact(s),s=_.sortBy(s,function(t){return t.points[1]?-t.points[1].values[1]:-t.points[0].values[1]}),N[Y("getClustersChartData",arguments)]=s},getWellsChartData:function(t,e,a,r,n,i){if(!_.isUndefined(N[Y("getClustersChartData",arguments)]))return N[Y("getClustersChartData",arguments)];var l,o=w.getRange(r),s=I.getRawData(),c=_.map(s,function(t){var e=JSON.parse(t.json);return e.year=t.year,e});t&&(c=_.filter(c,{objUID:t}));var u=[];_.forEach(c,function(e){u=u.concat(_.map(e.clusters,function(t){return t.year=e.year,t}))}),e&&(u=_.filter(u,{objUID:e}));var d=[];_.forEach(u,function(e){d=d.concat(_.map(e.wells,function(t){return t.year=e.year,t}))}),console.log(d);var m=_.flatten(_.pluck(o,"months"));return l=_.map(a,function(t){var e=_.filter(d,{objUID:t.UID}),a=i(m,e,1,null,null,n);return _.isNull(a.plan)&&_.isNull(a.fact)?null:{points:[{labels:["План","Факт"],values:[a.plan,a.fact]}],title:t.name}}),l=_.compact(l),l=_.sortBy(l,function(t){return t.points[1]?-t.points[1].values[1]:-t.points[0].values[1]}),N[Y("getWellsChartData",arguments)]=l}},I)}]),angular.module("smbApp").controller("CompaniesChartCtrl",["$scope","$location","$q","$timeout","$routeParams","chartSeriesColors","appSettings","companiesData","utils","apiData","physChartsData","xlsx","saveFile","config",function(h,t,a,e,r,n,i,l,g,o,s,c,u,d){if(h.authData&&h.authData.CanViewPhysData){var m;h.$on("$destroy",function(){p()}),h.filter={wellState:1,timeKey:"month",timeCount:0,drillType:0,showDynamic:!1,reverseMarkers:-1!==["npv","drillingBrigades","explorationBrigades"].indexOf(r.attributeName),lineId:null,showTable:!1,showValues:!0,showAverageLines:[!0,!1,!0,!1],hideAllAverageLines:!1,showMarkers:[[!1,!0],[!1,!0]],showMarkersYear:[[!0,!0],[!0,!0]],tiltXAxisTextContractors:!0,tiltXAxisTextNnsContractors:!0,tiltXAxisTextGsContractors:!0,attributeName:r.attributeName},h.data={params:[],splitCharts:!1,lines:[],contractors:[],error:null,loaded:!1,chartsLoaded:!1,physCharts:[],physChart:null},(m=i.getSettings("app"))&&angular.extend(h.filter,m),h.$watch("filter",function(){p()},!0),a.all([l.getData(),s.getData()]).then(function(t){e(function(){h.data.physCharts=t[1],h.data.physChart=_.find(h.data.physCharts,{Id:h.filter.attributeName}),h.data.splitCharts=h.data.physChart&&h.data.physChart.Parameters&&1<h.data.physChart.Parameters.length,h.data.loaded=!0,v()},400)}),h.$watch("filter.wellState",function(t,e){t!==e&&v()}),h.$watch("filter.timeKey",function(t,e){t!==e&&v()}),h.$watch("filter.drillType",function(t,e){t!==e&&v()}),h.$watch("filter.timeCount",function(t,e){t!==e&&v()}),h.$watch("filter.attributeName",function(t,e){t!==e&&(window.location.href="#/companiesChart/"+t)});var f=null;h.$watch("filter.lineId",D),h.getAttributeFullName=function(t){var e=_.find(h.data.physCharts,{Id:t});return e&&e.Name||t},h.getAttributeNameWithUom=function(t){var e=_.find(h.data.physCharts,{Id:t});return e&&e.Name+", "+e.Uom||t},h.planFactChatsColors=n.planFactChatsColors,h.factChatsColor=n.factChatsColor,h.onlyFactChatsColor=[h.factChatsColor[1]],h.getExcel=function(){var t,e,a=["eb","zbs","prb"],r=["undefined","drilling","drilled","builded","active"],n=null;if(h.filter.showDynamic){switch(h.filter.timeKey){case"month":n="Month",t=moment().startOf("month").subtract(10-h.filter.timeCount,"months"),(e=moment().startOf("month").subtract(-1-h.filter.timeCount-10,"months").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("month").format("YYYY-MM-DD")&&(e=moment().endOf("month")),t.format("YYYY-MM-DD")<"2013-01-01"&&(t=moment("2013-01-01"));break;case"quarter":n="Quarter",t=moment().startOf("quarter").subtract(10-h.filter.timeCount,"quarters"),(e=moment().startOf("quarter").subtract(-1-h.filter.timeCount-10,"quarters").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("quarter").format("YYYY-MM-DD")&&(e=moment().endOf("quarter")),t.format("YYYY-MM-DD")<"2013-01-01"&&(t=moment("2013-01-01"));break;case"year":n="Year",t=moment().startOf("year").subtract(10-h.filter.timeCount,"years"),(e=moment().startOf("year").subtract(-1-h.filter.timeCount-10,"years").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("year").format("YYYY-MM-DD")&&(e=moment().endOf("year")),t.format("YYYY-MM-DD")<"2013-01-01"&&(t=moment("2013-01-01"))}if(t=t.format("YYYY-MM-DD"),e=e.format("YYYY-MM-DD"),2===h.filter.wellState)var i=d.getApiUrl()+"physreport/1/"+a[h.filter.drillType]+"/"+r[h.filter.wellState]+"/2006-06-12/2100-01-01?targetObject=Gpn&periodBy="+n+(h.data.splitCharts?"&parameter="+h.filter.attributeName+"Gs&parameter="+h.filter.attributeName+"Nns":"&parameter="+h.filter.attributeName);else i=d.getApiUrl()+"physreport/1/"+a[h.filter.drillType]+"/"+r[h.filter.wellState]+"/"+t+"/"+e+"?targetObject=Gpn&periodBy="+n+(h.data.splitCharts?"&parameter="+h.filter.attributeName+"Gs&parameter="+h.filter.attributeName+"Nns":"&parameter="+h.filter.attributeName)}else{switch(h.filter.timeKey){case"month":n="Month",t=moment().startOf("month").subtract(-h.filter.timeCount,"months"),e=moment().startOf("month").subtract(-1-h.filter.timeCount,"months").subtract(1,"day");break;case"quarter":n="Quarter",t=moment().startOf("quarter").subtract(-h.filter.timeCount,"quarters"),e=moment().startOf("quarter").subtract(-1-h.filter.timeCount,"quarters").subtract(1,"day");break;case"year":n="Year",t=moment().startOf("year").subtract(-h.filter.timeCount,"years"),e=moment().startOf("year").subtract(-1-h.filter.timeCount,"years").subtract(1,"day")}if(t=t.format("YYYY-MM-DD"),e=e.format("YYYY-MM-DD"),2===h.filter.wellState)i=d.getApiUrl()+"physreport/1/"+a[h.filter.drillType]+"/"+r[h.filter.wellState]+"/2006-06-12/2100-01-01?branchId=00000000-0000-0000-0000-000000000000&targetObject=branch&periodBy=None"+(h.data.splitCharts?"&parameter="+h.filter.attributeName+"Gs&parameter="+h.filter.attributeName+"Nns":"&parameter="+h.filter.attributeName);else i=d.getApiUrl()+"physreport/1/"+a[h.filter.drillType]+"/"+r[h.filter.wellState]+"/"+t+"/"+e+"?branchId=00000000-0000-0000-0000-000000000000&targetObject=branch&periodBy=None"+(h.data.splitCharts?"&parameter="+h.filter.attributeName+"Gs&parameter="+h.filter.attributeName+"Nns":"&parameter="+h.filter.attributeName)}window.open(i,"_blank").focus()}}else t.path("/main");function p(){var t={wellState:h.filter.wellState,timeKey:h.filter.timeKey,drillType:h.filter.drillType,showValues:h.filter.showValues,timeCount:h.filter.timeCount,showDynamic:h.filter.showDynamic};i.setSettings("app",t)}function v(){h.data.chartsLoaded=!1,h.data.error=null,h.data.chartsData={},f&&f.reject("cancel"),console.log(h.data.physCharts),_.find(h.data.physChart&&h.data.physChart.TrendWellStates,function(t){return t===h.filter.wellState})?h.filter.hideAllAverageLines=!1:h.filter.hideAllAverageLines=!0;var t=_.filter(h.data.physCharts,function(t){return-1!==t.DrillTypes.indexOf(h.filter.drillType)});t=_.filter(t,function(t){return-1!==t.WellStates.indexOf(h.filter.wellState)});h.data.params=_.pluck(t,"Id"),-1==h.data.params.indexOf(h.filter.attributeName)&&(h.filter.attributeName=h.data.params[0]);var e=f=a.defer();a.all([o.getCompaniesData(h.filter.drillType,h.filter.timeKey,h.filter.timeCount,h.filter.wellState,h.filter.attributeName,h.data.splitCharts).promise,o.getCompaniesDynamicData(h.filter.drillType,h.filter.timeKey,h.filter.timeCount,h.filter.wellState,h.filter.attributeName,h.data.splitCharts).promise]).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise.then(function(t){if(h.data.splitCharts){var e=t[0].data,a=_.find(e,{Parameter:h.filter.attributeName+"Nns"}),r=_.find(e,{Parameter:h.filter.attributeName+"Gs"}),n=_.find(e,{Parameter:h.filter.attributeName}),i=a&&a.Objects,l=r&&r.Objects,o=n&&n.Objects,s=_.union(_.pluck(i,"ObjId"),_.pluck(l,"ObjId"));if(s&&s.length){var c={uom:h.data.physChart&&h.data.physChart.Uom,displayName:h.data.physChart&&h.data.physChart.Name,yAxisTitle:" ",subXAxisTitles:["ННС","ГС"],values:[],averageLines:[],format:n&&n.Format};_.forEach(s,function(t){var e=_.find(i,{ObjId:t}),a=_.find(l,{ObjId:t});c.values.push({uid:t,title:e&&e.DisplayName||a&&a.DisplayName,points:"year"===h.filter.timeKey?[{values:e?[{val:e.Value,color:e.Color}]:[null]},{values:a?[{val:a.Value,color:a.Color}]:[null]}]:[{values:e?[{val:e.PrevValue,color:e.PrevColor},{val:e.Value,color:e.Color}]:[null,null]},{values:a?[{val:a.PrevValue,color:a.PrevColor},{val:a.Value,color:a.Color}]:[null,null]}],link:"/fieldsChart/"+h.filter.attributeName+"/"+t.toUpperCase()})}),a&&(c.averageLines.push({value:a.TrendValue}),c.averageLines.push({value:a.PrevTrendValue})),r&&(c.averageLines.push({value:r.TrendValue}),c.averageLines.push({value:r.PrevTrendValue})),h.data.chartsData.companies=g.sortChart(c,"drillingRate"===h.filter.attributeName);var u=_.pluck(c.values,"uid");h.data.chartsData.companiesObjects={nns:g.sortObjectChart(i,u),gs:g.sortObjectChart(l,u),all:g.sortObjectChart(o,u)}}var d=_.find(e,{Parameter:h.filter.attributeName+"Nns"});if(d&&(d=d.Contractors),d&&d.length){c={uom:h.data.physChart&&h.data.physChart.Uom,displayName:h.data.physChart&&h.data.physChart.Name,yAxisTitle:" ",values:[],format:n&&n.Format};_.forEach(d,function(t){c.values.push({lineName:t.LineName,title:t.DisplayName?t.DisplayName:"Н/Д",points:[{values:[{val:t.Value}]}],link:function(){"nonProductivePc"===h.filter.attributeName?window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card"+(h.filter.lineId?"?lineId="+h.filter.lineId:""):window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card?lineId=a7588dfd-1e2e-4cb9-a60d-3a5b875bd216"}})}),h.data.chartsData.nnsContractorsSrc=g.sortChart(c),h.data.chartsData.nnsContractors=_.cloneDeep(h.data.chartsData.nnsContractorsSrc)}var m=_.find(e,{Parameter:h.filter.attributeName+"Gs"});if((m=m&&m.Contractors)&&m.length){c={uom:h.data.physChart&&h.data.physChart.Uom,displayName:h.data.physChart&&h.data.physChart.Name,yAxisTitle:" ",values:[],format:n&&n.Format};_.forEach(m,function(t){c.values.push({lineName:t.LineName,title:t.DisplayName?t.DisplayName:"Н/Д",points:[{values:[{val:t.Value}]}],link:function(){"nonProductivePc"===h.filter.attributeName?window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card"+(h.filter.lineId?"?lineId="+h.filter.lineId:""):window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card?lineId=a7588dfd-1e2e-4cb9-a60d-3a5b875bd216"}})}),h.data.chartsData.gsContractorsSrc=g.sortChart(c),h.data.chartsData.gsContractors=_.cloneDeep(h.data.chartsData.gsContractorsSrc)}e=t[1].data;a=_.find(e,{Parameter:h.filter.attributeName+"Nns"}),r=_.find(e,{Parameter:h.filter.attributeName+"Gs"}),n=_.find(e,{Parameter:h.filter.attributeName}),i=a&&a.Objects,l=r&&r.Objects,o=n&&n.Objects,c={uom:h.data.physChart&&h.data.physChart.Uom,displayName:h.data.physChart&&h.data.physChart.Name,yAxisTitle:" ",subXAxisTitles:["ННС","ГС"],values:[],averageLines:[],format:n&&n.Format};var f=_.unique(_.union(i,l),function(t){return""+t.Year+t.Quarter+g.pad(t.Month,2)});f=g.sortTimeObject(f),_.forEach(f,function(t){var e=_.find(i,{Year:t.Year,Quarter:t.Quarter,Month:t.Month}),a=_.find(l,{Year:t.Year,Quarter:t.Quarter,Month:t.Month});c.values.push({title:g.getObjectTimeTitle(e||a),points:[{values:e?[{val:e.Value,color:e.Color}]:[null]},{values:a?[{val:a.Value,color:a.Color}]:[null]}]})}),a&&(c.averageLines.push({value:a.TrendValue}),c.averageLines.push({value:a.PrevTrendValue})),r&&(c.averageLines.push({value:r.TrendValue}),c.averageLines.push({value:r.PrevTrendValue})),h.data.chartsData.dynamic=c,h.data.chartsData.dynamicObjects={nns:g.sortTimeObject(i),gs:g.sortTimeObject(l),all:g.sortTimeObject(o)}}else{if((e=t[0].data[0]).Objects&&e.Objects.length){c={uom:h.data.physChart&&h.data.physChart.Uom,displayName:h.data.physChart&&h.data.physChart.Name,yAxisTitle:" ",values:[],averageLines:[],format:e&&e.Format};_.forEach(e.Objects,function(t){c.values.push({uid:t.ObjId,title:t.DisplayName,points:"year"===h.filter.timeKey?[{values:[{val:t.Value,color:t.Color}]}]:[{values:[{val:t.PrevValue,color:t.PrevColor},{val:t.Value,color:t.Color}]}],link:"/fieldsChart/"+h.filter.attributeName+"/"+t.ObjId.toUpperCase()})}),c.averageLines.push({value:e.TrendValue}),h.data.chartsData.companies=g.sortChart(c,"drillingRate"===h.filter.attributeName);u=_.pluck(c.values,"uid");h.data.chartsData.companiesObjects=g.sortObjectChart(e.Objects,u)}h.data.lines=[],h.data.contractors=e.Contractors,e.Contractors&&e.Contractors.length&&(_.forEach(e.Contractors,function(t){h.data.lines.push({id:t.LineId,name:t.LineName,format:e&&e.Format})}),h.data.lines=_.uniq(h.data.lines,"id")),h.data.lines.unshift({id:null,name:"Все",format:e&&e.Format}),D(),e=t[1].data;var p=(e=_.find(e,{Parameter:h.filter.attributeName})).Objects;c={uom:h.data.physChart&&h.data.physChart.Uom,displayName:h.data.physChart&&h.data.physChart.Name,yAxisTitle:" ",values:[],averageLines:[],format:e&&e.Format};p=g.sortTimeObject(p),_.forEach(p,function(t){c.values.push({title:g.getObjectTimeTitle(t),points:[{values:[{val:t.Value,color:t.Color}]}]})}),c.averageLines.push({value:e.TrendValue}),h.data.chartsData.dynamic=c,h.data.chartsData.dynamicObjects=g.sortTimeObject(p)}h.data.chartsLoaded=!0,h.data.error=null},function(t){"cancel"!==t&&(h.data.chartsLoaded=!0,h.data.error=t)})}function D(){var t=_.find(h.data.lines,{id:h.filter.lineId}),e=h.data.contractors;h.data.chartsData=h.data.chartsData||{},h.filter.lineId&&(e=_.filter(e,{LineId:h.filter.lineId}));var a={uom:h.data.physChart&&h.data.physChart.Uom,displayName:h.data.physChart&&h.data.physChart.Name,yAxisTitle:" ",values:[],format:t&&t.format};_.forEach(e,function(t){a.values.push({lineName:t.LineName,title:t.DisplayName?t.DisplayName:"Н/Д",points:[{values:[{val:t.Value}]}],link:function(){"nonProductivePc"===h.filter.attributeName?window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card"+(h.filter.lineId?"?lineId="+h.filter.lineId:""):window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card?lineId=a7588dfd-1e2e-4cb9-a60d-3a5b875bd216"}})}),h.data.chartsData.contractorsSrc=g.sortChart(a),h.data.chartsData.contractors=_.cloneDeep(h.data.chartsData.contractorsSrc)}}]),angular.module("smbApp").controller("FieldsChartCtrl",["$scope","$location","$q","$timeout","$routeParams","physChartsData","chartSeriesColors","appSettings","companiesData","fieldsAttributesData","utils","apiData","xlsx","saveFile","authData","config",function(h,e,a,r,n,t,i,l,o,s,g,c,u,d,m,f){if(h.authData&&h.authData.CanViewPhysData){var p;h.$on("$destroy",function(){D()}),h.filter={wellState:1,timeKey:"month",timeCount:0,drillType:0,showDynamic:!1,reverseMarkers:-1!==["npv","drillingBrigades","explorationBrigades"].indexOf(n.attributeName),lineId:null,showTable:!1,showValues:!0,showAverageLines:[!0,!1,!0,!1],hideAllAverageLines:!1,showMarkers:[[!1,!0],[!1,!0]],showMarkersYear:[[!0,!0],[!0,!0]],tiltXAxisTextNnsContractors:!0,tiltXAxisTextContractors:!0,tiltXAxisTextGsContractors:!0,attributeName:n.attributeName},h.data={params:[],splitCharts:!1,lines:[],contractors:[],error:null,loaded:!1,chartsLoaded:!1,companyUID:n.companyUID,company:null,companies:[],physCharts:[],physChart:null},(p=l.getSettings("app"))&&angular.extend(h.filter,p),h.$watch("filter",function(){D()},!0),a.all([o.getData(),t.getData()]).then(function(t){r(function(){h.data.companies=o.getCompaniesNames(),h.data.company=_.find(h.data.companies,{UID:n.companyUID}),h.data.physCharts=t[1],h.data.physChart=_.find(h.data.physCharts,{Id:h.filter.attributeName}),h.data.splitCharts=h.data.physChart&&h.data.physChart.Parameters&&1<h.data.physChart.Parameters.length,h.data.loaded=!0,y()},400)}),h.$watch("filter.wellState",function(t,e){t!==e&&y()}),h.$watch("filter.timeKey",function(t,e){t!==e&&y()}),h.$watch("filter.timeCount",function(t,e){t!==e&&y()}),h.$watch("filter.drillType",function(t,e){t!==e&&y()}),h.$watch("filter.attributeName",function(t,e){t!==e&&(window.location.href="#/fieldsChart/"+t+"/"+h.data.companyUID)});var v=null;h.$watch("filter.lineId",b),h.getAttributeFullName=function(t){var e=_.find(h.data.physCharts,{Id:t});return e&&e.Name||t},h.getAttributeNameWithUom=function(t){var e=_.find(h.data.physCharts,{Id:t});return e&&e.Name+", "+e.Uom||t},h.planFactChatsColors=i.planFactChatsColors,h.factChatsColor=i.factChatsColor,h.onlyFactChatsColor=[h.factChatsColor[1]],h.selectCompany=function(t){e.path("/fieldsChart/"+h.filter.attributeName+"/"+t.UID)},h.singleCompany=m.singleCompany,h.getExcel=function(){var t,e,a=["eb","zbs","prb"],r=["undefined","drilling","drilled","builded","active"],n=null;if(h.filter.showDynamic){switch(h.filter.timeKey){case"month":n="Month",t=moment().startOf("month").subtract(10-h.filter.timeCount,"months"),(e=moment().startOf("month").subtract(-1-h.filter.timeCount-10,"months").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("month").format("YYYY-MM-DD")&&(e=moment().endOf("month")),t.format("YYYY-MM-DD")<"2013-01-01"&&(t=moment("2013-01-01"));break;case"quarter":n="Quarter",t=moment().startOf("quarter").subtract(10-h.filter.timeCount,"quarters"),(e=moment().startOf("quarter").subtract(-1-h.filter.timeCount-10,"quarters").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("quarter").format("YYYY-MM-DD")&&(e=moment().endOf("quarter")),t.format("YYYY-MM-DD")<"2013-01-01"&&(t=moment("2013-01-01"));break;case"year":n="Year",t=moment().startOf("year").subtract(10-h.filter.timeCount,"years"),(e=moment().startOf("year").subtract(-1-h.filter.timeCount-10,"years").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("year").format("YYYY-MM-DD")&&(e=moment().endOf("year")),t.format("YYYY-MM-DD")<"2013-01-01"&&(t=moment("2013-01-01"))}if(t=t.format("YYYY-MM-DD"),e=e.format("YYYY-MM-DD"),4===h.filter.wellState)var i="/crsreport/api/physreport/2/"+a[h.filter.drillType]+"/"+r[h.filter.wellState]+"/2006-06-12/2100-01-01?targetObject=branch&branchId="+h.data.companyUID+"&periodBy="+n+(h.data.splitCharts?"&parameter="+h.filter.attributeName+"Gs&parameter="+h.filter.attributeName+"Nns":"&parameter="+h.filter.attributeName);else i="/crsreport/api/physreport/2/"+a[h.filter.drillType]+"/"+r[h.filter.wellState]+"/"+t+"/"+e+"?targetObject=branch&branchId="+h.data.companyUID+"&periodBy="+n+(h.data.splitCharts?"&parameter="+h.filter.attributeName+"Gs&parameter="+h.filter.attributeName+"Nns":"&parameter="+h.filter.attributeName)}else{switch(h.filter.timeKey){case"month":n="Month",t=moment().startOf("month").subtract(-h.filter.timeCount,"months"),e=moment().startOf("month").subtract(-1-h.filter.timeCount,"months").subtract(1,"day");break;case"quarter":n="Quarter",t=moment().startOf("quarter").subtract(-h.filter.timeCount,"quarters"),e=moment().startOf("quarter").subtract(-1-h.filter.timeCount,"quarters").subtract(1,"day");break;case"year":n="Year",t=moment().startOf("year").subtract(-h.filter.timeCount,"years"),e=moment().startOf("year").subtract(-1-h.filter.timeCount,"years").subtract(1,"day")}if(t=t.format("YYYY-MM-DD"),e=e.format("YYYY-MM-DD"),4===h.filter.wellState)i=f.getApiUrl()+"physreport/2/"+a[h.filter.drillType]+"/"+r[h.filter.wellState]+"/2006-06-12/2100-01-01?targetObject=Locality&branchId="+h.data.companyUID+"&periodBy=None"+(h.data.splitCharts?"&parameter="+h.filter.attributeName+"Gs&parameter="+h.filter.attributeName+"Nns":"&parameter="+h.filter.attributeName);else i=f.getApiUrl()+"physreport/2/"+a[h.filter.drillType]+"/"+r[h.filter.wellState]+"/"+t+"/"+e+"?targetObject=Locality&branchId="+h.data.companyUID+"&periodBy=None"+(h.data.splitCharts?"&parameter="+h.filter.attributeName+"Gs&parameter="+h.filter.attributeName+"Nns":"&parameter="+h.filter.attributeName)}window.open(i,"_blank").focus()}}else h.bErrorCanView=!0;function D(){var t={wellState:h.filter.wellState,timeKey:h.filter.timeKey,drillType:h.filter.drillType,showValues:h.filter.showValues,timeCount:h.filter.timeCount,showDynamic:h.filter.showDynamic};l.setSettings("app",t)}function y(){h.data.chartsLoaded=!1,h.data.error=null,h.data.chartsData={},v&&v.reject("cancel"),_.find(h.data.physChart&&h.data.physChart.TrendWellStates,function(t){return t===h.filter.wellState})?h.filter.hideAllAverageLines=!1:h.filter.hideAllAverageLines=!0;var t=_.filter(h.data.physCharts,function(t){return-1!==t.DrillTypes.indexOf(h.filter.drillType)});t=_.filter(t,function(t){return-1!==t.WellStates.indexOf(h.filter.wellState)});h.data.params=_.pluck(t,"Id"),-1==h.data.params.indexOf(h.filter.attributeName)&&(h.filter.attributeName=h.data.params[0]);var e=v=a.defer();a.all([c.getFieldsData(h.data.companyUID,h.filter.drillType,h.filter.timeKey,h.filter.timeCount,h.filter.wellState,h.filter.attributeName,h.data.splitCharts).promise,c.getFieldsDynamicData(h.data.companyUID,h.filter.drillType,h.filter.timeKey,h.filter.timeCount,h.filter.wellState,h.filter.attributeName,h.data.splitCharts).promise]).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise.then(function(t){if(h.data.splitCharts){var e=t[0].data,a=_.find(e,{Parameter:h.filter.attributeName+"Nns"}),r=_.find(e,{Parameter:h.filter.attributeName+"Gs"}),n=_.find(e,{Parameter:h.filter.attributeName}),i=a&&a.Objects,l=r&&r.Objects,o=n&&n.Objects,s=_.union(_.pluck(i,"ObjId"),_.pluck(l,"ObjId"));if(s&&s.length){var c={uom:h.data.physChart&&h.data.physChart.Uom,displayName:h.data.physChart&&h.data.physChart.Name,yAxisTitle:" ",subXAxisTitles:["ННС","ГС"],values:[],averageLines:[],format:n&&n.Format};_.forEach(s,function(t){var e=_.find(i,{ObjId:t}),a=_.find(l,{ObjId:t});c.values.push({uid:t,title:e&&e.DisplayName||a&&a.DisplayName,points:"year"===h.filter.timeKey?[{values:e?[{val:e.Value,color:e.Color}]:[null]},{values:a?[{val:a.Value,color:a.Color}]:[null]}]:[{values:e?[{val:e.PrevValue,color:e.PrevColor},{val:e.Value,color:e.Color}]:[null,null]},{values:a?[{val:a.PrevValue,color:a.PrevColor},{val:a.Value,color:a.Color}]:[null,null]}],link:"/fieldChart/"+h.filter.attributeName+"/"+h.data.companyUID+"/"+t.toUpperCase()})}),a&&(c.averageLines.push({value:a.TrendValue}),c.averageLines.push({value:a.PrevTrendValue})),r&&(c.averageLines.push({value:r.TrendValue}),c.averageLines.push({value:r.PrevTrendValue})),h.data.chartsData.fields=g.sortChart(c,"drillingRate"===h.filter.attributeName);var u=_.pluck(c.values,"uid");h.data.chartsData.fieldsObjects={nns:g.sortObjectChart(i,u),gs:g.sortObjectChart(l,u),all:g.sortObjectChart(o,u)}}var d=_.find(e,{Parameter:h.filter.attributeName+"Nns"});if(d&&(d=d.Contractors),d&&d.length){c={uom:h.data.physChart&&h.data.physChart.Uom,displayName:h.data.physChart&&h.data.physChart.Name,yAxisTitle:" ",values:[],format:n&&n.Format};_.forEach(d,function(t){c.values.push({lineName:t.LineName,title:t.DisplayName?t.DisplayName:"Н/Д",points:[{values:[{val:t.Value}]}],link:function(){"nonProductivePc"===h.filter.attributeName?window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card"+(h.filter.lineId?"?lineId="+h.filter.lineId:""):window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card?lineId=a7588dfd-1e2e-4cb9-a60d-3a5b875bd216"}})}),h.data.chartsData.nnsContractorsSrc=g.sortChart(c),h.data.chartsData.nnsContractors=_.cloneDeep(h.data.chartsData.nnsContractorsSrc)}var m=_.find(e,{Parameter:h.filter.attributeName+"Gs"});if(m&&(m=m.Contractors),m&&m.length){c={uom:h.data.physChart&&h.data.physChart.Uom,displayName:h.data.physChart&&h.data.physChart.Name,yAxisTitle:" ",values:[],format:n&&n.Format};_.forEach(m,function(t){c.values.push({lineName:t.LineName,title:t.DisplayName?t.DisplayName:"Н/Д",points:[{values:[{val:t.Value}]}],link:function(){"nonProductivePc"===h.filter.attributeName?window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card"+(h.filter.lineId?"?lineId="+h.filter.lineId:""):window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card?lineId=a7588dfd-1e2e-4cb9-a60d-3a5b875bd216"}})}),h.data.chartsData.gsContractorsSrc=g.sortChart(c),h.data.chartsData.gsContractors=_.cloneDeep(h.data.chartsData.gsContractorsSrc)}e=t[1].data;a=_.find(e,{Parameter:h.filter.attributeName+"Nns"}),r=_.find(e,{Parameter:h.filter.attributeName+"Gs"}),n=_.find(e,{Parameter:h.filter.attributeName}),i=a&&a.Objects,l=r&&r.Objects,o=n&&n.Objects,c={uom:h.data.physChart&&h.data.physChart.Uom,displayName:h.data.physChart&&h.data.physChart.Name,yAxisTitle:" ",subXAxisTitles:["ННС","ГС"],values:[],averageLines:[],format:n&&n.Format};var f=_.unique(_.union(i,l),function(t){return""+t.Year+t.Quarter+g.pad(t.Month,2)});f=g.sortTimeObject(f),_.forEach(f,function(t){var e=_.find(i,{Year:t.Year,Quarter:t.Quarter,Month:t.Month}),a=_.find(l,{Year:t.Year,Quarter:t.Quarter,Month:t.Month});c.values.push({title:g.getObjectTimeTitle(e||a),points:[{values:e?[{val:e.Value,color:e.Color}]:[null]},{values:a?[{val:a.Value,color:a.Color}]:[null]}]})}),a&&(c.averageLines.push({value:a.TrendValue}),c.averageLines.push({value:a.PrevTrendValue})),r&&(c.averageLines.push({value:r.TrendValue}),c.averageLines.push({value:r.PrevTrendValue})),h.data.chartsData.dynamic=c,h.data.chartsData.dynamicObjects={nns:g.sortTimeObject(i),gs:g.sortTimeObject(l),all:g.sortTimeObject(o)}}else{if((e=t[0].data[0]).Objects&&e.Objects.length){c={uom:h.data.physChart&&h.data.physChart.Uom,displayName:h.data.physChart&&h.data.physChart.Name,yAxisTitle:" ",values:[],averageLines:[],format:e&&e.Format};_.forEach(e.Objects,function(t){c.values.push({uid:t.ObjId,title:t.DisplayName,points:"year"===h.filter.timeKey?[{values:[{val:t.Value,color:t.Color}]}]:[{values:[{val:t.PrevValue,color:t.PrevColor},{val:t.Value,color:t.Color}]}],link:"/fieldChart/"+h.filter.attributeName+"/"+h.data.companyUID+"/"+t.ObjId.toUpperCase()})}),c.averageLines.push({value:e.TrendValue}),h.data.chartsData.fields=g.sortChart(c,"drillingRate"===h.filter.attributeName);u=_.pluck(c.values,"uid");h.data.chartsData.fieldsObjects=g.sortObjectChart(e.Objects,u)}h.data.lines=[],h.data.contractors=e.Contractors,e.Contractors&&e.Contractors.length&&(_.forEach(e.Contractors,function(t){h.data.lines.push({id:t.LineId,name:t.LineName,format:e&&e.Format})}),h.data.lines=_.uniq(h.data.lines,"id")),h.data.lines.unshift({id:null,name:"Все",format:e&&e.Format}),b(),e=t[1].data;var p=(e=_.find(e,{Parameter:h.filter.attributeName})).Objects;c={uom:h.data.physChart&&h.data.physChart.Uom,displayName:h.data.physChart&&h.data.physChart.Name,yAxisTitle:" ",values:[],averageLines:[],format:e&&e.Format};p=g.sortTimeObject(p),_.forEach(p,function(t){c.values.push({title:g.getObjectTimeTitle(t),points:[{values:[{val:t.Value,color:t.Color}]}]})}),c.averageLines.push({value:e.TrendValue}),h.data.chartsData.dynamic=c,h.data.chartsData.dynamicObjects=g.sortTimeObject(p)}h.data.chartsLoaded=!0,h.data.error=null},function(t){"cancel"!==t&&(h.data.chartsLoaded=!0,h.data.error=t)})}function b(){var t=_.find(h.data.lines,{id:h.filter.lineId}),e=h.data.contractors;h.data.chartsData=h.data.chartsData||{},h.filter.lineId&&(e=_.filter(e,{LineId:h.filter.lineId}));var a={uom:h.data.physChart&&h.data.physChart.Uom,displayName:h.data.physChart&&h.data.physChart.Name,yAxisTitle:" ",values:[],format:t&&t.format};_.forEach(e,function(t){a.values.push({lineName:t.LineName,title:t.DisplayName?t.DisplayName:"Н/Д",points:[{values:[{val:t.Value}]}],link:function(){"nonProductivePc"===h.filter.attributeName?window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card"+(h.filter.lineId?"?lineId="+h.filter.lineId:""):window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card?lineId=a7588dfd-1e2e-4cb9-a60d-3a5b875bd216"}})}),h.data.chartsData.contractorsSrc=g.sortChart(a),h.data.chartsData.contractors=_.cloneDeep(h.data.chartsData.contractorsSrc)}}]),angular.module("smbApp").controller("ClustersChartCtrl",["$scope","$location","$q","$timeout","$routeParams","chartSeriesColors","appSettings","companiesData","fieldsAttributesData","utils","refData",function(l,t,e,a,i,r,n,o,s,c,u){var d;function m(){e.all([s.getData(),u.getData(),o.getData()]).then(function(t){a(function(){l.data.companies=o.getCompaniesNames(),l.data.company=_.find(l.data.companies,{UID:i.companyUID}),l.data.fields=o.getCompanyFieldsNames(i.companyUID),l.data.field=_.find(l.data.fields,{UID:i.fieldUID}),l.data.clusters=o.getCompanyClustersNames(i.companyUID,i.fieldUID),console.log(l.data.clusters);var t=[0,1,2],e=["month","quarter","year"];l.data.chartsData={},l.data.chartsData.clusters={},_.forEach([0,1,2],function(n){l.data.chartsData.clusters[n]={},_.forEach(t,function(r){l.data.chartsData.clusters[n][r]={},_.forEach(e,function(a){switch(i.attributeName){case"drillingRate":var t=s.getClustersChartData(l.data.field.UID,l.data.clusters,r,n,a,i.attributeName,!0,c.aggregateChartDataMean);l.data.chartsData.clusters[n][r][a]=t?{values:t,yAxisTitle:" ",subXAxisTitles:["ННС","ГС"]}:null;break;case"incidentPer1000m":case"hoursPerIncident":case"nonProductivePc":t=s.getClustersChartData(l.data.field.UID,l.data.clusters,r,n,a,i.attributeName,!1,c.aggregateChartDataMean);l.data.chartsData.clusters[n][r][a]=t?{values:t,yAxisTitle:" "}:null;break;case"explorationDuration":case"drillingDuration":t=s.getClustersChartData(l.data.field.UID,l.data.clusters,r,n,a,i.attributeName,!0,c.aggregateChartDataSum);l.data.chartsData.clusters[n][r][a]=t?{values:t,yAxisTitle:" ",subXAxisTitles:["ННС","ГС"]}:null;break;case"drillingBrigades":case"explorationBrigades":t=s.getClustersChartData(l.data.field.UID,l.data.clusters,r,n,a,i.attributeName,!1,c.aggregateChartDataSum);l.data.chartsData.clusters[n][r][a]=t?{values:t,yAxisTitle:" "}:null;default:t=s.getClustersChartData(l.data.field.UID,l.data.clusters,r,n,a,i.attributeName,!1,c.aggregateChartDataSum);l.data.chartsData.clusters[n][r][a]=t?{values:t,yAxisTitle:" "}:null}_.forEach(l.data.clusters,function(t,e){l.data.chartsData.clusters[n][r][a]&&l.data.chartsData.clusters[n][r][a].values[e]&&(l.data.chartsData.clusters[n][r][a].values[e].link="/wellsChart/"+i.attributeName+"/"+i.companyUID+"/"+i.fieldUID+"/"+t.UID)})})})}),console.log(l.data),l.data.loaded=!0},100)})}l.$on("$destroy",function(){var t;s.removeUpdateDataCallback(m),u.removeUpdateDataCallback(m),o.removeUpdateDataCallback(m),t={wellState:l.filter.wellState,timeKey:l.filter.timeKey,drillType:l.filter.drillType},n.setSettings("app",t)}),l.filter={wellState:1,timeKey:"month",drillType:0},l.data={loaded:!1,attributeName:i.attributeName,companyUID:i.companyUID,companies:[],company:null,fields:[],field:null},(d=n.getSettings("app"))&&angular.extend(l.filter,d),e.all([s.getData(),u.getData(),o.getData()]).then(function(t){m(),s.addUpdateDataCallback(m),u.addUpdateDataCallback(m),o.addUpdateDataCallback(m)}),l.getAttributeFullName=u.getAttributeFullName,l.getAttributeMUnit=u.getAttributeMUnit,l.planFactChatsColors=r.planFactChatsColors,l.getPeriodLabel=function(){switch(l.filter.timeKey){case"month":var t=moment().startOf("month").subtract(3,"months"),e=moment().startOf("month").subtract(1,"months");return t.year()===e.year()?t.format("MMMM")+"-"+e.format("MMMM")+" "+e.format("YYYY")+" г.":t.format("MMMM YYYY")+" - "+e.format("MMMM YYYY");case"quarter":var a=moment().startOf("quarter").subtract(3,"quarters"),r=moment().startOf("quarter").subtract(1,"quarters");return a.year()===r.year()?a.format("Q")+"-"+r.format("Q")+" "+e.format("YYYY")+" г.":a.format("Q кв YYYY")+" - "+r.format("Q кв YYYY");case"year":var n=moment().startOf("year").subtract(3,"years"),i=moment().startOf("year").subtract(1,"years");return n.format("YYYY")+"-"+i.format("YYYY")+" г.";default:return""}}}]),angular.module("smbApp").service("reports",["$q","$http","$timeout","msg","config",function(e,o,s,c,u){var d=0,m=[],a={};function f(){var t=arguments[0]||"",e=[].slice.call(arguments,1);_.forEach(a[t],function(t){t.apply(void 0,e)})}return{getReport:function(t,a){d++;var r=e.defer(),n={id:d,defer:r,title:a};m.push(n),f("report-loading",n.id,n);var i=null;function l(){o.get(u.getApiUrl()+"report/"+i).success(function(t){if(t.IsReady){console.log(t);var e=t.AbsoluteUri?t.AbsoluteUri:u.getApiUrl()+"report/"+t.Dbid+"/content";r.resolve(e)}else r.promise.$$state.status||s(l,2e3)}).error(function(t){r.reject(t)})}return o.post(u.getApiUrl()+"report",t).success(function(t){if(t.IsReady){console.log(t);var e=t.AbsoluteUri?t.AbsoluteUri:u.getApiUrl()+"report/"+t.Dbid+"/content";r.resolve(e)}else i=t.Dbid,r.promise.$$state.status||l()}).error(function(t){r.reject(t)}),r.promise.catch(function(t){var e=_.indexOf(m,n);-1!==e&&m.splice(e,1),"cancel"!==t&&c.pop("error",a+" не удалось сформировать.","Произошла ошибка.",0),f("report-loading-finish",n.id)}),r.promise.then(function(t){m.splice(_.indexOf(m,n),1),c.pop("success",a+" сформирован.","",0,function(){window.open(t,"_blank").focus()}),f("report-loading-finish",n.id)}),r.promise},getReports:function(){return m},cancelReport:function(t){var e=_.find(m,{id:t});e&&e.defer.reject("cancel")},on:function(t,e){a[t]=a[t]||[],a[t].push(e)}}}]),angular.module("smbApp").service("logger",["$http","config",function(a,r){var n="26b0b6c3-668a-4ff6-a65d-2e1528474863";return{login:function(){a.post(r.getApiUrl()+"log",{AppID:n,EventType:0,Message:"Login"})},logout:function(){a.post(r.getApiUrl()+"log",{AppID:n,EventType:1,Message:"Logout"})},routeChange:function(t,e){a.post(r.getApiUrl()+"log",{AppID:n,EventType:2,Message:"Route changed, old route: "+t+", new route: "+e})}}}]),angular.module("smbApp").service("psdDocumentsData",["$q","BaseClusterDataService",function(t,e){var a=new e([4],"psdDocumentsData");return angular.extend({getPsdDocuments:function(){var e=t.defer();return a.getData().then(function(t){var a=[];_.forEach(t,function(e){var t=JSON.parse(e.json);_.forEach(t.contracts,function(t){t.companyId=e.rootUID}),a=a.concat(t.contracts)}),e.resolve(a)}),e.promise}},a)}]),angular.module("smbApp").service("permitDocumentsData",["$q","BaseClusterDataService",function(t,e){var a=new e([5],"permitDocumentsData");return angular.extend({getPermitDocuments:function(){var e=t.defer();return a.getData().then(function(t){var a=[];_.forEach(t,function(e){var t=JSON.parse(e.json);_.forEach(t.contracts,function(t){t.companyId=e.rootUID}),a=a.concat(t.contracts)}),e.resolve(a)}),e.promise}},a)}]),angular.module("smbApp").service("companyData",["$q","BaseClusterDataService",function(t,e){var r=new e([10],"companyData");return angular.extend({getParsedData:function(){var a=t.defer();return r.getData().then(function(t){var e=_.map(t,function(t){return _.clone(t)});a.resolve(e)}),a.promise}},r)}]),angular.module("smbApp").service("activeObjectsStatuses",["$http","$interval","$q","config",function(t,e,a,r){var n=[],i=null,l=!1;function o(){l||(l=!0,t.get(r.getApiUrl()+"datatype_8").success(function(e){angular.forEach(n,function(t){t(e.json)}),l=!1}).error(function(){l=!1}))}return{start:function(){o(),i||(i=e(o,1e4))},stop:function(){i&&(e.cancel(i),i=null)},addUpdate:function(t){n.push(t)},removeUpdate:function(t){var e=n.indexOf(t);-1<e&&n.splice(e,1)}}}]),angular.module("smbApp").directive("reportsList",["$timeout","reports","accept",function(r,n,i){return{templateUrl:"views/directives/reports-list.html",replace:!0,restrict:"AE",link:function(a,t,e){a.reports=n.getReports(),a.reportsCount=a.reports.length,n.on("report-loading",function(t,e){r(function(){a.reports=n.getReports(),a.reportsCount=a.reports.length})}),n.on("report-loading-finish",function(){r(function(){a.reports=n.getReports(),a.reportsCount=a.reports.length})}),a.cancelReport=function(t){i("Вы действительно хотите удалить отчёт: "+t.title).then(function(){n.cancelReport(t.id)})}}}}]),angular.module("smbApp").controller("WellsChartCtrl",["$scope","$location","$q","$timeout","$routeParams","physChartsData","chartSeriesColors","appSettings","companiesData","fieldsAttributesData","utils","refData","apiData","xlsx","saveFile","authData",function(l,t,e,a,r,n,i,o,s,c,u,d,m,f,p,h){if(l.authData&&l.authData.CanViewPhysData){var g,v=t.search();if(l.$on("$destroy",function(){C()}),l.filter={wellState:1,timeKey:"month",timeCount:0,drillType:0,reverseMarkers:-1!==["npv","drillingBrigades","explorationBrigades"].indexOf(r.attributeName),showTable:!1,showValues:!0,showAverageLines:[!0,!1,!0,!1],hideAllAverageLines:!1,showMarkers:[[!1,!0],[!1,!0]],showMarkersYear:[[!0,!0],[!0,!0]],tiltXAxisTextContractors:!0,attributeName:r.attributeName},l.data={params:[],splitCharts:!1,profiles:null,period:"",error:null,loaded:!1,chartsLoaded:!1,companyUID:r.companyUID,company:null,companies:[],fieldUID:r.fieldUID,field:null,fields:[],physCharts:[],physChart:null},(g=o.getSettings("app"))&&angular.extend(l.filter,g),v.month||v.quarter||v.year){var D=moment(),y=moment(D);switch(v.month&&"0"!==v.month&&D.month(parseInt(v.month)-1),v.quarter&&"0"!==v.quarter&&D.quarter(parseInt(v.quarter)),v.year&&"0"!==v.year&&D.year(parseInt(v.year)),l.filter.timeKey){case"month":l.filter.timeCount=12*(D.year()-y.year())+D.month()-y.month();break;case"quarter":l.filter.timeCount=4*(D.year()-y.year())+D.quarter()-y.quarter();break;case"year":l.filter.timeCount=D.year()-y.year()}}l.$watch("filter",function(){C()},!0),e.all([d.getData(),s.getData(),n.getData()]).then(function(t){a(function(){l.data.companies=s.getCompaniesNames(),l.data.company=_.find(l.data.companies,{UID:r.companyUID}),l.data.fields=s.getCompanyFieldsNames(r.companyUID),l.data.field=_.find(l.data.fields,{UID:r.fieldUID}),l.data.physCharts=t[2],l.data.physChart=_.find(l.data.physCharts,{Id:l.filter.attributeName}),l.data.splitCharts=l.data.physChart&&l.data.physChart.Parameters&&1<l.data.physChart.Parameters.length,l.data.splitCharts?v.profiles="Nns"===v.profiles||"Gs"===v.profiles?v.profiles:"Nns":v.profiles=null,l.data.loaded=!0,w()},400)}),l.$watch("filter.wellState",function(t,e){t!==e&&w()}),l.$watch("filter.timeKey",function(t,e){t!==e&&w()}),l.$watch("filter.timeCount",function(t,e){t!==e&&w()}),l.$watch("filter.drillType",function(t,e){t!==e&&w()}),l.$watch("filter.attributeName",function(t,e){t!==e&&(window.location.href="#/wellsChart/"+t+"/"+l.data.companyUID+"/"+l.data.fieldUID+"?profiles="+v.profiles)});var b=null;l.getAttributeFullName=function(t){var e=_.find(l.data.physCharts,{Id:t});return e&&e.Name||t},l.getAttributeNameWithUom=function(t){var e=_.find(l.data.physCharts,{Id:t});return e&&e.Name+", "+e.Uom||t},l.planFactChatsColors=i.planFactChatsColors,l.factChatsColor=i.factChatsColor,l.onlyFactChatsColor=[l.factChatsColor[1]],l.getPeriodLabel=function(){switch(l.filter.timeKey){case"month":return moment().startOf("month").subtract(1,"months").format("MMMM YYYY г.");case"quarter":return moment().startOf("month").subtract(1,"quarter").format("Q кв. YYYY г.");case"year":return moment().startOf("month").subtract(1,"months").year()===moment().year()?moment().startOf("year").format("YYYY г."):moment().startOf("year").subtract(1,"years").format("YYYY г.");default:return""}},l.singleCompany=h.singleCompany,l.getExcel=function(){var t,e,a,r=["eb","zbs","prb"],n=["undefined","drilling","drilled","builded","active"];switch(l.filter.timeKey){case"month":a="Month",t=moment().startOf("month").subtract(-l.filter.timeCount,"months"),e=moment().startOf("month").subtract(-1-l.filter.timeCount,"months").subtract(1,"day"),l.data.period=t.format("MMMM YYYYг");break;case"quarter":a="Quarter",t=moment().startOf("quarter").subtract(-l.filter.timeCount,"quarters"),e=moment().startOf("quarter").subtract(-1-l.filter.timeCount,"quarters").subtract(1,"day"),l.data.period=t.format("Q квартал YYYYг");break;case"year":a="Year",t=moment().startOf("year").subtract(-l.filter.timeCount,"years"),e=moment().startOf("year").subtract(-1-l.filter.timeCount,"years").subtract(1,"day"),l.data.period=t.format("YYYYг")}if(t=t.format("YYYY-MM-DD"),e=e.format("YYYY-MM-DD"),4===l.filter.wellState)var i="/crsreport/api/physreport/4/"+r[l.filter.drillType]+"/"+n[l.filter.wellState]+"/2006-06-12/2100-01-01/?targetObject=well&periodBy="+a+"&localityId="+l.data.fieldUID+(v.profiles?"&profiles="+v.profiles:"")+"&parameter="+u.getApiAttributeName(l.filter.attributeName);else i="/crsreport/api/physreport/4/"+r[l.filter.drillType]+"/"+n[l.filter.wellState]+"/"+t+"/"+e+"/?targetObject=well&periodBy="+a+"&localityId="+l.data.fieldUID+(v.profiles?"&profiles="+v.profiles:"")+"&parameter="+u.getApiAttributeName(l.filter.attributeName);window.open(i,"_blank").focus()}}else t.path("/main");function C(){var t={wellState:l.filter.wellState,timeKey:l.filter.timeKey,drillType:l.filter.drillType,showValues:l.filter.showValues,timeCount:l.filter.timeCount};o.setSettings("app",t)}function w(){l.data.error=null,l.data.chartsLoaded=!1,l.data.chartsData={},b&&b.reject("cancel"),_.find(l.data.physChart&&l.data.physChart.TrendWellStates,function(t){return t===l.filter.wellState})?l.filter.hideAllAverageLines=!1:l.filter.hideAllAverageLines=!0;var t=_.filter(l.data.physCharts,function(t){return-1!==t.DrillTypes.indexOf(l.filter.drillType)});t=_.filter(t,function(t){return-1!==t.WellStates.indexOf(l.filter.wellState)});l.data.params=_.pluck(t,"Id"),-1==l.data.params.indexOf(l.filter.attributeName)&&(l.filter.attributeName=l.data.params[0]),"Gs"===v.profiles&&(l.data.profiles="ГС"),"Nns"===v.profiles&&(l.data.profiles="ННС"),(b=m.getWellsData(l.data.fieldUID,l.filter.drillType,l.filter.timeKey,l.filter.timeCount,l.filter.wellState,l.filter.attributeName,v.profiles)).promise.then(function(t){var e=t.data[0];if(e&&e.Objects&&e.Objects.length){var a={uom:l.data.physChart&&l.data.physChart.Uom,displayName:l.data.physChart&&l.data.physChart.Name,yAxisTitle:" ",values:[],averageLines:[],format:e&&e.Format};_.forEach(e.Objects,function(t){a.values.push({uid:t.ObjId,title:t.DisplayName,points:"year"===l.filter.timeKey?[{values:[{val:t.Value,color:t.Color}]}]:[{values:[{val:t.PrevValue,color:t.PrevColor},{val:t.Value,color:t.Color}]}],link:"/well/"+l.data.companyUID+"/"+l.data.fieldUID+"/"+t.ObjId.toUpperCase()})}),a.averageLines.push({value:e.TrendValue}),l.data.chartsData.wells=u.sortChart(a,"drillingRate"===l.filter.attributeName);var r=_.pluck(a.values,"uid");l.data.chartsData.wellsObjects=u.sortObjectChart(e.Objects,r)}if(e.Contractors&&e.Contractors.length){a={uom:l.data.physChart&&l.data.physChart.Uom,displayName:l.data.physChart&&l.data.physChart.Name,yAxisTitle:" ",values:[],format:e&&e.Format};_.forEach(e.Contractors,function(t){a.values.push({lineName:t.LineName,title:t.DisplayName?t.DisplayName:"Н/Д",points:[{values:[{val:t.Value}]}],link:function(){"nonProductivePc"===l.filter.attributeName?window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card"+(l.filter.lineId?"?lineId="+l.filter.lineId:""):window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card?lineId=a7588dfd-1e2e-4cb9-a60d-3a5b875bd216"}})}),l.data.chartsData.contractorsSrc=u.sortChart(a),l.data.chartsData.contractors=_.cloneDeep(l.data.chartsData.contractorsSrc)}l.data.chartsLoaded=!0,l.data.error=null},function(t){"cancel"!==t&&(l.data.chartsLoaded=!0,l.data.error=t)})}}]),angular.module("smbApp").controller("WellsFinChartCtrl",["$scope","$location","$q","$timeout","$routeParams","chartSeriesColors","appSettings","companiesData","fieldsAttributesData","utils","refData","apiData","xlsx","saveFile","authData",function(c,u,t,a,r,e,n,i,l,s,o,d,m,f,p){if(c.authData&&c.authData.CanViewFinData){var h,g=u.search();if(c.$on("$destroy",function(){o.removeUpdateDataCallback(C),i.removeUpdateDataCallback(C),b()}),c.filter={reverseMarkers:!0,wellState:1,timeKey:"month",timeCount:0,drillType:0,lineId:null,showTable:!1,showValues:!0,showAverageLines:[!0,!1,!0,!1],hideAllAverageLines:!1,showMarkers:[[!1,!0],[!1,!0]],showMarkersYear:[[!0,!0],[!0,!0]],tiltXAxisTextContractors:!0,attributeName:r.attributeName},c.data={lines:[],contractors:[],profiles:null,period:"",error:null,loaded:!1,chartsLoaded:!1,companyUID:r.companyUID,company:null,companies:[],fieldUID:r.fieldUID,field:null,fields:[],finCharts:[],params:[]},(h=n.getSettings("app"))&&angular.extend(c.filter,h),g.month||g.quarter||g.year){var v=moment(),D=moment(v);switch(g.month&&"0"!==g.month&&v.month(parseInt(g.month)-1),g.quarter&&"0"!==g.quarter&&v.quarter(parseInt(g.quarter)),g.year&&"0"!==g.year&&v.year(parseInt(g.year)),c.filter.timeKey){case"month":c.filter.timeCount=12*(v.year()-D.year())+v.month()-D.month();break;case"quarter":c.filter.timeCount=4*(v.year()-D.year())+v.quarter()-D.quarter();break;case"year":c.filter.timeCount=v.year()-D.year()}}c.$watch("filter",function(){b()},!0),t.all([o.getData(),i.getData()]).then(function(t){C(),o.addUpdateDataCallback(C),i.addUpdateDataCallback(C)}),c.$watch("filter.wellState",function(t,e){t!==e&&w()}),c.$watch("filter.timeKey",function(t,e){t!==e&&w()}),c.$watch("filter.timeCount",function(t,e){t!==e&&w()}),c.$watch("filter.drillType",function(t,e){t!==e&&w()}),c.$watch("filter.attributeName",function(t,e){t!==e&&(window.location.href="#/wellsFinChart/"+t+"/"+c.data.companyUID+"/"+c.data.fieldUID+"?profiles="+g.profiles)}),c.getAttributeFullName=function(e){var t=_.find(c.data.finCharts,function(t){return t.Parameters[0].Id.replace("Gs","").replace("Nns","")===e});return t?t.Name:e},c.getAttributeMUnit=function(e){var t=_.find(c.data.finCharts,function(t){return t.Parameters[0].Id.replace("Gs","").replace("Nns","")===e});return t?t.Parameters[0].Uom:e};var y=null;c.$watch("filter.lineId",I),c.planFactChatsColors=e.planFactChatsColors,c.factChatsColor=e.factChatsColor,c.onlyFactChatsColor=[c.factChatsColor[1]],c.getPeriodLabel=function(){switch(c.filter.timeKey){case"month":return moment().startOf("month").subtract(1,"months").format("MMMM YYYY г.");case"quarter":return moment().startOf("month").subtract(1,"quarter").format("Q кв. YYYY г.");case"year":return moment().startOf("month").subtract(1,"months").year()===moment().year()?moment().startOf("year").format("YYYY г."):moment().startOf("year").subtract(1,"years").format("YYYY г.");default:return""}},c.singleCompany=p.singleCompany,c.getExcel=function(){var t,e,a,r=["eb","zbs","prb"],n=["undefined","drilling","drilled","builded","active"],i=u.search();switch(c.filter.timeKey){case"month":a="Month",t=moment().startOf("month").subtract(-c.filter.timeCount,"months"),e=moment().startOf("month").subtract(-1-c.filter.timeCount,"months").subtract(1,"day"),c.data.period=t.format("MMMM YYYYг");break;case"quarter":a="Quarter",t=moment().startOf("quarter").subtract(-c.filter.timeCount,"quarters"),e=moment().startOf("quarter").subtract(-1-c.filter.timeCount,"quarters").subtract(1,"day"),c.data.period=t.format("Q квартал YYYYг");break;case"year":a="Year",t=moment().startOf("year").subtract(-c.filter.timeCount,"years"),e=moment().startOf("year").subtract(-1-c.filter.timeCount,"years").subtract(1,"day"),c.data.period=t.format("YYYYг")}t=t.format("YYYY-MM-DD"),e=e.format("YYYY-MM-DD");var l=[c.filter.attributeName],o=_.map(l,function(t){return"parameter="+i.profiles+t});if(o=o.join("&"),4===c.filter.wellState)var s="/crsreport/api/finreport/4/"+r[c.filter.drillType]+"/"+n[c.filter.wellState]+"/2006-06-12/2100-01-01?targetObject=well&periodBy="+a+"&localityId="+c.data.fieldUID+"&"+o;else s="/crsreport/api/finreport/4/"+r[c.filter.drillType]+"/"+n[c.filter.wellState]+"/"+t+"/"+e+"?targetObject=well&periodBy="+a+"&localityId="+c.data.fieldUID+"&"+o;console.log(s),window.open(s,"_blank").focus()}}else u.path("/main");function b(){var t={wellState:c.filter.wellState,timeKey:c.filter.timeKey,drillType:c.filter.drillType,showValues:c.filter.showValues,timeCount:c.filter.timeCount};n.setSettings("app",t)}function C(){t.all([o.getData(),i.getData(),d.getFinCharts().promise,d.getFinParamList().promise]).then(function(e){a(function(){c.data.companies=i.getCompaniesNames(),c.data.company=_.find(c.data.companies,{UID:r.companyUID}),c.data.fields=i.getCompanyFieldsNames(r.companyUID),c.data.field=_.find(c.data.fields,{UID:r.fieldUID}),c.data.finCharts=e[2].data,c.data.finChart=_.find(c.data.finCharts,{Id:c.filter.attributeName});var t=_.pluck(e[3].data,"Id");t=_.map(t,function(t){return t.replace("Gs","").replace("Nns","")}),c.data.params=_.unique(t),c.data.loaded=!0,w()},400)})}function w(){c.data.error=null,c.data.chartsLoaded=!1,c.data.chartsData={},y&&y.reject("cancel"),_.find(c.data.finChart&&c.data.finChart.TrendWellStates,function(t){return t===c.filter.wellState})?c.filter.hideAllAverageLines=!1:c.filter.hideAllAverageLines=!0,"Gs"===g.profiles&&(c.data.profiles="ГС"),"Nns"===g.profiles&&(c.data.profiles="ННС"),(y=d.getWellsFinData(c.data.fieldUID,c.filter.drillType,c.filter.timeKey,c.filter.timeCount,c.filter.wellState,"704AF9E4-E562-421A-BF02-BA28DF8BC0A1"===c.filter.attributeName?c.data.params:[c.filter.attributeName],g.profiles)).promise.then(function(t){var o=t.data,e=_.find(o,{Parameter:g.profiles+c.filter.attributeName}),a=e&&e.Objects;if(a&&a.length){var r={yAxisTitle:" ",values:[],averageLines:[],format:e&&e.Format};_.forEach(a,function(n){if("704AF9E4-E562-421A-BF02-BA28DF8BC0A1"===c.filter.attributeName){var i=[],l=[];_.forEach(c.data.params,function(t){if("704AF9E4-E562-421A-BF02-BA28DF8BC0A1"!==t){var e=_.find(o,{Parameter:g.profiles+t}),a=e&&e.Objects,r=_.find(a,{ObjId:n.ObjId});r&&r.Value?i.push({val:r.Value,label:c.getAttributeFullName(t)}):i.push({val:0}),r&&r.PrevValue?l.push({val:r.PrevValue,label:c.getAttributeFullName(t)}):l.push({val:0})}}),r.values.push({uid:n.ObjId,title:n.DisplayName,points:"year"===c.filter.timeKey?[{values:[{val:i,color:n&&n.Color}]}]:[{values:[{val:l,color:n.PrevColor},{val:i,color:n.Color}]}],link:"/well/"+c.data.companyUID+"/"+c.data.fieldUID+"/"+n.ObjId.toUpperCase()})}else r.values.push({uid:n.ObjId,title:n.DisplayName,points:"year"===c.filter.timeKey?[{values:[{val:n.Value,color:n.Color}]}]:[{values:[{val:n.PrevValue,color:n.PrevColor},{val:n.Value,color:n.Color}]}],link:"/well/"+c.data.companyUID+"/"+c.data.fieldUID+"/"+n.ObjId.toUpperCase()})}),r.averageLines.push({value:e.TrendValue}),c.data.chartsData.wells=s.sortChart(r);var n=_.pluck(r.values,"uid");c.data.chartsData.wellsObjects=s.sortObjectChart(e.Objects,n)}c.data.lines=[],c.data.contractors=e&&e.Contractors,c.data.contractors&&c.data.contractors.length&&(_.forEach(c.data.contractors,function(t){c.data.lines.push({id:t.LineId,name:t.LineName,format:o&&o.Format})}),c.data.lines=_.uniq(c.data.lines,"id")),c.data.lines.unshift({id:null,name:"Все",format:o&&o.Format}),I(),c.data.chartsLoaded=!0,c.data.error=null},function(t){"cancel"!==t&&(c.data.chartsLoaded=!0,c.data.error=t)})}function I(){var t=_.find(c.data.lines,{id:c.filter.lineId}),e=c.data.contractors;c.data.chartsData=c.data.chartsData||{},c.filter.lineId&&(e=_.filter(e,{LineId:c.filter.lineId}));var a={yAxisTitle:" ",values:[],format:t&&t.format};_.forEach(e,function(t){a.values.push({lineName:t.LineName,title:t.DisplayName?t.DisplayName:"Н/Д",points:[{values:[{val:t.Value}]}],link:"/contractor/"+t.ObjId.toUpperCase()+"/card?companyUID="+c.data.companyUID+"&fieldUID="+c.data.fieldUID})}),c.data.chartsData.contractorsSrc=s.sortChart(a),c.data.chartsData.contractors=_.cloneDeep(c.data.chartsData.contractorsSrc)}}]),angular.module("smbApp").controller("TestChartCtrl",["$scope","$location","$q","$timeout","$http","$routeParams","pvChartData","chartSeriesColors","appSettings","companiesData","utils","refData",function(l,t,e,a,r,n,i,o,s,c,u,d){function m(){l.data.loaded=!1,l.data.chartsData={};var t,e,a="/crsreport/api/branches/penetrationrate/";switch(l.filter.wellState){case 0:a+="drilling/";break;case 1:a+="drilled/";break;case 2:a+="builded/"}switch(l.filter.drillType){case 0:a+="eb";break;case 1:a+="zbs";break;case 2:a+="prb"}switch(l.filter.timeKey){case"month":t=moment().startOf("month").subtract(3,"months"),e=moment().startOf("month").subtract(1,"months");break;case"quarter":t=moment().startOf("quarter").subtract(3,"quarters"),e=moment().startOf("quarter").subtract(1,"quarters");break;case"year":t=moment().startOf("year").subtract(3,"years"),e=moment().startOf("year").subtract(1,"years")}a=a+"?start="+t.format("YYYY-MM-DD")+"&end="+e.format("YYYY-MM-DD"),r.get(a).success(function(n){var i={yAxisTitle:" ",values:[]},t=_.unique(_.pluck(n.Objects,"ObjId"));_.forEach(t,function(t){var e=_.find(n.Objects,{ObjId:t,ProfileType:0}),a=_.find(n.Objects,{ObjId:t,ProfileType:1}),r={title:t,points:[{values:[e?e.DaysPer1000M:null,a?a.DaysPer1000M:null]}]};i.values.push(r)}),l.data.chartsData.companies=i;i={yAxisTitle:" ",values:[]};var e=_.unique(_.pluck(n.Contractors,"ObjId"));_.forEach(e,function(t){var e={title:t,points:[{values:[_.find(n.Contractors,{ObjId:t}).DaysPer1000M]}]};i.values.push(e)}),l.data.chartsData.contractors=i,l.data.loaded=!0}).error(function(t,e,a,r){l.data.loaded=!0,msg.pop("error","Не удалось получить данные",t,0)})}l.filter={wellState:1,timeKey:"month",drillType:0},l.data={loaded:!1,attributeName:"penetrationrate",companies:[],contractors:[]},e.all([d.getData(),c.getData()]).then(function(t){a(function(){l.data.companies=c.getCompaniesNames()}),m()}),l.$watch("filter.wellState",m),l.$watch("filter.timeKey",m),l.$watch("filter.drillType",m),l.planFactChatsColors=o.planFactChatsColors,l.getPeriodLabel=function(){switch(l.filter.timeKey){case"month":var t=moment().startOf("month").subtract(3,"months"),e=moment().startOf("month").subtract(1,"months");return t.year()===e.year()?t.format("MMMM")+"-"+e.format("MMMM")+" "+e.format("YYYY")+" г.":t.format("MMMM YYYY")+" - "+e.format("MMMM YYYY");case"quarter":var a=moment().startOf("quarter").subtract(3,"quarters"),r=moment().startOf("quarter").subtract(1,"quarters");return a.year()===r.year()?a.format("Q")+"-"+r.format("Q")+" "+e.format("YYYY")+" г.":a.format("Q кв YYYY")+" - "+r.format("Q кв YYYY");case"year":var n=moment().startOf("year").subtract(3,"years"),i=moment().startOf("year").subtract(1,"years");return n.format("YYYY")+"-"+i.format("YYYY")+" г.";default:return""}}}]),angular.module("smbApp").service("mapData",["$q","BaseDataService",function(t,e){var a=new e("mapData");return angular.extend({},a)}]),angular.module("smbApp").service("contractorsData",["$q","$http","config",function(t,a,r){var n=null;return{getData:function(){var e=t.defer();return n?e.resolve(n):a.get(r.getApiUrl()+"contractors").success(function(t){n=t,e.resolve(t)}).error(function(t){e.reject(t)}),e.promise}}}]),angular.module("smbApp").filter("round",function(){return function(t,e){if(_.isNumber(t)){_.isNumber(e)||(e=3);var a=Math.pow(10,e),r=t*a;return Math.round(r)/a}return""}}),angular.module("smbApp").service("apiData",["$q","$timeout","$http","companiesData","utils","config",function(p,t,h,e,f,g){var v=["eb","zbs","prb"],D=["undefined","drilling","drilled","builded","active"];return{saveClientDoc:function(t,e,a){var r=g.getApiUrl()+"clientdoc";console.log(r);var n=p.defer();return h.post(r,{name:a,ext:e,data:t}).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n},getUser:function(){var t=g.getApiUrl()+"user";console.log(t);var e=p.defer();return h.get(t).then(function(t){e.resolve(t.data)},function(t){e.reject(t)}),e},getReports:function(){var t=g.getApiUrl()+"report";console.log(t);var e=p.defer();return h.get(t).then(function(t){e.resolve(t.data)},function(t){e.reject(t)}),e},getRegulatoryDocuments:function(){var t=g.getApiUrl()+"document/nmd";console.log(t);var e=p.defer();return h.get(t).then(function(t){e.resolve(t.data)},function(t){e.reject(t)}),e},getProfiles:function(){var t=g.getApiUrl()+"dashboard/profiles";return h.get(t)},getIntegrationLogs:function(){var t=g.getApiUrl()+"integration/logs";return h.get(t)},downloadErrorLog:function(t){var e=g.getApiUrl()+"integration/logs/"+t;return h.get(e)},runIntegration:function(t){var e=g.getApiUrl()+"integration/"+t;return h.post(e)},getMailingSettingsById:function(t,e){var a=g.getApiUrl()+"dashboard/settings/"+t+"/"+e;return h.get(a)},createUserMailingSettings:function(t,e,a){var r=g.getApiUrl()+"dashboard/settings/"+t+"/"+e;return h.post(r,a)},matchSapSmb:function(t){return h.post(g.getApiUrl()+"contractor/"+t)},getWellData:function(t){var e=g.getApiUrl()+"well/"+t+"/card";return console.log(e),h.get(e)},getPhysWellData:function(t){var e=g.getApiUrl()+"well/"+t+"/card/phys";return console.log(e),h.get(e)},getFinWellData:function(t){var e=g.getApiUrl()+"well/"+t+"/card/fin";return console.log(e),h.get(e)},editWellSppId:function(t,e){var a=g.getApiUrl()+"welldoc",r=new FormData;r.append("spp",e||""),r.append("wellName",t);var n=p.defer();return h.post(a,r,{headers:{Accept:"text/html,application/xhtml+xml,application/xml","Content-Type":void 0},transformRequest:angular.identity}).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n},getClusterWidgetsData:function(t,e,a,r,n,i){var l,o,s="parameter="+i.join("&parameter="),c=null;switch(a){case"month":c="Month",l=moment().startOf("month").subtract(-r,"months"),o=moment().startOf("month").subtract(-1-r,"months").subtract(1,"day");break;case"quarter":c="Quarter",l=moment().startOf("quarter").subtract(-r,"quarters"),o=moment().startOf("quarter").subtract(-1-r,"quarters").subtract(1,"day");break;case"year":c="Year",l=moment().startOf("year").subtract(-r,"years"),o=moment().startOf("year").subtract(-1-r,"years").subtract(1,"day")}if(l=l.format("YYYY-MM-DD"),o=o.format("YYYY-MM-DD"),4===n)var u=g.getApiUrl()+v[e]+"/"+D[n]+"/2006-06-12/2100-01-01?targetObject=locality&lastParValueOnly=true&periodBy="+c+"&"+s+"&clusterId="+t;else u=g.getApiUrl()+v[e]+"/"+D[n]+"/"+l+"/"+o+"?targetObject=locality&lastParValueOnly=true&periodBy="+c+"&"+s+"&clusterId="+t;console.log(u);var d=p.defer();return h.get(u).then(function(t){d.resolve(t)},function(t){d.reject(t)}),d},getClusterWidgetsFinData:function(t,e,a,r,n){var i,l,o=null;switch(a){case"month":o="Month",i=moment().startOf("month").subtract(-r,"months"),l=moment().startOf("month").subtract(-1-r,"months").subtract(1,"day");break;case"quarter":o="Quarter",i=moment().startOf("quarter").subtract(-r,"quarters"),l=moment().startOf("quarter").subtract(-1-r,"quarters").subtract(1,"day");break;case"year":o="Year",i=moment().startOf("year").subtract(-r,"years"),l=moment().startOf("year").subtract(-1-r,"years").subtract(1,"day")}if(i=i.format("YYYY-MM-DD"),l=l.format("YYYY-MM-DD"),4===n)var s=g.getApiUrl()+"fin/"+v[e]+"/"+D[n]+"/2006-06-12/2100-01-01?targetObject=locality&lastParValueOnly=true&periodBy="+o+"&clusterId="+t;else s=g.getApiUrl()+"fin/"+v[e]+"/"+D[n]+"/"+i+"/"+l+"?targetObject=locality&lastParValueOnly=true&periodBy="+o+"&clusterId="+t;console.log(s);var c=p.defer();return h.get(s).then(function(t){c.resolve(t)},function(t){c.reject(t)}),c},getFieldWidgetsData:function(t,e,a,r,n,i){var l,o,s="parameter="+i.join("&parameter="),c=null;switch(a){case"month":c="Month",l=moment().startOf("month").subtract(-r,"months"),o=moment().startOf("month").subtract(-1-r,"months").subtract(1,"day");break;case"quarter":c="Quarter",l=moment().startOf("quarter").subtract(-r,"quarters"),o=moment().startOf("quarter").subtract(-1-r,"quarters").subtract(1,"day");break;case"year":c="Year",l=moment().startOf("year").subtract(-r,"years"),o=moment().startOf("year").subtract(-1-r,"years").subtract(1,"day")}if(l=l.format("YYYY-MM-DD"),o=o.format("YYYY-MM-DD"),4===n)var u=g.getApiUrl()+v[e]+"/"+D[n]+"/2006-06-12/2100-01-01?targetObject=locality&lastParValueOnly=true&periodBy="+c+"&"+s+"&localityId="+t;else u=g.getApiUrl()+v[e]+"/"+D[n]+"/"+l+"/"+o+"?targetObject=locality&lastParValueOnly=true&periodBy="+c+"&"+s+"&localityId="+t;console.log(u);var d=p.defer();return h.get(u).then(function(t){d.resolve(t)},function(t){d.reject(t)}),d},getFieldWidgetsFinData:function(t,e,a,r,n){var i,l,o=null;switch(a){case"month":o="Month",i=moment().startOf("month").subtract(-r,"months"),l=moment().startOf("month").subtract(-1-r,"months").subtract(1,"day");break;case"quarter":o="Quarter",i=moment().startOf("quarter").subtract(-r,"quarters"),l=moment().startOf("quarter").subtract(-1-r,"quarters").subtract(1,"day");break;case"year":o="Year",i=moment().startOf("year").subtract(-r,"years"),l=moment().startOf("year").subtract(-1-r,"years").subtract(1,"day")}if(i=i.format("YYYY-MM-DD"),l=l.format("YYYY-MM-DD"),4===n)var s=g.getApiUrl()+"fin/"+v[e]+"/"+D[n]+"/2006-06-12/2100-01-01?targetObject=locality&lastParValueOnly=true&periodBy="+o+"&localityId="+t;else s=g.getApiUrl()+"fin/"+v[e]+"/"+D[n]+"/"+i+"/"+l+"?targetObject=locality&lastParValueOnly=true&periodBy="+o+"&localityId="+t;console.log(s);var c=p.defer();return h.get(s).then(function(t){c.resolve(t)},function(t){c.reject(t)}),c},getCompanyWidgetsData:function(t,e,a,r,n,i){var l,o,s="parameter="+i.join("&parameter="),c=null;switch(a){case"month":c="Month",l=moment().startOf("month").subtract(-r,"months"),o=moment().startOf("month").subtract(-1-r,"months").subtract(1,"day");break;case"quarter":c="Quarter",l=moment().startOf("quarter").subtract(-r,"quarters"),o=moment().startOf("quarter").subtract(-1-r,"quarters").subtract(1,"day");break;case"year":c="Year",l=moment().startOf("year").subtract(-r,"years"),o=moment().startOf("year").subtract(-1-r,"years").subtract(1,"day")}if(l=l.format("YYYY-MM-DD"),o=o.format("YYYY-MM-DD"),4===n)var u=g.getApiUrl()+v[e]+"/"+D[n]+"/2006-06-12/2100-01-01?lastParValueOnly=true&periodBy="+c+"&"+s+("all"===t?"":"&branchId="+t);else u=g.getApiUrl()+v[e]+"/"+D[n]+"/"+l+"/"+o+"?lastParValueOnly=true&periodBy="+c+"&"+s+("all"===t?"":"&branchId="+t);console.log(u);var d=p.defer();return h.get(u).then(function(t){d.resolve(t)},function(t){d.reject(t)}),d},getCompanyWidgetsFinData:function(t,e,a,r,n){var i,l,o=null;switch(a){case"month":o="Month",i=moment().startOf("month").subtract(-r,"months"),l=moment().startOf("month").subtract(-1-r,"months").subtract(1,"day");break;case"quarter":o="Quarter",i=moment().startOf("quarter").subtract(-r,"quarters"),l=moment().startOf("quarter").subtract(-1-r,"quarters").subtract(1,"day");break;case"year":o="Year",i=moment().startOf("year").subtract(-r,"years"),l=moment().startOf("year").subtract(-1-r,"years").subtract(1,"day")}if(i=i.format("YYYY-MM-DD"),l=l.format("YYYY-MM-DD"),4===n)var s=g.getApiUrl()+"fin/"+v[e]+"/"+D[n]+"/2006-06-12/2100-01-01?lastParValueOnly=true&periodBy="+o+("all"===t?"":"&branchId="+t);else s=g.getApiUrl()+"fin/"+v[e]+"/"+D[n]+"/"+i+"/"+l+"?lastParValueOnly=true&periodBy="+o+("all"===t?"":"&branchId="+t);console.log(s);var c=p.defer();return h.get(s).then(function(t){c.resolve(t)},function(t){c.reject(t)}),c},getNpvMainCompanyData:function(t,e,a){var r,n;switch(e){case"month":r=moment().startOf("month").subtract(2,"months"),n=moment().endOf("month");break;case"quarter":r=moment().startOf("quarter").subtract(2,"quarters"),n=moment().endOf("quarter");break;case"year":r=moment().startOf("year").subtract(2,"years"),n=moment().endOf("year")}r=r.format("YYYY-MM-DD"),n=n.format("YYYY-MM-DD");var i=g.getApiUrl()+v[t]+"/"+D[a]+"/"+r+"/"+n+"?parameter=npv&periodBy=None";console.log(i);var l=p.defer();return h.get(i).then(function(t){l.resolve(t)},function(t){l.reject(t)}),l},getMainCompanyData:function(t,e,a,r,n){var i,l,o="parameter="+n.join("&parameter="),s=null;switch(e){case"month":s="Month",i=moment().startOf("month").subtract(2-a,"months"),l=moment().startOf("month").subtract(-1-a,"months").subtract(1,"day"),i.format("YYYY-MM-DD")<"2013-01-01"&&(i=moment("2013-01-01"));break;case"quarter":s="Quarter",i=moment().startOf("quarter").subtract(2-a,"quarters"),l=moment().startOf("quarter").subtract(-1-a,"quarters").subtract(1,"day"),i.format("YYYY-MM-DD")<"2013-01-01"&&(i=moment("2013-01-01"));break;case"year":s="Year",i=moment().startOf("year").subtract(2-a,"years"),l=moment().startOf("year").subtract(-1-a,"years").subtract(1,"day"),i.format("YYYY-MM-DD")<"2013-01-01"&&(i=moment("2013-01-01"))}if(i=i.format("YYYY-MM-DD"),l=l.format("YYYY-MM-DD"),4===r)var c=g.getApiUrl()+v[t]+"/"+D[r]+"/2006-06-12/2100-01-01?periodBy="+s+"&"+o;else c=g.getApiUrl()+v[t]+"/"+D[r]+"/"+i+"/"+l+"?periodBy="+s+"&"+o;console.log(c);var u=p.defer();return h.get(c).then(function(t){u.resolve(t)},function(t){u.reject(t)}),u},getCompaniesData:function(t,e,a,r,n,i){var l,o;switch(e){case"month":"Month",l=moment().startOf("month").subtract(-a,"months"),o=moment().startOf("month").subtract(-1-a,"months").subtract(1,"day");break;case"quarter":"Quarter",l=moment().startOf("quarter").subtract(-a,"quarters"),o=moment().startOf("quarter").subtract(-1-a,"quarters").subtract(1,"day");break;case"year":"Year",l=moment().startOf("year").subtract(-a,"years"),o=moment().startOf("year").subtract(-1-a,"years").subtract(1,"day")}if(l=l.format("YYYY-MM-DD"),o=o.format("YYYY-MM-DD"),4===r)var s=g.getApiUrl()+v[t]+"/"+D[r]+"/2006-06-12/2100-01-01?branchId=00000000-0000-0000-0000-000000000000&targetObject=branch&periodBy=None"+(i?"&parameter="+f.getApiAttributeName(n)+"&parameter="+f.getApiAttributeName(n)+"Gs&parameter="+f.getApiAttributeName(n)+"Nns":"&parameter="+f.getApiAttributeName(n));else s=g.getApiUrl()+v[t]+"/"+D[r]+"/"+l+"/"+o+"?branchId=00000000-0000-0000-0000-000000000000&targetObject=branch&periodBy=None"+(i?"&parameter="+f.getApiAttributeName(n)+"&parameter="+f.getApiAttributeName(n)+"Gs&parameter="+f.getApiAttributeName(n)+"Nns":"&parameter="+f.getApiAttributeName(n));console.log(s);var c=p.defer();return h.get(s).then(function(t){c.resolve(t)},function(t){c.reject(t)}),c},getCompaniesDynamicData:function(t,e,a,r,n,i){var l,o,s=null;switch(e){case"month":s="Month",l=moment().startOf("month").subtract(10-a,"months"),(o=moment().startOf("month").subtract(-1-a-10,"months").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("month").format("YYYY-MM-DD")&&(o=moment().endOf("month")),l.format("YYYY-MM-DD")<"2013-01-01"&&(l=moment("2013-01-01"));break;case"quarter":s="Quarter",l=moment().startOf("quarter").subtract(10-a,"quarters"),(o=moment().startOf("quarter").subtract(-1-a-10,"quarters").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("quarter").format("YYYY-MM-DD")&&(o=moment().endOf("quarter")),l.format("YYYY-MM-DD")<"2013-01-01"&&(l=moment("2013-01-01"));break;case"year":s="Year",l=moment().startOf("year").subtract(10-a,"years"),(o=moment().startOf("year").subtract(-1-a-10,"years").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("year").format("YYYY-MM-DD")&&(o=moment().endOf("year")),l.format("YYYY-MM-DD")<"2013-01-01"&&(l=moment("2013-01-01"))}if(l=l.format("YYYY-MM-DD"),o=o.format("YYYY-MM-DD"),4===r)var c=g.getApiUrl()+v[t]+"/"+D[r]+"/2006-06-12/2100-01-01?targetObject=Gpn&periodBy="+s+(i?"&parameter="+f.getApiAttributeName(n)+"&parameter="+f.getApiAttributeName(n)+"Gs&parameter="+f.getApiAttributeName(n)+"Nns":"&parameter="+f.getApiAttributeName(n));else c=g.getApiUrl()+v[t]+"/"+D[r]+"/"+l+"/"+o+"?targetObject=Gpn&periodBy="+s+(i?"&parameter="+f.getApiAttributeName(n)+"&parameter="+f.getApiAttributeName(n)+"Gs&parameter="+f.getApiAttributeName(n)+"Nns":"&parameter="+f.getApiAttributeName(n));console.log(c);var u=p.defer();return h.get(c).then(function(t){u.resolve(t)},function(t){u.reject(t)}),u},getFieldsData:function(t,e,a,r,n,i,l){var o,s;switch(a){case"month":"Month",o=moment().startOf("month").subtract(-r,"months"),s=moment().startOf("month").subtract(-1-r,"months").subtract(1,"day");break;case"quarter":"Quarter",o=moment().startOf("quarter").subtract(-r,"quarters"),s=moment().startOf("quarter").subtract(-1-r,"quarters").subtract(1,"day");break;case"year":"Year",o=moment().startOf("year").subtract(-r,"years"),s=moment().startOf("year").subtract(-1-r,"years").subtract(1,"day")}if(o=o.format("YYYY-MM-DD"),s=s.format("YYYY-MM-DD"),4===n)var c=g.getApiUrl()+v[e]+"/"+D[n]+"/2006-06-12/2100-01-01?targetObject=Locality&branchId="+t+"&periodBy=None"+(l?"&parameter="+f.getApiAttributeName(i)+"&parameter="+f.getApiAttributeName(i)+"Gs&parameter="+f.getApiAttributeName(i)+"Nns":"&parameter="+f.getApiAttributeName(i));else c=g.getApiUrl()+v[e]+"/"+D[n]+"/"+o+"/"+s+"?targetObject=Locality&branchId="+t+"&periodBy=None"+(l?"&parameter="+f.getApiAttributeName(i)+"&parameter="+f.getApiAttributeName(i)+"Gs&parameter="+f.getApiAttributeName(i)+"Nns":"&parameter="+f.getApiAttributeName(i));console.log(c);var u=p.defer();return h.get(c).then(function(t){u.resolve(t)},function(t){u.reject(t)}),u},getFieldsDynamicData:function(t,e,a,r,n,i,l){var o,s,c=null;switch(a){case"month":c="Month",o=moment().startOf("month").subtract(10-r,"months"),(s=moment().startOf("month").subtract(-1-r-10,"months").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("month").format("YYYY-MM-DD")&&(s=moment().endOf("month")),o.format("YYYY-MM-DD")<"2013-01-01"&&(o=moment("2013-01-01"));break;case"quarter":c="Quarter",o=moment().startOf("quarter").subtract(10-r,"quarters"),(s=moment().startOf("quarter").subtract(-1-r-10,"quarters").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("quarter").format("YYYY-MM-DD")&&(s=moment().endOf("quarter")),o.format("YYYY-MM-DD")<"2013-01-01"&&(o=moment("2013-01-01"));break;case"year":c="Year",o=moment().startOf("year").subtract(10-r,"years"),(s=moment().startOf("year").subtract(-1-r-10,"years").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("year").format("YYYY-MM-DD")&&(s=moment().endOf("year")),o.format("YYYY-MM-DD")<"2013-01-01"&&(o=moment("2013-01-01"))}if(o=o.format("YYYY-MM-DD"),s=s.format("YYYY-MM-DD"),4===n)var u=g.getApiUrl()+v[e]+"/"+D[n]+"/2006-06-12/2100-01-01?targetObject=branch&branchId="+t+"&periodBy="+c+(l?"&parameter="+f.getApiAttributeName(i)+"&parameter="+f.getApiAttributeName(i)+"Gs&parameter="+f.getApiAttributeName(i)+"Nns":"&parameter="+f.getApiAttributeName(i));else u=g.getApiUrl()+v[e]+"/"+D[n]+"/"+o+"/"+s+"?targetObject=branch&branchId="+t+"&periodBy="+c+(l?"&parameter="+f.getApiAttributeName(i)+"&parameter="+f.getApiAttributeName(i)+"Gs&parameter="+f.getApiAttributeName(i)+"Nns":"&parameter="+f.getApiAttributeName(i));console.log(u);var d=p.defer();return h.get(u).then(function(t){d.resolve(t)},function(t){d.reject(t)}),d},getFieldData:function(t,e,a,r,n,i,l){var o,s,c=null;switch(a){case"month":c="Month",o=moment().startOf("month").subtract(10-r,"months"),(s=moment().startOf("month").subtract(-1-r-10,"months").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("month").format("YYYY-MM-DD")&&(s=moment().endOf("month")),o.format("YYYY-MM-DD")<"2013-01-01"&&(o=moment("2013-01-01"));break;case"quarter":c="Quarter",o=moment().startOf("quarter").subtract(10-r,"quarters"),(s=moment().startOf("quarter").subtract(-1-r-10,"quarters").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("quarter").format("YYYY-MM-DD")&&(s=moment().endOf("quarter")),o.format("YYYY-MM-DD")<"2013-01-01"&&(o=moment("2013-01-01"));break;case"year":c="Year",o=moment().startOf("year").subtract(10-r,"years"),(s=moment().startOf("year").subtract(-1-r-10,"years").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("year").format("YYYY-MM-DD")&&(s=moment().endOf("year")),o.format("YYYY-MM-DD")<"2013-01-01"&&(o=moment("2013-01-01"))}if(o=o.format("YYYY-MM-DD"),s=s.format("YYYY-MM-DD"),4===n)var u=g.getApiUrl()+v[e]+"/"+D[n]+"/2006-06-12/2100-01-01?targetObject=locality&periodBy="+c+"&localityId="+t+(l?"&parameter="+f.getApiAttributeName(i)+"Gs&parameter="+f.getApiAttributeName(i)+"Nns":"&parameter="+f.getApiAttributeName(i));else u=g.getApiUrl()+v[e]+"/"+D[n]+"/"+o+"/"+s+"?targetObject=locality&periodBy="+c+"&localityId="+t+(l?"&parameter="+f.getApiAttributeName(i)+"Gs&parameter="+f.getApiAttributeName(i)+"Nns":"&parameter="+f.getApiAttributeName(i));console.log(u);var d=p.defer();return h.get(u).then(function(t){d.resolve(t)},function(t){d.reject(t)}),d},getFieldDn7Data:function(t,e,a,r,n,i,l,o){var s,c,u=null;switch(a){case"month":u="Month",s=moment().startOf("month").subtract(10-r,"months"),(c=moment().startOf("month").subtract(-1-r-10,"months").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("month").format("YYYY-MM-DD")&&(c=moment().endOf("month")),s.format("YYYY-MM-DD")<"2013-01-01"&&(s=moment("2013-01-01"));break;case"quarter":u="Quarter",s=moment().startOf("quarter").subtract(10-r,"quarters"),(c=moment().startOf("quarter").subtract(-1-r-10,"quarters").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("quarter").format("YYYY-MM-DD")&&(c=moment().endOf("quarter")),s.format("YYYY-MM-DD")<"2013-01-01"&&(s=moment("2013-01-01"));break;case"year":u="Year",s=moment().startOf("year").subtract(10-r,"years"),(c=moment().startOf("year").subtract(-1-r-10,"years").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("year").format("YYYY-MM-DD")&&(c=moment().endOf("year")),s.format("YYYY-MM-DD")<"2013-01-01"&&(s=moment("2013-01-01"))}if(s=s.format("YYYY-MM-DD"),c=c.format("YYYY-MM-DD"),4===n)var d=g.getApiUrl()+v[e]+"/"+D[n]+"/2006-06-12/2100-01-01/?targetObject=locality&periodBy="+u+"&localityId="+t+"&parameter="+f.getApiAttributeName(i);else d=g.getApiUrl()+v[e]+"/"+D[n]+"/"+s+"/"+c+"/?targetObject=locality&periodBy="+u+"&localityId="+t+"&parameter="+f.getApiAttributeName(i);l&&(d+="&profiles="+l+("Gs"===l&&o?"&dn7Gs="+o:"")+("Nns"===l&&o?"&dn7Nns="+o:"")),console.log(d);var m=p.defer();return h.get(d).then(function(t){m.resolve(t)},function(t){m.reject(t)}),m},getWellsData:function(t,e,a,r,n,i,l){var o,s,c=null;switch(a){case"month":c="Month",o=moment().startOf("month").subtract(-r,"months"),s=moment().startOf("month").subtract(-1-r,"months").subtract(1,"day");break;case"quarter":c="Quarter",o=moment().startOf("quarter").subtract(-r,"quarters"),s=moment().startOf("quarter").subtract(-1-r,"quarters").subtract(1,"day");break;case"year":c="Year",o=moment().startOf("year").subtract(-r,"years"),s=moment().startOf("year").subtract(-1-r,"years").subtract(1,"day")}if(o=o.format("YYYY-MM-DD"),s=s.format("YYYY-MM-DD"),4===n)var u=g.getApiUrl()+v[e]+"/"+D[n]+"/2006-06-12/2100-01-01/?targetObject=well&periodBy="+c+"&localityId="+t+(l?"&profiles="+l:"")+"&parameter="+f.getApiAttributeName(i);else u=g.getApiUrl()+v[e]+"/"+D[n]+"/"+o+"/"+s+"/?targetObject=well&periodBy="+c+"&localityId="+t+(l?"&profiles="+l:"")+"&parameter="+f.getApiAttributeName(i);console.log(u);var d=p.defer();return h.get(u).then(function(t){d.resolve(t)},function(t){d.reject(t)}),d},getFinCharts:function(){var t=g.getApiUrl()+"fin/charts";console.log(t);var e=p.defer();return h.get(t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e},getFinParamList:function(){var t=g.getApiUrl()+"fin/paramlist";console.log(t);var e=p.defer();return h.get(t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e},getMainCompanyFinData:function(t,e,a,r,n){var i,l,o="parameter="+n.join("&parameter="),s=null;switch(e){case"month":s="Month",i=moment().startOf("month").subtract(2-a,"months"),l=moment().startOf("month").subtract(-1-a,"months").subtract(1,"day"),i.format("YYYY-MM-DD")<"2013-01-01"&&(i=moment("2013-01-01"));break;case"quarter":s="Quarter",i=moment().startOf("quarter").subtract(2-a,"quarters"),l=moment().startOf("quarter").subtract(-1-a,"quarters").subtract(1,"day"),i.format("YYYY-MM-DD")<"2013-01-01"&&(i=moment("2013-01-01"));break;case"year":s="Year",i=moment().startOf("year").subtract(2-a,"years"),l=moment().startOf("year").subtract(-1-a,"years").subtract(1,"day"),i.format("YYYY-MM-DD")<"2013-01-01"&&(i=moment("2013-01-01"))}if(i=i.format("YYYY-MM-DD"),l=l.format("YYYY-MM-DD"),4===r)var c=g.getApiUrl()+"fin/"+v[t]+"/"+D[r]+"/2006-06-12/2100-01-01?targetObject=Gpn&periodBy="+s+"&"+o;else c=g.getApiUrl()+"fin/"+v[t]+"/"+D[r]+"/"+i+"/"+l+"?targetObject=Gpn&periodBy="+s+"&"+o;console.log(c);var u=p.defer();return h.get(c).then(function(t){u.resolve(t)},function(t){u.reject(t)}),u},getCompaniesFinData:function(t,e,a,r,n,i){var l=_.map(n,function(t){return i?"parameter="+t+"&parameter=Gs"+t+"&parameter=Nns"+t:"parameter="+t});l=l.join("&");var o,s;switch(e){case"month":"Month",o=moment().startOf("month").subtract(-a,"months"),s=moment().startOf("month").subtract(-1-a,"months").subtract(1,"day");break;case"quarter":"Quarter",o=moment().startOf("quarter").subtract(-a,"quarters"),s=moment().startOf("quarter").subtract(-1-a,"quarters").subtract(1,"day");break;case"year":"Year",o=moment().startOf("year").subtract(-a,"years"),s=moment().startOf("year").subtract(-1-a,"years").subtract(1,"day")}if(o=o.format("YYYY-MM-DD"),s=s.format("YYYY-MM-DD"),4===r)var c=g.getApiUrl()+"fin/"+v[t]+"/"+D[r]+"/2006-06-12/2100-01-01?branchId=00000000-0000-0000-0000-000000000000&targetObject=branch&periodBy=None&"+l;else c=g.getApiUrl()+"fin/"+v[t]+"/"+D[r]+"/"+o+"/"+s+"?branchId=00000000-0000-0000-0000-000000000000&targetObject=branch&periodBy=None&"+l;console.log(c);var u=p.defer();return h.get(c).then(function(t){u.resolve(t)},function(t){u.reject(t)}),u},getCompaniesFinDynamicData:function(t,e,a,r,n,i){var l=_.map(n,function(t){return i?"parameter="+t+"&parameter=Gs"+t+"&parameter=Nns"+t:"parameter="+t});l=l.join("&");var o,s,c=null;switch(e){case"month":c="Month",o=moment().startOf("month").subtract(10-a,"months"),(s=moment().startOf("month").subtract(-1-a-10,"months").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("month").format("YYYY-MM-DD")&&(s=moment().endOf("month")),o.format("YYYY-MM-DD")<"2013-01-01"&&(o=moment("2013-01-01"));break;case"quarter":c="Quarter",o=moment().startOf("quarter").subtract(10-a,"quarters"),(s=moment().startOf("quarter").subtract(-1-a-10,"quarters").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("quarter").format("YYYY-MM-DD")&&(s=moment().endOf("quarter")),o.format("YYYY-MM-DD")<"2013-01-01"&&(o=moment("2013-01-01"));break;case"year":c="Year",o=moment().startOf("year").subtract(10-a,"years"),(s=moment().startOf("year").subtract(-1-a-10,"years").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("year").format("YYYY-MM-DD")&&(s=moment().endOf("year")),o.format("YYYY-MM-DD")<"2013-01-01"&&(o=moment("2013-01-01"))}if(o=o.format("YYYY-MM-DD"),s=s.format("YYYY-MM-DD"),4===r)var u=g.getApiUrl()+"fin/"+v[t]+"/"+D[r]+"/2006-06-12/2100-01-01?targetObject=Gpn&periodBy="+c+"&"+l;else u=g.getApiUrl()+"fin/"+v[t]+"/"+D[r]+"/"+o+"/"+s+"?targetObject=Gpn&periodBy="+c+"&"+l;console.log(u);var d=p.defer();return h.get(u).then(function(t){d.resolve(t)},function(t){d.reject(t)}),d},getFieldsFinData:function(t,e,a,r,n,i,l){var o=_.map(i,function(t){return l?"parameter="+t+"&parameter=Gs"+t+"&parameter=Nns"+t:"parameter="+t});o=o.join("&");var s,c;switch(a){case"month":"Month",s=moment().startOf("month").subtract(-r,"months"),c=moment().startOf("month").subtract(-1-r,"months").subtract(1,"day");break;case"quarter":"Quarter",s=moment().startOf("quarter").subtract(-r,"quarters"),c=moment().startOf("quarter").subtract(-1-r,"quarters").subtract(1,"day");break;case"year":"Year",s=moment().startOf("year").subtract(-r,"years"),c=moment().startOf("year").subtract(-1-r,"years").subtract(1,"day")}if(s=s.format("YYYY-MM-DD"),c=c.format("YYYY-MM-DD"),4===n)var u=g.getApiUrl()+"fin/"+v[e]+"/"+D[n]+"/2006-06-12/2100-01-01?targetObject=Locality&branchId="+t+"&periodBy=None&"+o;else u=g.getApiUrl()+"fin/"+v[e]+"/"+D[n]+"/"+s+"/"+c+"?targetObject=Locality&branchId="+t+"&periodBy=None&"+o;console.log(u);var d=p.defer();return h.get(u).then(function(t){d.resolve(t)},function(t){d.reject(t)}),d},getFieldsFinDynamicData:function(t,e,a,r,n,i,l){var o=_.map(i,function(t){return l?"parameter="+t+"&parameter=Gs"+t+"&parameter=Nns"+t:"parameter="+t});o=o.join("&");var s,c,u=null;switch(a){case"month":u="Month",s=moment().startOf("month").subtract(10-r,"months"),(c=moment().startOf("month").subtract(-1-r-10,"months").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("month").format("YYYY-MM-DD")&&(c=moment().endOf("month")),s.format("YYYY-MM-DD")<"2013-01-01"&&(s=moment("2013-01-01"));break;case"quarter":u="Quarter",s=moment().startOf("quarter").subtract(10-r,"quarters"),(c=moment().startOf("quarter").subtract(-1-r-10,"quarters").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("quarter").format("YYYY-MM-DD")&&(c=moment().endOf("quarter")),s.format("YYYY-MM-DD")<"2013-01-01"&&(s=moment("2013-01-01"));break;case"year":u="Year",s=moment().startOf("year").subtract(10-r,"years"),(c=moment().startOf("year").subtract(-1-r-10,"years").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("year").format("YYYY-MM-DD")&&(c=moment().endOf("year")),s.format("YYYY-MM-DD")<"2013-01-01"&&(s=moment("2013-01-01"))}if(s=s.format("YYYY-MM-DD"),c=c.format("YYYY-MM-DD"),4===n)var d=g.getApiUrl()+"fin/"+v[e]+"/"+D[n]+"/2006-06-12/2100-01-01?targetObject=Branch&branchId="+t+"&periodBy="+u+"&"+o;else d=g.getApiUrl()+"fin/"+v[e]+"/"+D[n]+"/"+s+"/"+c+"?targetObject=Branch&branchId="+t+"&periodBy="+u+"&"+o;console.log(d);var m=p.defer();return h.get(d).then(function(t){m.resolve(t)},function(t){m.reject(t)}),m},getFieldFinData:function(t,e,a,r,n,i,l){var o=_.map(i,function(t){return l?"parameter="+t+"&parameter=Gs"+t+"&parameter=Nns"+t:"parameter="+t});o=o.join("&");var s,c,u=null;switch(a){case"month":u="Month",s=moment().startOf("month").subtract(10-r,"months"),(c=moment().startOf("month").subtract(-1-r-10,"months").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("month").format("YYYY-MM-DD")&&(c=moment().endOf("month")),s.format("YYYY-MM-DD")<"2013-01-01"&&(s=moment("2013-01-01"));break;case"quarter":u="Quarter",s=moment().startOf("quarter").subtract(10-r,"quarters"),(c=moment().startOf("quarter").subtract(-1-r-10,"quarters").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("quarter").format("YYYY-MM-DD")&&(c=moment().endOf("quarter")),s.format("YYYY-MM-DD")<"2013-01-01"&&(s=moment("2013-01-01"));break;case"year":u="Year",s=moment().startOf("year").subtract(10-r,"years"),(c=moment().startOf("year").subtract(-1-r-10,"years").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("year").format("YYYY-MM-DD")&&(c=moment().endOf("year")),s.format("YYYY-MM-DD")<"2013-01-01"&&(s=moment("2013-01-01"))}if(s=s.format("YYYY-MM-DD"),c=c.format("YYYY-MM-DD"),4===n)var d=g.getApiUrl()+"fin/"+v[e]+"/"+D[n]+"/2006-06-12/2100-01-01?targetObject=locality&periodBy="+u+"&localityId="+t+"&"+o;else d=g.getApiUrl()+"fin/"+v[e]+"/"+D[n]+"/"+s+"/"+c+"?targetObject=locality&periodBy="+u+"&localityId="+t+"&"+o;console.log(d);var m=p.defer();return h.get(d).then(function(t){m.resolve(t)},function(t){m.reject(t)}),m},getFieldDn7FinData:function(t,e,a,r,n,i,l,o){var s=_.map(i,function(t){return"Gs"===l?"parameter=Gs"+t:"Nns"===l?"parameter=Nns"+t:""});s=s.join("&");var c,u,d=null;switch(a){case"month":d="Month",c=moment().startOf("month").subtract(10-r,"months"),(u=moment().startOf("month").subtract(-1-r-10,"months").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("month").format("YYYY-MM-DD")&&(u=moment().endOf("month")),c.format("YYYY-MM-DD")<"2013-01-01"&&(c=moment("2013-01-01"));break;case"quarter":d="Quarter",c=moment().startOf("quarter").subtract(10-r,"quarters"),(u=moment().startOf("quarter").subtract(-1-r-10,"quarters").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("quarter").format("YYYY-MM-DD")&&(u=moment().endOf("quarter")),c.format("YYYY-MM-DD")<"2013-01-01"&&(c=moment("2013-01-01"));break;case"year":d="Year",c=moment().startOf("year").subtract(10-r,"years"),(u=moment().startOf("year").subtract(-1-r-10,"years").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("year").format("YYYY-MM-DD")&&(u=moment().endOf("year")),c.format("YYYY-MM-DD")<"2013-01-01"&&(c=moment("2013-01-01"))}if(c=c.format("YYYY-MM-DD"),u=u.format("YYYY-MM-DD"),4===n)var m=g.getApiUrl()+"fin/"+v[e]+"/"+D[n]+"/2006-06-12/2100-01-01?targetObject=locality&periodBy="+d+"&localityId="+t;else m=g.getApiUrl()+"fin/"+v[e]+"/"+D[n]+"/"+c+"/"+u+"?targetObject=locality&periodBy="+d+"&localityId="+t;l&&(m+="&"+s+("Gs"===l&&o?"&dn7Gs="+o:"")+("Nns"===l&&o?"&dn7Nns="+o:"")),console.log(m);var f=p.defer();return h.get(m).then(function(t){f.resolve(t)},function(t){f.reject(t)}),f},getWellsFinData:function(t,e,a,r,n,i,l){var o,s,c=null;switch(a){case"month":c="Month",o=moment().startOf("month").subtract(-r,"months"),s=moment().startOf("month").subtract(-1-r,"months").subtract(1,"day");break;case"quarter":c="Quarter",o=moment().startOf("quarter").subtract(-r,"quarters"),s=moment().startOf("quarter").subtract(-1-r,"quarters").subtract(1,"day");break;case"year":c="Year",o=moment().startOf("year").subtract(-r,"years"),s=moment().startOf("year").subtract(-1-r,"years").subtract(1,"day")}o=o.format("YYYY-MM-DD"),s=s.format("YYYY-MM-DD");var u=_.map(i,function(t){return"parameter="+l+t});if(u=u.join("&"),4===n)var d=g.getApiUrl()+"fin/"+v[e]+"/"+D[n]+"/2006-06-12/2100-01-01?targetObject=well&periodBy="+c+"&localityId="+t+"&"+u;else d=g.getApiUrl()+"fin/"+v[e]+"/"+D[n]+"/"+o+"/"+s+"?targetObject=well&periodBy="+c+"&localityId="+t+"&"+u;console.log(d);var m=p.defer();return h.get(d).then(function(t){m.resolve(t)},function(t){m.reject(t)}),m},getContractorData:function(t,e){var a=g.getApiUrl()+"contractor/"+t+"/card?line="+e;return console.log(a),h.get(a)},getContractsData:function(t,e,a,r){r&&(r=encodeURIComponent(r));var n=g.getServerUrl()+"odata/Agreements?$skip="+t+"&$top="+e+(a?"&$orderby="+a:"")+(r?"&$filter="+r:"");console.log(n);var i=p.defer();return h.get(n).then(function(t){i.resolve(t)},function(t){i.reject(t)}),i},getContractsCount:function(t){t&&(t=encodeURIComponent(t));var e=g.getServerUrl()+"odata/Agreements/$count?"+(t?"$filter="+t:"");console.log(e);var a=p.defer();return h.get(e).then(function(t){a.resolve(parseInt(t.data))},function(t){a.reject(t)}),a},getContractsYears:function(){var t=g.getApiUrl()+"agreement/years";console.log(t);var e=p.defer();return h.get(t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e},getContractsServices:function(){var t=g.getApiUrl()+"agreement/services";console.log(t);var e=p.defer();return h.get(t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e},getPermitDocumentsData:function(t,e,a,r){r&&(r=encodeURIComponent(r));var n=g.getServerUrl()+"odata/WellDoc?$skip="+t+"&$top="+e+(a?"&$orderby="+a:"")+(r?"&$filter="+r:"");console.log(n);var i=p.defer();return h.get(n).then(function(t){i.resolve({items:t.data.value,totalCount:Number(t.headers()["x-total-count"])})},function(t){i.reject(t)}),i},getPermitDocumentsCount:function(t){t&&(t=encodeURIComponent(t));var e=g.getServerUrl()+"odata/WellDoc/$count?"+(t?"$filter="+t:"");console.log(e);var a=p.defer();return h.get(e).then(function(t){a.resolve(parseInt(t.data))},function(t){a.reject(t)}),a},getPermitDocumentsYears:function(){var t=g.getApiUrl()+"Rd/years";console.log(t);var e=p.defer();return h.get(t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e},getPermitDocumentTypes:function(){var t=g.getApiUrl()+"Rd/doctype";console.log(t);var e=p.defer();return h.get(t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e},getPsdDocumentsData:function(t,e,a,r){r&&(r=encodeURIComponent(r));var n=g.getServerUrl()+"odata/Psd?$skip="+t+"&$top="+e+(a?"&$orderby="+a:"")+(r?"&$filter="+r:"");console.log(n);var i=p.defer();return h.get(n).then(function(t){i.resolve(t)},function(t){i.reject(t)}),i},getPsdDocument:function(t){var e=g.getServerUrl()+"odata/Psd("+t+")";console.log(e);var a=p.defer();return h.get(e).then(function(t){a.resolve(t)},function(t){a.reject(t)}),a},getPsdDocumentsCount:function(t){t&&(t=encodeURIComponent(t));var e=g.getServerUrl()+"odata/Psd/$count?"+(t?"$filter="+t:"");console.log(e);var a=p.defer();return h.get(e).then(function(t){a.resolve(parseInt(t.data))},function(t){a.reject(t)}),a},getPsdDocumentsYears:function(){var t=g.getApiUrl()+"Psd/years";console.log(t);var e=p.defer();return h.get(t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e},getPsdDocumentTypes:function(){var t=g.getApiUrl()+"psd/doctype";console.log(t);var e=p.defer();return h.get(t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e},getPsdDiameters:function(){var t=g.getApiUrl()+"well/psd/diameters";console.log(t);var e=p.defer();return h.get(t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e},editPermitDocument:function(t){var e=new FormData;e.append("dataVvodaVOsnovnyeFondy",t.dataVvodaVOsnovnyeFondy||""),e.append("projectNumber",t.projectNumber||""),e.append("branchName",t.branchName||""),e.append("localityName",t.localityName||""),e.append("clusterName",t.clusterName||""),e.append("wellName",t.wellName||"");var a=g.getApiUrl()+"welldoc",r=p.defer();return h.post(a,e,{headers:{Accept:"text/html,application/xhtml+xml,application/xml","Content-Type":void 0},transformRequest:angular.identity}).then(function(t){r.resolve(t)},function(t){r.reject(t)}),r},addPermitDocument:function(t){var e=new FormData;e.append("file",t.file||""),e.append("branchName",t.branchName||""),e.append("localityName",t.localityName||""),e.append("clusterName",t.clusterName||""),e.append("wellName",t.wellName||""),e.append("documentType",t.documentType||""),e.append("developmentDate",t.developmentDate&&"Invalid date"!==t.developmentDate?t.developmentDate:"");var a=g.getApiUrl()+"rd",r=p.defer();return h.post(a,e,{headers:{Accept:"text/html,application/xhtml+xml,application/xml","Content-Type":void 0},transformRequest:angular.identity}).then(function(t){r.resolve(t)},function(t){r.reject(t)}),r},addPsdDocument:function(t){var e=new FormData;e.append("branchUid",t.branchUid?t.branchUid:""),e.append("localityUid",t.localityUid?t.localityUid:""),e.append("documentType",t.documentTypeId?t.documentTypeId:""),e.append("profileType",t.profileTypeId?t.profileTypeId:""),e.append("projectName",t.projectName?t.projectName:""),e.append("projectNumber",t.projectNumber?t.projectNumber:""),e.append("developmentDate",t.developmentDate&&"Invalid date"!==t.developmentDate?t.developmentDate:""),e.append("file",t.file?t.file:""),e.append("inspectionFileRequired",t.inspectionFileRequired?"true":"false"),e.append("inspectionFileDate",t.inspectionFileRequired&&t.inspectionFileDate&&"Invalid date"!==t.inspectionFileDate?t.inspectionFileDate:""),e.append("inspectionFile",t.inspectionFileRequired&&t.inspectionFile?t.inspectionFile:""),e.append("ecoInspectionFileRequired",t.ecoInspectionFileRequired?"true":"false"),e.append("ecoInspectionFileDate",t.ecoInspectionFileRequired&&t.ecoInspectionFileDate&&"Invalid date"!==t.ecoInspectionFileDate?t.ecoInspectionFileDate:""),e.append("ecoInspectionFile",t.ecoInspectionFileRequired&&t.ecoInspectionFile?t.ecoInspectionFile:""),e.append("promInspectionFileRequired",t.promInspectionFileRequired?"true":"false"),e.append("promInspectionFileDate",t.promInspectionFileRequired&&t.promInspectionFileDate&&"Invalid date"!==t.promInspectionFileDate?t.promInspectionFileDate:""),e.append("promInspectionFile",t.promInspectionFileRequired&&t.promInspectionFile?t.promInspectionFile:""),e.append("objUid",t.objUid?t.objUid:""),e.append("drillType",t.drillType?t.drillType:""),e.append("wellCategory",t.wellCategory?t.wellCategory:""),e.append("measuredDepthActualSign",t.measuredDepthActualSign?t.measuredDepthActualSign:""),e.append("measuredDepthActual",t.measuredDepthActual?t.measuredDepthActual:""),e.append("measuredDepthActualIntervalGreaterValue",t.measuredDepthActualIntervalGreaterValue?t.measuredDepthActualIntervalGreaterValue:""),e.append("verticalDepthActualSign",t.verticalDepthActualSign?t.verticalDepthActualSign:""),e.append("verticalDepthActual",t.verticalDepthActual?t.verticalDepthActual:""),e.append("verticalDepthActualIntervalGreaterValue",t.verticalDepthActualIntervalGreaterValue?t.verticalDepthActualIntervalGreaterValue:""),e.append("offsetActualSign",t.offsetActualSign?t.offsetActualSign:""),e.append("offsetActual",t.offsetActual?t.offsetActual:""),e.append("offsetActualIntervalGreaterValue",t.offsetActualIntervalGreaterValue?t.offsetActualIntervalGreaterValue:""),e.append("casingDiameterActualSign",t.casingDiameterActualSign?t.casingDiameterActualSign:""),e.append("casingDiameterActual",t.casingDiameterActual?t.casingDiameterActual:""),e.append("casingDiameterActualIntervalGreaterValue",t.casingDiameterActualIntervalGreaterValue?t.casingDiameterActualIntervalGreaterValue:""),e.append("casingShoeDepthActualSign",t.casingShoeDepthActualSign?t.casingShoeDepthActualSign:""),e.append("casingShoeDepthActual",t.casingShoeDepthActual?t.casingShoeDepthActual:""),e.append("casingShoeDepthActualIntervalGreaterValue",t.casingShoeDepthActualIntervalGreaterValue?t.casingShoeDepthActualIntervalGreaterValue:""),e.append("horizon",t.horizon?t.horizon:"");var a=g.getApiUrl()+"psd",r=p.defer();return h.post(a,e,{headers:{Accept:"text/html,application/xhtml+xml,application/xml","Content-Type":void 0},transformRequest:angular.identity}).then(function(t){r.resolve(t)},function(t){r.reject(t)}),r},getPsdEntity:function(t){var e=g.getApiUrl()+"psd/"+t+"/entity",a=p.defer();return h.get(e).then(function(t){a.resolve(t)},function(t){a.reject(t)}),a},getDrillPlanWells:function(){var t=g.getApiUrl()+"ru-ru/drillplan/well";console.log(t);var e=p.defer();return h.get(t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e},getContractor2Data:function(t,e,a,r,n,i){var l,o;switch(e){case"month":l=moment().startOf("month").subtract(-a,"months"),o=moment().startOf("month").subtract(-1-a,"months").subtract(1,"day");break;case"quarter":l=moment().startOf("quarter").subtract(-a,"quarters"),o=moment().startOf("quarter").subtract(-1-a,"quarters").subtract(1,"day");break;case"year":l=moment().startOf("year").subtract(-a,"years"),o=moment().startOf("year").subtract(-1-a,"years").subtract(1,"day")}l=l.format("YYYY-MM-DD"),o=o.format("YYYY-MM-DD");var s=g.getApiUrl()+"contractor2/"+l+"/"+o+"/"+t+"/card?drillType="+["eb","zbs","prb"][r]+(n&&!i?"&branchId="+n:"")+(i?"&localityId="+i:"");console.log(s);var c=p.defer();return h.get(s).then(function(t){c.resolve(t)},function(t){c.reject(t)}),c},deleteDocument:function(t){var e=g.getApiUrl()+"document/"+t,a=p.defer();return h.delete(e).then(function(t){a.resolve(t)},function(t){a.reject(t)}),a},getPlans:function(){var t=g.getApiUrl()+"ru-RU/plan",e=p.defer();return h.get(t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e},getPlan:function(t){var e=g.getApiUrl()+"ru-RU/plan/"+t,a=p.defer();return h.get(e).then(function(t){a.resolve(t)},function(t){a.reject(t)}),a},changePlanStatus:function(t,e){var a=g.getApiUrl()+"ru-RU/plan/"+t,r=p.defer();return h.put(a,{PlanStatus:e}).then(function(t){r.resolve(t)},function(t){r.reject(t)}),r},getLessonsDocs:function(){var t=g.getApiUrl()+"lessons/docs",e=p.defer();return h.get(t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e},getLessonsVideos:function(){var t=g.getApiUrl()+"lessons/videos",e=p.defer();return h.get(t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e},getWhatsNew:function(){var t=g.getApiUrl()+"whats_new",e=p.defer();return h.get(t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e},getReportname:function(t,e,a,r,n){var i=g.getApiUrl()+"reportname",l=p.defer();return h.post(i,{Objects:t,ObjectsType:e,DateFrom:a,InclusiveDateTo:r,ReportName:n}).then(function(t){l.resolve(t)},function(t){l.reject(t)}),l},getCostDay:function(t,e,a,r){var n,i;switch(e){case"month":n=moment().startOf("month").subtract(-r,"months"),i=moment().startOf("month").subtract(-1-r,"months").subtract(1,"day");break;case"quarter":n=moment().startOf("quarter").subtract(-r,"quarters"),i=moment().startOf("quarter").subtract(-1-r,"quarters").subtract(1,"day");break;case"year":n=moment().startOf("year").subtract(-r,"years"),i=moment().startOf("year").subtract(-1-r,"years").subtract(1,"day")}n=n.format("YYYY-MM-DD"),i=i.format("YYYY-MM-DD");var l=g.getApiUrl()+"dailycost/pivot/"+v[t]+"/"+D[a]+"/"+n+"/"+i;console.log(l);var o=p.defer();return h.get(l).then(function(t){o.resolve(t)},function(t){o.reject(t)}),o},getRatindDo:function(){var t=g.getApiUrl()+"dzo_rating";console.log(t);var e=p.defer();return h.get(t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e},saveRatingDo:function(t){var e=g.getApiUrl()+"dzo_rating";console.log(e);var a=p.defer();return h.post(e,t).then(function(t){a.resolve(t)},function(t){a.reject(t)}),a},loadRatingDoMonthData:function(t,e,a,r){console.log("monthNum="+a);var n=a-1,i=11===n?0:n+1,l=11===n?e+1:e,o=new Date(e,a-1,1),s=new Date(l,i,1),c=o.toISODate(),u=s.toISODate(),d=g.getApiUrl()+"dzo_rating_calc_val/"+t+"/"+c+"/"+u+"/?pid="+r;console.log(d);var m=p.defer();return h.get(d).then(function(t){m.resolve(t)},function(t){m.reject(t)}),m}}}]),angular.module("smbApp").controller("FieldChartCtrl",["$scope","$location","$q","$timeout","$routeParams","chartSeriesColors","appSettings","companiesData","fieldsAttributesData","utils","refData","physChartsData","apiData","xlsx","saveFile","authData","config",function(o,e,t,a,r,n,i,l,s,c,u,d,m,f,p,h,g){if(o.authData&&o.authData.CanViewPhysData){var v;o.$on("$destroy",function(){C()}),o.filter={wellState:1,timeKey:"month",timeCount:0,drillType:0,reverseMarkers:-1!==["npv","drillingBrigades","explorationBrigades"].indexOf(r.attributeName),gsDn7Filter:null,nnsDn7Filter:null,lineId:null,showTable:!1,showTableNns:!1,showTableGs:!1,showValues:!0,showAverageLines:[!0,!1,!0,!1],showAverageLinesNns:[!0,!1,!0,!1],showAverageLinesGs:[!0,!1,!0,!1],showMarkers:[[!1,!0],[!1,!0]],showMarkersYear:[[!0,!0],[!0,!0]],showMarkersNns:[[!1,!0],[!1,!0]],showMarkersYearNns:[[!0,!0],[!0,!0]],showMarkersGs:[[!1,!0],[!1,!0]],showMarkersYearGs:[[!0,!0],[!0,!0]],hideAllAverageLines:!1,tiltXAxisTextNns:!0,tiltXAxisTextGs:!0,tiltXAxisTextNnsContractors:!0,tiltXAxisTextContractors:!0,tiltXAxisTextGsContractors:!0,attributeName:r.attributeName},o.data={params:[],splitCharts:!1,lines:[],contractors:[],error:null,loaded:!1,chartsLoaded:!1,fieldNnsLoaded:!1,fieldNnsError:!1,fieldGsLoaded:!1,fieldGsError:!1,companyUID:r.companyUID,company:null,companies:[],fieldUID:r.fieldUID,field:null,fields:[],gsDn7Filters:[],nnsDn7Filters:[],physCharts:[],physChart:null},(v=i.getSettings("app"))&&angular.extend(o.filter,v),o.$watch("filter",function(){C()},!0),t.all([u.getData(),l.getData(),d.getData()]).then(function(t){a(function(){o.data.companies=l.getCompaniesNames(),o.data.company=_.find(o.data.companies,{UID:r.companyUID}),o.data.fields=l.getCompanyFieldsNames(r.companyUID),o.data.field=_.find(o.data.fields,{UID:r.fieldUID}),o.data.gsDn7Filters=u.getDn7GsFilters(),o.data.nnsDn7Filters=u.getDn7NnsFilters(),o.data.physCharts=t[2],o.data.physChart=_.find(o.data.physCharts,{Id:o.filter.attributeName}),o.data.splitCharts=o.data.physChart&&o.data.physChart.Parameters&&1<o.data.physChart.Parameters.length,o.data.loaded=!0,M()},400)}),o.$watch("filter.wellState",function(t,e){t!==e&&M()}),o.$watch("filter.timeKey",function(t,e){t!==e&&M()}),o.$watch("filter.timeCount",function(t,e){t!==e&&M()}),o.$watch("filter.drillType",function(t,e){t!==e&&M()}),o.$watch("filter.attributeName",function(t,e){t!==e&&(window.location.href="#/fieldChart/"+t+"/"+o.data.companyUID+"/"+o.data.fieldUID)}),o.$watch("filter.nnsDn7Filter",function(t,e){t!==e&&N()}),o.$watch("filter.gsDn7Filter",function(t,e){t!==e&&Y()});var D=null;o.$watch("filter.lineId",I);var y=null,b=null;o.getAttributeFullName=function(t){var e=_.find(o.data.physCharts,{Id:t});return e&&e.Name||t},o.getAttributeNameWithUom=function(t){var e=_.find(o.data.physCharts,{Id:t});return e&&e.Name+", "+e.Uom||t},o.planFactChatsColors=n.planFactChatsColors,o.factChatsColor=n.factChatsColor,o.onlyFactChatsColor=[o.factChatsColor[1]],o.selectField=function(t){e.path("/fieldChart/"+o.filter.attributeName+"/"+o.data.companyUID+"/"+t.UID)},o.singleCompany=h.singleCompany,o.getExcel=function(){var t,e,a=["eb","zbs","prb"],r=["undefined","drilling","drilled","builded","active"],n=null;switch(o.filter.timeKey){case"month":n="Month",t=moment().startOf("month").subtract(10-o.filter.timeCount,"months"),(e=moment().startOf("month").subtract(-1-o.filter.timeCount-10,"months").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("month").format("YYYY-MM-DD")&&(e=moment().endOf("month")),t.format("YYYY-MM-DD")<"2013-01-01"&&(t=moment("2013-01-01"));break;case"quarter":n="Quarter",t=moment().startOf("quarter").subtract(10-o.filter.timeCount,"quarters"),(e=moment().startOf("quarter").subtract(-1-o.filter.timeCount-10,"quarters").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("quarter").format("YYYY-MM-DD")&&(e=moment().endOf("quarter")),t.format("YYYY-MM-DD")<"2013-01-01"&&(t=moment("2013-01-01"));break;case"year":n="Year",t=moment().startOf("year").subtract(10-o.filter.timeCount,"years"),(e=moment().startOf("year").subtract(-1-o.filter.timeCount-10,"years").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("year").format("YYYY-MM-DD")&&(e=moment().endOf("year")),t.format("YYYY-MM-DD")<"2013-01-01"&&(t=moment("2013-01-01"))}if(t=t.format("YYYY-MM-DD"),e=e.format("YYYY-MM-DD"),o.data.splitCharts){if(4===o.filter.wellState)var i=g.getApiUrl()+"physreport/3/"+a[o.filter.drillType]+"/"+r[o.filter.wellState]+"/2006-06-12/2100-01-01/?targetObject=locality&periodBy="+n+"&localityId="+o.data.fieldUID+"&parameter="+o.filter.attributeName;else i=g.getApiUrl()+"physreport/3/"+a[o.filter.drillType]+"/"+r[o.filter.wellState]+"/"+t+"/"+e+"/?targetObject=locality&periodBy="+n+"&localityId="+o.data.fieldUID+"&parameter="+o.filter.attributeName;i+="&profiles=Nns&profiles=Gs"+(o.filter.gsDn7Filter?"&dn7Gs="+gsDn7Filter:"")+(o.filter.nnsDn7Filter?"&dn7Nns="+o.filter.nnsDn7Filter:"")}else if(4===o.filter.wellState)i=g.getApiUrl()+"physreport/3/"+a[o.filter.drillType]+"/"+r[o.filter.wellState]+"/2006-06-12/2100-01-01?targetObject=locality&periodBy="+n+"&localityId="+o.data.fieldUID+"&parameter="+o.filter.attributeName;else i=g.getApiUrl()+"physreport/3/"+a[o.filter.drillType]+"/"+r[o.filter.wellState]+"/"+t+"/"+e+"?targetObject=locality&periodBy="+n+"&localityId="+o.data.fieldUID+"&parameter="+o.filter.attributeName;window.open(i,"_blank").focus()}}else e.path("/main");function C(){var t={wellState:o.filter.wellState,timeKey:o.filter.timeKey,drillType:o.filter.drillType,showValues:o.filter.showValues,timeCount:o.filter.timeCount};i.setSettings("app",t)}function w(){D&&D.reject("cancel"),_.find(o.data.physChart&&o.data.physChart.TrendWellStates,function(t){return t===o.filter.wellState})?o.filter.hideAllAverageLines=!1:o.filter.hideAllAverageLines=!0;var t=_.filter(o.data.physCharts,function(t){return-1!==t.DrillTypes.indexOf(o.filter.drillType)});t=_.filter(t,function(t){return-1!==t.WellStates.indexOf(o.filter.wellState)});return o.data.params=_.pluck(t,"Id"),-1==o.data.params.indexOf(o.filter.attributeName)&&(o.filter.attributeName=o.data.params[0]),o.data.splitCharts?(o.data.chartsData.gsContractors=null,o.data.chartsData.nnsContractors=null,(D=m.getFieldData(o.data.fieldUID,o.filter.drillType,o.filter.timeKey,o.filter.timeCount,o.filter.wellState,o.filter.attributeName,!0)).promise.then(function(t){var e=t.data,a=_.find(e,{Parameter:o.filter.attributeName+"Nns"}),r=_.find(e,{Parameter:o.filter.attributeName+"Nns"});if(r&&(r=r.Contractors),r&&r.length){var n={uom:o.data.physChart&&o.data.physChart.Uom,displayName:o.data.physChart&&o.data.physChart.Name,yAxisTitle:" ",values:[],format:a&&a.Format};_.forEach(r,function(t){n.values.push({lineName:t.LineName,title:t.DisplayName?t.DisplayName:"Н/Д",points:[{values:[{val:t.Value}]}],link:function(){"nonProductivePc"===o.filter.attributeName?window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card"+(o.filter.lineId?"?lineId="+o.filter.lineId:""):window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card?lineId=a7588dfd-1e2e-4cb9-a60d-3a5b875bd216"}})}),o.data.chartsData.nnsContractorsSrc=c.sortChart(n),o.data.chartsData.nnsContractors=_.cloneDeep(o.data.chartsData.nnsContractorsSrc)}var i=_.find(e,{Parameter:o.filter.attributeName+"Gs"}),l=_.find(e,{Parameter:o.filter.attributeName+"Gs"});if(i&&(i=i.Contractors),i&&i.length){n={uom:o.data.physChart&&o.data.physChart.Uom,displayName:o.data.physChart&&o.data.physChart.Name,yAxisTitle:" ",values:[],format:l&&l.Format};_.forEach(i,function(t){n.values.push({lineName:t.LineName,title:t.DisplayName?t.DisplayName:"Н/Д",points:[{values:[{val:t.Value}]}],link:function(){"nonProductivePc"===o.filter.attributeName?window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card"+(o.filter.lineId?"?lineId="+o.filter.lineId:""):window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card?lineId=a7588dfd-1e2e-4cb9-a60d-3a5b875bd216"}})}),o.data.chartsData.gsContractorsSrc=c.sortChart(n),o.data.chartsData.gsContractors=_.cloneDeep(o.data.chartsData.gsContractorsSrc)}})):(o.data.chartsData.field=null,o.data.chartsData.fieldObjects=null,o.data.chartsData.contractors=null,(D=m.getFieldData(o.data.fieldUID,o.filter.drillType,o.filter.timeKey,o.filter.timeCount,o.filter.wellState,o.filter.attributeName)).promise.then(function(t){var e=t.data[0];if(e.Objects&&e.Objects.length){var a={uom:o.data.physChart&&o.data.physChart.Uom,displayName:o.data.physChart&&o.data.physChart.Name,yAxisTitle:" ",values:[],averageLines:[],format:e&&e.Format};e.Objects=c.sortTimeObject(e.Objects),_.forEach(e.Objects,function(t){a.values.push({title:A(t),points:"year"===o.filter.timeKey?[{values:[{val:t.Value,color:t.Color}]}]:[{values:[{val:t.PrevValue,color:t.Color},{val:t.Value,color:t.Color}]}],link:"/wellsChart/"+o.filter.attributeName+"/"+o.data.companyUID+"/"+o.data.fieldUID+"?month="+t.Month+"&quarter="+t.Quarter+"&year="+t.Year})}),a.averageLines.push({value:e.TrendValue}),o.data.chartsData.field=a,o.data.chartsData.fieldObjects=_.map(e.Objects,function(t){return t.DisplayName=A(t),t})}o.data.lines=[],o.data.contractors=e.Contractors,e.Contractors&&e.Contractors.length&&(_.forEach(e.Contractors,function(t){o.data.lines.push({id:t.LineId,name:t.LineName,format:e&&e.Format})}),o.data.lines=_.uniq(o.data.lines,"id")),o.data.lines.unshift({id:null,name:"Все",format:e&&e.Format}),I()})),D.promise}function I(){var t=_.find(o.data.lines,{id:o.filter.lineId}),e=o.data.contractors;o.data.chartsData=o.data.chartsData||{},o.filter.lineId&&(e=_.filter(e,{LineId:o.filter.lineId}));var a={uom:o.data.physChart&&o.data.physChart.Uom,displayName:o.data.physChart&&o.data.physChart.Name,yAxisTitle:" ",values:[],format:t&&t.format};_.forEach(e,function(t){a.values.push({lineName:t.LineName,title:t.DisplayName?t.DisplayName:"Н/Д",points:[{values:[{val:t.Value}]}],link:function(){"nonProductivePc"===o.filter.attributeName?window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card"+(o.filter.lineId?"?lineId="+o.filter.lineId:""):window.location.href="#/contractor/"+t.ObjId.toUpperCase()+"/card?lineId=a7588dfd-1e2e-4cb9-a60d-3a5b875bd216"}})}),o.data.chartsData.contractorsSrc=c.sortChart(a),o.data.chartsData.contractors=_.cloneDeep(o.data.chartsData.contractorsSrc)}function N(){return y&&y.reject("cancel"),o.data.fieldNnsLoaded=!1,o.data.fieldNnsError=null,o.data.chartsData.fieldNns=null,o.data.chartsData.fieldNnsObjects=null,(y=m.getFieldDn7Data(o.data.fieldUID,o.filter.drillType,o.filter.timeKey,o.filter.timeCount,o.filter.wellState,o.filter.attributeName,"Nns",o.filter.nnsDn7Filter)).promise.then(function(t){var e=t.data[0];if(e&&e.Objects&&e.Objects.length){var a={uom:o.data.physChart&&o.data.physChart.Uom,displayName:o.data.physChart&&o.data.physChart.Name,yAxisTitle:" ",values:[],averageLines:[],format:e&&e.Format};e.Objects=c.sortTimeObject(e.Objects),_.forEach(e.Objects,function(t){a.values.push({title:A(t),points:"year"===o.filter.timeKey?[{values:[{val:t.Value,color:t.Color}]}]:[{values:[{val:t.PrevValue,color:t.PrevColor},{val:t.Value,color:t.Color}]}],link:"/wellsChart/"+o.filter.attributeName+"/"+o.data.companyUID+"/"+o.data.fieldUID+"?month="+t.Month+"&quarter="+t.Quarter+"&year="+t.Year+"&profiles=Nns"})}),a.averageLines.push({value:e.TrendValue}),o.data.chartsData.fieldNns=a,o.data.chartsData.fieldNnsObjects=_.map(e.Objects,function(t){return t.DisplayName=A(t),t})}o.data.fieldNnsLoaded=!0},function(t){"cancel"!==t&&(o.data.fieldNnsLoaded=!0,o.data.fieldNnsError=t)}),y.promise}function Y(){return b&&b.reject("cancel"),o.data.fieldGsLoaded=!1,o.data.fieldGsError=null,o.data.chartsData.fieldGs=null,o.data.chartsData.fieldGsObjects=null,(b=m.getFieldDn7Data(o.data.fieldUID,o.filter.drillType,o.filter.timeKey,o.filter.timeCount,o.filter.wellState,o.filter.attributeName,"Gs",o.filter.gsDn7Filter)).promise.then(function(t){var e=t.data[0];if(e&&e.Objects&&e.Objects.length){var a={uom:o.data.physChart&&o.data.physChart.Uom,displayName:o.data.physChart&&o.data.physChart.Name,yAxisTitle:" ",values:[],averageLines:[],format:e&&e.Format};e.Objects=c.sortTimeObject(e.Objects),_.forEach(e.Objects,function(t){a.values.push({title:A(t),points:"year"===o.filter.timeKey?[{values:[{val:t.Value,color:t.Color}]}]:[{values:[{val:t.PrevValue,color:t.PrevColor},{val:t.Value,color:t.Color}]}],link:"/wellsChart/"+o.filter.attributeName+"/"+o.data.companyUID+"/"+o.data.fieldUID+"?month="+t.Month+"&quarter="+t.Quarter+"&year="+t.Year+"&profiles=Gs"})}),a.averageLines.push({value:e.TrendValue}),o.data.chartsData.fieldGs=a,o.data.chartsData.fieldGsObjects=_.map(e.Objects,function(t){return t.DisplayName=A(t),t})}o.data.fieldGsLoaded=!0},function(t){"cancel"!==t&&(o.data.fieldGsLoaded=!0,o.data.fieldGsError=t)}),b.promise}function M(){o.data.chartsLoaded=!1,o.data.error=null,o.data.chartsData={},o.data.splitCharts?t.all([w(),N(),Y()]).then(function(t){o.data.chartsLoaded=!0},function(t){"cancel"!==t&&(o.data.chartsLoaded=!0,o.data.error=t)}):w().then(function(){o.data.chartsLoaded=!0},function(t){"cancel"!==t&&(o.data.chartsLoaded=!0,o.data.error=t)})}function A(t){return t.Month?moment().year()===t.Year?moment().month(t.Month-1).format("MMMM"):moment().month(t.Month-1).year(t.Year).format("MMMM YYYYг"):t.Quarter?moment().year()===t.Year?moment().quarter(t.Quarter).format("Q квартал"):moment().quarter(t.Quarter).year(t.Year).format("Q кв YYYYг"):moment().year(t.Year).format("YYYYг")}}]),angular.module("smbApp").service("selectWell",["$rootScope","$q","$filter","$modal",function(c,u,t,d){return function(t,e){var a=function(t,e){return moment(t.drillBeginActual,"DD.MM.YYYY").toDate()-moment(e.drillBeginActual,"DD.MM.YYYY").toDate()},r=u.defer(),n=c.$new(!0);n.search={wellName:""},n.showActiveObjects=!1,n.noActiveObjects=!e||!e.length;var i=_.groupBy(t,"clusterName"),l=[];_.forEach(i,function(t,e){t.sort(a),l.push({name:"none"===e?"Не в кустах":"Куст "+e,children:_.map(t,function(t){return{name:"Скважина "+t.wellName,uid:t.wellUID,drillBeginActual:t.drillBeginActual}})})}),l=_.sortBy(l,function(t){return"Не в кустах"===t.name?-1:0}),n.objectsWellsTree=_.cloneDeep(l),n.expandedObjectsClusters=[];i=_.groupBy(e,"clusterName");var o=[];_.forEach(i,function(t,e){t.sort(a),o.push({name:"none"===e?"Не в кустах":"Куст "+e,children:_.map(t,function(t){return{name:"Скважина "+t.wellName,uid:t.wellUID,drillBeginActual:t.drillBeginActual}})})}),o=_.sortBy(o,function(t){return"Не в кустах"===t.name?-1:0}),n.activeObjectsWellsTree=_.cloneDeep(o),n.expandedActiveObjectsClusters=[],n.$watch("search.wellName",function(a){n.expandedObjectsClusters=[];var r=[];_.forEach(_.cloneDeep(l),function(t){if(-1!==t.name.indexOf(a))return r.push(t),!0;var e=_.filter(t.children,function(t){return-1!==t.name.indexOf(a)});e&&e.length&&(t.children=e,r.push(t),n.expandedObjectsClusters.push(t))}),n.objectsWellsTree=r,n.expandedActiveObjectsClusters=[],r=[],_.forEach(_.cloneDeep(o),function(t){if(-1!==t.name.indexOf(a))return r.push(t),!0;var e=_.filter(t.children,function(t){return-1!==t.name.indexOf(a)});e&&e.length&&(t.children=e,r.push(t),n.expandedActiveObjectsClusters.push(t))}),n.activeObjectsWellsTree=r}),n.showSelected=function(t,e){s.hide(),r.resolve(t.uid)},n.treeOptions={nodeChildren:"children",dirSelectable:!1,multiSelection:!1,injectClasses:{iExpanded:"glyphicon glyphicon-minus",iCollapsed:"glyphicon glyphicon-plus",iLeaf:"glyphicon glyphicon-asterisk"}};var s=d({scope:n,template:"views/modals/select-well.html",show:!0});return r.promise}}]),angular.module("smbApp").directive("tableObjectsChart",["numeraljsFilter",function(i){return{templateUrl:"views/directives/tableObjectsChart.html",restrict:"EA",scope:{objects:"=ngModel",splitted:"=splitted"},link:function(r,t,e){var n=[];r.getRowCells=function(a){return r.objects&&r.objects.all?(n[a]||(n[a]=[],_.forEach(r.objects.all,function(t,e){n[a].push({value:r.objects.nns[e]?i(r.objects.nns[e].ComputedFrom[a].PlanValue,r.objects.nns[e].ComputedFrom[a].Format||"0.0[0000]"):"-",all:!1}),n[a].push({value:r.objects.nns[e]?i(r.objects.nns[e].ComputedFrom[a].Value,r.objects.nns[e].ComputedFrom[a].Format||"0.0[0000]"):"-",all:!1}),n[a].push({value:r.objects.gs[e]?i(r.objects.gs[e].ComputedFrom[a].PlanValue,r.objects.gs[e].ComputedFrom[a].Format||"0.0[0000]"):"-",all:!1}),n[a].push({value:r.objects.gs[e]?i(r.objects.gs[e].ComputedFrom[a].Value,r.objects.gs[e].ComputedFrom[a].Format||"0.0[0000]"):"-",all:!1}),n[a].push({value:r.objects.all[e]?i(r.objects.all[e].ComputedFrom[a].PlanValue,r.objects.all[e].ComputedFrom[a].Format||"0.0[0000]"):"-",all:!0}),n[a].push({value:r.objects.all[e]?i(r.objects.all[e].ComputedFrom[a].Value,r.objects.all[e].ComputedFrom[a].Format||"0.0[0000]"):"-",all:!0})})),n[a]):r.objects&&!r.objects.all?(n[a]||(n[a]=[],_.forEach(r.objects,function(t,e){n[a].push(r.objects[e]?i(r.objects[e].ComputedFrom[a].PlanValue,r.objects[e].ComputedFrom[a].Format||"0.0[0000]"):"-"),n[a].push(r.objects[e]?i(r.objects[e].ComputedFrom[a].Value,r.objects[e].ComputedFrom[a].Format||"0.0[0000]"):"-")})),n[a]):[]},r.$watch("objects",function(){n=[]}),r.getHeaderCells=function(){var a=[];return r.objects&&_.forEach(r.objects.all,function(t,e){a.push("ННС"),a.push("ГС"),a.push("Всего")}),a},r.getHeaderCellsValueTypes=function(){var a=[];return r.objects&&r.objects.all&&_.forEach(r.objects.all,function(t,e){a.push("План"),a.push("Факт"),a.push("План"),a.push("Факт"),a.push("План"),a.push("Факт")}),r.objects&&!r.objects.all&&_.forEach(r.objects,function(t,e){a.push("План"),a.push("Факт")}),a}}}}]),angular.module("smbApp").controller("ContractorCtrl",["$scope","$routeParams","$timeout","$q","appSettings","companiesData","refData","apiData","utils","xlsx","saveFile","config",function(v,e,a,t,r,n,i,l,s,o,c,u){function d(){var t={wellState:v.filter.wellState,timeKey:v.filter.timeKey,drillType:v.filter.drillType,showValues:v.filter.showValues,timeCount:v.filter.timeCount};r.setSettings("app",t)}var m;function f(){t.all([i.getData(),n.getData()]).then(function(t){a(function(){v.data.companiesSrc=n.getCompaniesNames(),v.data.fieldsSrc=n.getCompanyFieldsNames("all"===e.companyUID?null:e.companyUID),h(),v.data.loaded=!0},400)})}v.$on("$destroy",function(){i.removeUpdateDataCallback(f),d()}),v.filter={wellState:1,timeKey:"month",timeCount:0,drillType:0,lineId:e.lineId?e.lineId.toUpperCase():null,chartDrilldown:!0,showNpvType:!0,showNpvClass:!0,showNpvReason:!0,npvChartSelected:!1,companyUID:e.companyUID||null,fieldUID:e.fieldUID||null},v.data={error:null,loaded:!1,contractorLoaded:!1,companies:[],fields:[],contractorUID:e.contractorUID,contractor:null,lineInfo:null,lines:[],finParameters:null,finParametersSrc:null,parameters:null,equipment:null,equipmentSrc:null,benchSummary:null,benchWells:null,npv:null,npvDuration:0,npvPc:0},(m=r.getSettings("app"))&&angular.extend(v.filter,m),v.$watch("filter",function(){d()},!0),t.all([i.getData(),n.getData()]).then(function(t){f(),i.addUpdateDataCallback(f)}),v.getCompanyName=function(t){var e=_.find(v.data.companies,{UID:t});return e?e.name:"Все компании"},v.getFieldName=function(t){var e=_.find(v.data.fields,{UID:t});return e?e.name:"Все месторождения"},v.selectCompany=function(t){v.filter.companyUID=t.UID,v.filter.fieldUID=null},v.selectField=function(t){v.filter.fieldUID=t.UID},v.$watch("filter.companyUID",function(t,e){t!==e&&(v.data.fields=n.getCompanyFieldsNames("all"===v.filter.companyUID?null:v.filter.companyUID),h())}),v.$watch("filter.fieldUID",function(t,e){t!==e&&h()}),v.$watch("filter.timeKey",function(t,e){t!==e&&h()}),v.$watch("filter.timeCount",function(t,e){t!==e&&h()}),v.$watch("filter.drillType",function(t,e){t!==e&&h()}),v.$watch("filter.lineId",function(t,e){t!==e&&g()});var p=null;function h(){v.data.contractorLoaded=!1,v.data.error=null,p&&p.reject("cancel"),(p=l.getContractor2Data(v.data.contractorUID,v.filter.timeKey,v.filter.timeCount,v.filter.drillType,v.filter.companyUID,v.filter.fieldUID)).promise.then(function(t){v.data.contractor=t.data,console.log(v.data.contractor);var e=_.pluck(v.data.contractor.Localities,"DzoId");e=_.unique(e);var a=_.filter(v.data.companiesSrc,function(t){return-1!==e.indexOf(t.UID.toLowerCase())});a.unshift({name:"Газпром нефть",shortName:"Газпром нефть",UID:null}),v.data.companies=a;var r=_.pluck(v.data.contractor.Localities,"LocalityId");r=_.unique(r);var n=_.filter(v.data.fieldsSrc,function(t){return-1!==r.indexOf(t.UID.toLowerCase())});v.data.fields=n,v.data.lines=_.map(v.data.contractor.LineInfos,function(t){return{name:t.LineName,id:t.LineId.toUpperCase()}}),v.data.lines=_.uniq(v.data.lines,function(t){return t.id}),!v.filter.lineId&&v.data.lines.length&&(v.filter.lineId=v.data.lines[0].id.toUpperCase()),g(),v.data.contractorLoaded=!0},function(t){"cancel"!==t&&(v.data.contractorLoaded=!0,v.data.error=t)})}function g(){v.data.line=null,v.data.finParameters=[],v.data.finParametersSrc=[],v.data.parameters=[],v.data.agreements=null,v.data.agreementsSrc=null,v.data.equipment=null,v.data.equipmentSrc=null,v.data.benchSummary=null,v.data.benchWells=null,v.data.npv=null,v.data.lineInfo=_.find(v.data.contractor.LineInfos,function(t){return v.filter.lineId&&t.LineId.toUpperCase()===v.filter.lineId.toUpperCase()})||null,v.data.agreementsSrc=v.data.lineInfo&&v.data.lineInfo.CardAgreements,v.data.agreements=_.cloneDeep(v.data.agreementsSrc),v.data.npv=v.data.lineInfo&&v.data.lineInfo.Npv,v.data.npvDuration=v.data.lineInfo&&v.data.lineInfo.TotalNpvDays,v.data.lineInfo&&0<v.data.lineInfo.TotalDurationDays&&(v.data.npvPc=v.data.lineInfo.TotalNpvDays/v.data.lineInfo.TotalDurationDays*100);var t=v.data.lineInfo&&v.data.lineInfo.Parameters;v.data.parameters=_.map(t,function(t){return{displayName:t.DisplayName,uom:t.Uom,value:t.TrendValue,delta:t.TrendDeltaValue,deltaPc:t.TrendDeltaPc,color:t.Color,roundTo:t.RoundTo}}),v.data.finParametersSrc=v.data.lineInfo&&v.data.lineInfo.FinParameters,v.data.finParameters=_.cloneDeep(v.data.finParametersSrc),v.data.equipmentSrc=v.data.lineInfo&&v.data.lineInfo.Equipment,v.data.equipment=_.cloneDeep(v.data.equipmentSrc),v.data.benchSummary={filters:{setName:null,subSetName:null,costCategoryName:null,costItemName:null,contractId:null},benchSummarySrc:v.data.contractor&&v.data.contractor.BenchSummary,filteredBenchSummarySrc:_.cloneDeep(v.data.contractor&&v.data.contractor.BenchSummary),filteredBenchSummary:_.cloneDeep(v.data.contractor&&v.data.contractor.BenchSummary),sets:[],subSets:[],contracts:[],costItemName:[],workBreakdownStructureName:[],totalAmmount:null},y(),v.data.benchWells={filters:{dzoName:null,localityName:null,clusterName:null,wellName:null,drillTypeName:null,dn7TypeName:null,setName:null,subSetName:null,contractId:null},benchWellsSrc:v.data.contractor&&v.data.contractor.BenchWells,filteredBenchWellsSrc:_.cloneDeep(v.data.contractor&&v.data.contractor.BenchWells),filteredBenchWells:_.cloneDeep(v.data.contractor&&v.data.contractor.BenchWells),dzos:[],localities:[],clusters:[],wells:[],drillTypes:[],dn7Types:[],sets:[],subSets:[],costCategoryNames:[],costItemNames:[],contracts:[]},b(),C()}function D(e,t){for(var a in e.filters)if(e.filters.hasOwnProperty(a)&&a!==t){var r=e.filters[a]?function(t){return t===e.filters[a]}:null;e=_.filter(e,r)}var n=_.pluck(e,t)||[];return n=_.uniq(_.compact(n)).sort(),_.map(n,function(t){return{id:t,name:t+""}})}function y(){if(v.data.benchSummary){var t=v.data.benchSummary.benchSummarySrc,e=D(t,"SetName");v.data.benchSummary.sets=e,v.data.benchSummary.sets.unshift({name:"Все",id:null});var a=D(t,"SubSetName");v.data.benchSummary.subSets=a,v.data.benchSummary.subSets.unshift({name:"Все",id:null});var r=D(t,"CostCategoryName");v.data.benchSummary.costCategoryNames=r,v.data.benchSummary.costCategoryNames.unshift({name:"Все",id:null});var n=D(t,"CostItemName");v.data.benchSummary.costItemNames=n,v.data.benchSummary.costItemNames.unshift({name:"Все",id:null});var i=D(t,"WorkBreakdownStructureName");v.data.benchSummary.workBreakdownStructureNames=i,v.data.benchSummary.workBreakdownStructureNames.unshift({name:"Все",id:null}),v.data.benchSummary.totalAmmount=0,_.forEach(t,function(t){v.data.benchSummary.totalAmmount+=t.Ammount});var l=_.pluck(t,"ContractId")||[];l=_.uniq(_.compact(l)).sort(),v.data.benchSummary.contracts=_.map(l,function(t){return{id:t,name:t+""}}),v.data.benchSummary.contracts.unshift({name:"Все",id:null})}}function b(){if(v.data.benchWells){var t=v.data.benchWells.benchWellsSrc,e=D(t,"DzoName");v.data.benchWells.dzos=e,v.data.benchWells.dzos.unshift({name:"Все",id:null});var a=D(t,"LocalityName");v.data.benchWells.localities=a,v.data.benchWells.localities.unshift({name:"Все",id:null});var r=D(t,"ClusterName");v.data.benchWells.clusters=r,v.data.benchWells.clusters.unshift({name:"Все",id:null});var n=D(t,"WellName");v.data.benchWells.wells=n,v.data.benchWells.wells.unshift({name:"Все",id:null});var i=D(t,"DrillTypeName");v.data.benchWells.drillTypes=i,v.data.benchWells.drillTypes.unshift({name:"Все",id:null});var l=D(t,"Dn7TypeName");v.data.benchWells.dn7Types=l,v.data.benchWells.dn7Types.unshift({name:"Все",id:null});var o=D(t,"SetName");v.data.benchWells.sets=o,v.data.benchWells.sets.unshift({name:"Все",id:null});var s=D(t,"SubSetName");v.data.benchWells.subSets=s,v.data.benchWells.subSets.unshift({name:"Все",id:null});var c=D(t,"ContractId");v.data.benchWells.contracts=c,v.data.benchWells.contracts.unshift({name:"Все",id:null})}}function C(t){v.data.npv&&v.data.npv.length&&(t=t||0,v.npvChartConfig=null,a(function(){v.npvChartConfig={options:{chart:{type:"pie"},title:{text:""},plotOptions:{pie:{shadow:!1,center:["50%","50%"],borderColor:"#000000"}},tooltip:{headerFormat:'<span style="font-size:11px">{series.name}</span><br>',pointFormat:"<span>{point.name}</span>: <b>{point.pcY:.1f} %, {point.y:.1f} сут</b>"}},series:[]};var t=v.data.npv,i=[],p=[],h=[],e=[],l=[],g=[];t=_.sortBy(t,function(t){return s.getNpvPieChartAttributeIndex(t.NpvLevel1Id)});var a=_.groupBy(t,"NpvLevel1"),o=[];if(_.forEach(a,function(t,e,a){var u=s.getNpvPieChartAttributeColor(t[0].NpvLevel1Id),n=0,d=0,m=0;t=_.sortBy(t,function(t){return t.NpvLevel2===e?0:1});var r=_.groupBy(t,"NpvLevel2"),f=[];_.forEach(r,function(t,e,a){var i=0,l=0,o=_.keys(a).length,s=0;t=_.sortBy(t,function(t){return t.NpvLevel2===e?0:1});var c=[];_.forEach(t,function(t,e,a){i+=t.Duration,l+=t.Pc;var r=_.keys(a).length,n=.3*m/o+.9*s*.3/o/r;h.push({name:t.NpvLevel3,y:t.Duration,pcY:t.Pc,color:Highcharts.Color(u).brighten(n).get()}),c.push({name:t.NpvLevel3,y:t.Duration,pcY:t.Pc,color:Highcharts.Color(u).brighten(n).get()}),s++}),g.push({level:2,key:e,name:"Причина НПВ: "+e,id:"Уровень 3 "+e,data:c,dataLabels:{formatter:function(){return v.filter.chartDrilldown?Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%":"<b>"+this.point.name+":</b> "+Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%"}}}),n+=i,d+=l;var r=.3*m/o;p.push({name:e,y:i,pcY:l,color:Highcharts.Color(u).brighten(r).get()}),f.push({name:e,y:i,pcY:l,color:Highcharts.Color(u).brighten(r).get(),drilldown:"Уровень 3 "+e}),m++}),l.push({level:2,key:e,name:"Класс НПВ: "+e,id:"Уровень 2 "+e,data:f,dataLabels:{formatter:function(){return v.filter.chartDrilldown?Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%":"<b>"+this.point.name+":</b> "+Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%"}}}),i.push({name:e,y:n,pcY:d,color:u}),o.push({name:e,y:n,color:u,pcY:d,drilldown:"Уровень 2 "+e})}),e.push({level:1,key:null,name:"Тип НПВ",data:o,dataLabels:{formatter:function(){return v.filter.chartDrilldown?Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%":"<b>"+this.point.name+":</b> "+Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%"}}}),v.filter.chartDrilldown)v.npvChartConfig.options.plotOptions.pie.showInLegend=!0,v.npvChartConfig.options.drilldown={series:_.union(l,g)},v.npvChartConfig.series=e;else{if(v.npvChartConfig.series=[],v.filter.showNpvType){var r="30%";(!v.filter.showNpvClass&&v.filter.showNpvReason||v.filter.showNpvClass&&!v.filter.showNpvReason)&&(r="50%"),v.filter.showNpvClass||v.filter.showNpvReason||(r="75%"),v.npvChartConfig.series.push({level:1,key:null,name:"Тип НПВ",data:i,size:r,dataLabels:{formatter:function(){return v.filter.showNpvClass||v.filter.showNpvReason?this.point.name:"<b>"+this.point.name+":</b> "+Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%"},color:v.filter.showNpvClass||v.filter.showNpvReason?"white":null,distance:v.filter.showNpvClass||v.filter.showNpvReason?-50:30}})}if(v.filter.showNpvClass){r="65%";var n="30%";!v.filter.showNpvReason&&v.filter.showNpvType&&(n="50%",r="75%"),v.filter.showNpvReason&&!v.filter.showNpvType&&(n=null,r="50%"),v.filter.showNpvReason||v.filter.showNpvType||(n=null,r="75%"),v.npvChartConfig.series.push({name:"Класс НПВ",data:p,size:r,innerSize:n,dataLabels:{formatter:function(){return v.filter.showNpvReason?null:"<b>"+this.point.name+":</b> "+Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%"}}})}if(v.filter.showNpvReason){n="65%";(!v.filter.showNpvClass&&v.filter.showNpvType||v.filter.showNpvClass&&!v.filter.showNpvType)&&(n="50%"),v.filter.showNpvClass||v.filter.showNpvType||(n=null),v.npvChartConfig.series.push({name:"Причина НПВ",data:h,size:"75%",innerSize:n,dataLabels:{formatter:function(){return"<b>"+this.point.name+":</b> "+Math.round(100*this.y)/100+" сут, "+Math.round(100*this.point.pcY)/100+"%"}}})}}},t))}v.$watch("data.benchSummary.filters",function(){if(v.data.benchSummary&&v.data.benchSummary.benchSummarySrc){var t=_.cloneDeep(v.data.benchSummary.benchSummarySrc);t=_.filter(t,v.data.benchSummary.filters.setName?{SetName:v.data.benchSummary.filters.setName}:null),t=_.filter(t,v.data.benchSummary.filters.subSetName?{SubSetName:v.data.benchSummary.filters.subSetName}:null),t=_.filter(t,v.data.benchSummary.filters.costCategoryName?{CostCategoryName:v.data.benchSummary.filters.costCategoryName}:null),t=_.filter(t,v.data.benchSummary.filters.costItemName?{CostItemName:v.data.benchSummary.filters.costItemName}:null),t=_.filter(t,v.data.benchSummary.filters.workBreakdownStructureName?{WorkBreakdownStructureName:v.data.benchSummary.filters.workBreakdownStructureName}:null),t=_.filter(t,v.data.benchSummary.filters.contractId?{ContractId:v.data.benchSummary.filters.contractId}:null),v.data.benchSummary.filteredBenchSummarySrc=t,v.data.benchSummary.filteredBenchSummary=_.cloneDeep(v.data.benchSummary.filteredBenchSummarySrc)}y()},!0),v.$watch("data.benchWells.filters",function(){if(v.data.benchWells&&v.data.benchWells.benchWellsSrc){var t=_.cloneDeep(v.data.benchWells.benchWellsSrc);t=_.filter(t,v.data.benchWells.filters.dzoName?{DzoName:v.data.benchWells.filters.dzoName}:null),t=_.filter(t,v.data.benchWells.filters.localityName?{LocalityName:v.data.benchWells.filters.localityName}:null),t=_.filter(t,v.data.benchWells.filters.clusterName?{ClusterName:v.data.benchWells.filters.clusterName}:null),t=_.filter(t,v.data.benchWells.filters.wellName?{WellName:v.data.benchWells.filters.wellName}:null),t=_.filter(t,v.data.benchWells.filters.drillTypeName?{DrillTypeName:v.data.benchWells.filters.drillTypeName}:null),t=_.filter(t,v.data.benchWells.filters.dn7TypeName?{Dn7TypeName:v.data.benchWells.filters.dn7TypeName}:null),t=_.filter(t,v.data.benchWells.filters.setName?{SetName:v.data.benchWells.filters.setName}:null),t=_.filter(t,v.data.benchWells.filters.subSetName?{SubSetName:v.data.benchWells.filters.subSetName}:null),t=_.filter(t,v.data.benchWells.filters.contractId?{ContractId:v.data.benchWells.filters.contractId}:null),v.data.benchWells.filteredBenchWellsSrc=t,v.data.benchWells.filteredBenchWells=_.cloneDeep(v.data.benchWells.filteredBenchWellsSrc)}b()},!0),v.getAttributeFullName=i.getAttributeFullName,v.getAttributeMUnit=i.getAttributeMUnit,v.$watch("filter.chartDrilldown",C),v.$watch("filter.showNpvType",C),v.$watch("filter.showNpvClass",C),v.$watch("filter.showNpvReason",C),v.updateNpvChartData=C,v.getExcel=function(){var t,e;switch(v.filter.timeKey){case"month":t=moment().startOf("month").subtract(-v.filter.timeCount,"months"),e=moment().startOf("month").subtract(-1-v.filter.timeCount,"months").subtract(1,"day");break;case"quarter":t=moment().startOf("quarter").subtract(-v.filter.timeCount,"quarters"),e=moment().startOf("quarter").subtract(-1-v.filter.timeCount,"quarters").subtract(1,"day");break;case"year":t=moment().startOf("year").subtract(-v.filter.timeCount,"years"),e=moment().startOf("year").subtract(-1-v.filter.timeCount,"years").subtract(1,"day");break;default:return""}t=t.format("YYYY-MM-DD"),e=e.format("YYYY-MM-DD"),window.open(u.getApiUrl()+"contractor2/"+t+"/"+e+"/report?uidContractor="+v.data.contractorUID+"&drillType="+["eb","zbs","prb"][v.filter.drillType]+"&line="+v.filter.lineId,"_blank").focus()},v.openLink=function(t){if(t){var e=window.open(t,"_blank");e&&e.focus()}}}]),angular.module("smbApp").filter("bytes",function(){return function(t,e){if(isNaN(parseFloat(t))||!isFinite(t))return"-";if(void 0===e&&(e=1),t){var a=Math.floor(Math.log(t)/Math.log(1024));return(t/Math.pow(1024,Math.floor(a))).toFixed(e)+" "+["байт","кБ","МБ","ГБ","ТБ","ПБ"][a]}return 0}}),angular.module("smbApp").directive("stFilter",function(){return{require:"^stTable",scope:{ngModel:"=",stFilter:"="},link:function(a,t,e,r){a.$watch("ngModel",function(t,e){r.tableState()[a.stFilter]=t,console.log(r.tableState()),r.pipe()})}}}),angular.module("smbApp").controller("CompaniesFinChartCtrl",["$scope","$location","$q","$timeout","$routeParams","chartSeriesColors","appSettings","companiesData","utils","apiData","xlsx","saveFile","config",function(p,t,a,r,e,n,i,l,h,o,s,c,u){if(p.authData&&p.authData.CanViewFinData){var d;p.$on("$destroy",function(){f()}),p.filter={reverseMarkers:!0,wellState:1,timeKey:"month",timeCount:0,drillType:0,showDynamic:!1,lineNnsId:null,lineGsId:null,showTable:!1,showValues:!0,showAverageLines:[!0,!1,!0,!1],hideAllAverageLines:!1,showMarkers:[[!1,!0],[!1,!0]],showMarkersYear:[[!0,!0],[!0,!0]],tiltXAxisTextNnsContractors:!0,tiltXAxisTextContractors:!0,tiltXAxisTextGsContractors:!0,attributeName:e.attributeName},p.data={splitCharts:!0,linesNns:[],linesGs:[],contractorsNns:[],contractorsGs:[],error:null,loaded:!1,chartsLoaded:!1,finCharts:[],finChart:null,params:[]},(d=i.getSettings("app"))&&angular.extend(p.filter,d),p.$watch("filter",function(){f()},!0),a.all([l.getData(),o.getFinCharts().promise,o.getFinParamList().promise]).then(function(e){r(function(){p.data.loaded=!0,p.data.finCharts=e[1].data,p.data.finChart=_.find(p.data.finCharts,{Id:p.filter.attributeName});var t=_.pluck(e[2].data,"Id");t=_.map(t,function(t){return t.replace("Gs","").replace("Nns","")}),p.data.params=_.unique(t),g()},400)}),p.$watch("filter.wellState",function(t,e){t!==e&&g()}),p.$watch("filter.timeKey",function(t,e){t!==e&&g()}),p.$watch("filter.drillType",function(t,e){t!==e&&g()}),p.$watch("filter.timeCount",function(t,e){t!==e&&g()}),p.$watch("filter.attributeName",function(t,e){t!==e&&(window.location.href="#/companiesFinChart/"+t)}),p.getAttributeFullName=function(e){var t=_.find(p.data.finCharts,function(t){return t.Parameters[0].Id.replace("Gs","").replace("Nns","")===e});return t?t.Name:e},p.getAttributeMUnit=function(e){var t=_.find(p.data.finCharts,function(t){return t.Parameters[0].Id.replace("Gs","").replace("Nns","")===e});return t?t.Parameters[0].Uom:e};var m=null;p.$watch("filter.lineNnsId",v),p.$watch("filter.lineGsId",D),p.planFactChatsColors=n.planFactChatsColors,p.factChatsColor=n.factChatsColor,p.onlyFactChatsColor=[p.factChatsColor[1]],p.getExcel=function(){var t=["eb","zbs","prb"],e=["undefined","drilling","drilled","builded","active"],a=[p.filter.attributeName],r=_.map(a,function(t){return p.data.splitCharts?"parameter=Gs"+t+"&parameter=Nns"+t:"parameter="+t});r=r.join("&");var n,i,l=null;if(p.filter.showDynamic){switch(p.filter.timeKey){case"month":l="Month",n=moment().startOf("month").subtract(10-p.filter.timeCount,"months"),(i=moment().startOf("month").subtract(-1-p.filter.timeCount-10,"months").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("month").format("YYYY-MM-DD")&&(i=moment().endOf("month")),n.format("YYYY-MM-DD")<"2013-01-01"&&(n=moment("2013-01-01"));break;case"quarter":l="Quarter",n=moment().startOf("quarter").subtract(10-p.filter.timeCount,"quarters"),(i=moment().startOf("quarter").subtract(-1-p.filter.timeCount-10,"quarters").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("quarter").format("YYYY-MM-DD")&&(i=moment().endOf("quarter")),n.format("YYYY-MM-DD")<"2013-01-01"&&(n=moment("2013-01-01"));break;case"year":l="Year",n=moment().startOf("year").subtract(10-p.filter.timeCount,"years"),(i=moment().startOf("year").subtract(-1-p.filter.timeCount-10,"years").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("year").format("YYYY-MM-DD")&&(i=moment().endOf("year")),n.format("YYYY-MM-DD")<"2013-01-01"&&(n=moment("2013-01-01"))}if(n=n.format("YYYY-MM-DD"),i=i.format("YYYY-MM-DD"),4===p.filter.wellState)var o=u.getApiUrl()+"finreport/1/"+t[p.filter.drillType]+"/"+e[p.filter.wellState]+"/2006-06-12/2100-01-01?targetObject=Gpn&periodBy="+l+"&"+r;else o=u.getApiUrl()+"finreport/1/"+t[p.filter.drillType]+"/"+e[p.filter.wellState]+"/"+n+"/"+i+"?targetObject=Gpn&periodBy="+l+"&"+r}else{switch(p.filter.timeKey){case"month":l="Month",n=moment().startOf("month").subtract(-p.filter.timeCount,"months"),i=moment().startOf("month").subtract(-1-p.filter.timeCount,"months").subtract(1,"day");break;case"quarter":l="Quarter",n=moment().startOf("quarter").subtract(-p.filter.timeCount,"quarters"),i=moment().startOf("quarter").subtract(-1-p.filter.timeCount,"quarters").subtract(1,"day");break;case"year":l="Year",n=moment().startOf("year").subtract(-p.filter.timeCount,"years"),i=moment().startOf("year").subtract(-1-p.filter.timeCount,"years").subtract(1,"day")}if(n=n.format("YYYY-MM-DD"),i=i.format("YYYY-MM-DD"),4===p.filter.wellState)o=u.getApiUrl()+"finreport/1/"+t[p.filter.drillType]+"/"+e[p.filter.wellState]+"/2006-06-12/2100-01-01?branchId=00000000-0000-0000-0000-000000000000&targetObject=branch&periodBy=None&"+r;else o=u.getApiUrl()+"finreport/1/"+t[p.filter.drillType]+"/"+e[p.filter.wellState]+"/"+n+"/"+i+"?branchId=00000000-0000-0000-0000-000000000000&targetObject=branch&periodBy=None&"+r}window.open(o,"_blank").focus()}}else t.path("/main");function f(){var t={wellState:p.filter.wellState,timeKey:p.filter.timeKey,drillType:p.filter.drillType,showValues:p.filter.showValues,timeCount:p.filter.timeCount,showDynamic:p.filter.showDynamic};i.setSettings("app",t)}function g(){p.data.chartsLoaded=!1,p.data.error=null,p.data.chartsData={},m&&m.reject("cancel"),_.find(p.data.finChart&&p.data.finChart.TrendWellStates,function(t){return t===p.filter.wellState})?p.filter.hideAllAverageLines=!1:p.filter.hideAllAverageLines=!0;var e=m=a.defer();a.all([o.getCompaniesFinData(p.filter.drillType,p.filter.timeKey,p.filter.timeCount,p.filter.wellState,"704AF9E4-E562-421A-BF02-BA28DF8BC0A1"===p.filter.attributeName?p.data.params:[p.filter.attributeName],p.data.splitCharts).promise,o.getCompaniesFinDynamicData(p.filter.drillType,p.filter.timeKey,p.filter.timeCount,p.filter.wellState,"704AF9E4-E562-421A-BF02-BA28DF8BC0A1"===p.filter.attributeName?p.data.params:[p.filter.attributeName],p.data.splitCharts).promise]).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise.then(function(t){var m=t[0].data,e=_.find(m,{Parameter:"Nns"+p.filter.attributeName}),a=_.find(m,{Parameter:"Gs"+p.filter.attributeName}),r=_.find(m,{Parameter:h.getApiAttributeName(p.filter.attributeName)}),n=e&&e.Objects,i=a&&a.Objects,l=r&&r.Objects,o=_.union(_.pluck(n,"ObjId"),_.pluck(i,"ObjId"));if(o&&o.length){var f={yAxisTitle:" ",subXAxisTitles:["ННС","ГС"],values:[],averageLines:[],format:r&&r.Format};_.forEach(o,function(o){var t=_.find(n,{ObjId:o}),e=_.find(i,{ObjId:o});if("704AF9E4-E562-421A-BF02-BA28DF8BC0A1"===p.filter.attributeName){var s=[],c=[],u=[],d=[];_.forEach(p.data.params,function(t){if("704AF9E4-E562-421A-BF02-BA28DF8BC0A1"!==t){var e=_.find(m,{Parameter:"Nns"+t}),a=_.find(m,{Parameter:"Gs"+t}),r=e&&e.Objects,n=a&&a.Objects,i=_.find(r,{ObjId:o}),l=_.find(n,{ObjId:o});i&&i.Value?s.push({val:i.Value,label:p.getAttributeFullName(t)}):s.push({val:0}),i&&i.PrevValue?u.push({val:i.PrevValue,label:p.getAttributeFullName(t)}):u.push({val:0}),l&&l.Value?c.push({val:l.Value,label:p.getAttributeFullName(t)}):c.push({val:0}),l&&l.PrevValue?d.push({val:l.PrevValue,label:p.getAttributeFullName(t)}):d.push({val:0})}}),f.values.push({uid:o,title:t&&t.DisplayName||e&&e.DisplayName,points:"year"===p.filter.timeKey?[{values:[{val:s,color:t&&t.Color}]},{values:[{val:c,color:e&&e.Color}]}]:[{values:[{val:u,color:t&&t.PrevColor},{val:s,color:t&&t.Color}]},{values:[{val:d,color:e&&e.PrevColor},{val:c,color:e&&e.Color}]}],link:"/fieldsFinChart/"+p.filter.attributeName+"/"+o.toUpperCase()})}else f.values.push({uid:o,title:t&&t.DisplayName||e&&e.DisplayName,points:"year"===p.filter.timeKey?[{values:t?[{val:t.Value,color:t.Color}]:[null]},{values:e?[{val:e.Value,color:e.Color}]:[null]}]:[{values:t?[{val:t.PrevValue,color:t.PrevColor},{val:t.Value,color:t.Color}]:[null,null]},{values:e?[{val:e.PrevValue,color:e.PrevColor},{val:e.Value,color:e.Color}]:[null,null]}],link:"/fieldsFinChart/"+p.filter.attributeName+"/"+o.toUpperCase()})}),e&&(f.averageLines.push({value:e.TrendValue}),f.averageLines.push({value:e.PrevTrendValue})),a&&(f.averageLines.push({value:a.TrendValue}),f.averageLines.push({value:a.PrevTrendValue})),p.data.chartsData.companies=h.sortChart(f);var s=_.pluck(f.values,"uid");p.data.chartsData.companiesObjects={nns:h.sortObjectChart(n,s),gs:h.sortObjectChart(i,s),all:h.sortObjectChart(l,s)}}p.data.linesNns=[];var c=_.find(m,{Parameter:"Nns"+p.filter.attributeName});c&&(c=c.Contractors),(p.data.contractorsNns=c)&&c.length&&(_.forEach(c,function(t){p.data.linesNns.push({id:t.LineId,name:t.LineName,format:r&&r.Format})}),p.data.linesNns=_.uniq(p.data.linesNns,"id")),p.data.linesNns.unshift({id:null,name:"Все",format:r&&r.Format}),v(),p.data.linesGs=[];var u=_.find(m,{Parameter:"Gs"+p.filter.attributeName});u&&(u=u.Contractors),(p.data.contractorsGs=u)&&u.length&&(_.forEach(u,function(t){p.data.linesGs.push({id:t.LineId,name:t.LineName,format:r&&r.Format})}),p.data.linesGs=_.uniq(p.data.linesGs,"id")),p.data.linesGs.unshift({id:null,name:"Все",format:r&&r.Format}),D(),m=t[1].data;e=_.find(m,{Parameter:"Nns"+h.getApiAttributeName(p.filter.attributeName)}),a=_.find(m,{Parameter:"Gs"+h.getApiAttributeName(p.filter.attributeName)}),r=_.find(m,{Parameter:h.getApiAttributeName(p.filter.attributeName)}),n=e&&e.Objects,i=a&&a.Objects,l=r&&r.Objects,f={yAxisTitle:" ",subXAxisTitles:["ННС","ГС"],values:[],averageLines:[],format:r&&r.Format};var d=_.unique(_.union(n,i),function(t){return""+t.Year+t.Quarter+h.pad(t.Month,2)});d=h.sortTimeObject(d),_.forEach(d,function(o){var t=_.find(n,{Year:o.Year,Quarter:o.Quarter,Month:o.Month}),e=_.find(i,{Year:o.Year,Quarter:o.Quarter,Month:o.Month});if("704AF9E4-E562-421A-BF02-BA28DF8BC0A1"===p.filter.attributeName){var s=[],c=[];_.forEach(p.data.params,function(t){if("704AF9E4-E562-421A-BF02-BA28DF8BC0A1"!==t){var e=_.find(m,{Parameter:"Nns"+t}),a=_.find(m,{Parameter:"Gs"+t}),r=e&&e.Objects,n=a&&a.Objects,i=_.find(r,{Year:o.Year,Quarter:o.Quarter,Month:o.Month}),l=_.find(n,{Year:o.Year,Quarter:o.Quarter,Month:o.Month});i&&i.Value?s.push({val:i.Value,label:p.getAttributeFullName(t)}):s.push({val:0}),l&&l.Value?c.push({val:l.Value,label:p.getAttributeFullName(t)}):c.push({val:0})}}),f.values.push({title:h.getObjectTimeTitle(t||c),points:[{values:[{val:s,color:t&&t.Color}]},{values:[{val:c,color:e&&e.Color}]}]})}else f.values.push({title:h.getObjectTimeTitle(t||c),points:[{values:t?[{val:t.Value,color:t.Color}]:[null]},{values:e?[{val:e.Value,color:e.Color}]:[null]}]})}),e&&(f.averageLines.push({value:e.TrendValue}),f.averageLines.push({value:e.PrevTrendValue})),a&&(f.averageLines.push({value:a.TrendValue}),f.averageLines.push({value:a.PrevTrendValue})),p.data.chartsData.dynamic=f,p.data.chartsData.dynamicObjects={nns:h.sortTimeObject(n),gs:h.sortTimeObject(i),all:h.sortTimeObject(l)},p.data.chartsLoaded=!0,p.data.error=null},function(t){"cancel"!==t&&(p.data.chartsLoaded=!0,p.data.error=t)})}function v(){var t=_.find(p.data.linesNns,{id:p.filter.lineNnsId}),e=p.data.contractorsNns;p.data.chartsData=p.data.chartsData||{},p.filter.lineNnsId&&(e=_.filter(e,{LineId:p.filter.lineNnsId}));var a={yAxisTitle:" ",values:[],format:t&&t.format};_.forEach(e,function(t){a.values.push({lineName:t.LineName,title:t.DisplayName?t.DisplayName:"Н/Д",points:[{values:[{val:t.Value}]}],link:"/contractor/"+t.ObjId.toUpperCase()+"/card"})}),p.data.chartsData.nnsContractorsSrc=h.sortChart(a),p.data.chartsData.nnsContractors=_.cloneDeep(p.data.chartsData.nnsContractorsSrc)}function D(){var t=_.find(p.data.linesGs,{id:p.filter.lineGsId}),e=p.data.contractorsGs;p.data.chartsData=p.data.chartsData||{},p.filter.lineGsId&&(e=_.filter(e,{LineId:p.filter.lineGsId}));var a={yAxisTitle:" ",values:[],format:t&&t.format};_.forEach(e,function(t){a.values.push({lineName:t.LineName,title:t.DisplayName?t.DisplayName:"Н/Д",points:[{values:[{val:t.Value}]}],link:"/contractor/"+t.ObjId.toUpperCase()+"/card"})}),p.data.chartsData.gsContractorsSrc=h.sortChart(a),p.data.chartsData.gsContractors=_.cloneDeep(p.data.chartsData.gsContractorsSrc)}}]),angular.module("smbApp").controller("FieldsFinChartCtrl",["$scope","$location","$q","$timeout","$routeParams","chartSeriesColors","appSettings","companiesData","fieldsAttributesData","utils","refData","apiData","xlsx","saveFile","authData","config",function(p,e,t,a,r,n,i,l,o,h,s,c,u,d,m,f){if(p.authData&&p.authData.CanViewFinData){var g;p.$on("$destroy",function(){s.removeUpdateDataCallback(y),l.removeUpdateDataCallback(y),D()}),p.filter={reverseMarkers:!0,wellState:1,timeKey:"month",timeCount:0,drillType:0,showDynamic:!1,lineNnsId:null,lineGsId:null,showTable:!1,showValues:!0,showAverageLines:[!0,!1,!0,!1],hideAllAverageLines:!1,showMarkers:[[!1,!0],[!1,!0]],showMarkersYear:[[!0,!0],[!0,!0]],tiltXAxisTextNnsContractors:!0,tiltXAxisTextContractors:!0,tiltXAxisTextGsContractors:!0,attributeName:r.attributeName},p.data={splitCharts:!0,linesNns:[],linesGs:[],contractorsNns:[],contractorsGs:[],error:null,loaded:!1,chartsLoaded:!1,companyUID:r.companyUID,company:null,companies:[],finCharts:[],finChart:null,params:[]},(g=i.getSettings("app"))&&angular.extend(p.filter,g),p.$watch("filter",function(){D()},!0),t.all([s.getData(),l.getData()]).then(function(t){y(),s.addUpdateDataCallback(y),l.addUpdateDataCallback(y)}),p.$watch("filter.wellState",function(t,e){t!==e&&b()}),p.$watch("filter.timeKey",function(t,e){t!==e&&b()}),p.$watch("filter.timeCount",function(t,e){t!==e&&b()}),p.$watch("filter.drillType",function(t,e){t!==e&&b()}),p.$watch("filter.attributeName",function(t,e){t!==e&&(window.location.href="#/fieldsFinChart/"+t+"/"+p.data.companyUID)}),p.getAttributeFullName=function(e){var t=_.find(p.data.finCharts,function(t){return t.Parameters[0].Id.replace("Gs","").replace("Nns","")===e});return t?t.Name:e},p.getAttributeMUnit=function(e){var t=_.find(p.data.finCharts,function(t){return t.Parameters[0].Id.replace("Gs","").replace("Nns","")===e});return t?t.Parameters[0].Uom:e};var v=null;p.$watch("filter.lineNnsId",C),p.$watch("filter.lineGsId",w),p.planFactChatsColors=n.planFactChatsColors,p.factChatsColor=n.factChatsColor,p.onlyFactChatsColor=[p.factChatsColor[1]],p.selectCompany=function(t){e.path("/fieldsFinChart/"+p.filter.attributeName+"/"+t.UID)},p.singleCompany=m.singleCompany,p.getExcel=function(){var t=["eb","zbs","prb"],e=["undefined","drilling","drilled","builded","active"],a=[p.filter.attributeName],r=_.map(a,function(t){return p.data.splitCharts?"parameter=Gs"+t+"&parameter=Nns"+t:"parameter="+t});r=r.join("&");var n,i,l=null;if(p.filter.showDynamic){switch(p.filter.timeKey){case"month":l="Month",n=moment().startOf("month").subtract(10-p.filter.timeCount,"months"),(i=moment().startOf("month").subtract(-1-p.filter.timeCount-10,"months").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("month").format("YYYY-MM-DD")&&(i=moment().endOf("month")),n.format("YYYY-MM-DD")<"2013-01-01"&&(n=moment("2013-01-01"));break;case"quarter":l="Quarter",n=moment().startOf("quarter").subtract(10-p.filter.timeCount,"quarters"),(i=moment().startOf("quarter").subtract(-1-p.filter.timeCount-10,"quarters").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("quarter").format("YYYY-MM-DD")&&(i=moment().endOf("quarter")),n.format("YYYY-MM-DD")<"2013-01-01"&&(n=moment("2013-01-01"));break;case"year":l="Year",n=moment().startOf("year").subtract(10-p.filter.timeCount,"years"),(i=moment().startOf("year").subtract(-1-p.filter.timeCount-10,"years").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("year").format("YYYY-MM-DD")&&(i=moment().endOf("year")),n.format("YYYY-MM-DD")<"2013-01-01"&&(n=moment("2013-01-01"))}if(n=n.format("YYYY-MM-DD"),i=i.format("YYYY-MM-DD"),4===p.filter.wellState)var o=f.getApiUrl()+"finreport/2/"+t[p.filter.drillType]+"/"+e[p.filter.wellState]+"/2006-06-12/2100-01-01?targetObject=Branch&branchId="+p.data.companyUID+"&periodBy="+l+"&"+r;else o=f.getApiUrl()+"finreport/2/"+t[p.filter.drillType]+"/"+e[p.filter.wellState]+"/"+n+"/"+i+"?targetObject=Branch&branchId="+p.data.companyUID+"&periodBy="+l+"&"+r}else{switch(p.filter.timeKey){case"month":l="Month",n=moment().startOf("month").subtract(-p.filter.timeCount,"months"),i=moment().startOf("month").subtract(-1-p.filter.timeCount,"months").subtract(1,"day");break;case"quarter":l="Quarter",n=moment().startOf("quarter").subtract(-p.filter.timeCount,"quarters"),i=moment().startOf("quarter").subtract(-1-p.filter.timeCount,"quarters").subtract(1,"day");break;case"year":l="Year",n=moment().startOf("year").subtract(-p.filter.timeCount,"years"),i=moment().startOf("year").subtract(-1-p.filter.timeCount,"years").subtract(1,"day")}if(n=n.format("YYYY-MM-DD"),i=i.format("YYYY-MM-DD"),4===p.filter.wellState)o=f.getApiUrl()+"finreport/2/"+t[p.filter.drillType]+"/"+e[p.filter.wellState]+"/2006-06-12/2100-01-01?targetObject=Locality&branchId="+p.data.companyUID+"&periodBy=None&"+r;else o=f.getApiUrl()+"finreport/2/"+t[p.filter.drillType]+"/"+e[p.filter.wellState]+"/"+n+"/"+i+"?targetObject=Locality&branchId="+p.data.companyUID+"&periodBy=None&"+r}window.open(o,"_blank").focus()}}else e.path("/main");function D(){var t={wellState:p.filter.wellState,timeKey:p.filter.timeKey,drillType:p.filter.drillType,showValues:p.filter.showValues,timeCount:p.filter.timeCount,showDynamic:p.filter.showDynamic};i.setSettings("app",t)}function y(){t.all([s.getData(),l.getData(),c.getFinCharts().promise,c.getFinParamList().promise]).then(function(e){a(function(){p.data.companies=l.getCompaniesNames(),p.data.company=_.find(p.data.companies,{UID:r.companyUID}),p.data.finCharts=e[2].data,p.data.finChart=_.find(p.data.finCharts,{Id:p.filter.attributeName});var t=_.pluck(e[3].data,"Id");t=_.map(t,function(t){return t.replace("Gs","").replace("Nns","")}),p.data.params=_.unique(t),p.data.loaded=!0,b()},400)})}function b(){p.data.chartsLoaded=!1,p.data.error=null,p.data.chartsData={},v&&v.reject("cancel"),_.find(p.data.finChart&&p.data.finChart.TrendWellStates,function(t){return t===p.filter.wellState})?p.filter.hideAllAverageLines=!1:p.filter.hideAllAverageLines=!0;var e=v=t.defer();t.all([c.getFieldsFinData(p.data.companyUID,p.filter.drillType,p.filter.timeKey,p.filter.timeCount,p.filter.wellState,"704AF9E4-E562-421A-BF02-BA28DF8BC0A1"===p.filter.attributeName?p.data.params:[p.filter.attributeName],p.data.splitCharts).promise,c.getFieldsFinDynamicData(p.data.companyUID,p.filter.drillType,p.filter.timeKey,p.filter.timeCount,p.filter.wellState,"704AF9E4-E562-421A-BF02-BA28DF8BC0A1"===p.filter.attributeName?p.data.params:[p.filter.attributeName],p.data.splitCharts).promise]).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise.then(function(t){var m=t[0].data,e=_.find(m,{Parameter:"Nns"+p.filter.attributeName}),a=_.find(m,{Parameter:"Gs"+p.filter.attributeName}),r=_.find(m,{Parameter:h.getApiAttributeName(p.filter.attributeName)}),n=e&&e.Objects,i=a&&a.Objects,l=r&&r.Objects,o=_.union(_.pluck(n,"ObjId"),_.pluck(i,"ObjId"));if(o&&o.length){var f={yAxisTitle:" ",subXAxisTitles:["ННС","ГС"],values:[],averageLines:[],format:r&&r.Format};_.forEach(o,function(o){var t=_.find(n,{ObjId:o}),e=_.find(i,{ObjId:o});if("704AF9E4-E562-421A-BF02-BA28DF8BC0A1"===p.filter.attributeName){var s=[],c=[],u=[],d=[];_.forEach(p.data.params,function(t){if("704AF9E4-E562-421A-BF02-BA28DF8BC0A1"!==t){var e=_.find(m,{Parameter:"Nns"+t}),a=_.find(m,{Parameter:"Gs"+t}),r=e&&e.Objects,n=a&&a.Objects,i=_.find(r,{ObjId:o}),l=_.find(n,{ObjId:o});i&&i.Value?s.push({val:i.Value,label:p.getAttributeFullName(t)}):s.push({val:0}),i&&i.PrevValue?u.push({val:i.PrevValue,label:p.getAttributeFullName(t)}):u.push({val:0}),l&&l.Value?c.push({val:l.Value,label:p.getAttributeFullName(t)}):c.push({val:0}),l&&l.PrevValue?d.push({val:l.PrevValue,label:p.getAttributeFullName(t)}):d.push({val:0})}}),f.values.push({uid:o,title:t&&t.DisplayName||e&&e.DisplayName,points:"year"===p.filter.timeKey?[{values:[{val:s,color:t&&t.Color}]},{values:[{val:c,color:e&&e.Color}]}]:[{values:[{val:u,color:t&&t.PrevColor},{val:s,color:t&&t.Color}]},{values:[{val:d,color:e&&e.PrevColor},{val:c,color:e&&e.Color}]}],link:"/fieldFinChart/"+p.filter.attributeName+"/"+p.data.companyUID+"/"+o.toUpperCase()})}else f.values.push({uid:o,title:t&&t.DisplayName||e&&e.DisplayName,points:"year"===p.filter.timeKey?[{values:t?[{val:t.Value,color:t.Color}]:[null]},{values:e?[{val:e.Value,color:e.Color}]:[null]}]:[{values:t?[{val:t.PrevValue,color:t.PrevColor},{val:t.Value,color:t.Color}]:[null,null]},{values:e?[{val:e.PrevValue,color:e.PrevColor},{val:e.Value,color:e.Color}]:[null,null]}],link:"/fieldFinChart/"+p.filter.attributeName+"/"+p.data.companyUID+"/"+o.toUpperCase()})}),e&&(f.averageLines.push({value:e.TrendValue}),f.averageLines.push({value:e.PrevTrendValue})),a&&(f.averageLines.push({value:a.TrendValue}),f.averageLines.push({value:a.PrevTrendValue})),p.data.chartsData.fields=h.sortChart(f);var s=_.pluck(f.values,"uid");p.data.chartsData.fieldsObjects={nns:h.sortObjectChart(n,s),gs:h.sortObjectChart(i,s),all:h.sortObjectChart(l,s)}}p.data.linesNns=[];var c=_.find(m,{Parameter:"Nns"+p.filter.attributeName});c&&(c=c.Contractors),(p.data.contractorsNns=c)&&c.length&&(_.forEach(c,function(t){p.data.linesNns.push({id:t.LineId,name:t.LineName,format:r&&r.Format})}),p.data.linesNns=_.uniq(p.data.linesNns,"id")),p.data.linesNns.unshift({id:null,name:"Все",format:r&&r.Format}),C(),p.data.linesGs=[];var u=_.find(m,{Parameter:"Gs"+p.filter.attributeName});u&&(u=u.Contractors),(p.data.contractorsGs=u)&&u.length&&(_.forEach(u,function(t){p.data.linesGs.push({id:t.LineId,name:t.LineName,format:r&&r.Format})}),p.data.linesGs=_.uniq(p.data.linesGs,"id")),p.data.linesGs.unshift({id:null,name:"Все",format:r&&r.Format}),w(),m=t[1].data;e=_.find(m,{Parameter:"Nns"+h.getApiAttributeName(p.filter.attributeName)}),a=_.find(m,{Parameter:"Gs"+h.getApiAttributeName(p.filter.attributeName)}),r=_.find(m,{Parameter:h.getApiAttributeName(p.filter.attributeName)}),n=e&&e.Objects,i=a&&a.Objects,l=r&&r.Objects,f={yAxisTitle:" ",subXAxisTitles:["ННС","ГС"],values:[],averageLines:[],format:r&&r.Format};var d=_.unique(_.union(n,i),function(t){return""+t.Year+t.Quarter+h.pad(t.Month,2)});d=h.sortTimeObject(d),_.forEach(d,function(o){var t=_.find(n,{Year:o.Year,Quarter:o.Quarter,Month:o.Month}),e=_.find(i,{Year:o.Year,Quarter:o.Quarter,Month:o.Month});if("704AF9E4-E562-421A-BF02-BA28DF8BC0A1"===p.filter.attributeName){var s=[],c=[];_.forEach(p.data.params,function(t){if("704AF9E4-E562-421A-BF02-BA28DF8BC0A1"!==t){var e=_.find(m,{Parameter:"Nns"+t}),a=_.find(m,{Parameter:"Gs"+t}),r=e&&e.Objects,n=a&&a.Objects,i=_.find(r,{Year:o.Year,Quarter:o.Quarter,Month:o.Month}),l=_.find(n,{Year:o.Year,Quarter:o.Quarter,Month:o.Month});i&&i.Value?s.push({val:i.Value,label:p.getAttributeFullName(t)}):s.push({val:0}),l&&l.Value?c.push({val:l.Value,label:p.getAttributeFullName(t)}):c.push({val:0})}}),f.values.push({title:h.getObjectTimeTitle(t||e),points:[{values:[{val:s,color:t&&t.Color}]},{values:[{val:c,color:e&&e.Color}]}]})}else f.values.push({title:h.getObjectTimeTitle(t||e),points:[{values:t?[{val:t.Value,color:t.Color}]:[null]},{values:e?[{val:e.Value,color:e.Color}]:[null]}]})}),e&&(f.averageLines.push({value:e.TrendValue}),f.averageLines.push({value:e.PervTrendValue})),a&&(f.averageLines.push({value:a.TrendValue}),f.averageLines.push({value:a.PrevTrendValue})),p.data.chartsData.dynamic=f,p.data.chartsData.dynamicObjects={nns:h.sortTimeObject(n),gs:h.sortTimeObject(i),all:h.sortTimeObject(l)},p.data.chartsLoaded=!0,p.data.error=null},function(t){"cancel"!==t&&(p.data.chartsLoaded=!0,p.data.error=t)})}function C(){var t=_.find(p.data.linesNns,{id:p.filter.lineNnsId}),e=p.data.contractorsNns;p.data.chartsData=p.data.chartsData||{},p.filter.lineNnsId&&(e=_.filter(e,{LineId:p.filter.lineNnsId}));var a={yAxisTitle:" ",values:[],format:t&&t.format};_.forEach(e,function(t){a.values.push({lineName:t.LineName,title:t.DisplayName?t.DisplayName:"Н/Д",points:[{values:[{val:t.Value}]}],link:"/contractor/"+t.ObjId.toUpperCase()+"/card?companyUID="+p.data.companyUID})}),p.data.chartsData.nnsContractorsSrc=h.sortChart(a),p.data.chartsData.nnsContractors=_.cloneDeep(p.data.chartsData.nnsContractorsSrc)}function w(){var t=_.find(p.data.linesGs,{id:p.filter.lineGsId}),e=p.data.contractorsGs;p.data.chartsData=p.data.chartsData||{},p.filter.lineGsId&&(e=_.filter(e,{LineId:p.filter.lineGsId}));var a={yAxisTitle:" ",values:[],format:t&&t.format};_.forEach(e,function(t){a.values.push({lineName:t.LineName,title:t.DisplayName?t.DisplayName:"Н/Д",points:[{values:[{val:t.Value}]}],link:"/contractor/"+t.ObjId.toUpperCase()+"/card?companyUID="+p.data.companyUID})}),p.data.chartsData.gsContractorsSrc=h.sortChart(a),p.data.chartsData.gsContractors=_.cloneDeep(p.data.chartsData.gsContractorsSrc)}}]),angular.module("smbApp").controller("FieldFinChartCtrl",["$scope","$location","$q","$timeout","$routeParams","chartSeriesColors","appSettings","companiesData","fieldsAttributesData","utils","refData","apiData","xlsx","saveFile","authData","config",function(s,e,t,a,r,n,i,l,o,c,u,d,m,f,p,h){if(s.authData&&s.authData.CanViewFinData){var g;s.$on("$destroy",function(){u.removeUpdateDataCallback(C),l.removeUpdateDataCallback(C),b()}),s.filter={reverseMarkers:!0,wellState:1,timeKey:"month",timeCount:0,drillType:0,gsDn7Filter:null,nnsDn7Filter:null,lineNnsId:null,lineGsId:null,showTable:!1,showTableNns:!1,showTableGs:!1,showValues:!0,showAverageLines:[!0,!1,!0,!1],showAverageLinesNns:[!0,!1,!0,!1],showAverageLinesGs:[!0,!1,!0,!1],showMarkers:[[!1,!0],[!1,!0]],showMarkersYear:[[!0,!0],[!0,!0]],showMarkersNns:[[!1,!0],[!1,!0]],showMarkersYearNns:[[!0,!0],[!0,!0]],showMarkersGs:[[!1,!0],[!1,!0]],showMarkersYearGs:[[!0,!0],[!0,!0]],hideAllAverageLines:!1,tiltXAxisTextNns:!0,tiltXAxisTextGs:!0,tiltXAxisTextNnsContractors:!0,tiltXAxisTextContractors:!0,tiltXAxisTextGsContractors:!0,attributeName:r.attributeName},s.data={splitCharts:!0,linesNns:[],linesGs:[],contractorsNns:[],contractorsGs:[],error:null,loaded:!1,chartsLoaded:!1,fieldNnsLoaded:!1,fieldNnsError:!1,fieldGsLoaded:!1,fieldGsError:!1,companyUID:r.companyUID,company:null,companies:[],fieldUID:r.fieldUID,field:null,fields:[],gsDn7Filters:[],nnsDn7Filters:[],finCharts:[],finChart:null,params:[]},(g=i.getSettings("app"))&&angular.extend(s.filter,g),s.$watch("filter",function(){b()},!0),t.all([u.getData(),l.getData()]).then(function(t){C(),u.addUpdateDataCallback(C),l.addUpdateDataCallback(C)}),s.$watch("filter.wellState",function(t,e){t!==e&&A()}),s.$watch("filter.timeKey",function(t,e){t!==e&&A()}),s.$watch("filter.timeCount",function(t,e){t!==e&&A()}),s.$watch("filter.drillType",function(t,e){t!==e&&A()}),s.$watch("filter.attributeName",function(t,e){t!==e&&(window.location.href="#/fieldFinChart/"+t+"/"+s.data.companyUID+"/"+s.data.fieldUID)}),s.$watch("filter.nnsDn7Filter",function(t,e){t!==e&&Y()}),s.$watch("filter.gsDn7Filter",function(t,e){t!==e&&M()}),s.getAttributeFullName=function(e){var t=_.find(s.data.finCharts,function(t){return t.Parameters[0].Id.replace("Gs","").replace("Nns","")===e});return t?t.Name:e},s.getAttributeMUnit=function(e){var t=_.find(s.data.finCharts,function(t){return t.Parameters[0].Id.replace("Gs","").replace("Nns","")===e});return t?t.Parameters[0].Uom:e};var v=null;s.$watch("filter.lineNnsId",I),s.$watch("filter.lineGsId",N);var D=null,y=null;s.planFactChatsColors=n.planFactChatsColors,s.factChatsColor=n.factChatsColor,s.onlyFactChatsColor=[s.factChatsColor[1]],s.selectField=function(t){e.path("/fieldFinChart/"+s.filter.attributeName+"/"+s.data.companyUID+"/"+t.UID)},s.singleCompany=p.singleCompany,s.getExcel=function(){var t=["eb","zbs","prb"],e=["undefined","drilling","drilled","builded","active"],a=[s.filter.attributeName],r=_.map(a,function(t){return"parameter=Gs"+t+"&parameter=Nns"+t});r=r.join("&");var n,i,l=null;switch(s.filter.timeKey){case"month":l="Month",n=moment().startOf("month").subtract(10-s.filter.timeCount,"months"),(i=moment().startOf("month").subtract(-1-s.filter.timeCount-10,"months").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("month").format("YYYY-MM-DD")&&(i=moment().endOf("month")),n.format("YYYY-MM-DD")<"2013-01-01"&&(n=moment("2013-01-01"));break;case"quarter":l="Quarter",n=moment().startOf("quarter").subtract(10-s.filter.timeCount,"quarters"),(i=moment().startOf("quarter").subtract(-1-s.filter.timeCount-10,"quarters").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("quarter").format("YYYY-MM-DD")&&(i=moment().endOf("quarter")),n.format("YYYY-MM-DD")<"2013-01-01"&&(n=moment("2013-01-01"));break;case"year":l="Year",n=moment().startOf("year").subtract(10-s.filter.timeCount,"years"),(i=moment().startOf("year").subtract(-1-s.filter.timeCount-10,"years").subtract(1,"day")).format("YYYY-MM-DD")>moment().endOf("year").format("YYYY-MM-DD")&&(i=moment().endOf("year")),n.format("YYYY-MM-DD")<"2013-01-01"&&(n=moment("2013-01-01"))}if(n=n.format("YYYY-MM-DD"),i=i.format("YYYY-MM-DD"),4===s.filter.wellState)var o=h.getApiUrl()+"finreport/3/"+t[s.filter.drillType]+"/"+e[s.filter.wellState]+"/2006-06-12/2100-01-01?targetObject=locality&periodBy="+l+"&localityId="+s.data.fieldUID;else o=h.getApiUrl()+"finreport/3/"+t[s.filter.drillType]+"/"+e[s.filter.wellState]+"/"+n+"/"+i+"?targetObject=locality&periodBy="+l+"&localityId="+s.data.fieldUID;o+="&"+r+(s.filter.gsDn7Filter?"&dn7Gs="+s.filter.gsDn7Filter:"")+(s.filter.nnsDn7Filter?"&dn7Nns="+s.filter.nnsDn7Filter:""),window.open(o,"_blank").focus()}}else e.path("/main");function b(){var t={wellState:s.filter.wellState,timeKey:s.filter.timeKey,drillType:s.filter.drillType,showValues:s.filter.showValues,timeCount:s.filter.timeCount};i.setSettings("app",t)}function C(){t.all([u.getData(),l.getData(),d.getFinCharts().promise,d.getFinParamList().promise]).then(function(e){a(function(){s.data.companies=l.getCompaniesNames(),s.data.company=_.find(s.data.companies,{UID:r.companyUID}),s.data.fields=l.getCompanyFieldsNames(r.companyUID),s.data.field=_.find(s.data.fields,{UID:r.fieldUID}),s.data.gsDn7Filters=u.getDn7GsFilters(),s.data.nnsDn7Filters=u.getDn7NnsFilters(),s.data.finCharts=e[2].data,s.data.finChart=_.find(s.data.finCharts,{Id:s.filter.attributeName});var t=_.pluck(e[2].data,"Id");t=_.map(t,function(t){return t.replace("Gs","").replace("Nns","")}),s.data.params=_.unique(t),s.data.loaded=!0,A()},400)})}function w(){return v&&v.reject("cancel"),_.find(s.data.finChart&&s.data.finChart.TrendWellStates,function(t){return t===s.filter.wellState})?s.filter.hideAllAverageLines=!1:s.filter.hideAllAverageLines=!0,s.data.splitCharts?(s.data.chartsData.gsContractors=null,s.data.chartsData.nnsContractors=null,(v=d.getFieldFinData(s.data.fieldUID,s.filter.drillType,s.filter.timeKey,s.filter.timeCount,s.filter.wellState,[s.filter.attributeName],!0)).promise.then(function(t){var e=t.data;s.data.linesNns=[];var a=_.find(e,{Parameter:"Nns"+s.filter.attributeName}),r=_.find(e,{Parameter:"Nns"+s.filter.attributeName});r&&(r=r.Contractors),(s.data.contractorsNns=r)&&r.length&&(_.forEach(r,function(t){s.data.linesNns.push({id:t.LineId,name:t.LineName,format:a&&a.Format})}),s.data.linesNns=_.uniq(s.data.linesNns,"id")),s.data.linesNns.unshift({id:null,name:"Все",format:a.Format}),I(),s.data.linesGs=[];var n=_.find(e,{Parameter:"Gs"+s.filter.attributeName}),i=_.find(e,{Parameter:"Gs"+s.filter.attributeName});i&&(i=i.Contractors),(s.data.contractorsGs=i)&&i.length&&(_.forEach(i,function(t){s.data.linesGs.push({id:t.LineId,name:t.LineName,format:n&&n.Format})}),s.data.linesGs=_.uniq(s.data.linesGs,"id")),s.data.linesGs.unshift({id:null,name:"Все",format:n.Format}),N()})):(s.data.chartsData.field=null,s.data.chartsData.fieldObjects=null,s.data.chartsData.contractors=null,(v=d.getFieldFinData(s.data.fieldUID,s.filter.drillType,s.filter.timeKey,s.filter.timeCount,s.filter.wellState,[s.filter.attributeName])).promise.then(function(t){var e=t.data[0];if(e.Objects&&e.Objects.length){var a={yAxisTitle:" ",values:[],averageLines:[],format:e&&e.Format};e.Objects=c.sortTimeObject(e.Objects),_.forEach(e.Objects,function(t){a.values.push({title:S(t),points:"year"===s.filter.timeKey?[{values:[{val:t.Value,color:t.Color}]}]:[{values:[{val:t.PrevValue,color:t.PrevColor},{val:t.Value,color:t.Color}]}],link:"/wellsFinChart/"+s.filter.attributeName+"/"+s.data.companyUID+"/"+s.data.fieldUID+"?month="+t.Month+"&quarter="+t.Quarter+"&year="+t.Year})}),a.averageLines.push({value:e.TrendValue}),s.data.chartsData.field=a,s.data.chartsData.fieldObjects=_.map(e.Objects,function(t){return t.DisplayName=S(t),t})}s.data.lines=[],s.data.contractors=e.Contractors,e.Contractors&&e.Contractors.length&&(_.forEach(e.Contractors,function(t){s.data.lines.push({id:t.LineId,name:t.LineName,format:e&&e.Format})}),s.data.lines=_.uniq(s.data.lines,"id")),s.data.lines.unshift({id:null,name:"Все",format:e&&e.Format}),applyLineFilter()})),v.promise}function I(){var t=_.find(s.data.linesNns,{id:s.filter.lineNnsId}),e=s.data.contractorsNns;s.data.chartsData=s.data.chartsData||{},s.filter.lineNnsId&&(e=_.filter(e,{LineId:s.filter.lineNnsId}));var a={yAxisTitle:" ",values:[],format:t&&t.format};_.forEach(e,function(t){a.values.push({lineName:t.LineName,title:t.DisplayName?t.DisplayName:"Н/Д",points:[{values:[{val:t.Value}]}],link:"/contractor/"+t.ObjId.toUpperCase()+"/card?companyUID="+s.data.companyUID+"&fieldUID="+s.data.fieldUID})}),s.data.chartsData.nnsContractorsSrc=c.sortChart(a),s.data.chartsData.nnsContractors=_.cloneDeep(s.data.chartsData.nnsContractorsSrc)}function N(){var t=_.find(s.data.linesGs,{id:s.filter.lineGsId}),e=s.data.contractorsGs;s.data.chartsData=s.data.chartsData||{},s.filter.lineGsId&&(e=_.filter(e,{LineId:s.filter.lineGsId}));var a={yAxisTitle:" ",values:[],format:t&&t.format};_.forEach(e,function(t){a.values.push({lineName:t.LineName,title:t.DisplayName?t.DisplayName:"Н/Д",points:[{values:[{val:t.Value}]}],link:"/contractor/"+t.ObjId.toUpperCase()+"/card?companyUID="+s.data.companyUID+"&fieldUID="+s.data.fieldUID})}),s.data.chartsData.gsContractorsSrc=c.sortChart(a),s.data.chartsData.gsContractors=_.cloneDeep(s.data.chartsData.gsContractorsSrc)}function Y(){return D&&D.reject("cancel"),s.data.fieldNnsLoaded=!1,s.data.fieldNnsError=null,s.data.chartsData.fieldNns=null,s.data.chartsData.fieldNnsObjects=null,(D=d.getFieldDn7FinData(s.data.fieldUID,s.filter.drillType,s.filter.timeKey,s.filter.timeCount,s.filter.wellState,"704AF9E4-E562-421A-BF02-BA28DF8BC0A1"===s.filter.attributeName?s.data.params:[s.filter.attributeName],"Nns",s.filter.nnsDn7Filter)).promise.then(function(t){var o=t.data,e=_.find(o,{Parameter:"Nns"+s.filter.attributeName}),a=e&&e.Objects;if(a&&a.length){var r={yAxisTitle:" ",values:[],averageLines:[],format:e&&e.Format},n=_.map(c.sortTimeObject(a),function(t){return""+t.Year+t.Quarter+c.pad(t.Month,2)});n=_.uniq(n),_.forEach(n,function(n){var t=_.find(a,function(t){return n===""+t.Year+t.Quarter+c.pad(t.Month,2)});if("704AF9E4-E562-421A-BF02-BA28DF8BC0A1"===s.filter.attributeName){var i=[],l=[];_.forEach(s.data.params,function(t){if("704AF9E4-E562-421A-BF02-BA28DF8BC0A1"!==t){var e=_.find(o,{Parameter:"Nns"+t}),a=e&&e.Objects,r=_.find(a,function(t){return n===""+t.Year+t.Quarter+c.pad(t.Month,2)});r&&r.Value?i.push({val:r.Value,label:s.getAttributeFullName(t)}):i.push({val:0}),r&&r.PrevValue?l.push({val:r.PrevValue,label:s.getAttributeFullName(t)}):l.push({val:0})}}),r.values.push({title:S(t),points:"year"===s.filter.timeKey?[{values:[{val:i,color:t.Color}]}]:[{values:[{val:l,color:t.PrevColor},{val:i,color:t.Color}]}],link:"/wellsFinChart/"+s.filter.attributeName+"/"+s.data.companyUID+"/"+s.data.fieldUID+"?month="+t.Month+"&quarter="+t.Quarter+"&year="+t.Year+"&profiles=Nns"})}else r.values.push({title:S(t),points:"year"===s.filter.timeKey?[{values:[{val:t.Value,color:t.Color}]}]:[{values:[{val:t.PrevValue,color:t.PrevColor},{val:t.Value,color:t.Color}]}],link:"/wellsFinChart/"+s.filter.attributeName+"/"+s.data.companyUID+"/"+s.data.fieldUID+"?month="+t.Month+"&quarter="+t.Quarter+"&year="+t.Year+"&profiles=Nns"})}),r.averageLines.push({value:e.TrendValue}),s.data.chartsData.fieldNns=r,s.data.chartsData.fieldNnsObjects=_.map(e.Objects,function(t){return t.DisplayName=S(t),t})}console.log(s.data.chartsData,o),s.data.fieldNnsLoaded=!0},function(t){"cancel"!==t&&(s.data.fieldNnsLoaded=!0,s.data.fieldNnsError=t)}),D.promise}function M(){return y&&y.reject("cancel"),s.data.fieldGsLoaded=!1,s.data.fieldGsError=null,s.data.chartsData.fieldGs=null,s.data.chartsData.fieldGsObjects=null,(y=d.getFieldDn7FinData(s.data.fieldUID,s.filter.drillType,s.filter.timeKey,s.filter.timeCount,s.filter.wellState,"704AF9E4-E562-421A-BF02-BA28DF8BC0A1"===s.filter.attributeName?s.data.params:[s.filter.attributeName],"Gs",s.filter.gsDn7Filter)).promise.then(function(t){var o=t.data,e=_.find(o,{Parameter:"Gs"+s.filter.attributeName}),a=e&&e.Objects;if(a&&a.length){var r={yAxisTitle:" ",values:[],averageLines:[],format:e&&e.Format},n=_.map(c.sortTimeObject(a),function(t){return""+t.Year+t.Quarter+c.pad(t.Month,2)});n=_.uniq(n),_.forEach(n,function(n){var t=_.find(a,function(t){return n===""+t.Year+t.Quarter+c.pad(t.Month,2)});if("704AF9E4-E562-421A-BF02-BA28DF8BC0A1"===s.filter.attributeName){var i=[],l=[];_.forEach(s.data.params,function(t){if("704AF9E4-E562-421A-BF02-BA28DF8BC0A1"!==t){var e=_.find(o,{Parameter:"Gs"+t}),a=e&&e.Objects,r=_.find(a,function(t){return n===""+t.Year+t.Quarter+c.pad(t.Month,2)});r&&r.Value?i.push({val:r.Value,label:s.getAttributeFullName(t)}):i.push({val:0}),r&&r.PrevValue?l.push({val:r.PrevValue,label:s.getAttributeFullName(t)}):l.push({val:0})}}),r.values.push({title:S(t),points:"year"===s.filter.timeKey?[{values:[{val:i,color:t.Color}]}]:[{values:[{val:l,color:t.PrevColor},{val:i,color:t.Color}]}],link:"/wellsFinChart/"+s.filter.attributeName+"/"+s.data.companyUID+"/"+s.data.fieldUID+"?month="+t.Month+"&quarter="+t.Quarter+"&year="+t.Year+"&profiles=Gs"})}else r.values.push({title:S(t),points:"year"===s.filter.timeKey?[{values:[{val:t.Value,color:t.Color}]}]:[{values:[{val:t.PrevValue,color:t.Color},{val:t.Value,color:t.Color}]}],link:"/wellsFinChart/"+s.filter.attributeName+"/"+s.data.companyUID+"/"+s.data.fieldUID+"?month="+t.Month+"&quarter="+t.Quarter+"&year="+t.Year+"&profiles=Gs"})}),r.averageLines.push({value:e.TrendValue}),s.data.chartsData.fieldGs=r,s.data.chartsData.fieldGsObjects=_.map(e.Objects,function(t){return t.DisplayName=S(t),t})}s.data.fieldGsLoaded=!0},function(t){"cancel"!==t&&(s.data.fieldGsLoaded=!0,s.data.fieldGsError=t)}),y.promise}function A(){s.data.chartsLoaded=!1,s.data.error=null,s.data.chartsData={},s.data.splitCharts?t.all([w(),Y(),M()]).then(function(t){s.data.chartsLoaded=!0},function(t){"cancel"!==t&&(s.data.chartsLoaded=!0,s.data.error=t)}):w().then(function(){s.data.chartsLoaded=!0},function(t){"cancel"!==t&&(s.data.chartsLoaded=!0,s.data.error=t)})}function S(t){return t.Month?moment().year()===t.Year?moment().month(t.Month-1).format("MMMM"):moment().month(t.Month-1).year(t.Year).format("MMMM YYYYг"):t.Quarter?moment().year()===t.Year?moment().quarter(t.Quarter).format("Q квартал"):moment().quarter(t.Quarter).year(t.Year).format("Q кв YYYYг"):moment().year(t.Year).format("YYYYг")}}]),angular.module("smbApp").service("xlsx",["$interpolate",function(t){function e(){if(!(this instanceof e))return new e;this.SheetNames=[],this.Sheets={}}function l(n,t,i){_.forEach(t,function(t,e){var a;e>i.e.c&&(i.e.c=e),a=_.isObject(t)?{v:t.value,t:t.type}:{v:t,t:"s"};var r=XLSX.utils.encode_cell({c:e,r:i.e.r});n[r]=a}),i.e.r++}return{writeXlsx:function(t){var i=new e;return t.forEach(function(t){var e={},a=t.headers,r={s:{c:0,r:0},e:{c:a.length-1,r:0}};l(e,[t.tableDescription],r),l(e,a,r),_.forEach(t.rows,function(t){l(e,t,r)}),r.e.r--,e["!ref"]=XLSX.utils.encode_range(r),e["!merges"]=t.merges||[],e["!merges"].push({s:{c:0,r:0},e:{c:a.length-1,r:0}});var n=[];_.forEach(a,function(t){n.push({wch:15<t.length?t.length:15})}),e["!cols"]=n,i.SheetNames.push(t.sheetName),i.Sheets[t.sheetName]=e}),XLSX.write(i,{bookType:"xlsx",bookSST:!1,type:"base64"})}}}]),angular.module("smbApp").directive("saveSvgBtn",["saveFile",function(u){return{template:'<div class="download-img-btn"><i class="fa fa-download"></i></div>',restrict:"E",scope:{fileName:"@"},link:function(c,t){t.bind("click",function(t){t.stopPropagation(),t.preventDefault();var e=angular.element(this).parent().find("svg")[0];e=(e=$(e).clone())[0];var a=$("<div></div>");a.append(e);var r=(e=a.html()).indexOf("xmlns"),n=e.indexOf("xmlns",r+5);if(console.log("svg:"),console.log(e),console.log(r),console.log(n),r<n){var i=e.indexOf("svg",n+10);console.log(i),e=e.substring(0,n)+e.substring(i+5),console.log(e)}console.log("конец");var l=$('<canvas style="width: 1000px; height: 500px"></canvas>');canvg(l[0],e);var o=l[0].toDataURL("image/png");o=o.replace("data:image/png;base64,",""),l.remove();var s=c.fileName+" "+moment().format("DD.MM.YYYY");u.saveFile(o,"png",s).promise.then(function(t){window.open("/crsreport/api/document/content?id="+t.data,"_blank").focus(),console.log(t)})})}}}]),angular.module("smbApp").service("accept",["$rootScope","$q","$modal",function(n,i,l){return function(t){var e=i.defer(),a=n.$new(!0);a.message=t,a.ok=function(){r.hide(),e.resolve()},a.cancel=function(){r.hide(),e.reject()};var r=l({scope:a,template:"views/modals/accept.html",show:!0});return e.promise}}]),angular.module("smbApp").directive("numbersOnly",function(){return{link:function(t,e,a){e.bind("keydown",function(t){-1!==_.indexOf([46,8,9,27,13,110,190],t.keyCode)||65==t.keyCode&&(!0===t.ctrlKey||!0===t.metaKey)||35<=t.keyCode&&t.keyCode<=40||(t.shiftKey||t.keyCode<48||57<t.keyCode)&&(t.keyCode<96||105<t.keyCode)&&t.preventDefault()})}}}),angular.module("smbApp").directive("psdFiles",["apiData",function(r){return{templateUrl:"views/directives/pdfFiles.html",replace:!0,restrict:"E",scope:{guid:"="},link:function(e,t,a){e.treeDateLoaded=!1,e.guid?r.getPsdEntity(e.guid).promise.then(function(t){e.treeDateLoaded=!0,e.treeDate=function e(t){return _.map(t,function(t){return t.IsDirectory?{id:t.Id,name:t.Name,isDirectory:t.IsDirectory,children:e(t.Entries)}:{id:t.Id,name:t.Name,isDirectory:t.IsDirectory,children:[]}})}(t.data)}).catch(function(t){e.treeDateLoaded=!0,e.error=t}):(e.treeDateLoaded=!0,e.treeDate=null),e.downloadFile=function(t){t.isDirectory||window.open("/crsreport/api/psd/"+e.guid+"/content?fileId="+t.id).focus();console.log(t)}}}}]),angular.module("smbApp").service("saveFile",["apiData",function(r){return{saveFile:function(t,e,a){return r.saveClientDoc(t,e,a)}}}]),angular.module("smbApp").directive("tableContractorsChart",function(){return{templateUrl:"views/directives/tableContractorsChart.html",restrict:"EA",scope:{contractors:"=contractors",contractorsSrc:"=contractorsSrc",lineHeader:"@",dimension:"@",format:"@"},link:function(t,e,a){t.openLink=function(t){t&&(_.isFunction(t)&&(t(),retrun),window.location.href="#"+t)}}}}),angular.module("smbApp").directive("periodCounter",function(){return{templateUrl:"views/directives/periodCounter.html",restrict:"E",replace:!0,scope:{timeCount:"=timeCount",timeKey:"=timeKey"},link:function(a){a.timeCount=a.timeCount||0,a.$watch("timeKey",function(t,e){t!==e&&(a.timeCount=0)}),a.getPeriodLabel=function(){switch(a.timeKey){case"month":return moment().startOf("month").subtract(-a.timeCount,"months").format("MMMM YYYY г.");case"quarter":return moment().startOf("month").subtract(-a.timeCount,"quarter").format("Q кв. YYYY г.");case"year":return moment().startOf("month").subtract(-a.timeCount,"years").format("YYYY г.");default:return""}},a.up=function(){a.timeCount++},a.down=function(){a.timeCount--},a.disableUp=function(){return 0<=a.timeCount},a.disableDown=function(){var t;switch(a.timeKey){case"month":t=moment().startOf("month").subtract(1-a.timeCount,"months").year();break;case"quarter":t=moment().startOf("month").subtract(1-a.timeCount,"quarter").year();break;case"year":t=moment().startOf("year").subtract(1-a.timeCount,"years").year()}return t<2013},a.upYear=function(){switch(a.timeKey){case"month":a.timeCount+=12;break;case"quarter":a.timeCount+=4;break;case"year":a.timeCount+=1}},a.downYear=function(){switch(a.timeKey){case"month":a.timeCount-=12;break;case"quarter":a.timeCount-=4;break;case"year":a.timeCount-=1}},a.disableUpYear=function(){switch(a.timeKey){case"month":return-12<a.timeCount;case"quarter":return-4<a.timeCount;case"year":return 0<=a.timeCount}},a.showUpDown=function(){return"year"!=a.timeKey}}}}),angular.module("smbApp").service("addPermitDocumentModal",["$rootScope","$q","$modal","apiData",function(t,e,o,s){return function(a,r){var n=e.defer(),i=t.$new(!0);i.newPermitDocument={developmentDate:null,file:null},i.data={item:a,documentTypeName:r,submitted:!1,disableSend:!1},i.addPermitDocument=function(t){if(i.data.submitted=!0,t.$valid){i.data.disableSend=!0;var e=_.clone(i.newPermitDocument);e.branchName=a.DzoName,e.localityName=a.LocalityName,e.clusterName=a.ClusterName,e.wellName=a.WellId,e.documentType=r,s.addPermitDocument(e).promise.then(function(t){l.hide(),n.resolve()},function(t){l.hide(),n.reject(t)})}};var l=o({scope:i,template:"views/modals/add-permit-document.html",show:!1,animation:"am-fade-and-scale"});return l.$promise.then(l.show),n.promise}}]),angular.module("smbApp").service("addPsdDocumentModal",["$rootScope","$q","$timeout","$modal","companiesData","apiData","wellCategoryData","intervalData","drillTypeData","refData",function(l,e,t,o,s,c,u,d,m,f){function p(e,a){return function(t){e[a]="Range"===t}}return function(t,r){var n=s.getCompaniesNames();n=_.sortBy(n,"name");var i=e.defer();return s.getData().then(function(){var e=l.$new(!0);e.newPsdDocument={branchUid:1===n.length?n[0].UID:null,localityUid:null,documentTypeId:"",profileTypeId:"",projectName:"",projectNumber:"",developmentDate:"",file:null,inspectionFileDate:"",inspectionFile:null,inspectionFileRequired:!0,ecoInspectionFileDate:"",ecoInspectionFile:null,ecoInspectionFileRequired:!0,promInspectionFileDate:"",promInspectionFile:null,promInspectionFileRequired:!0,measuredDepthActualSign:null,measuredDepthActual:null,measuredDepthActualIntervalGreaterValue:null},e.data={disableWells:!1,disableClusters:!1,submitted:!1,profileTypes:[{name:"ННС",UID:"ННС"},{name:"ГС",UID:"ГС"}],documentTypes:t,branches:n,localities:[],disableSend:!1,drillTypes:m.getDrillTypes(),wellCategories:u.getWellCategories(),psdDiameters:r,intervalSigns:d.getIntervalSigns()},e.measuredDepthActualShowRange=!1,e.$watch("newPsdDocument.measuredDepthActualSign",p(e,"measuredDepthActualShowRange")),e.verticalDepthActualShowRange=!1,e.$watch("newPsdDocument.verticalDepthActualSign",p(e,"verticalDepthActualShowRange")),e.offsetActualShowRange=!1,e.$watch("newPsdDocument.offsetActualSign",p(e,"offsetActualShowRange")),e.casingDiameterActualShowRange=!1,e.$watch("newPsdDocument.casingDiameterActualSign",p(e,"casingDiameterActualShowRange")),e.casingShoeDepthActualShowRange=!1,e.$watch("newPsdDocument.casingShoeDepthActualSign",p(e,"casingShoeDepthActualShowRange")),e.$watch("newPsdDocument.branchUid",function(t){e.data.localities=t?_.sortBy(s.getCompanyFieldsNames(t),"name"):[],e.newPsdDocument.localityUid=null}),e.$watch("newPsdDocument.localityUid",function(t){t?(e.data.horizons=[],f.getRefHorizonsByLocality(t).promise.then(function(t){e.data.horizons=_.map(t.data,function(t){return{name:t.Name,UID:t.Id}}),e.data.horizons.unshift({name:"Не выбран",UID:null})})):e.data.horizons=[],e.newPsdDocument.horizon=null}),e.addPsdDocument=function(t){e.data.submitted=!0,t&&(e.data.disableSend=!0,c.addPsdDocument(e.newPsdDocument).promise.then(function(t){a.hide(),i.resolve()},function(t){a.hide(),i.reject(t)}))};var a=o({scope:e,template:"views/modals/add-psd-document.html",show:!1,animation:"am-fade-and-scale"});a.$promise.then(a.show)}),i.promise}}]),angular.module("smbApp").service("showPsdDocumentModal",["$rootScope","$q","$modal","config",function(n,i,l,o){return function(t){var e=i.defer(),a=n.$new(!0);a.selectedPsdDocument=t,a.openDocument=function(t){window.open(o.getApiUrl()+"document/"+t.objUID+"/content","_blank").focus()};var r=l({scope:a,template:"views/modals/show-psd-document.html",show:!1,animation:"am-fade-and-scale"});return r.$promise.then(r.show),e.promise}}]),angular.module("smbApp").service("editPsdDocumentModal",["$rootScope","$q","$timeout","$modal","companiesData","apiData","wellCategoryData","intervalData","drillTypeData","refData",function(l,e,t,o,s,c,u,d,m,f){function p(e,a){return function(t){e[a]="Range"===t}}return function(t,r,n){var i=e.defer();return s.getData().then(function(){var a=l.$new(!0);switch(a.selectedPsdDocument=t,a.newPsdDocument={objUid:t.objUID,branchUid:(t.branchId||"").toUpperCase(),localityUid:(t.localityId||"").toUpperCase(),documentTypeId:t.documentType,profileTypeId:t.profileType,projectName:t.documentName,projectNumber:t.projectNumber,developmentDate:moment(t.developmentDate).format("YYYY-MM-DD"),file:null,inspectionFileDate:moment(t.inspectionFileDate).format("YYYY-MM-DD"),inspectionFile:null,inspectionFileRequired:t.inspectionFileRequired,ecoInspectionFileDate:moment(t.ecoInspectionFileDate).format("YYYY-MM-DD"),ecoInspectionFile:null,ecoInspectionFileRequired:t.ecoInspectionFileRequired,promInspectionFileDate:moment(t.promInspectionFileDate).format("YYYY-MM-DD"),promInspectionFile:null,promInspectionFileRequired:t.promInspectionFileRequired,measuredDepthActualSign:t.MeasuredDepthActualInterval?t.MeasuredDepthActualInterval.SignRange:null,measuredDepthActual:t.MeasuredDepthActualInterval?t.MeasuredDepthActualInterval.Value:null,measuredDepthActualIntervalGreaterValue:t.MeasuredDepthActualInterval?t.MeasuredDepthActualInterval.IntervalGreaterValue:null,verticalDepthActualSign:t.VerticalDepthActualInterval?t.VerticalDepthActualInterval.SignRange:null,verticalDepthActual:t.VerticalDepthActualInterval?t.VerticalDepthActualInterval.Value:null,verticalDepthActualIntervalGreaterValue:t.VerticalDepthActualInterval?t.VerticalDepthActualInterval.IntervalGreaterValue:null,offsetActualSign:t.OffsetActualInterval?t.OffsetActualInterval.SignRange:null,offsetActual:t.OffsetActualInterval?t.OffsetActualInterval.Value:null,offsetActualIntervalGreaterValue:t.OffsetActualInterval?t.OffsetActualInterval.IntervalGreaterValue:null,casingDiameterActualSign:t.CasingDiameterActualInterval?t.CasingDiameterActualInterval.SignRange:null,casingDiameterActual:t.CasingDiameterActualInterval?t.CasingDiameterActualInterval.Value:null,casingDiameterActualIntervalGreaterValue:t.CasingDiameterActualInterval?t.CasingDiameterActualInterval.IntervalGreaterValue:null,casingShoeDepthActualSign:t.CasingShoeDepthActualInterval?t.CasingShoeDepthActualInterval.SignRange:null,casingShoeDepthActual:t.CasingShoeDepthActualInterval?t.CasingShoeDepthActualInterval.Value:null,casingShoeDepthActualIntervalGreaterValue:t.CasingShoeDepthActualInterval?t.CasingShoeDepthActualInterval.IntervalGreaterValue:null,horizon:t.GeoHorizonUids},a.newPsdDocument.wellCategory=u.getWellCategory(t.CategoryType),t.DrillType){case null:a.newPsdDocument.drillType=null;break;case 0:a.newPsdDocument.drillType="Eb";break;case 1:a.newPsdDocument.drillType="Zbs";break;case 2:a.newPsdDocument.drillType="Prb"}a.data={disableWells:!1,disableClusters:!1,submitted:!1,profileTypes:[{name:"ННС",UID:"ННС"},{name:"ГС",UID:"ГС"}],documentTypes:r,branches:_.sortBy(s.getCompaniesNames(),"name"),localities:t.branchId?_.sortBy(s.getCompanyFieldsNames(t.branchId),"name"):[],disableSend:!1,drillTypes:m.getDrillTypes(),wellCategories:u.getWellCategories(),psdDiameters:n,intervalSigns:d.getIntervalSigns()},a.newPsdDocument.localityUid&&f.getRefHorizonsByLocality(a.newPsdDocument.localityUid).promise.then(function(t){a.data.horizons=_.map(t.data,function(t){return{name:t.Name,UID:t.Id}}).sort(function(t,e){return t.name>e.name?1:-1}),a.data.horizons.unshift({name:"Не выбран",UID:null})}),a.measuredDepthActualShowRange=!1,a.$watch("newPsdDocument.measuredDepthActualSign",p(a,"measuredDepthActualShowRange")),a.verticalDepthActualShowRange=!1,a.$watch("newPsdDocument.verticalDepthActualSign",p(a,"verticalDepthActualShowRange")),a.offsetActualShowRange=!1,a.$watch("newPsdDocument.offsetActualSign",p(a,"offsetActualShowRange")),a.casingDiameterActualShowRange=!1,a.$watch("newPsdDocument.casingDiameterActualSign",p(a,"casingDiameterActualShowRange")),a.casingShoeDepthActualShowRange=!1,a.$watch("newPsdDocument.casingShoeDepthActualSign",p(a,"casingShoeDepthActualShowRange")),a.$watch("newPsdDocument.branchUid",function(t,e){t!==e&&(a.data.localities=t?_.sortBy(s.getCompanyFieldsNames(t),"name"):[],a.newPsdDocument.localityUid=null)}),a.$watch("newPsdDocument.localityUid",function(t,e){t!==e&&(t?(a.data.horizons=[],f.getRefHorizonsByLocality(t).promise.then(function(t){a.data.horizons=_.map(t.data,function(t){return{name:t.Name,UID:t.Id}}),a.data.horizons.unshift({name:"Не выбран",UID:null})})):a.data.horizons=[],a.newPsdDocument.horizon=null)}),a.updatePsdDocument=function(t){a.data.submitted=!0,t&&(a.data.disableSend=!0,c.addPsdDocument(a.newPsdDocument).promise.then(function(t){e.hide(),i.resolve()},function(t){e.hide(),i.reject(t)}))};var e=o({scope:a,template:"views/modals/edit-psd-document.html",show:!1,animation:"am-fade-and-scale"});e.$promise.then(e.show)}),i.promise}}]),angular.module("smbApp").service("editPermitDocumentProjectNumberModal",["$rootScope","$q","$modal","apiData",function(t,e,l,o){return function(a){var r=e.defer(),n=t.$new(!0);n.permitDocument={projectNumber:a.ProjectNumber},n.data={item:a,submitted:!1,disableSend:!1},n.updatePermitDocument=function(t){if(n.data.submitted=!0,t.$valid){n.data.disableSend=!0;var e=_.clone(n.permitDocument);e.branchName=a.DzoName,e.localityName=a.LocalityName,e.clusterName=a.ClusterName,e.wellName=a.WellId,e.dataVvodaVOsnovnyeFondy=a.DataVvodaVOsnovnyeFondy,o.editPermitDocument(e).promise.then(function(t){i.hide(),r.resolve()},function(t){i.hide(),r.reject(t)})}};var i=l({scope:n,template:"views/modals/edit-permit-document-project-number.html",show:!1,animation:"am-fade-and-scale"});return i.$promise.then(i.show),r.promise}}]),angular.module("smbApp").controller("HelpCtrl",["$scope","$location","$q","apiData",function(e,t,a,r){function n(t,e){return _.map(t,function(t){return t.IsDirectory?{label:t.Name,type:"section",children:n(t.Entries,e)}:{id:t.Id,label:t.Name,type:e,children:[]}})}e.authData&&e.authData.CanViewReports?(e.data={loaded:!1,sections:[],selectedNode:null,playerConfig:{autoPlay:!1,autohide:!0,autohideTime:1e3,sources:[]}},e.opts={dirSelectable:!1,equality:function(t,e){return t===e}},a.all([r.getLessonsDocs().promise,r.getLessonsVideos().promise]).then(function(t){e.data.sections.push({label:"Документы",type:"section",content:"",children:n(t[0].data,"pdf")}),e.data.sections.push({label:"Видео",type:"section",content:"",children:n(t[1].data,"video")}),e.data.loaded=!0}),e.$watch("data.selectedNode",function(t){t&&"video"===t.type&&(e.data.playerConfig.sources=[{src:"/crsreport/api/lessons/videos/"+t.id+"/content",type:"video/mp4"}])})):t.path("/main")}]),angular.module("smbApp").directive("tableDynamicObjectsChart",["utils","numeraljsFilter",function(a,i){return{templateUrl:"views/directives/tableDynamicObjectsChart.html",restrict:"EA",scope:{objects:"=ngModel",splitted:"=splitted"},link:function(r,t,e){var n=[];r.getObjectTimeTitle=a.getObjectTimeTitle,r.getRowCells=function(a){return r.objects&&r.objects.all?(n[a]||(n[a]=[],_.forEach(r.objects.all,function(t,e){n[a].push({value:r.objects.nns[e]?i(r.objects.nns[e].ComputedFrom[a].PlanValue,r.objects.nns[e].ComputedFrom[a].Format||"0.0[0000]"):"-",all:!1}),n[a].push({value:r.objects.nns[e]?i(r.objects.nns[e].ComputedFrom[a].Value,r.objects.nns[e].ComputedFrom[a].Format||"0.0[0000]"):"-",all:!1}),n[a].push({value:r.objects.gs[e]?i(r.objects.gs[e].ComputedFrom[a].PlanValue,r.objects.gs[e].ComputedFrom[a].Format||"0.0[0000]"):"-",all:!1}),n[a].push({value:r.objects.gs[e]?i(r.objects.gs[e].ComputedFrom[a].Value,r.objects.gs[e].ComputedFrom[a].Format||"0.0[0000]"):"-",all:!1}),n[a].push({value:r.objects.all[e]?i(r.objects.all[e].ComputedFrom[a].PlanValue,r.objects.all[e].ComputedFrom[a].Format||"0.0[0000]"):"-",all:!0}),n[a].push({value:r.objects.all[e]?i(r.objects.all[e].ComputedFrom[a].Value,r.objects.all[e].ComputedFrom[a].Format||"0.0[0000]"):"-",all:!0})})),n[a]):r.objects&&!r.objects.all?(n[a]||(n[a]=[],_.forEach(r.objects,function(t,e){n[a].push(r.objects[e]?i(r.objects[e].ComputedFrom[a].PlanValue,r.objects[e].ComputedFrom[a].Format||"0.0[0000]"):"-"),n[a].push(r.objects[e]?i(r.objects[e].ComputedFrom[a].Value,r.objects[e].ComputedFrom[a].Format||"0.0[0000]"):"-")})),n[a]):[]},r.$watch("objects",function(){n=[]}),r.getHeaderCells=function(){var a=[];return r.objects&&_.forEach(r.objects.all,function(t,e){a.push("ННС"),a.push("ГС"),a.push("Всего")}),a},r.getHeaderCellsValueTypes=function(){var a=[];return r.objects&&r.objects.all&&_.forEach(r.objects.all,function(t,e){a.push("План"),a.push("Факт"),a.push("План"),a.push("Факт"),a.push("План"),a.push("Факт")}),r.objects&&!r.objects.all&&_.forEach(r.objects,function(t,e){a.push("План"),a.push("Факт")}),a}}}}]),angular.module("smbApp").service("editPermitDocumentOFDateModal",["$rootScope","$q","$modal","apiData",function(t,e,l,o){return function(a){var r=e.defer(),n=t.$new(!0);n.permitDocument={dataVvodaVOsnovnyeFondy:a.DataVvodaVOsnovnyeFondy},n.data={item:a,submitted:!1,disableSend:!1},n.updatePermitDocument=function(t){if(n.data.submitted=!0,t.$valid){n.data.disableSend=!0;var e=_.clone(n.permitDocument);e.branchName=a.DzoName,e.localityName=a.LocalityName,e.clusterName=a.ClusterName,e.wellName=a.WellId,e.projectNumber=a.ProjectNumber,o.editPermitDocument(e).promise.then(function(t){i.hide(),r.resolve()},function(t){i.hide(),r.reject(t)})}};var i=l({scope:n,template:"views/modals/edit-permit-document-of-date.html",show:!1,animation:"am-fade-and-scale"});return i.$promise.then(i.show),r.promise}}]),angular.module("smbApp").service("editSppIdModal",["$rootScope","$q","$modal","apiData",function(i,l,o,s){return function(e,t){var a=l.defer(),r=i.$new(!0);r.data={sppId:t},r.saveSppIdModal=function(t){r.data.submitted=!0,t.$valid&&(r.data.disableSend=!0,s.editWellSppId(e,r.data.sppId).promise.then(function(t){n.hide(),a.resolve(r.data.sppId)},function(t){n.hide(),a.reject(t)}))};var n=o({scope:r,template:"views/modals/edit-spp-id.html",show:!1,animation:"am-fade-and-scale"});return n.$promise.then(n.show),a.promise}}]),angular.module("smbApp").directive("limitTo",function(){return{restrict:"A",link:function(t,e,a){var r=parseInt(a.limitTo);angular.element(e).on("keypress",function(t){this.value.length==r&&t.preventDefault()})}}}),angular.module("smbApp").service("physChartsData",["$q","$http","config",function(t,e,a){var r=t.defer();return e.get(a.getApiUrl()+"phys/charts").success(function(t){t,r.resolve(t)}).error(function(t){r.reject(t)}),{getData:function(){return r.promise}}}]),angular.module("smbApp").service("config",["$q","$http",function(t,e){var a=null,r=t.defer(),n=!1;return e.get("config.json").success(function(t){a=t,r.resolve(t)}).error(function(t){r.reject(t)}).finally(function(){n=!0}),{getData:function(){return r.promise},getApiUrl:function(){for(;!n;);return a?a.protocol+a.host+a.path:""},getServerUrl:function(){if(a){var t=a.protocol+a.host+a.path;return t=t.replace("api/","")}return""},getIframeUrl:function(){return a.iframeUrl},getAdminUrl:function(){return a.adminUrl}}}]),angular.module("smbApp").filter("thousand",function(){return function(t){if(t||0===t){t=parseFloat(t),t=Math.round(100*t)/100;for(var e=(t+="").split(".")[1],a=t.split(".")[0].split("").reverse().join(""),r="",n="",i=0;n=a.substring(0+3*i,3+3*i);)r+=n+" ",i++;return r=r.split("").reverse().join(""),e&&(r+="."+e),r}return""}}),angular.module("smbApp").service("wellCategoryData",function(){return{getWellCategories:function(){return[{name:"Не выбран",UID:null},{name:"Прочие",UID:"Other"},{name:"Нефтяные",UID:"Oil"},{name:"Газовые",UID:"Gas"},{name:"Водозаборные",UID:"Water"},{name:"Нагнетательные",UID:"Pressure"}]},getWellCategory:function(t){switch(t){case null:return null;case 0:return"Other";case 1:return"Oil";case 2:return"Gas";case 3:return"Water";case 4:return"Pressure"}}}}),angular.module("smbApp").service("intervalData",function(){return{getIntervalSigns:function(){return[{name:"Не выбран",UID:null},{name:"<=",UID:"LessEqual"},{name:">=",UID:"GreaterEqual"},{name:"..",UID:"Range"}]}}}),angular.module("smbApp").service("drillTypeData",function(){return{getDrillTypes:function(){return[{name:"ЭБ",UID:"Eb"},{name:"ЗБС",UID:"Zbs"},{name:"ПРБ",UID:"Prb"}]}}});