<!doctype html> <html ng-app="testData" xmlns="http://www.w3.org/1999/html"> <head> <meta charset="utf-8"> <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.2/angular.min.js"></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.3/moment.min.js"></script> <script> angular.module('testData', [])
      .controller('test10TypeController', function($scope, $http) {
        $scope.update = function() {
          $scope.data = {};
          $scope.dataLoaded = false;
          $scope.loadDataError = null;
          $http.get('api.php/data/type/'+10).
            success(function(data, status, headers, config) {
              var json = JSON.parse(data[0].json);
              $scope.data.companiesCount = 0;
              angular.forEach(json.companies, function(company) {
                $scope.data.companiesCount++;
              });
              $scope.dataLoaded = true;
            }).
            error(function(data, status, headers, config) {
              console.log('loading data error: ', data);
              $scope.dataLoaded = true;
              $scope.loadDataError = data;
            });
        };
        $scope.update();
      })
      .controller('test9TypeController', function($scope, $http) {
        $scope.update = function() {
          function checkWell(well) {
            var now = moment();
            if (!well.drillBeginActual) {
              return false;
            }
            var drillBeginActual = moment(well.drillBeginActual, 'DD.MM.YYYY');
            var drillEndActual;
            if (well.drillEndActual) {
              drillEndActual = moment(well.drillEndActual, 'DD.MM.YYYY');
            }
            if (drillBeginActual.valueOf() < now.valueOf() && !drillEndActual) {
              return true;
            }
            if (drillBeginActual.valueOf() < now.valueOf() && drillEndActual.valueOf() > now.valueOf()) {
              return true;
            }
            return false;
          }

          $scope.data = {};
          $scope.dataLoaded = false;
          $scope.loadDataError = null;
          $http.get('api.php/data/type/'+9).
            success(function(data, status, headers, config) {
              console.log(data);
              $scope.data.companies = [];
              angular.forEach(data, function(company) {
                var json = JSON.parse(company.json);
                var companyData = {
                  name: json.name,
                  fieldsCount: 0,
                  clustersCount: 0,
                  wellsCount: 0,
                  activeObjects: []
                };
                angular.forEach(json.fields, function(field) {
                  companyData.fieldsCount++;
                  angular.forEach(field.clusters, function(cluster) {
                    companyData.clustersCount++;
                    angular.forEach(cluster.wells, function(well) {
                      companyData.wellsCount++;
                      if (checkWell(well)) {
                        companyData.activeObjects.push({
                          companyUID: json.objUID,
                          companyName: json.name,
                          fieldUID: field.objUID,
                          fieldName: field.name,
                          clusterUID: cluster.objUID,
                          clusterName: cluster.name,
                          wellUID: well.objUID,
                          wellName: well.name,
                          drillType: well.drillType
                        });
                      }
                    });
                  });
                  angular.forEach(field.wells, function(well) {
                    companyData.wellsCount++;
                    if (checkWell(well)) {
                      companyData.activeObjects.push({
                        companyUID: json.objUID,
                        companyName: json.name,
                        fieldUID: field.objUID,
                        fieldName: field.name,
                        clusterUID: 'none',
                        clusterName: 'none',
                        wellUID: well.objUID,
                        wellName: well.name,
                        drillType: well.drillType
                      });
                    }
                  });
                });
                $scope.data.companies.push(companyData);
              });
              $scope.dataLoaded = true;
            }).
            error(function(data, status, headers, config) {
              console.log('loading data error: ', data);
              $scope.dataLoaded = true;
              $scope.loadDataError = data;
            });
        };
        $scope.update();
      })
      .controller('test1TypeController', function($scope, $http) {
        $scope.update = function() {
          $scope.data = {};
          $scope.dataLoaded = false;
          $scope.loadDataError = null;
          $http.get('api.php/data/type/'+1).
            success(function(data, status, headers, config) {
              var wellStates = ['0', '1', '2'];
              var drillTypes = ['0', '1', '2'];
              var profileTypes = ['0', '1'];
              var months = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
              var fieldNames = ['nonProductivePc', 'nonProductiveDuration', 'vmrDuration', 'drillingDuration', 'explorationDuration', 'drillingRate', 'drillingBrigades',  'explorationBrigades', 'incidentPer1000m', 'hoursPerIncident', 'incidentCount', 'penetration'];
              $scope.data.companiesData = [];
              $scope.data.months = months;

              angular.forEach(data, function(company) {
                var json = JSON.parse(company.json);
                var companyData = {
                  name: company.data_id + ' ' + company.year,
                  fields: []
                };
                angular.forEach(fieldNames, function(fieldName) {
                  var fieldData = {
                    name: fieldName,
                    filteredAttributes: []
                  };
                  angular.forEach(wellStates, function(wellState) {
                    angular.forEach(drillTypes, function(drillType) {
                      angular.forEach(profileTypes, function(profileType) {
                        var filteredAttribute = {
                          name: wellState + ' ' + drillType + ' ' + profileType,
                          months: []
                        };
                        angular.forEach(months, function(month) {
                          attributeDataFact = null;
                          attributeDataPlan = null;
                          angular.forEach(json.months, function(monthData) {
                            if (monthData.month === month && monthData.wellState === wellState && monthData.drillType === drillType && monthData.profileType === profileType) {
                              attributeDataFact = monthData.fact[fieldName];
                              attributeDataPlan = monthData.plans[0][fieldName];
                            }
                          });
                          filteredAttribute.months.push({
                            fact: (attributeDataFact)?attributeDataFact:'none',
                            plan: (attributeDataPlan)?attributeDataPlan:'none'
                          });
                        });
                        fieldData.filteredAttributes.push(filteredAttribute);
                      });
                    });
                  });
                  companyData.fields.push(fieldData);
                });
                $scope.data.companiesData.push(companyData);
              });
              $scope.dataLoaded = true;
            }).
            error(function(data, status, headers, config) {
              console.log('loading data error: ', data);
              $scope.dataLoaded = true;
              $scope.loadDataError = data;
            });
        };
        $scope.update();
      }); </script> <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"> <style> [ng\:cloak], [ng-cloak], [data-ng-cloak], [x-ng-cloak], .ng-cloak, .x-ng-cloak
    {
      display: none !important;
    } </style> </head> <body> <div class="container" ng-controller="test10TypeController"> <h1 class="text-center">Type 10 test <span class="glyphicon glyphicon-refresh" aria-hidden="true" ng-click="update()"></span></h1> <div ng-show="dataLoaded && !loadDataError"> <p><strong>Колличество ДО:</strong> {{data.companiesCount}}</p> </div> <p class="text-center" ng-hide="dataLoaded">Загрузка данных</p> <p class="bg-danger" ng-show="loadDataError">Произошла ошибка при загрузке данных: {{loadDataError}}</p> </div> <div class="container" ng-controller="test9TypeController"> <h1 class="text-center">Type 9 test <span class="glyphicon glyphicon-refresh" aria-hidden="true" ng-click="update()"></span></h1> <div ng-show="dataLoaded && !loadDataError"> <div class="row"> <div class="col-md-4" ng-repeat="company in data.companies"> <h3 class="text-center">{{company.name}}</h3> <p><strong>Колличество месторождений:</strong> {{company.fieldsCount}}</p> <p><strong>Колличество кустов:</strong> {{company.clustersCount}}</p> <p><strong>Колличество скважин:</strong> {{company.wellsCount}}</p> <p><strong>Колличество активных объектов:</strong> {{company.activeObjects.length}}</p> <p><strong>Активные объекты:</strong> <span ng-hide="company.activeObjects.length">-</span> <span ng-repeat="activeObject in company.activeObjects">{{activeObject.fieldName}}->{{activeObject.clusterName}}->{{activeObject.wellName}} </span></p> </div> </div> </div> <p class="text-center" ng-hide="dataLoaded">Загрузка данных</p> <p class="bg-danger" ng-show="loadDataError">Произошла ошибка при загрузке данных: {{loadDataError}}</p> </div> <div class="container" ng-controller="test1TypeController"> <h1 class="text-center">Type 1 test <span class="glyphicon glyphicon-refresh" aria-hidden="true" ng-click="update()"></span></h1> <div ng-show="dataLoaded && !loadDataError"> <div class="row" ng-repeat="companyData in data.companiesData"> <h3 class="text-center">{{companyData.name}}</h3> <div ng-repeat="field in companyData.fields"> <h4 class="text-center">{{field.name}}</h4> <table class="table table-striped fixed"> <thead> <tr class="table-header"> <th>wellState drillType profileType</th> <th ng-repeat="month in data.months">{{month}}</th> </tr> </thead> <tbody> <tr ng-repeat="filteredAttribute in field.filteredAttributes"> <td>{{filteredAttribute.name}}</td> <td ng-repeat="month in filteredAttribute.months track by $index"><span ng-class="{'text-danger': month.fact == 'none'}">{{month.fact}}</span>/<span ng-class="{'text-danger': month.fact == 'none'}">{{month.plan}}</span></td> </tr> </tbody> </table> </div> </div> </div> <p class="text-center" ng-hide="dataLoaded">Загрузка данных</p> <p class="bg-danger" ng-show="loadDataError">Произошла ошибка при загрузке данных: {{loadDataError}}</p> </div> 